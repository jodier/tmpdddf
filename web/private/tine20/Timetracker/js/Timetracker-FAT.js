/*
 * Tine 2.0 - Timetracker 
 * Copyright (c) 2007-2011 Metaways Infosystems GmbH (http://www.metaways.de)
 * http://www.gnu.org/licenses/agpl.html AGPL Version 3
 */
Ext.ns("Tine.Timetracker");Tine.Timetracker.DurationSpinner=Ext.extend(Ext.ux.form.Spinner,{emptyOnZero:null,initComponent:function(){this.preventMark=false;this.strategy=new Ext.ux.form.Spinner.TimeStrategy({incrementValue:15});this.format=this.strategy.format},setValue:function(c){if(!c||c=="00:00"){c=this.emptyOnZero?"":"00:00"}else{if(!c.toString().match(/:/)){var d=new Date(0);var a=Math.floor(c/60);var b=c-a*60;d.setHours(a);d.setMinutes(b);c=Ext.util.Format.date(d,this.format)}}Tine.Timetracker.DurationSpinner.superclass.setValue.call(this,c)},validateValue:function(a){var b=Date.parseDate(a,this.format);return Ext.isDate(b)},getValue:function(){var a=Tine.Timetracker.DurationSpinner.superclass.getValue.call(this);a=a.replace(",",".");if(a&&typeof a=="string"){if(a.search(/:/)!=-1){var c=a.split(":");c[0]=c[0].length==1?"0"+c[0]:c[0];c[1]=c[1].length==1?"0"+c[1]:c[1];a=c.join(":");var b=Date.parseDate(a,this.format);if(!b){this.markInvalid(_("Not a valid time"));return}else{a=b.getHours()*60+b.getMinutes()}}else{if(a>0){if(a<24){a=a*60}}else{this.markInvalid(_("Not a valid time"));return}}}this.setValue(a);return a}});Ext.reg("tinedurationspinner",Tine.Timetracker.DurationSpinner);Ext.ns("Tine.Timetracker","Tine.Timetracker.Model");Tine.Timetracker.Model.TimesheetArray=Tine.Tinebase.Model.genericFields.concat([{name:"id"},{name:"account_id"},{name:"timeaccount_id"},{name:"start_date",type:"date",dateFormat:Date.patterns.ISO8601Short},{name:"start_time",type:"date",dateFormat:Date.patterns.ISO8601Time},{name:"duration"},{name:"description"},{name:"is_billable",type:"bool"},{name:"is_billable_combined",type:"bool"},{name:"is_cleared",type:"bool"},{name:"is_cleared_combined",type:"bool"},{name:"billed_in"},{name:"notes"},{name:"tags"},{name:"customfields"}]);Tine.Timetracker.Model.Timesheet=Tine.Tinebase.data.Record.create(Tine.Timetracker.Model.TimesheetArray,{appName:"Timetracker",modelName:"Timesheet",idProperty:"id",titleProperty:null,recordName:"Timesheet",recordsName:"Timesheets",containerProperty:"timeaccount_id",containerName:"All Timesheets",containersName:"timesheets lists",getTitle:function(){var b=this.get("timeaccount_id"),c=Ext.util.Format.ellipsis(this.get("description"),30,true),a="";if(b){if(typeof(b.get)!=="function"){b=new Tine.Timetracker.Model.Timeaccount(b)}a=b.getTitle()}a=a?"["+a+"] ":"";return a+c},copyOmitFields:["billed_in","is_cleared"]});Tine.Timetracker.Model.Timesheet.getDefaultData=function(){return{account_id:Tine.Tinebase.registry.get("currentAccount"),duration:"00:30",start_date:new Date(),is_billable:true,timeaccount_id:{account_grants:{bookOwnGrant:true}}}};Tine.Timetracker.Model.Timesheet.getFilterModel=function(){var a=Tine.Tinebase.appMgr.get("Timetracker");return[{label:a.i18n._("Quick search"),field:"query",operators:["contains"]},{label:a.i18n._("Account"),field:"account_id",valueType:"user"},{label:a.i18n._("Date"),field:"start_date",valueType:"date",pastOnly:true},{label:a.i18n._("Description"),field:"description",defaultOperator:"contains"},{label:a.i18n._("Billable"),field:"is_billable_combined",valueType:"bool",defaultValue:true},{label:a.i18n._("Cleared"),field:"is_cleared_combined",valueType:"bool",defaultValue:false},{label:_("Last Modified Time"),field:"last_modified_time",valueType:"date"},{label:_("Last Modified By"),field:"last_modified_by",valueType:"user"},{label:_("Creation Time"),field:"creation_time",valueType:"date"},{label:_("Created By"),field:"created_by",valueType:"user"},{filtertype:"tinebase.tag",app:a},{filtertype:"timetracker.timeaccount"}]};Tine.Timetracker.Model.TimeaccountArray=Tine.Tinebase.Model.genericFields.concat([{name:"id"},{name:"container_id"},{name:"title"},{name:"number"},{name:"description"},{name:"budget"},{name:"budget_unit"},{name:"price"},{name:"price_unit"},{name:"is_open",type:"bool"},{name:"is_billable",type:"bool"},{name:"billed_in"},{name:"status"},{name:"deadline"},{name:"account_grants"},{name:"grants"},{name:"notes"},{name:"tags"},{name:"customfields"},{name:"relations"}]);Tine.Timetracker.Model.Timeaccount=Tine.Tinebase.data.Record.create(Tine.Timetracker.Model.TimeaccountArray,{appName:"Timetracker",modelName:"Timeaccount",idProperty:"id",titleProperty:"title",recordName:"Time Account",recordsName:"Time Accounts",containerProperty:"container_id",containerName:"All Timeaccounts",containersName:"timeaccount lists",getTitle:function(){var a=this.get("is_open")?"":(" ("+Tine.Tinebase.appMgr.get("Timetracker").i18n._("closed")+")");return this.get("number")?(this.get("number")+" - "+this.get("title")+a):""}});Tine.Timetracker.Model.Timeaccount.getDefaultData=function(){return{is_open:1,is_billable:true}};Tine.Timetracker.Model.Timeaccount.getFilterModel=function(){var b=Tine.Tinebase.appMgr.get("Timetracker");var a=[{label:_("Quick search"),field:"query",operators:["contains"]},{label:b.i18n._("Number"),field:"number"},{label:b.i18n._("Title"),field:"title"},{label:b.i18n._("Description"),field:"description",operators:["contains"]},{label:b.i18n._("Billed"),field:"status",filtertype:"timetracker.timeaccountbilled"},{label:b.i18n._("Status"),field:"is_open",filtertype:"timetracker.timeaccountstatus"},{label:_("Last Modified Time"),field:"last_modified_time",valueType:"date"},{label:_("Last Modified By"),field:"last_modified_by",valueType:"user"},{label:_("Creation Time"),field:"creation_time",valueType:"date"},{label:_("Created By"),field:"created_by",valueType:"user"},{label:b.i18n._("Booking deadline"),field:"deadline"},{filtertype:"tinebase.tag",app:b}];if(Tine.Tinebase.appMgr.get("Sales")){a.push({filtertype:"timetracker.timeaccountcontract"})}return a};Tine.Timetracker.Model.TimeaccountGrant=Ext.data.Record.create([{name:"id"},{name:"account_id"},{name:"account_type"},{name:"account_name"},{name:"bookOwnGrant",type:"boolean"},{name:"viewAllGrant",type:"boolean"},{name:"bookAllGrant",type:"boolean"},{name:"manageBillableGrant",type:"boolean"},{name:"exportGrant",type:"boolean"},{name:"adminGrant",type:"boolean"}]);Ext.ns("Tine.Timetracker");Tine.Timetracker.Application=Ext.extend(Tine.Tinebase.Application,{init:function(){Tine.Timetracker.Application.superclass.init.apply(this,arguments);Ext.ux.ItemRegistry.registerItem("Tine.widgets.grid.GridPanel.addButton",{text:this.i18n._("New Timesheet"),iconCls:"TimetrackerTimesheet",scope:this,handler:function(){var a=this.getMainScreen(),b=a.getCenterPanel("Timesheet");b.onEditInNewWindow.call(b,{})}})}});Tine.Timetracker.MainScreen=Ext.extend(Tine.widgets.MainScreen,{activeContentType:"Timesheet",contentTypes:[{model:"Timesheet",requiredRight:null,singularContainerMode:true},{model:"Timeaccount",requiredRight:"manage",singularContainerMode:true}]});Tine.Timetracker.TimesheetFilterPanel=function(a){Ext.apply(this,a);Tine.Timetracker.TimesheetFilterPanel.superclass.constructor.call(this)};Ext.extend(Tine.Timetracker.TimesheetFilterPanel,Tine.widgets.persistentfilter.PickerPanel,{filter:[{field:"model",operator:"equals",value:"Timetracker_Model_TimesheetFilter"}]});Tine.Timetracker.TimeaccountFilterPanel=function(a){Ext.apply(this,a);Tine.Timetracker.TimeaccountFilterPanel.superclass.constructor.call(this)};Ext.extend(Tine.Timetracker.TimeaccountFilterPanel,Tine.widgets.persistentfilter.PickerPanel,{filter:[{field:"model",operator:"equals",value:"Timetracker_Model_TimeaccountFilter"}]});Tine.Timetracker.timesheetBackend=new Tine.Tinebase.data.RecordProxy({appName:"Timetracker",modelName:"Timesheet",recordClass:Tine.Timetracker.Model.Timesheet});Tine.Timetracker.timeaccountBackend=new Tine.Tinebase.data.RecordProxy({appName:"Timetracker",modelName:"Timeaccount",recordClass:Tine.Timetracker.Model.Timeaccount});Ext.ns("Tine.Timetracker");Tine.Timetracker.TimeaccountPickerCombo=Ext.extend(Tine.Tinebase.widgets.form.RecordPickerComboBox,{showClosed:false,showClosedBtn:null,sortBy:"number",initComponent:function(){this.recordProxy=Tine.Timetracker.timeaccountBackend;this.recordClass=Tine.Timetracker.Model.Timeaccount;Tine.Timetracker.TimeaccountPickerCombo.superclass.initComponent.apply(this,arguments)},initList:function(){Tine.Timetracker.TimeaccountPickerCombo.superclass.initList.apply(this,arguments);if(this.pageTb&&!this.showClosedBtn){this.showClosedBtn=new Tine.widgets.grid.FilterButton({text:this.app.i18n._("Show closed"),iconCls:"action_showArchived",field:"is_open",invert:true,pressed:this.showClosed,scope:this,handler:function(){this.showClosed=this.showClosedBtn.pressed;this.store.load()}});this.pageTb.add("-",this.showClosedBtn);this.pageTb.doLayout()}},onStoreBeforeLoadRecords:function(d,b,c,a){if(Tine.Timetracker.TimeaccountPickerCombo.superclass.onStoreBeforeLoadRecords.apply(this,arguments)!==false){if(this.showClosedBtn){this.showClosedBtn.setValue(b.params.filter)}}},onBeforeLoad:function(a,b){Tine.Timetracker.TimeaccountPickerCombo.superclass.onBeforeLoad.apply(this,arguments);if(this.showClosedBtn){Ext.each(a.baseParams.filter,function(d,c){if(d.field=="is_open"){a.baseParams.filter.remove(d)}},this);if(this.showClosedBtn.getValue().value===true){a.baseParams.filter.push(this.showClosedBtn.getValue())}}}});Tine.widgets.form.RecordPickerManager.register("Timetracker","Timeaccount",Tine.Timetracker.TimeaccountPickerCombo);Ext.ns("Tine.Timetracker");Tine.Timetracker.TimeAccountFilterModel=Ext.extend(Tine.widgets.grid.ForeignRecordFilter,{foreignRecordClass:Tine.Timetracker.Model.Timeaccount,linkType:"foreignId",filterName:"TimeaccountFilter",ownField:"timeaccount_id",initComponent:function(){this.app=Tine.Tinebase.appMgr.get("Timetracker");this.label=this.app.i18n.n_hidden(this.foreignRecordClass.getMeta("recordName"),this.foreignRecordClass.getMeta("recordsName"),1);this.pickerConfig=this.pickerConfig||{};Tine.Timetracker.TimeAccountFilterModel.superclass.initComponent.call(this)}});Tine.widgets.grid.FilterToolbar.FILTERS["timetracker.timeaccount"]=Tine.Timetracker.TimeAccountFilterModel;Ext.ns("Tine.Timetracker");Tine.Timetracker.TimeAccountStatusFilterModel=Ext.extend(Tine.widgets.grid.FilterModel,{field:"is_open",valueType:"bool",defaultValue:1,initComponent:function(){Tine.Timetracker.TimeAccountStatusFilterModel.superclass.initComponent.call(this);this.app=Tine.Tinebase.appMgr.get("Timetracker");this.label=this.label?this.label:this.app.i18n._("Time Account - Status");this.operators=["equals"]},valueRenderer:function(b,a){var c=new Ext.form.ComboBox({filter:b,width:200,id:"tw-ftb-frow-valuefield-"+b.id,value:b.data.value?b.data.value:this.defaultValue,renderTo:a,mode:"local",forceSelection:true,blurOnSelect:true,triggerAction:"all",store:[[0,this.app.i18n._("closed")],[1,this.app.i18n._("open")]]});c.on("specialkey",function(f,d){if(d.getKey()==d.ENTER){this.onFiltertrigger()}},this);return c}});Tine.widgets.grid.FilterToolbar.FILTERS["timetracker.timeaccountstatus"]=Tine.Timetracker.TimeAccountStatusFilterModel;Ext.ns("Tine.Timetracker");Tine.Timetracker.TimeAccountBilledFilterModel=Ext.extend(Tine.widgets.grid.FilterModel,{field:"timeaccount_status",valueType:"string",defaultValue:"to bill",initComponent:function(){Tine.Timetracker.TimeAccountBilledFilterModel.superclass.initComponent.call(this);this.app=Tine.Tinebase.appMgr.get("Timetracker");this.label=this.label?this.label:this.app.i18n._("Time Account - Billed");this.operators=["equals"]},valueRenderer:function(b,a){var c=new Ext.form.ComboBox({filter:b,width:200,id:"tw-ftb-frow-valuefield-"+b.id,value:b.data.value?b.data.value:this.defaultValue,renderTo:a,mode:"local",forceSelection:true,blurOnSelect:true,triggerAction:"all",store:[["not yet billed",this.app.i18n._("not yet billed")],["to bill",this.app.i18n._("to bill")],["billed",this.app.i18n._("billed")]]});c.on("specialkey",function(f,d){if(d.getKey()==d.ENTER){this.onFiltertrigger()}},this);return c}});Tine.widgets.grid.FilterToolbar.FILTERS["timetracker.timeaccountbilled"]=Tine.Timetracker.TimeAccountBilledFilterModel;Ext.ns("Tine.Timetracker");Tine.Timetracker.TimeaccountContractFilterModel=Ext.extend(Tine.widgets.grid.ForeignRecordFilter,{field:"contract",valueType:"relation",initComponent:function(){this.app=Tine.Tinebase.appMgr.get("Timetracker");this.label=this.app.i18n._("Contract");this.foreignRecordClass="Sales.Contract",this.pickerConfig={emptyText:this.app.i18n._("without contract"),allowBlank:true};Tine.Timetracker.TimeaccountContractFilterModel.superclass.initComponent.call(this)}});Tine.widgets.grid.FilterToolbar.FILTERS["timetracker.timeaccountcontract"]=Tine.Timetracker.TimeaccountContractFilterModel;Ext.namespace("Tine.Timetracker");Tine.Timetracker.TimeaccountGridPanel=Ext.extend(Tine.widgets.grid.GridPanel,{recordClass:Tine.Timetracker.Model.Timeaccount,defaultSortInfo:{field:"creation_time",direction:"DESC"},gridConfig:{autoExpandColumn:"title"},copyEditAction:true,initComponent:function(){this.recordProxy=Tine.Timetracker.timeaccountBackend;this.actionToolbarItems=this.getToolbarItems();this.gridConfig.cm=this.getColumnModel();this.initFilterToolbar();this.plugins=this.plugins||[];this.plugins.push(this.filterToolbar);Tine.Timetracker.TimeaccountGridPanel.superclass.initComponent.call(this);this.action_addInNewWindow.setDisabled(!Tine.Tinebase.common.hasRight("manage","Timetracker","timeaccounts"));this.action_editInNewWindow.requiredGrant="editGrant"},initFilterToolbar:function(){this.filterToolbar=new Tine.widgets.grid.FilterToolbar({app:this.app,recordClass:this.recordClass,filterModels:Tine.Timetracker.Model.Timeaccount.getFilterModel(),defaultFilter:"is_open",filters:[{field:"is_open",operator:"equals",value:true}],plugins:[new Tine.widgets.grid.FilterToolbarQuickFilterPlugin()]})},getColumnModel:function(){return new Ext.grid.ColumnModel({defaults:{sortable:true,resizable:true},columns:[{id:"tags",header:this.app.i18n._("Tags"),width:50,dataIndex:"tags",sortable:false,renderer:Tine.Tinebase.common.tagsRenderer},{id:"number",header:this.app.i18n._("Number"),width:100,dataIndex:"number"},{id:"title",header:this.app.i18n._("Title"),width:350,dataIndex:"title"},{id:"status",header:this.app.i18n._("Billed"),width:150,dataIndex:"status",renderer:this.statusRenderer.createDelegate(this)},{id:"budget",header:this.app.i18n._("Budget"),width:100,dataIndex:"budget"},{id:"billed_in",hidden:true,header:this.app.i18n._("Cleared in"),width:150,dataIndex:"billed_in"},{id:"deadline",hidden:true,header:this.app.i18n._("Booking deadline"),width:100,dataIndex:"deadline"},{id:"is_open",header:this.app.i18n._("Status"),width:150,dataIndex:"is_open",renderer:function(a){if(a){return this.app.i18n._("open")}return this.app.i18n._("closed")},scope:this,hidden:true}]})},statusRenderer:function(a){return this.app.i18n._hidden(a)},getToolbarItems:function(){this.exportButton=new Ext.Action({text:_("Export"),iconCls:"action_export",scope:this,requiredGrant:"readGrant",disabled:true,allowMultiple:true,menu:{items:[new Tine.widgets.grid.ExportButton({text:this.app.i18n._("Export as ODS"),format:"ods",exportFunction:"Timetracker.exportTimeaccounts",gridPanel:this})]}});return[Ext.apply(new Ext.Button(this.exportButton),{scale:"medium",rowspan:2,iconAlign:"top"})]}});Ext.namespace("Tine.Timetracker");Tine.Timetracker.TimeaccountEditDialog=Ext.extend(Tine.widgets.dialog.EditDialog,{windowNamePrefix:"TimeaccountEditWindow_",appName:"Timetracker",recordClass:Tine.Timetracker.Model.Timeaccount,recordProxy:Tine.Timetracker.timeaccountBackend,loadRecord:false,tbarItems:[{xtype:"widget-activitiesaddbutton"}],updateToolbars:function(){},onRecordLoad:function(){this.getGrantsGrid();var a=this.record.get("grants")||[];this.grantsStore.loadData({results:a});Tine.Timetracker.TimeaccountEditDialog.superclass.onRecordLoad.call(this)},onRecordUpdate:function(){Tine.Timetracker.TimeaccountEditDialog.superclass.onRecordUpdate.call(this);this.record.set("grants","");var a=[];this.grantsStore.each(function(b){a.push(b.data)});this.record.set("grants",a)},getFormItems:function(){var a=[{fieldLabel:this.app.i18n._("Unit"),name:"price_unit"},{xtype:"numberfield",fieldLabel:this.app.i18n._("Unit Price"),name:"price",allowNegative:false},{fieldLabel:this.app.i18n._("Budget"),name:"budget"},{fieldLabel:this.app.i18n._("Status"),name:"is_open",xtype:"combo",mode:"local",forceSelection:true,triggerAction:"all",store:[[0,this.app.i18n._("closed")],[1,this.app.i18n._("open")]]},{fieldLabel:this.app.i18n._("Billed"),name:"status",xtype:"combo",mode:"local",forceSelection:true,triggerAction:"all",value:"not yet billed",store:[["not yet billed",this.app.i18n._("not yet billed")],["to bill",this.app.i18n._("to bill")],["billed",this.app.i18n._("billed")]]},{fieldLabel:this.app.i18n._("Cleared In"),name:"billed_in",xtype:"textfield"},{fieldLabel:this.app.i18n._("Booking deadline"),name:"deadline",xtype:"combo",mode:"local",forceSelection:true,triggerAction:"all",value:"none",store:[["none",this.app.i18n._("none")],["lastweek",this.app.i18n._("last week")]]}];if(Tine.Tinebase.appMgr.get("Sales")){a.push({xtype:"tinerelationpickercombo",fieldLabel:this.app.i18n._("Cost Center"),editDialog:this,allowBlank:true,app:"Sales",recordClass:Tine.Sales.Model.CostCenter,relationType:"COST_CENTER",relationDegree:"sibling",modelUnique:true})}a.push({hideLabel:true,boxLabel:this.app.i18n._("Timesheets are billable"),name:"is_billable",xtype:"checkbox",columnWidth:0.666});return{xtype:"tabpanel",border:false,plain:true,activeTab:0,plugins:[{ptype:"ux.tabpanelkeyplugin"}],items:[{title:this.app.i18n.ngettext("Time Account","Time Accounts",1),autoScroll:true,border:false,frame:true,layout:"border",items:[{region:"center",xtype:"columnform",labelAlign:"top",formDefaults:{xtype:"textfield",anchor:"100%",labelSeparator:"",columnWidth:0.333},items:[[{fieldLabel:this.app.i18n._("Number"),name:"number",allowBlank:false},{columnWidth:0.666,fieldLabel:this.app.i18n._("Title"),name:"title",allowBlank:false}],[{columnWidth:1,fieldLabel:this.app.i18n._("Description"),xtype:"textarea",name:"description",height:150}],a]},{layout:"accordion",animate:true,region:"east",width:210,split:true,collapsible:true,collapseMode:"mini",header:false,margins:"0 5 0 5",border:true,items:[new Tine.widgets.activities.ActivitiesPanel({app:"Timetracker",showAddNoteForm:false,border:false,bodyStyle:"border:1px solid #B5B8C8;"}),new Tine.widgets.tags.TagPanel({app:"Timetracker",border:false,bodyStyle:"border:1px solid #B5B8C8;"})]}]},{title:this.app.i18n._("Access"),layout:"fit",items:[this.getGrantsGrid()]},new Tine.widgets.activities.ActivitiesTabPanel({app:this.appName,record_id:(!this.copyRecord)?this.record.id:null,record_model:this.appName+"_Model_"+this.recordClass.getMeta("modelName")})]}},getGrantsGrid:function(){if(!this.grantsGrid){this.grantsStore=new Ext.data.JsonStore({root:"results",totalProperty:"totalcount",id:"account_id",fields:Tine.Timetracker.Model.TimeaccountGrant});var a=[new Ext.ux.grid.CheckColumn({header:this.app.i18n._("Book Own"),dataIndex:"bookOwnGrant",tooltip:_("The grant to add Timesheets to this Timeaccount"),width:55}),new Ext.ux.grid.CheckColumn({header:this.app.i18n._("View All"),tooltip:_("The grant to view Timesheets of other users"),dataIndex:"viewAllGrant",width:55}),new Ext.ux.grid.CheckColumn({header:this.app.i18n._("Book All"),tooltip:_("The grant to add Timesheets for other users"),dataIndex:"bookAllGrant",width:55}),new Ext.ux.grid.CheckColumn({header:this.app.i18n._("Manage Clearing"),tooltip:_("The grant to manage clearing of Timesheets"),dataIndex:"manageBillableGrant",width:55}),new Ext.ux.grid.CheckColumn({header:this.app.i18n._("Export"),tooltip:_("The grant to export Timesheets of Timeaccount"),dataIndex:"exportGrant",width:55}),new Ext.ux.grid.CheckColumn({header:this.app.i18n._("Manage All"),tooltip:_("Includes all other grants"),dataIndex:"adminGrant",width:55})];this.grantsGrid=new Tine.widgets.account.PickerGridPanel({selectType:"both",title:this.app.i18n._("Permissions"),store:this.grantsStore,hasAccountPrefix:true,configColumns:a,selectAnyone:false,selectTypeDefault:"group",recordClass:Tine.Tinebase.Model.Grant})}return this.grantsGrid}});Tine.Timetracker.TimeaccountEditDialog.openWindow=function(a){var c=(a.record&&a.record.id)?a.record.id:0;var b=Tine.WindowFactory.getWindow({width:800,height:500,name:Tine.Timetracker.TimeaccountEditDialog.prototype.windowNamePrefix+c,contentPanelConstructor:"Tine.Timetracker.TimeaccountEditDialog",contentPanelConstructorConfig:a});return b};Ext.namespace("Tine.Timetracker");Tine.Timetracker.TimesheetGridPanel=Ext.extend(Tine.widgets.grid.GridPanel,{recordClass:Tine.Timetracker.Model.Timesheet,defaultSortInfo:{field:"start_date",direction:"DESC"},gridConfig:{autoExpandColumn:"description"},copyEditAction:true,multipleEdit:true,multipleEditRequiredRight:"manage_timeaccounts",initComponent:function(){this.recordProxy=Tine.Timetracker.timesheetBackend;this.gridConfig.cm=this.getColumnModel();this.initFilterToolbar();this.initDetailsPanel();this.plugins=this.plugins||[];this.plugins.push(this.filterToolbar);this.evalGrants=!Tine.Tinebase.common.hasRight("manage","Timetracker","timeaccounts");Tine.Timetracker.TimesheetGridPanel.superclass.initComponent.call(this)},initFilterToolbar:function(){this.filterToolbar=new Tine.widgets.grid.FilterPanel({app:this.app,recordClass:Tine.Timetracker.Model.Timesheet,allowSaving:true,filterModels:Tine.Timetracker.Model.Timesheet.getFilterModel().concat(this.getCustomfieldFilters()),defaultFilter:"start_date",filters:[{field:"start_date",operator:"within",value:"weekThis"},{field:"account_id",operator:"equals",value:Tine.Tinebase.registry.get("currentAccount")}]})},getColumnModel:function(){var a=[{id:"tags",header:this.app.i18n._("Tags"),width:50,dataIndex:"tags",sortable:false,renderer:Tine.Tinebase.common.tagsRenderer},{id:"start_date",header:this.app.i18n._("Date"),width:120,dataIndex:"start_date",renderer:Tine.Tinebase.common.dateRenderer},{id:"start_time",header:this.app.i18n._("Start time"),width:100,dataIndex:"start_time",hidden:true,renderer:Tine.Tinebase.common.timeRenderer},{id:"timeaccount_id",header:this.app.i18n._("Time Account (Number - Title)"),width:500,dataIndex:"timeaccount_id",renderer:this.rendererTimeaccountId},{id:"timeaccount_closed",header:this.app.i18n._("Time Account closed"),width:100,dataIndex:"timeaccount_closed",hidden:true,renderer:this.rendererTimeaccountClosed},{id:"description",header:this.app.i18n._("Description"),width:400,dataIndex:"description",hidden:true},{id:"is_billable",header:this.app.i18n._("Billable"),width:100,dataIndex:"is_billable_combined",renderer:Tine.Tinebase.common.booleanRenderer},{id:"is_cleared",header:this.app.i18n._("Cleared"),width:100,dataIndex:"is_cleared_combined",hidden:true,renderer:Tine.Tinebase.common.booleanRenderer},{id:"billed_in",header:this.app.i18n._("Cleared in"),width:150,dataIndex:"billed_in",hidden:true},{id:"account_id",header:this.app.i18n._("Account"),width:350,dataIndex:"account_id",renderer:Tine.Tinebase.common.usernameRenderer},{id:"duration",header:this.app.i18n._("Duration"),width:150,dataIndex:"duration",renderer:Tine.Tinebase.common.minutesRenderer}].concat(this.getModlogColumns());return new Ext.grid.ColumnModel({defaults:{sortable:true,resizable:true},columns:a.concat(this.getCustomfieldColumns())})},rendererTimeaccountId:function(a){return new Tine.Timetracker.Model.Timeaccount(a).getTitle()},rendererTimeaccountClosed:function(e,c,d){var f=(d.data.timeaccount_id.is_open=="1");return Tine.Tinebase.common.booleanRenderer(!f)},initDetailsPanel:function(){this.detailsPanel=new Tine.widgets.grid.DetailsPanel({gridpanel:this,defaultTpl:new Ext.XTemplate('<div class="preview-panel-timesheet-nobreak">',"<!-- Preview timeframe -->",'<div class="preview-panel preview-panel-timesheet-left">','<div class="bordercorner_1"></div>','<div class="bordercorner_2"></div>','<div class="bordercorner_3"></div>','<div class="bordercorner_4"></div>','<div class="preview-panel-declaration"></div>','<div class="preview-panel-timesheet-leftside preview-panel-left">','<span class="preview-panel-bold">',"<br/>","<br/>","<br/>","<br/>","</span>","</div>",'<div class="preview-panel-timesheet-rightside preview-panel-left">','<span class="preview-panel-nonbold">',"<br/>","<br/>","<br/>","<br/>","</span>","</div>","</div>","<!-- Preview summary -->",'<div class="preview-panel-timesheet-right">','<div class="bordercorner_gray_1"></div>','<div class="bordercorner_gray_2"></div>','<div class="bordercorner_gray_3"></div>','<div class="bordercorner_gray_4"></div>','<div class="preview-panel-declaration"></div>','<div class="preview-panel-timesheet-leftside preview-panel-left">','<span class="preview-panel-bold">',this.app.i18n._("Total Timesheets")+"<br/>",this.app.i18n._("Billable Timesheets")+"<br/>",this.app.i18n._("Total Time")+"<br/>",this.app.i18n._("Time of Billable Timesheets")+"<br/>","</span>","</div>",'<div class="preview-panel-timesheet-rightside preview-panel-left">','<span class="preview-panel-nonbold">',"{count}<br/>","{countbillable}<br/>","{sum}<br/>","{sumbillable}<br/>","</span>","</div>","</div>","</div>"),showDefault:function(a){var b={count:this.gridpanel.store.proxy.jsonReader.jsonData.totalcount,countbillable:(this.gridpanel.store.proxy.jsonReader.jsonData.totalcountbillable)?this.gridpanel.store.proxy.jsonReader.jsonData.totalcountbillable:0,sum:Tine.Tinebase.common.minutesRenderer(this.gridpanel.store.proxy.jsonReader.jsonData.totalsum),sumbillable:Tine.Tinebase.common.minutesRenderer(this.gridpanel.store.proxy.jsonReader.jsonData.totalsumbillable)};this.defaultTpl.overwrite(a,b)},showMulti:function(c,a){var b={count:c.getCount(),countbillable:0,sum:0,sumbillable:0};c.each(function(d){b.sum=b.sum+parseInt(d.data.duration);if(d.data.is_billable_combined=="1"){b.countbillable++;b.sumbillable=b.sumbillable+parseInt(d.data.duration)}});b.sum=Tine.Tinebase.common.minutesRenderer(b.sum);b.sumbillable=Tine.Tinebase.common.minutesRenderer(b.sumbillable);this.defaultTpl.overwrite(a,b)},tpl:new Ext.XTemplate('<div class="preview-panel-timesheet-nobreak">',"<!-- Preview beschreibung -->",'<div class="preview-panel preview-panel-timesheet-left">','<div class="bordercorner_1"></div>','<div class="bordercorner_2"></div>','<div class="bordercorner_3"></div>','<div class="bordercorner_4"></div>','<div class="preview-panel-declaration"></div>','<div class="preview-panel-timesheet-description preview-panel-left" ext:qtip="{[this.encode(values.description)]}">','<span class="preview-panel-nonbold">','{[this.encode(values.description, "longtext")]}',"<br/>","</span>","</div>","</div>","<!-- Preview detail-->",'<div class="preview-panel-timesheet-right">','<div class="bordercorner_gray_1"></div>','<div class="bordercorner_gray_2"></div>','<div class="bordercorner_gray_3"></div>','<div class="bordercorner_gray_4"></div>','<div class="preview-panel-declaration"></div>','<div class="preview-panel-timesheet-leftside preview-panel-left">',"</div>",'<div class="preview-panel-timesheet-rightside preview-panel-left">','<span class="preview-panel-nonbold">',"<br/>","<br/>","<br/>","<br/>","</span>","</div>","</div>","</div>",{encode:function(c,a,b){if(c){if(a){switch(a){case"longtext":c=Ext.util.Format.ellipsis(c,150);break;default:c+=a}}else{c=Ext.util.Format.htmlEncode(c)}var d=Ext.util.Format.htmlEncode(c);d=Ext.util.Format.nl2br(d);return d}else{return""}}})})},initActions:function(){this.actions_exportTimesheet=new Ext.Action({text:this.app.i18n._("Export Timesheets"),iconCls:"action_export",scope:this,requiredGrant:"exportGrant",disabled:true,allowMultiple:true,menu:{items:[new Tine.widgets.grid.ExportButton({text:this.app.i18n._("Export as ODS"),format:"ods",iconCls:"tinebase-action-export-ods",exportFunction:"Timetracker.exportTimesheets",gridPanel:this}),new Tine.widgets.grid.ExportButton({text:this.app.i18n._("Export as CSV"),format:"csv",iconCls:"tinebase-action-export-csv",exportFunction:"Timetracker.exportTimesheets",gridPanel:this}),new Tine.widgets.grid.ExportButton({text:this.app.i18n._("Export as ..."),iconCls:"tinebase-action-export-xls",exportFunction:"Timetracker.exportTimesheets",showExportDialog:true,gridPanel:this})]}});this.actionUpdater.addActions([this.actions_exportTimesheet]);Tine.Timetracker.TimesheetGridPanel.superclass.initActions.call(this)},getActionToolbarItems:function(){return[Ext.apply(new Ext.Button(this.actions_exportTimesheet),{scale:"medium",rowspan:2,iconAlign:"top"})]},getContextMenuItems:function(){var a=["-",this.actions_exportTimesheet];return a}});Ext.namespace("Tine.Timetracker");Tine.Timetracker.TimesheetEditDialog=Ext.extend(Tine.widgets.dialog.EditDialog,{windowNamePrefix:"TimesheetEditWindow_",appName:"Timetracker",recordClass:Tine.Timetracker.Model.Timesheet,recordProxy:Tine.Timetracker.timesheetBackend,loadRecord:false,tbarItems:null,evalGrants:false,updateToolbars:function(a){this.onTimeaccountUpdate();Tine.Timetracker.TimesheetEditDialog.superclass.updateToolbars.call(this,a,"timeaccount_id")},onTimeaccountUpdate:function(f,c){var d=Tine.Tinebase.common.hasRight("manage","Timetracker","timeaccounts");var e=false;var b=false;var a=c?c.get("account_grants"):(this.record.get("timeaccount_id")?this.record.get("timeaccount_id").account_grants:{});if(a){this.getForm().findField("account_id").setDisabled(!(a.bookAllGrant||a.adminGrant||d));e=!(a.manageBillableGrant||a.adminGrant||d);b=!(a.adminGrant||d);this.getForm().findField("billed_in").setDisabled(!(a.adminGrant||d))}if(c){e=e||c.data.is_billable=="0"||this.record.get("timeaccount_id").is_billable=="0";b=b||c.data.is_billable=="0"||this.record.get("timeaccount_id").is_billable=="0"}this.getForm().findField("is_billable").setDisabled(e);this.getForm().findField("is_cleared").setDisabled(b);if(this.record.id==0&&c){this.getForm().findField("is_billable").setValue(c.data.is_billable)}},onClearedUpdate:function(b,a){if(!this.useMultiple){this.getForm().findField("billed_in").setDisabled(!a)}},initComponent:function(){var a=new Tine.widgets.activities.ActivitiesAddButton({});this.tbarItems=[a];this.supr().initComponent.apply(this,arguments)},isMultipleValid:function(){var b=true;var a=["timeaccount_id","description","account_id"];Ext.each(a,function(c){var d=this.getForm().findField(c);if(d.edited&&!d.validate()){d.markInvalid();b=false}},this);return b},getFormItems:function(){return{xtype:"tabpanel",border:false,plain:true,activeTab:0,plugins:[{ptype:"ux.tabpanelkeyplugin"}],items:[{title:this.app.i18n.ngettext("Timesheet","Timesheets",1),autoScroll:true,border:false,frame:true,layout:"border",items:[{region:"center",xtype:"columnform",labelAlign:"top",formDefaults:{xtype:"textfield",anchor:"100%",labelSeparator:"",columnWidth:0.333},items:[[Tine.widgets.form.RecordPickerManager.get("Timetracker","Timeaccount",{columnWidth:1,fieldLabel:this.app.i18n.ngettext("Time Account","Time Accounts",1),emptyText:this.app.i18n._("Select Time Account..."),allowBlank:false,forceSelection:true,name:"timeaccount_id",listeners:{scope:this,render:function(a){if(!this.useMultiple){a.focus(false,250)}},select:this.onTimeaccountUpdate}})],[{fieldLabel:this.app.i18n._("Duration"),name:"duration",allowBlank:false,xtype:"tinedurationspinner"},{fieldLabel:this.app.i18n._("Date"),name:"start_date",allowBlank:false,xtype:"datefield"},{fieldLabel:this.app.i18n._("Start"),emptyText:this.app.i18n._("not set"),name:"start_time",xtype:"timefield"}],[{columnWidth:1,fieldLabel:this.app.i18n._("Description"),emptyText:this.app.i18n._("Enter description..."),name:"description",allowBlank:false,xtype:"textarea",height:150}],[new Tine.Addressbook.SearchCombo({allowBlank:false,forceSelection:true,columnWidth:1,disabled:true,useAccountRecord:true,userOnly:true,nameField:"n_fileas",fieldLabel:this.app.i18n._("Account"),name:"account_id"}),{columnWidth:0.25,disabled:(this.useMultiple)?false:true,boxLabel:this.app.i18n._("Billable"),name:"is_billable",xtype:"checkbox"},{columnWidth:0.25,disabled:(this.useMultiple)?false:true,boxLabel:this.app.i18n._("Cleared"),name:"is_cleared",xtype:"checkbox",listeners:{scope:this,check:this.onClearedUpdate}},{columnWidth:0.5,disabled:(this.useMultiple)?false:true,fieldLabel:this.app.i18n._("Cleared In"),name:"billed_in",xtype:"textfield"}]]},{layout:"accordion",animate:true,region:"east",width:210,split:true,collapsible:true,collapseMode:"mini",header:false,margins:"0 5 0 5",border:true,items:[new Tine.widgets.activities.ActivitiesPanel({showAddNoteForm:false,border:false,bodyStyle:"border:1px solid #B5B8C8;"}),new Tine.widgets.tags.TagPanel({app:"Timetracker",border:false,bodyStyle:"border:1px solid #B5B8C8;"})]}]},new Tine.widgets.activities.ActivitiesTabPanel({app:this.appName,record_id:(!this.copyRecord)?this.record.id:null,record_model:this.appName+"_Model_"+this.recordClass.getMeta("modelName")})]}},onRequestFailed:function(a,b){if(a.code&&a.code==902){Ext.MessageBox.alert(this.app.i18n._("Failed"),String.format(this.app.i18n._("Could not save {0}."),this.i18nRecordName)+" ( "+this.app.i18n._("Booking deadline for this Timeaccount has been exceeded.")+")")}else{Tine.Tinebase.ExceptionHandler.handleRequestException(a)}this.loadMask.hide()}});Tine.Timetracker.TimesheetEditDialog.openWindow=function(a){var c=(a.record&&a.record.id)?a.record.id:0;var b=Tine.WindowFactory.getWindow({width:800,height:500,name:Tine.Timetracker.TimesheetEditDialog.prototype.windowNamePrefix+c,contentPanelConstructor:"Tine.Timetracker.TimesheetEditDialog",contentPanelConstructorConfig:a});return b};