/*
 * Tine 2.0 - Calendar 
 * Copyright (c) 2007-2011 Metaways Infosystems GmbH (http://www.metaways.de)
 * http://www.gnu.org/licenses/agpl.html AGPL Version 3
 */
Ext.ns("Tine.Calendar");Tine.Calendar.AddressbookGridPanelHook=function(a){Tine.log.info("initialising calendar addressbook hooks");Ext.apply(this,a);var b=this.app.i18n.n_hidden(Tine.Calendar.Model.Event.prototype.recordName,Tine.Calendar.Model.Event.prototype.recordsName,1);this.addEventAction=new Ext.Action({actionType:"add",requiredGrant:"readGrant",text:b,iconCls:this.app.getIconCls(),scope:this,handler:this.onUpdateEvent,allowMultiple:true,listeners:{scope:this,render:this.onRender}});this.newEventAction=new Ext.Action({actionType:"new",requiredGrant:"readGrant",text:b,iconCls:this.app.getIconCls(),scope:this,handler:this.onAddEvent,allowMultiple:true,listeners:{scope:this,render:this.onRender}});Ext.ux.ItemRegistry.registerItem("Addressbook-GridPanel-ContextMenu-Add",this.addEventAction,100);Ext.ux.ItemRegistry.registerItem("Addressbook-GridPanel-ContextMenu-New",this.newEventAction,100)};Ext.apply(Tine.Calendar.AddressbookGridPanelHook.prototype,{app:null,ContactGridPanel:null,getContactGridPanel:function(){if(!this.ContactGridPanel){this.ContactGridPanel=Tine.Tinebase.appMgr.get("Addressbook").getMainScreen().getCenterPanel()}return this.ContactGridPanel},onAddEvent:function(c){var b=this.app.getMainScreen(),e=b.getCenterPanel(),d=this.getFilter(b);if(!d){var a=this.getSelectionsAsArray()}else{var a=true}e.onEditInNewWindow.call(e,"add",null,[{ptype:"addrelations_edit_dialog",selectionFilter:d,addRelations:a,callingApp:"Addressbook",callingModel:"Contact"}])},onUpdateEvent:function(){var b=this.app.getMainScreen(),e=b.getCenterPanel(),c=this.getFilter(b),f=this.getContactGridPanel().selectionModel;if(!c){var a=this.getSelectionsAsArray(),d=this.getSelectionsAsArray().length}else{var a=true,d=f.store.totalLength}Tine.Calendar.AddToEventPanel.openWindow({count:d,selectionFilter:c,addRelations:a})},getFilter:function(b){var d=this.getContactGridPanel().selectionModel,a=this.getSelectionsAsArray(),c=null;if(d.isFilterSelect){var c=d.getSelectionFilter()}return c},getSelectionsAsArray:function(){var b=this.getContactGridPanel().grid.getSelectionModel().getSelections(),a=[];Ext.each(b,function(c){if(c.data){a.push(c.data)}});return a},onRender:function(){var b=this.getContactGridPanel().actionUpdater,a=b.actions;if(a.indexOf(this.addEventAction)<0){b.addActions([this.addEventAction])}if(a.indexOf(this.newEventAction)<0){b.addActions([this.newEventAction])}}});Ext.ns("Tine.Calendar");Tine.Calendar.ParallelEventsRegistry=function(a){Ext.apply(this,a);this.dtStartTs=this.dtStart.getTime();this.dtEndTs=this.dtEnd.getTime();this.dt=this.granularity*Date.msMINUTE;this.frameLength=Math.ceil((this.dtEndTs-this.dtStartTs)/this.dt);this.map=[]};Tine.Calendar.ParallelEventsRegistry.prototype={dtStart:null,dtEnd:null,granularity:5,dtStartProperty:"dtstart",dtEndProperty:"dtend",map:null,dtStartTs:null,dtEndTs:null,dt:null,register:function(a,e){var h=a.get(this.dtStartProperty);var j=h.getTime();var d=a.get(this.dtEndProperty);var g=d.getTime()-1000;a.duration=g-j;var i=this.tsToIdx(h);var c=this.tsToIdx(g);var f=0;var b=this.getFrame(f);while(!this.isEmptySlice(b,i,c)){b=this.getFrame(++f)}this.registerSlice(b,i,c,a);a.parallelEventRegistry={registry:this,position:f,startIdx:i,endIdx:c};if(e){return this.getEvents(h,d)}},unregister:function(c){var b=c.parallelEventRegistry;var d=this.getFrame(b.position);if(!this.skipIntegrityChecks){for(var a=b.startIdx;a<=b.endIdx;a++){if(d[a]!==c){throw new Ext.Error("event is not registered at expected position")}}}this.unregisterSlice(d,b.startIdx,b.endIdx);c.parallelEventRegistry=null},getEvents:function(e,c,b){var g=e.getTime();var d=c.getTime()-1000;var f=this.tsToIdx(e);var a=this.tsToIdx(d);var i=this.getSliceInfo(f,a).events;var h=this;i.sort(function(k,j){var m=j.duration-k.duration;var l=k.get(h.dtStartProperty).getTime()-j.get(h.dtStartProperty).getTime();return b?l?l:m:m?m:l});return i},getMaxParalles:function(f,e){var a=f.getTime();var b=e.getTime()-1000;var d=this.tsToIdx(f);var c=this.tsToIdx(b);return this.getSliceInfo(d,c).maxParallels},getPosition:function(a){if(!a.parallelEventRegistry){throw new Ext.Error("can't compute position of a non registered event")}return a.parallelEventRegistry.position},getSliceInfo:function(f,e){var d=[];var c=1;for(var b,g,a=0;a<this.map.length;a++){g=this.map[a];for(b=f;b<=e;b++){if(g[b]&&d.indexOf(g[b])===-1){c=Math.max(c,a+1);d.push(g[b])}}}return{events:d,maxParallels:c}},getFrame:function(a){if(a>this.map.length+1){throw new Ext.Error("skipping frames is not allowed")}if(!Ext.isArray(this.map[a])){this.map[a]=new Array(this.frameLength)}return this.map[a]},isEmptySlice:function(d,c,b){for(var a=c;a<=b;a++){if(d[a]){return false}}return true},registerSlice:function(e,c,b,d){for(var a=c;a<=b;a++){e[a]=d}},tsToIdx:function(a){return Math.floor((a-this.dtStartTs)/this.dt)},unregisterSlice:function(d,c,b){for(var a=c;a<=b;a++){d[a]=null}return this}};Ext.ns("Tine.Calendar");Tine.Calendar.SearchCombo=Ext.extend(Ext.ux.form.ClearableComboBox,{anchor:"100% 100%",margins:"10px 10px",app:null,appName:"Calendar",store:null,allowBlank:false,triggerAction:"all",itemSelector:"div.search-item",minChars:3,forceSelection:true,showDatePager:true,showReloadBtn:null,showTodayBtn:null,initComponent:function(){if(!this.app){this.app=Tine.Tinebase.appMgr.get(this.appName)}this.listEmptyText=this.app.i18n._("no events found");this.loadingText=_("Searching...");this.recordClass=Tine.Calendar.Model.Event;this.recordProxy=Tine.Calendar.backend;this.displayField=this.recordClass.getMeta("titleProperty");this.valueField=this.recordClass.getMeta("idProperty");this.fieldLabel=this.app.i18n._("Event"),this.emptyText=this.app.i18n._("Search Event"),this.disableClearer=!this.allowBlank;this.store=new Tine.Tinebase.data.RecordStore(Ext.copyTo({readOnly:true,sortInfo:{field:"dtstart",direction:"ASC"},proxy:this.recordProxy||undefined},this,"totalProperty,root,recordClass"));this.store.on("beforeload",this.onBeforeStoreLoad,this);this.store.on("load",this.onStoreLoad,this);this.initTemplate();Tine.Calendar.SearchCombo.superclass.initComponent.call(this)},setValue:Tine.Tinebase.widgets.form.RecordPickerComboBox.prototype.setValue,onStoreLoad:function(b,a){b.each(function(c){if(!c.data.editGrant){b.remove(c)}})},onBeforeStoreLoad:function(a){a.baseParams.filter=[{field:"period",operator:"within",value:this.pageTb.getPeriod()},{field:"query",operator:"contains",value:this.getRawValue()}]},collapse:function(){if(this.pageTb.periodPickerActive==true){return false}else{Tine.Calendar.SearchCombo.superclass.collapse.call(this)}},initList:function(){Tine.Calendar.SearchCombo.superclass.initList.call(this);var a=new Date().clearTime();this.footer=this.list.createChild({cls:"list-ft"});this.pageTb=new Tine.Calendar.PagingToolbar({view:"month",anchor:"100% 100%",store:this.store,dtStart:a,showReloadBtn:this.showReloadBtn,showTodayBtn:this.showTodayBtn,renderTo:this.footer,listeners:{scope:this,change:function(){this.store.removeAll();this.store.load()}}});this.assetHeight+=this.footer.getHeight()},onBlur:Ext.emptyFn,assertValue:Ext.emptyFn,initTemplate:function(){if(!this.tpl){this.tpl=new Ext.XTemplate('<tpl for="."><div class="search-item">','<table cellspacing="0" cellpadding="2" border="0" style="font-size: 11px;" width="100%">',"<tr>",'<td width="40%"><b>{[this.encode(values.summary)]}</b></td>','<td width="60%">',"{[this.encodeDate(values)]}","</td>","</tr>","</table>","</div></tpl>",{encode:function(a){if(a){return Ext.util.Format.htmlEncode(a)}else{return""}},encodeDate:function(c){var e=c.dtstart,a=c.dtend;var d=c.is_all_day_event?Tine.Tinebase.appMgr.get("Calendar").i18n._("whole day"):Tine.Tinebase.common.minutesRenderer(Math.round((a.getTime()-e.getTime())/(1000*60)),"{0}:{1}","i");var b=e.getYear()+1900;return e.getDate()+"."+(e.getMonth()+1)+"."+b+" "+d}})}}});Tine.widgets.form.RecordPickerManager.register("Calendar","Event",Tine.Calendar.SearchCombo);Ext.ns("Tine.Calendar","Tine.Calendar.Model");Tine.Calendar.Model.Event=Tine.Tinebase.data.Record.create(Tine.Tinebase.Model.genericFields.concat([{name:"id"},{name:"dtend",type:"date",dateFormat:Date.patterns.ISO8601Long},{name:"transp"},{name:"class"},{name:"description"},{name:"geo"},{name:"location"},{name:"organizer"},{name:"priority"},{name:"status"},{name:"summary"},{name:"url"},{name:"uid"},{name:"attendee"},{name:"alarms"},{name:"tags"},{name:"notes"},{name:"dtstart",type:"date",dateFormat:Date.patterns.ISO8601Long},{name:"recurid"},{name:"exdate"},{name:"rrule"},{name:"is_all_day_event",type:"bool"},{name:"rrule_until",type:"date",dateFormat:Date.patterns.ISO8601Long},{name:"originator_tz"},{name:"readGrant",type:"bool"},{name:"editGrant",type:"bool"},{name:"deleteGrant",type:"bool"},{name:"editGrant",type:"bool"}]),{appName:"Calendar",modelName:"Event",idProperty:"id",titleProperty:"summary",recordName:"Event",recordsName:"Events",containerProperty:"container_id",containerName:"Calendar",containersName:"Calendars",copyOmitFields:["uid","recurid"],getDisplayContainer:function(){var a=this.get("container_id");var c=Tine.Tinebase.registry.get("currentAccount").accountId;var b=this.getAttendeeStore();b.each(function(f){var e=f.getUserAccountId();if(e==c){var d=f.get("displaycontainer_id");if(d){a=d}return false}},this);return a},isRecurBase:function(){return !!this.get("rrule")&&!this.get("recurid")},isRecurException:function(){return !!this.get("recurid")&&!this.isRecurInstance()},isRecurInstance:function(){return this.id&&this.id.match(/^fakeid/)},getAttendeeStore:function(){return Tine.Calendar.Model.Attender.getAttendeeStore(this.get("attendee"))},getMyAttenderRecord:function(){var a=this.getAttendeeStore();return Tine.Calendar.Model.Attender.getAttendeeStore.getMyAttenderRecord(a)}});Tine.Calendar.Model.Event.getDefaultData=function(){var h=Tine.Tinebase.appMgr.get("Calendar"),b=new Date().clearTime().add(Date.HOUR,(new Date().getHours()+1)),e=h.getMainScreen().getCenterPanel(),g=e.getCalendarPanel(e.activeView).getView().getPeriod(),a=h.getMainScreen().getWestPanel().getContainerTreePanel().getDefaultContainer(),f=Tine.Tinebase.registry.get("currentAccount"),c=h.getRegistry().get("preferences");if(g.from.getTime()>b.getTime()||g.until.getTime()<b.getTime()){b=g.from.clearTime(true).add(Date.HOUR,9)}var d={summary:"",dtstart:b,dtend:b.add(Date.HOUR,1),container_id:a,transp:"OPAQUE",editGrant:true,organizer:Tine.Tinebase.registry.get("userContact"),attendee:[Ext.apply(Tine.Calendar.Model.Attender.getDefaultData(),{user_type:"user",user_id:f,status:"ACCEPTED"})]};if(c.get("defaultalarmenabled")){d.alarms=[{minutes_before:parseInt(c.get("defaultalarmminutesbefore"),10)}]}return d};Tine.Calendar.Model.Event.getFilterModel=function(){var a=Tine.Tinebase.appMgr.get("Calendar");return[{label:_("Quick search"),field:"query",operators:["contains"]},{label:a.i18n._("Summary"),field:"summary"},{label:a.i18n._("Location"),field:"location"},{label:a.i18n._("Description"),field:"description"},{filtertype:"tine.widget.container.filtermodel",app:a,recordClass:Tine.Calendar.Model.Event,defaultValue:{path:Tine.Tinebase.container.getMyNodePath()}},{filtertype:"calendar.attendee"},{label:a.i18n._("Attendee Status"),field:"attender_status",filtertype:"tine.widget.keyfield.filter",app:a,keyfieldName:"attendeeStatus",defaultOperator:"notin",defaultValue:["DECLINED"]},{label:a.i18n._("Attendee Role"),field:"attender_role",filtertype:"tine.widget.keyfield.filter",app:a,keyfieldName:"attendeeRoles"},{filtertype:"addressbook.contact",field:"organizer",label:a.i18n._("Organizer")},{filtertype:"tinebase.tag",app:a}]};Tine.widgets.grid.ForeignRecordFilter.OperatorRegistry.register("Addressbook","Contact",{foreignRecordClass:"Calendar.Event",linkType:"foreignId",filterName:"ContactAttendeeFilter",label:"Event (as attendee)"});Tine.widgets.grid.ForeignRecordFilter.OperatorRegistry.register("Addressbook","Contact",{foreignRecordClass:"Calendar.Event",linkType:"foreignId",filterName:"ContactOrganizerFilter",label:"Event (as organizer)"});Tine.Calendar.Model.EventJsonBackend=Ext.extend(Tine.Tinebase.data.RecordProxy,{createRecurException:function(c,e,b,a){a=a||{};a.params=a.params||{};a.beforeSuccess=function(f){return[this.recordReader(f)]};var d=a.params;d.method=this.appName+".createRecurException";d.recordData=c.data;d.deleteInstance=e?1:0;d.deleteAllFollowing=b?1:0;return this.doXHTTPRequest(a)},deleteRecurSeries:function(b,a){a=a||{};a.params=a.params||{};var c=a.params;c.method=this.appName+".deleteRecurSeries";c.recordData=b.data;return this.doXHTTPRequest(a)},updateRecurSeries:function(b,a){a=a||{};a.params=a.params||{};a.beforeSuccess=function(d){return[this.recordReader(d)]};var c=a.params;c.method=this.appName+".updateRecurSeries";c.recordData=b.data;return this.doXHTTPRequest(a)}});if(Tine.Tinebase.widgets){Tine.Calendar.backend=new Tine.Calendar.Model.EventJsonBackend({appName:"Calendar",modelName:"Event",recordClass:Tine.Calendar.Model.Event})}else{Tine.Calendar.backend=new Tine.Tinebase.data.MemoryBackend({appName:"Calendar",modelName:"Event",recordClass:Tine.Calendar.Model.Event})}Tine.Calendar.Model.Attender=Tine.Tinebase.data.Record.create([{name:"id"},{name:"cal_event_id"},{name:"user_id",sortType:Tine.Tinebase.common.accountSortType},{name:"user_type"},{name:"role",type:"keyField",keyFieldConfigName:"attendeeRoles"},{name:"quantity"},{name:"status",type:"keyField",keyFieldConfigName:"attendeeStatus"},{name:"status_authkey"},{name:"displaycontainer_id"},{name:"alarm_ack_time",type:"date",dateFormat:Date.patterns.ISO8601Long},{name:"alarm_snooze_time",type:"date",dateFormat:Date.patterns.ISO8601Long},{name:"transp"}],{appName:"Calendar",modelName:"Attender",idProperty:"id",titleProperty:"name",recordName:"Attender",recordsName:"Attendee",containerProperty:"cal_event_id",containerName:"Event",containersName:"Events",getUserAccountId:function(){var b=this.get("user_type");if(b=="user"||b=="groupmember"){var a=this.get("user_id");if(!a){return null}if(typeof a.get=="function"){if(a.get("contact_id")){return a.get("accountId")}else{return a.get("account_id")}}else{if(a.hasOwnProperty("contact_id")){return a.accountId}else{if(a.hasOwnProperty("account_id")){return a.account_id}}}return a}return null},getUserId:function(){var b=this.get("user_id");if(!b){return null}var a=(typeof b.get=="function")?b.data:b;if(!a){return null}if(typeof a!="object"){return a}switch(this.get("user_type")){case"user":if(a.hasOwnProperty("contact_id")){return a.contact_id}else{if(a.hasOwnProperty("account_id")){return a.id}}break;default:return a.id;break}}});Tine.Calendar.Model.Attender.getDefaultData=function(){return{user_type:"user",role:"REQ",quantity:1,status:"NEEDS-ACTION"}};Tine.Calendar.Model.Attender.getAttendeeStore=function(a){var b=new Ext.data.SimpleStore({fields:Tine.Calendar.Model.Attender.getFieldDefinitions(),sortInfo:{field:"user_id",direction:"ASC"}});Ext.each(a,function(d){if(d){var c=new Tine.Calendar.Model.Attender(d,d.id);b.addSorted(c)}});return b};Tine.Calendar.Model.Attender.getAttendeeStore.getMyAttenderRecord=function(c){var b=Tine.Tinebase.registry.get("currentAccount").accountId;var a=false;c.each(function(e){var d=e.getUserAccountId();if(d==b){a=e;return false}},this);return a};Tine.Calendar.Model.Attender.getAttendeeStore.getAttenderRecord=function(c,a){var b=false;c.each(function(d){if(d.get("user_type")==a.get("user_type")&&d.getUserId()==a.getUserId()){b=d;return false}},this);return b};Tine.Calendar.Model.Resource=Tine.Tinebase.data.Record.create(Tine.Tinebase.Model.genericFields.concat([{name:"id"},{name:"name"},{name:"description"},{name:"email"},{name:"is_location",type:"bool"},{name:"tags"},{name:"notes"}]),{appName:"Calendar",modelName:"Resource",idProperty:"id",titleProperty:"name",recordName:"Resource",recordsName:"Resources",containerProperty:null});Tine.Calendar.Model.iMIP=Tine.Tinebase.data.Record.create([{name:"id"},{name:"ics"},{name:"method"},{name:"originator"},{name:"userAgent"},{name:"event"},{name:"existing_event"},{name:"preconditions"}],{appName:"Calendar",modelName:"iMIP",idProperty:"id"});Ext.namespace("Tine.Calendar");Tine.Calendar.AdminPanel=Ext.extend(Ext.TabPanel,{border:false,activeTab:0,initComponent:function(){this.app=Tine.Tinebase.appMgr.get("Calendar");this.items=[new Tine.Calendar.ResourcesGridPanel({title:this.app.i18n._("Manage Resources"),disabled:!Tine.Tinebase.common.hasRight("manage_resources","Calendar")})];Tine.Calendar.AdminPanel.superclass.initComponent.call(this)}});Tine.Calendar.AdminPanel.openWindow=function(a){var b=Tine.WindowFactory.getWindow({width:500,height:470,name:"cal-mange-resources",contentPanelConstructor:"Tine.Calendar.AdminPanel",contentPanelConstructorConfig:a})};Date.msSECOND=1000;Date.msMINUTE=60*Date.msSECOND;Date.msHOUR=60*Date.msMINUTE;Date.msDAY=24*Date.msHOUR;Date.msWEEK=7*Date.msDAY;Ext.ns("Tine.Calendar");Tine.Calendar.CalendarPanel=Ext.extend(Ext.Panel,{view:null,store:null,border:false,initComponent:function(){Tine.Calendar.CalendarPanel.superclass.initComponent.call(this);this.app=Tine.Tinebase.appMgr.get("Calendar");this.selModel=this.selModel||new Tine.Calendar.EventSelectionModel();this.autoScroll=false;this.autoWidth=false;this.relayEvents(this.view,["changeView","changePeriod","click","dblclick","contextmenu"]);this.store.on("beforeload",this.onBeforeLoad,this)},getSelectionModel:function(){return this.selModel},getStore:function(){return this.store},getView:function(){return this.view},onBeforeLoad:function(a,b){if(!b.refresh){this.store.each(this.view.removeEvent,this.view)}},onRender:function(b,a){Tine.Calendar.CalendarPanel.superclass.onRender.apply(this,arguments);var d=this.body;this.el.addClass("cal-panel");this.view.init(this);d.on("keydown",this.onKeyDown,this);this.view.render()},afterRender:function(){Tine.Calendar.CalendarPanel.superclass.afterRender.call(this);this.view.layout();this.view.afterRender();this.viewReady=true},onResize:function(b,a){Tine.Calendar.CalendarPanel.superclass.onResize.apply(this,arguments);if(this.viewReady){this.view.layout()}},onKeyDown:function(a){this.fireEvent("keydown",a)}});Ext.ns("Tine.Calendar");Tine.Calendar.EventUI=function(a){this.event=a;this.domIds=[];this.app=Tine.Tinebase.appMgr.get("Calendar");this.init()};Tine.Calendar.EventUI.prototype={addClass:function(a){Ext.each(this.getEls(),function(b){b.addClass(a)})},blur:function(){Ext.each(this.getEls(),function(a){a.blur()})},clearDirty:function(){Ext.each(this.getEls(),function(a){a.setOpacity(1,1)})},focus:function(){Ext.each(this.getEls(),function(a){a.focus()})},getEls:function(){var c=[];for(var a=0;a<this.domIds.length;a++){var b=Ext.get(this.domIds[a]);if(b){c.push(b)}}return c},init:function(){},markDirty:function(){Ext.each(this.getEls(),function(a){a.setOpacity(0.5,1)})},markOutOfFilter:function(){Ext.each(this.getEls(),function(a){a.setOpacity(0.5,0);a.setStyle({"background-color":"#aaa","border-color":"#888"});Ext.DomHelper.applyStyles(a.dom.firstChild,{"background-color":"#888"});Ext.DomHelper.applyStyles(a.dom.firstChild.firstChild,{"background-color":"#888"})})},onSelectedChange:function(a){if(a){this.addClass("cal-event-active");this.setStyle({"z-index":1000})}else{this.removeClass("cal-event-active");this.setStyle({"z-index":100})}},remove:function(){var a=this.getEls();for(var b=0;b<a.length;b++){if(a[b]&&typeof a[b].remove=="function"){a[b].remove()}}this.domIds=[]},removeClass:function(a){Ext.each(this.getEls(),function(b){b.removeClass(a)})},render:function(){},setOpacity:function(a){Ext.each(this.getEls(),function(b){b.setStyle(a)})},setStyle:function(a){Ext.each(this.getEls(),function(b){b.setStyle(a)})}};Tine.Calendar.DaysViewEventUI=Ext.extend(Tine.Calendar.EventUI,{clearDirty:function(){Tine.Calendar.DaysViewEventUI.superclass.clearDirty.call(this);Ext.each(this.getEls(),function(a){a.setStyle({"border-style":"solid"})})},getRzInfo:function(a,c,i){var h={};var b=a.event;var g=b.view;var e=a.proxy.getBox();var c=c?c:e.width;var i=i?i:e.height;var d=(b.get("dtend").getTime()-b.get("dtstart").getTime())/Date.msMINUTE;if(b.get("is_all_day_event")){var f=Ext.fly(g.wholeDayArea).getWidth()/g.numOfDays;h.diff=Math.round((c-a.originalWidth)/f)}else{h.diff=Math.round((i-a.originalHeight)*(g.timeGranularity/g.granularityUnitHeights));h.diff=Math.round(h.diff/15)*15}h.duration=d+h.diff;if(b.get("is_all_day_event")){h.dtend=b.get("dtend").add(Date.DAY,h.diff)}else{h.dtend=b.get("dtstart").add(Date.MINUTE,h.duration)}return h},markDirty:function(){Tine.Calendar.DaysViewEventUI.superclass.markDirty.call(this);Ext.each(this.getEls(),function(a){a.setStyle({"border-style":"dashed"})})},onSelectedChange:function(a){Tine.Calendar.DaysViewEventUI.superclass.onSelectedChange.call(this,a);if(a){this.addClass("cal-daysviewpanel-event-active")}else{this.removeClass("cal-daysviewpanel-event-active")}},render:function(c){this.event.view=c;this.colorSet=Tine.Calendar.colorMgr.getColor(this.event);this.event.colorSet=this.colorSet;this.dtStart=this.event.get("dtstart");this.startColNum=c.getColumnNumber(this.dtStart);this.dtEnd=this.event.get("dtend");if(this.event.get("editGrant")){this.extraCls="cal-daysviewpanel-event-editgrant"}this.extraCls+=" cal-status-"+this.event.get("status");if(this.dtEnd.format("H:i")=="00:00"){this.dtEnd=this.dtEnd.add(Date.MINUTE,-1)}this.endColNum=c.getColumnNumber(this.dtEnd);if(this.endColNum<0||this.startColNum>c.numOfDays-1){return}this.statusIcons=[];if(this.event.get("class")==="PRIVATE"){this.statusIcons.push({status:"private",text:this.app.i18n._("private classification")})}if(this.event.get("rrule")){this.statusIcons.push({status:"recur",text:this.app.i18n._("recurring event")})}else{if(this.event.isRecurException()){this.statusIcons.push({status:"recurex",text:this.app.i18n._("recurring event exception")})}}if(!Ext.isEmpty(this.event.get("alarms"))){this.statusIcons.push({status:"alarm",text:this.app.i18n._("has alarm")})}var f=this.event.getMyAttenderRecord(),b=f?Tine.Tinebase.widgets.keyfield.StoreMgr.get("Calendar","attendeeStatus").getById(f.get("status")):null;if(b&&b.get("system")){this.statusIcons.push({status:f.get("status"),text:b.get("i18nValue")})}var d=this.event.get("is_all_day_event")?c.parallelWholeDayEventsRegistry:c.parallelScrollerEventsRegistry;var a=d.getPosition(this.event);var e=d.getMaxParalles(this.dtStart,this.dtEnd);if(this.event.get("is_all_day_event")){this.renderAllDayEvent(c,e,a)}else{this.renderScrollerEvent(c,e,a)}if(this.event.dirty){this.onSelectedChange(true)}},renderAllDayEvent:function(i,e,h){var f=this.extraCls;var g=Ext.fly(i.wholeDayArea).getWidth();var b=Math.round(g*(this.dtEnd.getTime()-this.dtStart.getTime())/(i.numOfDays*Date.msDAY))-5;var c=Math.round(g*(this.dtStart.getTime()-i.startDate.getTime())/(i.numOfDays*Date.msDAY));if(c<0){b=b+c;c=0;f=f+" cal-daysviewpanel-event-cropleft"}if(c+b>g){b=g-c;f=f+" cal-daysviewpanel-event-cropright"}var d=Ext.id()+"-event:"+this.event.get("id");this.domIds.push(d);var a=i.templates.wholeDayEvent.insertFirst(i.wholeDayArea,{id:d,tagsHtml:Tine.Tinebase.common.tagsRenderer(this.event.get("tags")),summary:this.event.get("summary"),startTime:this.dtStart.format("H:i"),extraCls:f,color:this.colorSet.color,bgColor:this.colorSet.light,textColor:this.colorSet.text,zIndex:100,width:b+"px",height:"15px",left:c+"px",top:h*18+"px",statusIcons:this.statusIcons},true);if(this.event.dirty){a.setStyle({"border-style":"dashed"});a.setOpacity(0.5)}if(!(this.endColNum>i.numOfDays)&&this.event.get("editGrant")){this.resizeable=new Ext.Resizable(a,{handles:"e",disableTrackOver:true,dynamic:true,widthIncrement:Math.round(g/i.numOfDays),minWidth:Math.round(g/i.numOfDays),listeners:{scope:i,resize:i.onEventResize,beforeresize:i.onBeforeEventResize}})}},renderScrollerEvent:function(h,c,f){var d=h.granularityUnitHeights*((24*60)/h.timeGranularity);for(var j=this.startColNum;j<=this.endColNum;j++){var e=this.extraCls;if(j<0||j>=h.numOfDays){continue}var g=h.getTimeOffset(this.dtStart);var i=this.startColNum==this.endColNum?h.getTimeHeight(this.dtStart,this.dtEnd):h.getTimeOffset(this.dtEnd);if(j!=this.startColNum){g=0;e=e+" cal-daysviewpanel-event-croptop"}if(this.endColNum!=j){i=h.getTimeHeight(this.dtStart,this.dtStart.add(Date.DAY,1));e=e+" cal-daysviewpanel-event-cropbottom"}var b=Ext.id()+"-event:"+this.event.get("id");this.domIds.push(b);if(i<=12){i=12}if(g>d-12){g=d-12}var a=h.templates.event.append(h.getDateColumnEl(j),{id:b,summary:i>=24?this.event.get("summary"):"",tagsHtml:i>=24?Tine.Tinebase.common.tagsRenderer(this.event.get("tags")):"",startTime:(i>=24&&g<=d-24)?this.dtStart.format("H:i"):this.dtStart.format("H:i")+" "+this.event.get("summary"),extraCls:e,color:this.colorSet.color,bgColor:this.colorSet.light,textColor:this.colorSet.text,zIndex:100,height:i+"px",left:Math.round(f*90*1/c)+"%",width:Math.round(90*1/c)+"%",top:g+"px",statusIcons:this.statusIcons},true);if(this.event.dirty){a.setStyle({"border-style":"dashed"});a.setOpacity(0.5)}if(j==this.endColNum&&this.event.get("editGrant")){this.resizeable=new Ext.Resizable(a,{handles:"s",disableTrackOver:true,dynamic:true,heightIncrement:h.granularityUnitHeights/2,listeners:{scope:h,resize:h.onEventResize,beforeresize:h.onBeforeEventResize}})}}}});Tine.Calendar.MonthViewEventUI=Ext.extend(Tine.Calendar.EventUI,{onSelectedChange:function(a){Tine.Calendar.MonthViewEventUI.superclass.onSelectedChange.call(this,a);if(a){this.addClass("cal-monthview-active");this.setStyle({"background-color":this.color,color:(this.colorSet)?this.colorSet.text:"#000000"})}else{this.removeClass("cal-monthview-active");this.setStyle({"background-color":this.is_all_day_event?this.bgColor:"",color:this.is_all_day_event?"#000000":this.color})}}});Ext.ns("Tine.Calendar");Tine.Calendar.EventSelectionModel=Ext.extend(Ext.tree.MultiSelectionModel,{init:function(a){a.getTreeEl=function(){return a.el};a.el.on("keydown",this.onKeyDown,this);a.on("click",this.onNodeClick,this)},getCount:function(){return this.getSelectedNodes().length},getSelected:function(){var a=this.getSelectedEvents();return a.length>0?a[0]:null},getSelectedEvents:function(){return this.getSelectedNodes()},select:function(a,c,b){if(!a||!a.ui){return a}Tine.Calendar.EventSelectionModel.superclass.select.apply(this,arguments)},onKeyDown:Ext.emptyFn});Ext.ns("Tine.Calendar");Tine.Calendar.DaysView=function(a){Ext.apply(this,a);Tine.Calendar.DaysView.superclass.constructor.call(this);this.addEvents("click","contextmenu","dblclick","changeView","changePeriod","addEvent","updateEvent")};Ext.extend(Tine.Calendar.DaysView,Ext.util.Observable,{startDate:new Date(),numOfDays:4,newEventSummary:"New Event",dayFormatString:"{0}, the {1}. of {2}",timeGranularity:30,granularityUnitHeights:18,denyDragOnMissingEditGrant:true,timeScale:null,scrollOffset:19,editing:false,activeEvent:null,ds:null,updatePeriod:function(a){this.toDay=new Date().clearTime();this.startDate=a.from;var b=this.calPanel.getTopToolbar();if(b){b.periodPicker.update(this.startDate);this.startDate=b.periodPicker.getPeriod().from}this.endDate=this.startDate.add(Date.DAY,this.numOfDays+1);this.updateDayHeaders();this.onBeforeScroll();this.fireEvent("changePeriod",a)},init:function(a){this.calPanel=a;this.app=Tine.Tinebase.appMgr.get("Calendar");this.newEventSummary=this.app.i18n._hidden(this.newEventSummary);this.dayFormatString=this.app.i18n._hidden(this.dayFormatString);this.startDate.setHours(0);this.startDate.setMinutes(0);this.startDate.setSeconds(0);this.endDate=this.startDate.add(Date.DAY,this.numOfDays+1);this.parallelScrollerEventsRegistry=new Tine.Calendar.ParallelEventsRegistry({dtStart:this.startDate,dtEnd:this.endDate});this.parallelWholeDayEventsRegistry=new Tine.Calendar.ParallelEventsRegistry({dtStart:this.startDate,dtEnd:this.endDate});this.initData(a.store);this.initTimeScale();this.initTemplates();this.calPanel.on("beforehide",this.onBeforeHide,this);this.calPanel.on("show",this.onShow,this);Tine.Tinebase.appMgr.on("activate",this.onAppActivate,this)},initData:function(a){if(this.ds){this.ds.un("load",this.onLoad,this);this.ds.un("datachanged",this.onDataChange,this);this.ds.un("add",this.onAdd,this);this.ds.un("remove",this.onRemove,this);this.ds.un("update",this.onUpdate,this);this.ds.un("clear",this.onClear,this)}if(a){a.on("load",this.onLoad,this);a.on("datachanged",this.onDataChange,this);a.on("add",this.onAdd,this);a.on("remove",this.onRemove,this);a.on("update",this.onUpdate,this);a.on("clear",this.onClear,this)}this.ds=a},initTimeScale:function(){var e=[];var a=Date.msDAY/(this.timeGranularity*Date.msMINUTE);var d=this.startDate.clone();var c;for(var b=0;b<a;b++){c=b*this.timeGranularity;e.push([b,c,c*Date.msMINUTE,d.add(Date.MINUTE,c).format("H:i")])}this.timeScale=new Ext.data.SimpleStore({fields:["index","minutes","milliseconds","time"],data:e,id:"index"})},initDropZone:function(){this.dd=new Ext.dd.DropZone(this.mainWrap.dom,{ddGroup:"cal-event",notifyOver:function(a,h,g){var b=Ext.fly(g.sourceEl);b.setStyle({"border-style":"dashed"});b.setOpacity(0.5);if(g.event){var f=g.event;g.scope.getSelectionModel().select(f);var c=Tine.Calendar.DaysView.prototype.getTargetDateTime.call(g.scope,h);if(c){var d=c.format(c.is_all_day_event?Ext.form.DateField.prototype.format:"H:i");if(!f.data.is_all_day_event){Ext.fly(a.proxy.el.query("div[class=cal-daysviewpanel-event-header-inner]")[0]).update(d)}if(f.get("editGrant")){return Math.abs(c.getTime()-f.get("dtstart").getTime())<Date.msMINUTE?"cal-daysviewpanel-event-drop-nodrop":"cal-daysviewpanel-event-drop-ok"}}}return"cal-daysviewpanel-event-drop-nodrop"},notifyOut:function(){},notifyDrop:function(a,h,g){var c=g.scope;var d=c.getTargetDateTime(h);if(d){var f=g.event;if(!f.get("editGrant")||Math.abs(d.getTime()-f.get("dtstart").getTime())<Date.msMINUTE){return false}f.beginEdit();var b=(f.get("dtend").getTime()-f.get("dtstart").getTime())/Date.msMINUTE;f.set("dtstart",d);if(!f.get("is_all_day_event")&&d.is_all_day_event&&f.duration<Date.msDAY){f.set("dtend",d.add(Date.DAY,1))}else{if(f.get("is_all_day_event")&&!d.is_all_day_event){f.set("dtend",d.add(Date.HOUR,1))}else{f.set("dtend",d.add(Date.MINUTE,b))}}f.set("is_all_day_event",d.is_all_day_event);f.endEdit();c.fireEvent("updateEvent",f)}return !!d}})},initDragZone:function(){this.scroller.ddScrollConfig={vthresh:this.granularityUnitHeights*2,increment:this.granularityUnitHeights*4,hthresh:-1,frequency:500};Ext.dd.ScrollManager.register(this.scroller);this.dragZone=new Ext.dd.DragZone(this.el,{ddGroup:"cal-event",view:this,scroll:false,containerScroll:true,getDragData:function(h){var c=this.view.getSelectionModel().getSelectedEvents();var a=h.getTarget("div.cal-daysviewpanel-event",10);if(a){var g=a.id.split(":");var f=this.view.ds.getById(g[1]);if(!f||f.dirty||(this.view.denyDragOnMissingEditGrant&&!f.get("editGrant"))){return}var i=Ext.get(f.ui.domIds[0]).dom.cloneNode(true);i.id=Ext.id();if(f.get("is_all_day_event")){Ext.fly(i).setLeft(0)}else{var b=(Ext.fly(this.view.dayCols[0]).getWidth()*0.9);Ext.fly(i).setTop(0);Ext.fly(i).setWidth(b);Ext.fly(i).setHeight(this.view.getTimeHeight.call(this.view,f.get("dtstart"),f.get("dtend")))}return{scope:this.view,sourceEl:a,event:f,ddel:i,selections:this.view.getSelectionModel().getSelectedEvents()}}},getRepairXY:function(b,a){Ext.fly(this.dragData.sourceEl).setStyle({"border-style":"solid"});Ext.fly(this.dragData.sourceEl).setOpacity(1,1);return Ext.fly(this.dragData.sourceEl).getXY()}})},render:function(){this.templates.master.append(this.calPanel.body,{header:this.templates.header.applyTemplate({daysHeader:this.getDayHeaders(),wholeDayCols:this.getWholeDayCols()}),body:this.templates.body.applyTemplate({timeRows:this.getTimeRows(),dayColumns:this.getDayColumns()})});this.initElements();this.getSelectionModel().init(this)},afterRender:function(){this.mainWrap.on("click",this.onClick,this);this.mainWrap.on("dblclick",this.onDblClick,this);this.mainWrap.on("contextmenu",this.onContextMenu,this);this.mainWrap.on("mousedown",this.onMouseDown,this);this.mainWrap.on("mouseup",this.onMouseUp,this);this.calPanel.on("resize",this.onResize,this);this.initDropZone();this.initDragZone();this.updatePeriod({from:this.startDate});if(this.dsLoaded){this.onLoad.apply(this)}this.isScrolling=true;try{var b=this.app.getRegistry().get("preferences").get("daysviewstarttime");var a=Date.parseDate(b,"H:i");if(!Ext.isDate(a)){throw new Ext.Error("no valid startime given")}this.scrollTo(a)}catch(c){this.scrollTo()}this.layout();this.rendered=true},scrollTo:function(a){a=Ext.isDate(a)?a:new Date();this.scroller.dom.scrollTop=this.getTimeOffset(a)},onBeforeScroll:function(){if(!this.isScrolling){this.isScrolling=true;Ext.each(this.dayCols,function(e,a){var c=Ext.get(e),b=c.down("img[class=cal-daysviewpanel-body-daycolumn-hint-above]"),d=c.down("img[class=cal-daysviewpanel-body-daycolumn-hint-below]");b.setDisplayed(false);d.setDisplayed(false)},this)}},onScroll:function(h,c,i){var a=this.scroller.dom.clientHeight,g=this.scroller.dom.scrollTop,d=g+a,b=[],f=[];this.ds.each(function(e){if(e.ui){Ext.each(e.ui.domIds,function(l){var j=Ext.get(l),k=j.getBox(false,true);if(k.bottom<=g){b.push(j.up("div[class^=cal-daysviewpanel-body-daycolumn]"))}else{if(k.bottom-k.height>=d){f.push(j.up("div[class^=cal-daysviewpanel-body-daycolumn]"))}}},this)}});Ext.each(this.dayCols,function(m,e){var k=Ext.get(m),j=k.down("img[class=cal-daysviewpanel-body-daycolumn-hint-above]"),l=k.down("img[class=cal-daysviewpanel-body-daycolumn-hint-below]");if(b.indexOf(k)>=0){j.setTop(g+5);if(!j.isVisible()){j.fadeIn({duration:1.6})}}if(f.indexOf(k)>=0){l.setTop(d-14);if(!l.isVisible()){l.fadeIn({duration:1.6})}}},this);this.isScrolling=false},onShow:function(){this.layout();this.scroller.dom.scrollTop=this.lastScrollPos||this.getTimeOffset(new Date())},onBeforeHide:function(){this.lastScrollPos=this.scroller.dom.scrollTop},insertEvent:function(a){a.ui=new Tine.Calendar.DaysViewEventUI(a);a.ui.render(this)},removeAllEvents:function(){var b=Ext.DomQuery.select("div[class^=cal-daysviewpanel-event]",this.mainWrap.dom);for(var a=0;a<b.length;a++){Ext.fly(b[a]).remove()}this.ds.each(function(c){if(c.ui){c.ui.domIds=[]}})},removeEvent:function(a){if(a==this.activeEvent){this.activeEvent=null}if(this.editing){this.abortCreateEvent(a)}if(a.ui){a.ui.remove()}},setActiveEvent:function(a){this.activeEvent=a||null},getActiveEvent:function(){return this.activeEvent},getSelectionModel:function(){return this.calPanel.getSelectionModel()},createEvent:function(d,c){if(this.editing||(c.isRangeAdd&&!this.mouseDown)){return}this.editing=c;this.ds.suspendEvents();this.ds.add(c);this.ds.resumeEvents();var a=c.get("is_all_day_event")?this.parallelWholeDayEventsRegistry:this.parallelScrollerEventsRegistry;a.register(c);this.insertEvent(c);this.layout();if(c.isRangeAdd){c.ui.resizeable.on("resize",function(){if(c.get("is_all_day_event")){var e=true}else{var e=(c.get("dtend").getTime()-c.get("dtstart").getTime())/Date.msMINUTE>=this.timeGranularity}if(e){this.startEditSummary(c)}else{this.abortCreateEvent(c)}},this);var b=c.get("is_all_day_event")?"east":"south";if(Ext.isIE){d.browserEvent={type:"mousedown"}}c.ui.resizeable[b].onMouseDown.call(c.ui.resizeable[b],d)}else{this.startEditSummary(c)}},abortCreateEvent:function(a){this.ds.remove(a);this.editing=false},startEditSummary:function(b){if(b.summaryEditor){return false}var a=b.ui.getEls();var c=b.get("is_all_day_event")?"cal-daysviewpanel-wholedayevent-body":"cal-daysviewpanel-event-body";b.summaryEditor=new Ext.form.TextArea({event:b,renderTo:a[0].down("div[class="+c+"]"),width:b.ui.getEls()[0].getWidth()-12,height:Math.max(12,b.ui.getEls()[0].getHeight()-18),style:"background-color: transparent; background: 0: border: 0; position: absolute; top: 0px;",value:this.newEventSummary,maxLength:255,maxLengthText:this.app.i18n._("The summary must not be longer than 255 characters."),minLength:1,minLengthText:this.app.i18n._("The summary must have at least 1 character."),enableKeyEvents:true,listeners:{scope:this,render:function(d){d.focus(true,100)},blur:this.endEditSummary,specialkey:this.endEditSummary,keydown:this.endEditSummary}})},endEditSummary:function(f,d){var c=f.event;var b=f.getValue();if(!this.editing||this.validateMsg||!Ext.isDefined(d)){return}if(d&&(d.getKey()==d.ESC)){this.abortCreateEvent(c);return}if(d&&d.getKey()!=d.ENTER){return}if(b.length>f.maxLength){f.markInvalid();this.validateMsg=Ext.Msg.alert(this.app.i18n._("Summary too Long"),f.maxLengthText,function(){f.focus();this.validateMsg=false},this);return}if(!b||b.match(/^\s{1,}$/)||b.length<f.minLength){f.markInvalid();this.validateMsg=Ext.Msg.alert(this.app.i18n._("Summary too Short"),f.minLengthText,function(){f.focus();this.validateMsg=false},this);return}this.editing=false;c.summaryEditor=false;c.set("summary",b);this.ds.suspendEvents();this.ds.remove(c);this.ds.resumeEvents();var a=c.get("is_all_day_event")?this.parallelWholeDayEventsRegistry:this.parallelScrollerEventsRegistry;a.unregister(c);this.removeEvent(c);c.dirty=true;this.ds.add(c);this.fireEvent("addEvent",c)},onAppActivate:function(a){if(a===this.app){}},onResize:function(a){(function(){this.ds.each(function(b){if(b.get("is_all_day_event")){this.removeEvent(b);this.insertEvent(b)}},this)}).defer(50,this)},onClick:function(b){var c=b.getTarget("img[class^=cal-daysviewpanel-body-daycolumn-hint-]",10,true);if(c){this.scroller.scroll(c.hasClass("cal-daysviewpanel-body-daycolumn-hint-above")?"t":"b",10000,true);return}var a=this.getTargetEvent(b);if(a){this.fireEvent("click",a,b)}},onContextMenu:function(a){this.fireEvent("contextmenu",a)},onDblClick:function(h,g){h.stopEvent();var d=this.getTargetEvent(h);var f=this.getTargetDateTime(h);if(d){this.fireEvent("dblclick",d,h)}else{if(f&&!this.editing){var c="cal-daysviewpanel-new-"+Ext.id();var a=f.add(Date.HOUR,1);if(f.is_all_day_event){a=a.add(Date.HOUR,23).add(Date.SECOND,-1)}var d=new Tine.Calendar.Model.Event(Ext.apply(Tine.Calendar.Model.Event.getDefaultData(),{id:c,dtstart:f,dtend:a,is_all_day_event:f.is_all_day_event}),c);this.createEvent(h,d);d.dirty=true}else{if(g.className=="cal-daysviewpanel-dayheader-day"){var i=Ext.DomQuery.select("div[class=cal-daysviewpanel-dayheader-day]",this.innerHd);var b=this.startDate.add(Date.DAY,i.indexOf(g));this.fireEvent("changeView","day",b)}}}},onMouseDown:function(f){if(f.button!==0){return}if(!this.editing){this.focusEl.focus()}this.mouseDown=true;var b=this.getTargetEvent(f);if(this.editing&&this.editing.summaryEditor&&(b!=this.editing)){this.editing.summaryEditor.fireEvent("blur",this.editing.summaryEditor,null)}var g=this.getSelectionModel();g.select(b);var d=this.getTargetDateTime(f);if(d){var a="cal-daysviewpanel-new-"+Ext.id();var c=new Tine.Calendar.Model.Event(Ext.apply(Tine.Calendar.Model.Event.getDefaultData(),{id:a,dtstart:d,dtend:d.is_all_day_event?d.add(Date.HOUR,24).add(Date.SECOND,-1):d.add(Date.MINUTE,2*this.timeGranularity/2),is_all_day_event:d.is_all_day_event}),a);c.isRangeAdd=true;c.dirty=true;f.stopEvent();this.createEvent.defer(100,this,[f,c])}},onMouseUp:function(){this.mouseDown=false},onBeforeEventResize:function(b,d){var c=b.el.id.split(":");var a=this.ds.getById(c[1]);b.event=a;b.originalHeight=b.el.getHeight();b.originalWidth=b.el.getWidth();b.onMouseMove=b.onMouseMove.createSequence(function(){var e=this.event;if(!e){return}var f=e.ui;var g=f.getRzInfo(this);this.durationEl.update(g.dtend.format(e.get("is_all_day_event")?Ext.form.DateField.prototype.format:"H:i"))},b);a.ui.markDirty();if(!b.durationEl){b.durationEl=b.el.insertFirst({"class":"cal-daysviewpanel-event-rzduration",style:"position: absolute; bottom: 3px; right: 2px; z-index: 1000;"})}b.durationEl.update(a.get("dtend").format(a.get("is_all_day_event")?Ext.form.DateField.prototype.format:"H:i"));if(a){this.getSelectionModel().select(a)}else{this.getSelectionModel().clearSelections()}},onEventResize:function(e,c,a){var d=e.event;if(!d){return}var f=d.ui.getRzInfo(e,c,a);if(f.diff!=0){if(f.duration>0){d.set("dtend",f.dtend)}else{var b=new Date(d.get("dtstart").getTime());b.setMinutes(b.getMinutes()+1);d.set("dtend",b)}}if(d.summaryEditor){d.summaryEditor.setHeight(d.ui.getEls()[0].getHeight()-18)}if(f.diff!=0&&d!=this.editing&&!d.isRangeAdd){this.fireEvent("updateEvent",d)}else{d.ui.clearDirty()}},onDataChange:function(){},onClear:function(){},onUpdate:function(c,b){if(b.get("id").match(/new/)){return}var d=(b.modified.hasOwnProperty("is_all_day_event")?b.modified.is_all_day_event:b.get("is_all_day_event"))?this.parallelWholeDayEventsRegistry:this.parallelScrollerEventsRegistry;var a=b.get("is_all_day_event")?this.parallelWholeDayEventsRegistry:this.parallelScrollerEventsRegistry;var e=b.modified.hasOwnProperty("dtstart")?b.modified.dtstart:b.get("dtstart");var f=b.modified.hasOwnProperty("dtend")?b.modified.dtend:b.get("dtend");var h=d.getEvents(e,f);for(var g=0;g<h.length;g++){this.removeEvent(h[g])}d.unregister(b);var h=d.getEvents(e,f);for(var g=0;g<h.length;g++){this.insertEvent(h[g])}var i=a.getEvents(b.get("dtstart"),b.get("dtend"));for(var g=0;g<i.length;g++){this.removeEvent(i[g])}a.register(b);var i=a.getEvents(b.get("dtstart"),b.get("dtend"));for(var g=0;g<i.length;g++){this.insertEvent(i[g])}this.setActiveEvent(this.getActiveEvent());this.layout()},onAdd:function(h,b,e){for(var f=0;f<b.length;f++){var g=b[f];var a=g.get("is_all_day_event")?this.parallelWholeDayEventsRegistry:this.parallelScrollerEventsRegistry;a.register(g);var d=a.getEvents(g.get("dtstart"),g.get("dtend"));for(var c=0;c<d.length;c++){this.removeEvent(d[c]);this.insertEvent(d[c])}}this.layout()},onRemove:function(e,c,b,d){if(!c||b==-1){return}if(d!==true){}var a=c.get("is_all_day_event")?this.parallelWholeDayEventsRegistry:this.parallelScrollerEventsRegistry;a.unregister(c);this.removeEvent(c);this.getSelectionModel().unselect(c);this.layout()},onLoad:function(){if(!this.rendered){this.dsLoaded=true;return}this.removeAllEvents();this.parallelScrollerEventsRegistry=new Tine.Calendar.ParallelEventsRegistry({dtStart:this.startDate,dtEnd:this.endDate});this.parallelWholeDayEventsRegistry=new Tine.Calendar.ParallelEventsRegistry({dtStart:this.startDate,dtEnd:this.endDate});this.ds.fields=Tine.Calendar.Model.Event.prototype.fields;this.ds.sortInfo={field:"dtstart",direction:"ASC"};this.ds.applySort();this.ds.each(function(b){var a=b.get("is_all_day_event")?this.parallelWholeDayEventsRegistry:this.parallelScrollerEventsRegistry;a.register(b)},this);this.ds.each(this.insertEvent,this);this.layout()},print:function(){var a=new Tine.Calendar.Printer.DaysViewRenderer();a.print(this)},hex2dec:function(c){var f=0;c=c.toString();var b=c.length,e,d;for(var a=0;a<b;a++){e=Math.pow(16,(Math.abs(a-c.length)-1));d=parseInt(c.toString().charAt([a]),10);if(isNaN(d)){switch(c.toString().charAt([a]).toUpperCase()){case"A":d=10;break;case"B":d=11;break;case"C":d=12;break;case"D":d=13;break;case"E":d=14;break;case"F":d=15;break;default:return NaN}}f=f+(e*d)}return f},getPeriod:function(){return{from:this.startDate,until:this.startDate.add(Date.DAY,this.numOfDays)}},getTargetDateTime:function(f){var d=f.getTarget("div[class^=cal-daysviewpanel-datetime]");if(d&&d.id.match(/^ext-gen\d+:\d+/)){var c=d.id.split(":");var a=this.startDate.add(Date.DAY,parseInt(c[1],10));a.is_all_day_event=true;if(c[2]){var b=this.timeScale.getAt(c[2]);a=a.add(Date.MINUTE,b.get("minutes"));a.is_all_day_event=false}return a}},getTargetEvent:function(d){var c=d.getTarget();var a=Ext.fly(c);if(a.hasClass("cal-daysviewpanel-event")||(a=a.up("[id*=event:]",10))){var b=a.dom.id.split(":");return this.ds.getById(b[1])}},getTimeOffset:function(a){var b=this.granularityUnitHeights/this.timeGranularity;return Math.round(b*(60*a.getHours()+a.getMinutes()))},getTimeHeight:function(b,a){var c=this.granularityUnitHeights/this.timeGranularity;return Math.round(c*((a.getTime()-b.getTime())/Date.msMINUTE))},initElements:function(){var c=Ext.Element;var b=this.calPanel.body.dom.firstChild;var a=b.childNodes;this.el=new c(b);this.mainWrap=new c(a[0]);this.mainHd=new c(this.mainWrap.dom.firstChild);this.innerHd=this.mainHd.dom.firstChild;this.wholeDayScroller=this.innerHd.firstChild.childNodes[1];this.wholeDayArea=this.wholeDayScroller.firstChild;this.scroller=new c(this.mainWrap.dom.childNodes[1]);this.scroller.setStyle("overflow-x","hidden");this.scroller.on("scroll",this.onBeforeScroll,this);this.scroller.on("scroll",this.onScroll,this,{buffer:200});this.mainBody=new c(this.scroller.dom.firstChild);this.dayCols=this.mainBody.dom.firstChild.lastChild.childNodes;this.focusEl=new c(this.el.dom.lastChild);this.focusEl.swallowEvent("click",true);this.focusEl.swallowEvent("dblclick",true);this.focusEl.swallowEvent("contextmenu",true)},getColumnNumber:function(a){return Math.floor((a.add(Date.SECOND,1).getTime()-this.startDate.getTime())/Date.msDAY)},getDateColumnEl:function(a){return this.dayCols[a]},checkWholeDayEls:function(){var b=[];for(var a=0;a<this.wholeDayArea.childNodes.length-1;a++){if(this.wholeDayArea.childNodes[a].childNodes.length===1){b.push(a)}}for(var a=1;a<b.length;a++){Ext.fly(this.wholeDayArea.childNodes[b[a]]).remove()}},layout:function(){if(!this.mainBody){return}var h=this.calPanel;var l=h.body;var d=l.getSize(true);var m=d.width;this.el.setSize(d.width,d.height);var b=Ext.get(this.wholeDayArea);for(var f=0,a=b.getTop();f<this.wholeDayArea.childNodes.length-1;f++){a=Math.max(parseInt(Ext.get(this.wholeDayArea.childNodes[f]).getBottom(),10),a)}var j=a-b.getTop()+10;b.setHeight(j);Ext.fly(this.wholeDayScroller).setHeight(Math.min(Math.round(d.height/3),j));var k=this.mainHd.getHeight();var e=d.height-(k);this.scroller.setSize(m,e);this.onScroll.defer(100,this)},getDayHeaders:function(){var d="";var e=100/this.numOfDays;for(var c=0,b;c<this.numOfDays;c++){var a=this.startDate.add(Date.DAY,c);d+=this.templates.dayHeader.applyTemplate({day:String.format(this.dayFormatString,a.format("l"),a.format("j"),a.format("F")),height:this.granularityUnitHeights,width:e+"%",left:c*e+"%"})}return d},updateDayHeaders:function(){var e=Ext.DomQuery.select("div[class=cal-daysviewpanel-dayheader-day]",this.innerHd);for(var d=0,c,a,f,b;d<e.length;d++){c=this.startDate.add(Date.DAY,d);a=c.getTime()==this.toDay.getTime();f=Ext.fly(e[d]);f.update(String.format(this.dayFormatString,c.format("l"),c.format("j"),c.format("F")));f.parent()[(a?"add":"remove")+"Class"]("cal-daysviewpanel-dayheader-today");Ext.fly(this.dayCols[d])[(a?"add":"remove")+"Class"]("cal-daysviewpanel-body-daycolumn-today")}},getWholeDayCols:function(){var c="";var d=100/this.numOfDays;var a=Ext.id();for(var b=0;b<this.numOfDays;b++){c+=this.templates.wholeDayCol.applyTemplate({id:a+":"+b,width:d+"%",left:b*d+"%"})}return c},getTimeRows:function(){var a="";this.timeScale.each(function(c){var b=c.get("index");a+=this.templates.timeRow.applyTemplate({cls:b%2?"cal-daysviewpanel-timeRow-off":"cal-daysviewpanel-timeRow-on",height:this.granularityUnitHeights+"px",top:b*this.granularityUnitHeights+"px",time:b%2?"":c.get("time")})},this);return a},getDayColumns:function(){var b="";var c=100/this.numOfDays;for(var a=0;a<this.numOfDays;a++){b+=this.templates.dayColumn.applyTemplate({width:c+"%",left:a*c+"%",overRows:this.getOverRows(a)})}return b},getOverRows:function(c){var b="";var a=Ext.id();this.timeScale.each(function(e){var d=e.get("index");b+=this.templates.overRow.applyTemplate({id:a+":"+c+":"+d,cls:"cal-daysviewpanel-daycolumn-row-"+(d%2?"off":"on"),height:this.granularityUnitHeights+"px",time:e.get("time")})},this);return b},initTemplates:function(){var c=this.templates||{};c.master=new Ext.XTemplate('<div class="cal-daysviewpanel" hidefocus="true">','<div class="cal-daysviewpanel-viewport">','<div class="cal-daysviewpanel-header"><div class="cal-daysviewpanel-header-inner"><div class="cal-daysviewpanel-header-offset">{header}</div></div><div class="x-clear"></div></div>','<div class="cal-daysviewpanel-scroller"><div class="cal-daysviewpanel-body">{body}</div></div>',"</div>",'<a href="#" class="cal-daysviewpanel-focus" tabIndex="-1"></a>',"</div>");c.header=new Ext.XTemplate('<div class="cal-daysviewpanel-daysheader">{daysHeader}</div>','<div class="cal-daysviewpanel-wholedayheader-scroller">','<div class="cal-daysviewpanel-wholedayheader">','<div class="cal-daysviewpanel-wholedayheader-daycols">{wholeDayCols}</div>',"</div>","</div>");c.dayHeader=new Ext.XTemplate('<div class="cal-daysviewpanel-dayheader" style="height: {height}; width: {width}; left: {left};"><div class="cal-daysviewpanel-dayheader-day-wrap"><div class="cal-daysviewpanel-dayheader-day">{day}</div></div>',"</div>");c.wholeDayCol=new Ext.XTemplate('<div class="cal-daysviewpanel-body-wholedaycolumn" style="left: {left}; width: {width};"><div id="{id}" class="cal-daysviewpanel-datetime cal-daysviewpanel-body-wholedaycolumn-over">&#160;</div></div>');c.body=new Ext.XTemplate('<div class="cal-daysviewpanel-body-inner">{timeRows}<div class="cal-daysviewpanel-body-daycolumns">{dayColumns}</div></div>');c.timeRow=new Ext.XTemplate('<div class="{cls}" style="height: {height}; top: {top};">','<div class="cal-daysviewpanel-timeRow-time">{time}</div>',"</div>");c.dayColumn=new Ext.XTemplate('<div class="cal-daysviewpanel-body-daycolumn" style="left: {left}; width: {width};">','<div class="cal-daysviewpanel-body-daycolumn-inner">&#160;</div>',"{overRows}",'<img src="',Ext.BLANK_IMAGE_URL,'" class="cal-daysviewpanel-body-daycolumn-hint-above" />','<img src="',Ext.BLANK_IMAGE_URL,'" class="cal-daysviewpanel-body-daycolumn-hint-below" />',"</div>");c.overRow=new Ext.XTemplate('<div id="{id}" class="cal-daysviewpanel-datetime cal-daysviewpanel-daycolumn-row" style="height: {height};"><div class="{cls}" >{time}</div></div>');c.event=new Ext.XTemplate('<div id="{id}" class="cal-daysviewpanel-event {extraCls}" style="width: {width}; height: {height}; left: {left}; top: {top}; z-index: {zIndex}; background-color: {bgColor}; border-color: {color};">','<div class="cal-daysviewpanel-event-header" style="background-color: {color};">','<div class="cal-daysviewpanel-event-header-inner" style="color: {textColor}; background-color: {color}; z-index: {zIndex};">{startTime}</div>','<div class="cal-daysviewpanel-event-header-icons">','<tpl for="statusIcons">','<img src="',Ext.BLANK_IMAGE_URL,"\" class=\"cal-status-icon {status}-{[parent.textColor == '#FFFFFF' ? 'white' : 'black']}\" ext:qtip=\"{[this.encode(values.text)]}\" />","</tpl>","</div>","</div>",'<div class="cal-daysviewpanel-event-body">{[Ext.util.Format.nl2br(Ext.util.Format.htmlEncode(values.summary))]}</div>','<div class="cal-daysviewpanel-event-tags">{tagsHtml}</div>',"</div>",{encode:function(d){return Tine.Tinebase.common.doubleEncode(d)}});c.wholeDayEvent=new Ext.XTemplate('<div id="{id}" class="cal-daysviewpanel-event {extraCls}" style="width: {width}; height: {height}; left: {left}; top: {top}; z-index: {zIndex}; background-color: {bgColor}; border-color: {color};"><div class="cal-daysviewpanel-wholedayevent-tags">{tagsHtml}</div><div class="cal-daysviewpanel-wholedayevent-body">{[Ext.util.Format.nl2br(Ext.util.Format.htmlEncode(values.summary))]}</div><div class="cal-daysviewpanel-event-header-icons" style="background-color: {bgColor};" ><tpl for="statusIcons"><img src="',Ext.BLANK_IMAGE_URL,'" class="cal-status-icon {status}-black" ext:qtip="{[this.encode(values.text)]}" />',"</tpl></div></div>",{encode:function(d){return Tine.Tinebase.common.doubleEncode(d)}});for(var a in c){var b=c[a];if(b&&typeof b.compile=="function"&&!b.compiled){b.disableFormats=true;b.compile()}}this.templates=c}});Ext.ns("Tine.Calendar");Tine.Calendar.MonthView=function(a){Ext.apply(this,a);Tine.Calendar.MonthView.superclass.constructor.call(this);this.addEvents("click","contextmenu","dblclick","changeView","changePeriod","addEvent","updateEvent")};Ext.extend(Tine.Calendar.MonthView,Ext.util.Observable,{startDate:new Date().clearTime(),newEventSummary:"New Event",calWeekString:"WK",moreString:"{0} more...",monthNames:Date.monthNames,dayNames:Date.dayNames,startDay:Ext.DatePicker.prototype.startDay,denyDragOnMissingEditGrant:true,activeEvent:null,toDay:null,dateMesh:null,parallelEventsRegistry:null,afterRender:function(){this.initElements();this.getSelectionModel().init(this);this.el.on("mousedown",this.onMouseDown,this);this.el.on("dblclick",this.onDblClick,this);this.el.on("click",this.onClick,this);this.el.on("contextmenu",this.onContextMenu,this);this.initDragZone();this.initDropZone();this.updatePeriod({from:this.period.from});if(this.dsLoaded){this.onLoad.apply(this)}this.rendered=true},calcDateMesh:function(){var c=[];var b=Date.parseDate(this.startDate.format("Y-m")+"-01 00:00:00",Date.patterns.ISO8601Long);while(b.getDay()!=this.startDay){b=b.add(Date.DAY,-1)}while(b.getMonth()!=this.startDate.add(Date.MONTH,1).getMonth()){for(var a=0;a<7;a++){c.push(b.add(Date.DAY,a).clone())}b=b.add(Date.DAY,7)}this.dateMesh=c},getActiveEvent:function(){return this.activeEvent},getDayCellIndex:function(a){return Math.round((a.clearTime(true).getTime()-this.dateMesh[0].getTime())/Date.msDAY)},getEventSlice:function(b,c){c=Math.abs(c);for(var a=b.childNodes.length;a<=c;a++){Ext.DomHelper.insertAfter(b.lastChild,'<div class="cal-monthview-eventslice"/>')}while(b.childNodes[c].innerHTML){c++;if(c>b.childNodes.length-1){Ext.DomHelper.insertAfter(b.lastChild,'<div class="cal-monthview-eventslice"/>')}}return b.childNodes[c]},getPeriod:function(){if(!this.dateMesh){this.calcDateMesh()}return{from:this.dateMesh[0],until:this.dateMesh[this.dateMesh.length-1].add(Date.DAY,1)}},getSelectionModel:function(){return this.calPanel.selModel},getTargetDateTime:function(d){var c=d.getTarget("td.cal-monthview-daycell",3);if(c){var b=this.dayCells.indexOf(c);var a=this.dateMesh[this.dayCells.indexOf(c)];a.add(Date.HOUR,10);return a}},getTargetEvent:function(d){var c=d.getTarget("div.cal-monthview-alldayevent",10)||d.getTarget("div.cal-monthview-event",10);if(c){var b=c.id.split(":");var a=this.ds.getById(b[1])}return a},init:function(a){this.calPanel=a;this.app=Tine.Tinebase.appMgr.get("Calendar");this.newEventSummary=this.app.i18n._hidden(this.newEventSummary);this.calWeekString=this.app.i18n._hidden(this.calWeekString);this.moreString=this.app.i18n._hidden(this.moreString);this.monthNames=Date.monthNames;this.dayNames=Date.dayNames;this.startDay=Ext.DatePicker.prototype.startDay;this.initData(a.store);this.initTemplates()},initData:function(a){if(this.ds){this.ds.un("load",this.onLoad,this);this.ds.un("add",this.onAdd,this);this.ds.un("remove",this.onRemove,this);this.ds.un("update",this.onUpdate,this)}if(a){a.on("load",this.onLoad,this);a.on("add",this.onAdd,this);a.on("remove",this.onRemove,this);a.on("update",this.onUpdate,this)}this.ds=a},initDragZone:function(){this.dragZone=new Ext.dd.DragZone(this.el,{ddGroup:"cal-event",view:this,scroll:false,getDragData:function(g){var a=g.getTarget("div.cal-monthview-alldayevent",10)||g.getTarget("div.cal-monthview-event",10);if(a){var f=a.id.split(":");var c=this.view.ds.getById(f[1]);if(this.view.denyDragOnMissingEditGrant&&!c.get("editGrant")){return false}var h=Ext.get(c.ui.domIds[0]).dom.cloneNode(true);var b=Ext.fly(a).getWidth()*c.ui.domIds.length;Ext.fly(h).removeClass(["cal-monthview-alldayevent-cropleft","cal-monthview-alldayevent-cropright"]);Ext.fly(h).setWidth(b);Ext.fly(h).setOpacity(0.5);h.id=Ext.id();return{scope:this.view,sourceEl:a,event:c,ddel:h,selections:this.view.getSelectionModel().getSelectedEvents()}}},getRepairXY:function(b,a){Ext.fly(this.dragData.sourceEl).setOpacity(1,1);return Ext.fly(this.dragData.sourceEl).getXY()}})},initDropZone:function(){this.dd=new Ext.dd.DropZone(this.el.dom,{ddGroup:"cal-event",notifyOver:function(a,f,c){var d=f.getTarget("td.cal-monthview-daycell",3);var b=c.event;if(b){c.scope.getSelectionModel().select(b)}return d&&b&&b.get("editGrant")?"cal-daysviewpanel-event-drop-ok":"cal-daysviewpanel-event-drop-nodrop"},notifyDrop:function(a,i,f){var b=f.scope;var h=i.getTarget("td.cal-monthview-daycell",3);var c=b.dateMesh[b.dayCells.indexOf(h)];if(c){var d=f.event;var g=(c.getTime()-d.get("dtstart").clearTime(true).getTime())/Date.msDAY;if(!g||!d.get("editGrant")){return false}d.beginEdit();d.set("dtstart",d.get("dtstart").add(Date.DAY,g));d.set("dtend",d.get("dtend").add(Date.DAY,g));d.endEdit();b.fireEvent("updateEvent",d)}return !!c}})},initElements:function(){var a=Ext.Element;this.focusEl=new a(this.calPanel.body.dom.firstChild);this.el=new a(this.calPanel.body.dom.lastChild);this.mainHd=new a(this.el.dom.firstChild);this.mainBody=new a(this.el.dom.lastChild);this.dayCells=Ext.DomQuery.select("td[class=cal-monthview-daycell]",this.mainBody.dom)},initTemplates:function(){var c=this.templates||{};c.allDayEvent=new Ext.XTemplate('<div id="{id}" class="cal-monthview-event cal-monthview-alldayevent {extraCls}" style="background-color: {bgColor};"><div class="cal-event-icon {iconCls} cal-monthview-event-info-{[values.showInfo ? "show" : "hide"]}"><div class="cal-monthview-alldayevent-summary" style="width: {width};">{[Ext.util.Format.htmlEncode(values.summary)]}</div></div></div>');c.event=new Ext.XTemplate('<div id="{id}" class="cal-monthview-event {extraCls}" style="color: {color};"><div class="cal-event-icon {iconCls}"><div class="cal-monthview-event-summary">{startTime} {[Ext.util.Format.htmlEncode(values.summary)]}</div></div></div>');for(var a in c){var b=c[a];if(b&&typeof b.compile=="function"&&!b.compiled){b.disableFormats=true;b.compile()}}this.templates=c},insertEvent:function(b){b.ui=new Tine.Calendar.MonthViewEventUI(b);var j=b.get("dtstart");var d=this.getDayCellIndex(j);var e=b.get("dtend");if(e.format("H:i")=="00:00"){e=e.add(Date.MINUTE,-1)}var n=this.getDayCellIndex(e);if(n<0||d>=this.dateMesh.length){return}var l=this.parallelEventsRegistry.getPosition(b);b.ui.is_all_day_event=b.get("is_all_day_event")||d!=n;b.ui.colorSet=b.colorSet=Tine.Calendar.colorMgr.getColor(b);b.ui.color=b.ui.colorSet.color;b.ui.bgColor=b.ui.colorSet.light;var f={startTime:j.format("H:i"),summary:b.get("summary"),color:b.ui.color,bgColor:b.ui.bgColor,width:"100%"};for(var g=Math.max(d,0);g<=Math.min(n,this.dayCells.length-1);g++){var c=g%7,o=Math.floor(g/7);f.id=Ext.id()+"-event:"+b.get("id");b.ui.domIds.push(f.id);var m=this.templates.event;f.extraCls=b.get("editGrant")?"cal-monthview-event-editgrant":"";f.extraCls+=" cal-status-"+b.get("status");if(b.ui.is_all_day_event){m=this.templates.allDayEvent;f.color="black";if(g>d){f.extraCls+=" cal-monthview-alldayevent-cropleft"}if(g<n){f.extraCls+=" cal-monthview-alldayevent-cropright"}f.showInfo=g==d||g%7==0;if(f.showInfo&&d!=n){var k=(o==Math.floor(n/7)?n%7:6)-c+1;f.width=100*k+"%"}}var h=this.getEventSlice(this.dayCells[g].lastChild,l);var a=m.overwrite(h,f,true);if(b.dirty){a.setOpacity(0.5);b.ui.onSelectedChange(true)}}},layout:function(){if(!this.mainBody){return}var h=this.calPanel;var k=h.body;var d=k.getSize(true);var l=d.width;var m=this.mainHd.getSize(true);var b=this.mainHd.dom.firstChild.childNodes;Ext.fly(b[0]).setWidth(50);for(var e=1;e<b.length;e++){Ext.get(b[e]).setWidth((l-50)/7)}var a=((d.height-m.height-2)/Math.ceil(this.dateMesh.length/7));var f=this.mainBody.dom.childNodes;for(var e=0;e<f.length;e++){Ext.get(f[e]).setHeight(a)}var j=Ext.get(this.dayCells[0].firstChild).getSize();this.dayCellsHeight=a-j.height;for(var e=0;e<this.dayCells.length;e++){Ext.get(this.dayCells[e].lastChild).setSize((l-50)/7,this.dayCellsHeight)}this.layoutDayCells()},layoutDayCells:function(){for(var a=0;a<this.dayCells.length;a++){if(this.dayCells[a].lastChild.childNodes.length>1){this.layoutDayCell(this.dayCells[a],true,true)}}},layoutDayCell:function(c,g,f){while(c.lastChild.childNodes.length>1&&c.lastChild.lastChild.innerHTML==""){Ext.fly(c.lastChild.lastChild).remove()}for(var d=0,b=0,e=0;d<c.lastChild.childNodes.length;d++){var a=Ext.get(c.lastChild.childNodes[d]);b+=a.getHeight();a[b>this.dayCellsHeight&&g?"hide":"show"]();if(b>this.dayCellsHeight&&g){e++}}if(f){c.firstChild.firstChild.innerHTML=e>0?String.format(this.moreString,e):""}return b},onAdd:function(g,a,d){for(var e=0;e<a.length;e++){var f=a[e];this.parallelEventsRegistry.register(f);var c=this.parallelEventsRegistry.getEvents(f.get("dtstart"),f.get("dtend"));for(var b=0;b<c.length;b++){this.removeEvent(c[b]);this.insertEvent(c[b])}this.setActiveEvent(f)}this.layoutDayCells()},onClick:function(g,f){var c=this.getTargetEvent(g);if(c){this.fireEvent("click",c,g);return}var b=new Date().getTime();if(b-parseInt(this.lastClickTime,10)<300){this.lastClickTime=b;return}var d=this.getTargetDateTime(g);if(Math.abs(d-b)<100){this.lastClickTime=b;return this.onClick.defer(400,this,[g,f])}this.lastClickTime=b;switch(f.className){case"cal-monthview-dayheader-date":case"cal-monthview-dayheader-more":var a=f.parentNode.firstChild.innerHTML;if(!a){return}this.zoomDayCell(f.parentNode.parentNode);break}},onContextMenu:function(a){this.fireEvent("contextmenu",a)},onDblClick:function(g,f){this.lastClickTime=new Date().getTime();g.stopEvent();var d=this.getTargetEvent(g);if(d){this.fireEvent("dblclick",d,g);return}switch(f.className){case"cal-monthview-wkcell":var h=Ext.DomQuery.select("td[class=cal-monthview-wkcell]",this.mainBody.dom).indexOf(f);var b=this.dateMesh[7*h];this.fireEvent("changeView","week",b);break;case"cal-monthview-dayheader-date":case"cal-monthview-dayheader-more":var a=this.dayCells.indexOf(f.parentNode.parentNode);var c=this.dateMesh[a];this.fireEvent("changeView","day",c);break;case"cal-monthview-daycell":var a=this.dayCells.indexOf(f);var c=this.dateMesh[a];break}},onLoad:function(){if(!this.rendered){this.dsLoaded=true;return}this.removeAllEvents();this.parallelEventsRegistry=new Tine.Calendar.ParallelEventsRegistry({dtStart:this.dateMesh[0],dtEnd:this.dateMesh[this.dateMesh.length-1].add(Date.DAY,1),granularity:60*24});this.ds.fields=Tine.Calendar.Model.Event.prototype.fields;this.ds.sortInfo={field:"dtstart",direction:"ASC"};this.ds.applySort();this.ds.each(function(a){this.parallelEventsRegistry.register(a)},this);this.ds.each(this.insertEvent,this);this.layoutDayCells()},onMouseDown:function(b,a){this.focusEl.focus();this.mainBody.focus();if(!b.getTarget("div.cal-monthview-daypreviewbox")){this.unZoom()}},onRemove:function(d,b,a,c){this.parallelEventsRegistry.unregister(b);this.removeEvent(b);this.getSelectionModel().unselect(b)},onUpdate:function(f,e){var g=e.modified.hasOwnProperty("dtstart")?e.modified.dtstart:e.get("dtstart");var d=e.modified.hasOwnProperty("dtend")?e.modified.dtend:e.get("dtend");var c=this.parallelEventsRegistry.getEvents(g,d);for(var b=0;b<c.length;b++){this.removeEvent(c[b])}this.parallelEventsRegistry.unregister(e);var c=this.parallelEventsRegistry.getEvents(g,d);for(var b=0;b<c.length;b++){this.insertEvent(c[b])}var a=this.parallelEventsRegistry.getEvents(e.get("dtstart"),e.get("dtend"));for(var b=0;b<a.length;b++){this.removeEvent(a[b])}this.parallelEventsRegistry.register(e);var a=this.parallelEventsRegistry.getEvents(e.get("dtstart"),e.get("dtend"));for(var b=0;b<a.length;b++){this.insertEvent(a[b])}e.commit(true);this.setActiveEvent(this.getActiveEvent());this.layoutDayCells()},print:function(){var a=new Tine.Calendar.Printer.MonthViewRenderer();a.print(this)},removeAllEvents:function(){var b=Ext.DomQuery.filter(Ext.DomQuery.select("div[class^=cal-monthview-event]",this.mainBody.dom),"div[class=cal-monthview-eventslice]",true);for(var a=0;a<b.length;a++){Ext.fly(b[a]).remove()}this.ds.each(function(c){if(c.ui){c.ui.domIds=[]}});this.layoutDayCells()},removeEvent:function(a){if(!a){return}if(a==this.activeEvent){this.activeEvent=null}if(a.ui){a.ui.remove()}},render:function(){var a=['<a href="#" class="cal-monthviewpanel-focus" tabIndex="-1"></a>','<table class="cal-monthview-inner" cellspacing="0"><thead><tr class="cal-monthview-inner-header" height="23px">',"<th class='cal-monthview-wkcell-header'><span >",this.calWeekString,"</span></th>"];for(var b=0;b<7;b++){var e=this.startDay+b;if(e>6){e=e-7}a.push("<th class='cal-monthview-daycell'><span>",this.dayNames[e],"</span></th>")}a[a.length]="</tr></thead><tbody><tr><td class='cal-monthview-wkcell'></td>";for(var b=0;b<42;b++){if(b%7==0&&b!=0){a[a.length]="</tr><tr><td class='cal-monthview-wkcell'></td>"}a[a.length]='<td class="cal-monthview-daycell"><div class="cal-monthview-dayheader"><div class="cal-monthview-dayheader-more"></div><div class="cal-monthview-dayheader-date"></div></div><div class="cal-monthview-daybody"><div class="cal-monthview-eventslice" /></div></td>'}a.push("</tr></tbody></table>");var c=this.calPanel.body.dom;c.className="cal-monthview";c.innerHTML=a.join("")},setActiveEvent:function(a){this.activeEvent=a||null},updatePeriod:function(d){this.toDay=new Date().clearTime();this.startDate=d.from;this.calcDateMesh();var e=this.calPanel.getTopToolbar();if(e){e.periodPicker.update(this.startDate);this.startDate=e.periodPicker.getPeriod().from}var c=Ext.DomQuery.select("div[class=cal-monthview-dayheader-date]",this.mainBody.dom);for(var a=0;a<this.dateMesh.length;a++){this.dayCells[a].style.background=this.dateMesh[a].getMonth()==this.startDate.getMonth()?"#FFFFFF":"#F9F9F9";if(this.dateMesh[a].getTime()==this.toDay.getTime()){this.dayCells[a].style.background="#EBF3FD"}c[a].innerHTML=this.dateMesh[a].format("j")}var b=Ext.DomQuery.select("td[class=cal-monthview-wkcell]",this.mainBody.dom);for(var a=0;a<b.length;a++){if(this.dateMesh.length>a*7+1){b[a].innerHTML=this.dateMesh[a*7+1].getWeekOfYear()}}this.layout();this.fireEvent("changePeriod",d)},unZoom:function(){if(this.zoomCell){this.lastClickTime=new Date().getTime();var b=Ext.get(this.zoomCell);var d=b.last();var a=b.getHeight()-b.first().getHeight();d.scrollTo("top");d.removeClass("cal-monthview-daypreviewbox");d.setStyle("background-color",b.getStyle("background-color"));d.setStyle("border-top","none");d.setHeight(a);for(var c=0;c<d.dom.childNodes.length;c++){Ext.get(d.dom.childNodes[c]).setWidth(d.getWidth());Ext.get(d.dom.childNodes[c]).setWidth(d.first().getWidth())}this.layoutDayCell(this.zoomCell,true,true);this.zoomCell=false}},zoomDayCell:function(a){this.zoomCell=a;var e=Ext.get(a.lastChild);var d=e.getBox();var f=Ext.fly(a).getStyle("background-color");f=="transparent"?"#FFFFFF":f;e.addClass("cal-monthview-daypreviewbox");e.setBox(d);e.setStyle("background-color",f);e.setStyle("border-top","1px solid "+f);var c=this.layoutDayCell(a,false,true)+10;var b=this.calPanel.el.getBottom()-d.y;e.setHeight(Math.min(c,b))}});Ext.ns("Tine.Calendar");Tine.Calendar.GridView=Ext.extend(Ext.grid.GridPanel,{recordClass:Tine.Calendar.Model.Event,recordProxy:Tine.Calendar.backend,defaultSortInfo:{field:"dtstart",direction:"ASC"},layout:"fit",border:false,stateful:true,stateId:"Calendar-Event-GridPanel-Grid",enableDragDrop:true,ddGroup:"cal-event",initComponent:function(){this.app=Tine.Tinebase.appMgr.get("Calendar");this.store.sort(this.defaultSortInfo.field,this.defaultSortInfo.direction);this.cm=this.initCM();this.selModel=this.initSM();this.view=this.initVIEW();this.on("rowcontextmenu",function(b,d,c){var a=b.getSelectionModel();if(!a.isSelected(d)){a.selectRow(d)}},this);this.on("rowclick",Tine.widgets.grid.GridPanel.prototype.onRowClick,this);this.plugins=this.plugins?this.plugins:[];this.plugins.push(new Ext.ux.grid.GridViewMenuPlugin({}));this.enableHdMenu=false;Tine.Calendar.GridView.superclass.initComponent.call(this)},initCM:function(){return new Ext.grid.ColumnModel({defaults:{sortable:true,resizable:true},columns:[{id:"container_id",header:this.recordClass.getContainerName(),width:150,renderer:Tine.widgets.grid.RendererManager.get("Calendar","Event","container_id")},{id:"class",header:this.app.i18n._("Private"),width:50,dataIndex:"class",renderer:function(a){return Tine.Tinebase.common.booleanRenderer(a=="PRIVATE")}},{id:"tags",header:this.app.i18n._("Tags"),width:50,dataIndex:"tags",renderer:Tine.Tinebase.common.tagsRenderer},{id:"dtstart",header:this.app.i18n._("Start Time"),width:120,dataIndex:"dtstart",renderer:Tine.Tinebase.common.dateTimeRenderer},{id:"dtend",header:this.app.i18n._("End Time"),width:120,dataIndex:"dtend",renderer:Tine.Tinebase.common.dateTimeRenderer},{id:"is_all_day_event",header:this.app.i18n._("whole day"),width:50,dataIndex:"is_all_day_event",renderer:Tine.Tinebase.common.booleanRenderer},{id:"transp",header:this.app.i18n._("Blocking"),width:50,dataIndex:"transp",renderer:function(a){return Tine.Tinebase.common.booleanRenderer(a=="OPAQUE")}},{id:"status",header:this.app.i18n._("Tentative"),width:50,dataIndex:"status",renderer:function(a){return Tine.Tinebase.common.booleanRenderer(a=="TENTATIVE")}},{id:"summary",header:this.app.i18n._("Summary"),width:200,dataIndex:"summary"},{id:"location",header:this.app.i18n._("Location"),width:200,hidden:true,dataIndex:"location"},{id:"organizer",header:this.app.i18n._("Organizer"),width:200,hidden:true,dataIndex:"organizer",renderer:Tine.Calendar.AttendeeGridPanel.prototype.renderAttenderUserName},{id:"description",header:this.app.i18n._("Description"),width:200,hidden:true,dataIndex:"description",renderer:function(c,b,a){b.attr='ext:qtip="'+Ext.util.Format.nl2br(Ext.util.Format.htmlEncode(Ext.util.Format.htmlEncode(c)))+'"';return Ext.util.Format.htmlEncode(c)}}]})},initSM:function(){return new Ext.grid.RowSelectionModel({allowMultiple:true,getSelectedEvents:function(){return this.getSelections()},select:function(b,d,c){if(!b||!b.ui){return b}var a=this.grid.getStore.indexOf(b);this.selectRow(a,c);return b}})},initVIEW:function(){return new Ext.grid.GridView(Ext.apply({},this.viewConfig,{grid:this,forceFit:true,getPeriod:function(){return this.grid.getTopToolbar().periodPicker.getPeriod()},updatePeriod:function(a){this.startDate=a.from;var b=this.grid.getTopToolbar();if(b){b.periodPicker.update(this.startDate);this.startDate=b.periodPicker.getPeriod().from}},getTargetEvent:function(b){var a=this.findRowIndex(b.getTarget());return this.grid.getStore().getAt(a)},getTargetDateTime:Ext.emptyFn,getSelectionModel:function(){return this.grid.getSelectionModel()},print:function(){Ext.ux.Printer.print(this.grid)},getRowClass:this.getViewRowClass}))},attendeeStatusRenderer:function(a){var b=new Tine.Calendar.Model.Attender.getAttendeeStore(a),c=null;b.each(function(d){if(d.getUserId()==this.record.id&&d.get("user_type")=="user"){c=d;return false}},this);if(c){return Tine.Tinebase.widgets.keyfield.Renderer.render("Calendar","attendeeStatus",c.get("status"))}},getViewRowClass:function(a,b){return"cal-status-"+a.get("status")}});Ext.ns("Tine.Calendar");Tine.Calendar.PagingToolbar=Ext.extend(Ext.Toolbar,{dtStart:null,view:"day",periodPicker:null,showReloadBtn:true,showTodayBtn:true,periodPickerActive:null,initComponent:function(){this.addEvents("change","refresh");if(!Ext.isDate(this.dtStart)){this.dtStart=new Date()}this.periodPicker=new Tine.Calendar.PagingToolbar[Ext.util.Format.capitalize(this.view)+"PeriodPicker"]({tb:this,listeners:{scope:this,change:function(b,a,c){this.dtStart=c.from.clone();this.fireEvent("change",this,a,c)},menushow:function(){this.periodPickerActive=true},menuhide:function(){this.periodPickerActive=false}}});Tine.Calendar.PagingToolbar.superclass.initComponent.call(this);this.bind(this.store)},onRender:function(b,a){Tine.Calendar.PagingToolbar.superclass.onRender.call(this,b,a);this.prevBtn=this.addButton({tooltip:Ext.PagingToolbar.prototype.prevText,iconCls:"x-tbar-page-prev",handler:this.onClick.createDelegate(this,["prev"])});this.addSeparator();this.periodPicker.render();this.addSeparator();this.nextBtn=this.addButton({tooltip:Ext.PagingToolbar.prototype.nextText,iconCls:"x-tbar-page-next",handler:this.onClick.createDelegate(this,["next"])});if(this.showTodayBtn||this.showReloadBtn){this.addSeparator()}if(this.showTodayBtn){this.todayBtn=this.addButton({text:Ext.DatePicker.prototype.todayText,iconCls:"cal-today-action",handler:this.onClick.createDelegate(this,["today"])})}if(this.showReloadBtn){this.loading=this.addButton({tooltip:Ext.PagingToolbar.prototype.refreshText,iconCls:"x-tbar-loading",handler:this.onClick.createDelegate(this,["refresh"])})}this.addFill();if(this.isLoading){this.loading.disable()}},onClick:function(a){switch(a){case"today":case"next":case"prev":this.periodPicker[a]();this.fireEvent("change",this,this.activeView,this.periodPicker.getPeriod());break;case"refresh":this.fireEvent("refresh",this,this.activeView,this.periodPicker.getPeriod());break}},getPeriod:function(){return this.periodPicker.getPeriod()},beforeLoad:function(){this.isLoading=true;if(this.rendered&&this.loading){this.loading.disable()}},onLoad:function(a,b,c){this.isLoading=false;if(this.rendered&&this.loading){this.loading.enable()}},unbind:function(a){a=Ext.StoreMgr.lookup(a);a.un("beforeload",this.beforeLoad,this);a.un("load",this.onLoad,this);this.store=undefined},bind:function(a){a=Ext.StoreMgr.lookup(a);a.on("beforeload",this.beforeLoad,this);a.on("load",this.onLoad,this);this.store=a},bindStore:function(){},onDestroy:function(){if(this.store){this.unbind(this.store)}Tine.Calendar.PagingToolbar.superclass.onDestroy.call(this)}});Tine.Calendar.PagingToolbar.AbstractPeriodPicker=function(a){Ext.apply(this,a);this.addEvents("change");Tine.Calendar.PagingToolbar.AbstractPeriodPicker.superclass.constructor.call(this);this.update(this.tb.dtStart);this.init()};Ext.extend(Tine.Calendar.PagingToolbar.AbstractPeriodPicker,Ext.util.Observable,{init:function(){},hide:function(){this.button.hide()},show:function(){this.button.show()},update:function(a){},render:function(){},prev:function(){},next:function(){},today:function(){this.update(new Date().clearTime())},getPeriod:function(){}});Tine.Calendar.PagingToolbar.DayPeriodPicker=Ext.extend(Tine.Calendar.PagingToolbar.AbstractPeriodPicker,{init:function(){this.button=new Ext.Button({text:this.tb.dtStart.format(Ext.DatePicker.prototype.format),menu:new Ext.menu.DateMenu({listeners:{scope:this,select:function(a){if(typeof(a.getValue)=="function"){this.update(a.getValue());this.fireEvent("change",this,"day",this.getPeriod())}}}})})},update:function(a){this.dtStart=a.clone();if(this.button&&this.button.rendered){this.button.setText(a.format(Ext.DatePicker.prototype.format))}},render:function(){this.button=this.tb.addButton(this.button)},next:function(){this.dtStart=this.dtStart.add(Date.DAY,1);this.update(this.dtStart)},prev:function(){this.dtStart=this.dtStart.add(Date.DAY,-1);this.update(this.dtStart)},getPeriod:function(){var a=Date.parseDate(this.dtStart.format("Y-m-d")+" 00:00:00",Date.patterns.ISO8601Long);return{from:a,until:a.add(Date.DAY,1)}}});Tine.Calendar.PagingToolbar.WeekPeriodPicker=Ext.extend(Tine.Calendar.PagingToolbar.AbstractPeriodPicker,{init:function(){this.label=new Ext.form.Label({text:Tine.Tinebase.appMgr.get("Calendar").i18n._("Week"),style:"padding-right: 3px"});this.field=new Ext.form.TextField({value:this.tb.dtStart.getWeekOfYear(),width:30,cls:"x-tbar-page-number",listeners:{scope:this,specialkey:this.onSelect,blur:this.onSelect}})},onSelect:function(c,b){if(b&&b.getKey()==b.ENTER){return c.blur()}var a=c.getValue()-this.dtStart.getWeekOfYear()-parseInt(this.dtStart.getDay()<1?1:0,10);if(a!==0){this.update(this.dtStart.add(Date.DAY,a*7));this.fireEvent("change",this,"week",this.getPeriod())}},update:function(b){var c=b.add(Date.DAY,-1*b.getDay());if(Ext.DatePicker.prototype.startDay){c=c.add(Date.DAY,Ext.DatePicker.prototype.startDay-(b.getDay()==0?7:0))}this.dtStart=c;if(this.field&&this.field.rendered){var a=b.add(Date.DAY,b.getDay()<1?1:0);this.field.setValue(parseInt(a.getWeekOfYear(),10))}},render:function(){this.tb.addField(this.label);this.tb.addField(this.field)},hide:function(){this.label.hide();this.field.hide()},show:function(){this.label.show();this.field.show()},next:function(){this.dtStart=this.dtStart.add(Date.DAY,7);this.update(this.dtStart)},prev:function(){this.dtStart=this.dtStart.add(Date.DAY,-7);this.update(this.dtStart)},getPeriod:function(){return{from:this.dtStart.clone(),until:this.dtStart.add(Date.DAY,7)}}});Tine.Calendar.PagingToolbar.MonthPeriodPicker=Ext.extend(Tine.Calendar.PagingToolbar.AbstractPeriodPicker,{init:function(){this.dateMenu=new Ext.menu.DateMenu({hideMonthPicker:Ext.DatePicker.prototype.hideMonthPicker.createSequence(function(){if(this.monthPickerActive){this.monthPickerActive=false;this.value=this.activeDate;this.fireEvent("select",this,this.value)}}),listeners:{scope:this,select:function(a){if(typeof(a.getValue)=="function"){this.update(a.getValue());this.fireEvent("change",this,"month",this.getPeriod())}}}});this.button=new Ext.Button({minWidth:130,text:Ext.DatePicker.prototype.monthNames[this.tb.dtStart.getMonth()]+this.tb.dtStart.format(" Y"),menu:this.dateMenu,listeners:{scope:this,menushow:function(a,b){b.picker.showMonthPicker();b.picker.monthPickerActive=true;this.fireEvent("menushow")},menuhide:function(a,b){b.picker.monthPickerActive=false;this.fireEvent("menuhide")}}})},update:function(b){this.dtStart=b.clone();if(this.button&&this.button.rendered){var a=Ext.DatePicker.prototype.monthNames[b.getMonth()];this.button.setText(a+b.format(" Y"));this.dateMenu.picker.setValue(b)}},render:function(){this.button=this.tb.addButton(this.button)},next:function(){this.dtStart=this.dtStart.add(Date.MONTH,1);this.update(this.dtStart)},prev:function(){this.dtStart=this.dtStart.add(Date.MONTH,-1);this.update(this.dtStart)},getPeriod:function(){var a=Date.parseDate(this.dtStart.format("Y-m")+"-01 00:00:00",Date.patterns.ISO8601Long);return{from:a,until:a.add(Date.MONTH,1)}}});Ext.ns("Tine.Calendar");Tine.Calendar.EventDetailsPanel=Ext.extend(Tine.widgets.grid.DetailsPanel,{border:false,attendeeRenderer:function(c){if(!c){return _("No Information")}var d=Tine.Calendar.Model.Attender.getAttendeeStore(c);var b=[];d.each(function(f){var e=Tine.Calendar.AttendeeGridPanel.prototype.renderAttenderName.call(Tine.Calendar.AttendeeGridPanel.prototype,f.get("user_id"),false,f),a=Tine.Tinebase.widgets.keyfield.Renderer.render("Calendar","attendeeStatus",f.get("status")),g=Tine.Tinebase.widgets.keyfield.Renderer.render("Calendar","attendeeRoles",f.get("role"));b.push(e+" ("+g+", "+a+")")});return b.join("\n")},containerRenderer:function(a){if(this.record){var b=Tine.widgets.grid.RendererManager.get("Calendar","Event","container_id");return b.call(this,a,{},this.record)}else{return""}},datetimeRenderer:function(a){return String.format(this.app.i18n._("{0} {1} o'clock"),Tine.Tinebase.common.dateRenderer(a),a.format("H:i"))},transpRenderer:function(a){return Tine.Tinebase.common.booleanRenderer(a=="OPAQUE")},statusRenderer:function(a){return Tine.Tinebase.common.booleanRenderer(a=="TENTATIVE")},summaryRenderer:function(c){var e=this.record.getMyAttenderRecord(),b=Tine.Tinebase.common.tagsRenderer(this.record.get("tags")),a=null,d=null;b+=Ext.util.Format.htmlEncode(c);if(e){a=Tine.Tinebase.widgets.keyfield.Renderer.render("Calendar","attendeeStatus",e.get("status"))}if(this.record.isRecurBase()||this.record.isRecurInstance()){d='<img class="cal-recurring" unselectable="on" src="'+Ext.BLANK_IMAGE_URL+'">'+this.app.i18n._("recurring event")}else{if(this.record.isRecurException()){d='<img class="cal-recurring exception" unselectable="on" src="'+Ext.BLANK_IMAGE_URL+'">'+this.app.i18n._("recurring event exception")}}if(a||d){b+="&nbsp;&nbsp;&nbsp;(&nbsp;";if(a){b+=a}if(a&&d){b+="&nbsp;&nbsp;"}if(d){b+=d}b+="&nbsp;)"}return b},initComponent:function(){this.app=Tine.Tinebase.appMgr.get("Calendar");this.containerTpl=new Ext.XTemplate('<div class="x-tree-node-leaf x-unselectable file">','<img class="x-tree-node-icon" unselectable="on" src="',Ext.BLANK_IMAGE_URL,'">','<span style="color: {color};">&nbsp;&#9673;&nbsp</span>',"<span>{name}</span>","</div>").compile();Tine.Calendar.EventDetailsPanel.superclass.initComponent.call(this)},getDefaultInfosPanel:function(){if(!this.defaultInfosPanel){this.defaultInfosPanel=new Ext.ux.display.DisplayPanel({layout:"fit",border:false,items:[{layout:"hbox",border:false,defaults:{margins:"0 5 0 0"},layoutConfig:{padding:"5",align:"stretch"},items:[{flex:1,border:false,layout:"ux.display",layoutConfig:{background:"solid",declaration:this.app.i18n.n_("Event","Events",50)}},{flex:1,border:false,layout:"ux.display",layoutConfig:{background:"border"}}]}]})}return this.defaultInfosPanel},getSingleRecordPanel:function(){if(!this.singleRecordPanel){this.singleRecordPanel=new Ext.ux.display.DisplayPanel({layout:"fit",border:false,items:[{layout:"vbox",border:false,layoutConfig:{align:"stretch"},items:[{layout:"hbox",flex:0,height:16,border:false,style:"padding-left: 5px; padding-right: 5px",layoutConfig:{align:"stretch"},items:[{flex:0.5,xtype:"ux.displayfield",name:"summary",style:"padding-top: 2px",cls:"x-ux-display-header",htmlEncode:false,renderer:this.summaryRenderer.createDelegate(this)},{flex:0.5,xtype:"ux.displayfield",style:"text-align: right;",cls:"x-ux-display-header",name:"container_id",htmlEncode:false,renderer:this.containerRenderer.createDelegate(this)}]},{layout:"hbox",flex:1,border:false,layoutConfig:{padding:"5",align:"stretch"},defaults:{margins:"0 5 0 0"},items:[{flex:2,layout:"ux.display",labelWidth:60,layoutConfig:{background:"solid"},items:[{xtype:"ux.displayfield",name:"dtstart",fieldLabel:this.app.i18n._("Start Time"),renderer:this.datetimeRenderer.createDelegate(this)},{xtype:"ux.displayfield",name:"dtend",fieldLabel:this.app.i18n._("End Time"),renderer:this.datetimeRenderer.createDelegate(this)},{xtype:"ux.displayfield",name:"transp",fieldLabel:this.app.i18n._("Blocking"),renderer:this.transpRenderer.createDelegate(this)},{xtype:"ux.displayfield",name:"status",fieldLabel:this.app.i18n._("Tentative"),renderer:this.statusRenderer.createDelegate(this)},{xtype:"ux.displayfield",name:"location",fieldLabel:this.app.i18n._("Location")},{xtype:"ux.displayfield",name:"organizer",fieldLabel:this.app.i18n._("Organizer"),renderer:function(a){return a&&a.n_fileas?a.n_fileas:""}}]},{flex:3,layout:"ux.display",labelAlign:"top",autoScroll:true,layoutConfig:{background:"solid"},items:[{xtype:"ux.displayfield",name:"attendee",nl2br:true,htmlEncode:false,fieldLabel:this.app.i18n._("Attendee"),renderer:this.attendeeRenderer}]},{flex:3,layout:"fit",border:false,items:[{cls:"x-ux-display-background-border",xtype:"ux.displaytextarea",name:"description"}]}]}]}]})}return this.singleRecordPanel},updateDetails:function(b,a){this.getSingleRecordPanel().loadRecord.defer(100,this.getSingleRecordPanel(),[b])}});Ext.ns("Tine.Calendar");Tine.Calendar.MainScreenCenterPanel=Ext.extend(Ext.Panel,{activeView:"weekSheet",startDate:new Date().clearTime(),startDates:null,loadMaskText:"Loading events, please wait...",autoRefreshInterval:300,autoRefreshTask:null,periodRe:/^(day|week|month)/i,presentationRe:/(sheet|grid)$/i,calendarPanels:{},border:false,layout:"border",stateful:true,stateId:"cal-mainscreen",stateEvents:["changeview"],getState:function(){return Ext.copyTo({},this,"activeView")},applyState:Ext.emptyFn,initComponent:function(){var a=this;this.addEvents("changeview");this.recordClass=Tine.Calendar.Model.Event;this.app=Tine.Tinebase.appMgr.get("Calendar");this.i18nRecordName=this.app.i18n.n_hidden(this.recordClass.getMeta("recordName"),this.recordClass.getMeta("recordsName"),1);this.i18nRecordsName=this.app.i18n._hidden(this.recordClass.getMeta("recordsName"));this.i18nContainerName=this.app.i18n.n_hidden(this.recordClass.getMeta("containerName"),this.recordClass.getMeta("containersName"),1);this.i18nContainersName=this.app.i18n._hidden(this.recordClass.getMeta("containersName"));this.loadMaskText=this.app.i18n._hidden(this.loadMaskText);var b=Ext.state.Manager.get(this.stateId,{});Ext.apply(this,b);this.defaultFilters=[{field:"attender",operator:"in",value:[Ext.apply(Tine.Calendar.Model.Attender.getDefaultData(),{user_id:Tine.Tinebase.registry.get("currentAccount")})]},{field:"attender_status",operator:"notin",value:["DECLINED"]}];this.filterToolbar=this.getFilterToolbar({onFilterChange:this.refresh.createDelegate(this,[false]),getAllFilterData:this.getAllFilterData.createDelegate(this)});this.filterToolbar.getQuickFilterPlugin().criteriaIgnores.push({field:"period"},{field:"grants"});this.startDates=[];this.initActions();this.initLayout();this.autoRefreshTask=new Ext.util.DelayedTask(this.refresh,this,[{refresh:true,autoRefresh:true}]);Tine.Calendar.MainScreenCenterPanel.superclass.initComponent.call(this)},initActions:function(){this.action_editInNewWindow=new Ext.Action({requiredGrant:"readGrant",text:this.i18nEditActionText?this.app.i18n._hidden(this.i18nEditActionText):String.format(Tine.Tinebase.translation._hidden("Edit {0}"),this.i18nRecordName),disabled:true,handler:this.onEditInNewWindow.createDelegate(this,["edit"]),iconCls:"action_edit"});this.action_addInNewWindow=new Ext.Action({requiredGrant:"addGrant",text:this.i18nAddActionText?this.app.i18n._hidden(this.i18nAddActionText):String.format(Tine.Tinebase.translation._hidden("Add {0}"),this.i18nRecordName),handler:this.onEditInNewWindow.createDelegate(this,["add"]),iconCls:"action_add"});this.action_deleteRecord=new Ext.Action({requiredGrant:"deleteGrant",allowMultiple:true,singularText:this.i18nDeleteActionText?i18nDeleteActionText[0]:String.format(Tine.Tinebase.translation.n_hidden("Delete {0}","Delete {0}",1),this.i18nRecordName),pluralText:this.i18nDeleteActionText?i18nDeleteActionText[1]:String.format(Tine.Tinebase.translation.n_hidden("Delete {0}","Delete {0}",1),this.i18nRecordsName),translationObject:this.i18nDeleteActionText?this.app.i18n:Tine.Tinebase.translation,text:this.i18nDeleteActionText?this.i18nDeleteActionText[0]:String.format(Tine.Tinebase.translation.n_hidden("Delete {0}","Delete {0}",1),this.i18nRecordName),handler:this.onDeleteRecords,disabled:true,iconCls:"action_delete",scope:this});this.actions_print=new Ext.Action({requiredGrant:"readGrant",text:this.app.i18n._("Print Page"),handler:this.onPrint,iconCls:"action_print",scope:this});this.showSheetView=new Ext.Button({pressed:String(this.activeView).match(/sheet$/i),scale:"medium",minWidth:60,rowspan:2,iconAlign:"top",requiredGrant:"readGrant",text:this.app.i18n._("Sheet"),handler:this.changeView.createDelegate(this,["sheet"]),iconCls:"cal-sheet-view-type",xtype:"tbbtnlockedtoggle",toggleGroup:"Calendar_Toolbar_tgViewTypes",scope:this});this.showGridView=new Ext.Button({pressed:String(this.activeView).match(/grid$/i),scale:"medium",minWidth:60,rowspan:2,iconAlign:"top",requiredGrant:"readGrant",text:this.app.i18n._("Grid"),handler:this.changeView.createDelegate(this,["grid"]),iconCls:"cal-grid-view-type",xtype:"tbbtnlockedtoggle",toggleGroup:"Calendar_Toolbar_tgViewTypes",scope:this});this.showDayView=new Ext.Toolbar.Button({pressed:String(this.activeView).match(/^day/i),text:this.app.i18n._("Day"),iconCls:"cal-day-view",xtype:"tbbtnlockedtoggle",handler:this.changeView.createDelegate(this,["day"]),enableToggle:true,toggleGroup:"Calendar_Toolbar_tgViews"});this.showWeekView=new Ext.Toolbar.Button({pressed:String(this.activeView).match(/^week/i),text:this.app.i18n._("Week"),iconCls:"cal-week-view",xtype:"tbbtnlockedtoggle",handler:this.changeView.createDelegate(this,["week"]),enableToggle:true,toggleGroup:"Calendar_Toolbar_tgViews"});this.showMonthView=new Ext.Toolbar.Button({pressed:String(this.activeView).match(/^month/i),text:this.app.i18n._("Month"),iconCls:"cal-month-view",xtype:"tbbtnlockedtoggle",handler:this.changeView.createDelegate(this,["month"]),enableToggle:true,toggleGroup:"Calendar_Toolbar_tgViews"});this.changeViewActions=[this.showDayView,this.showWeekView,this.showMonthView];this.recordActions=[this.action_editInNewWindow,this.action_deleteRecord];this.actionUpdater=new Tine.widgets.ActionUpdater({actions:this.recordActions,grantsProperty:false,containerProperty:false})},getActionToolbar:Tine.widgets.grid.GridPanel.prototype.getActionToolbar,getActionToolbarItems:function(){return{xtype:"buttongroup",items:[this.showSheetView,this.showGridView]}},initLayout:function(){this.items=[{region:"center",layout:"card",activeItem:0,border:false,items:[this.getCalendarPanel(this.activeView)]}];if(this.detailsPanel){this.items.push({region:"south",border:false,collapsible:true,collapseMode:"mini",header:false,split:true,layout:"fit",height:this.detailsPanel.defaultHeight?this.detailsPanel.defaultHeight:125,items:this.detailsPanel})}if(this.filterToolbar){this.items.push({region:"north",border:false,items:this.filterToolbar,listeners:{scope:this,afterlayout:function(a){a.suspendEvents();a.setHeight(this.filterToolbar.getHeight());a.ownerCt.layout.layout();a.resumeEvents()}}})}},onRender:function(b,a){Tine.Calendar.MainScreenCenterPanel.superclass.onRender.apply(this,arguments);this.loadMask=new Ext.LoadMask(this.body,{msg:this.loadMaskText})},getViewParts:function(h){h=String(h);var a=String(this.activeView),i=h.match(this.periodRe),g=Ext.isArray(i)?i[0]:null,b=a.match(this.periodRe),c=Ext.isArray(b)?b[0]:"week",e=h.match(this.presentationRe),d=Ext.isArray(e)?e[0]:null,f=a.match(this.presentationRe),j=Ext.isArray(f)?f[0]:"sheet";return{period:g?g:c,presentation:d?d:j,toString:function(){return this.period+Ext.util.Format.capitalize(this.presentation)}}},changeView:function(g,b){var f=this.getViewParts(g);g=f.toString();Tine.log.debug("Tine.Calendar.MainScreenCenterPanel::changeView("+g+","+b+")");this.startDates[this.activeView]=this.startDate.clone();if(b&&Ext.isDate(b)){this.startDate=b.clone()}else{var d=this.startDates[g],j=this.getCalendarPanel(this.activeView).getView().getPeriod();if(Ext.isDate(d)&&d.between(j.from,j.until)){this.startDate=this.startDates[g].clone()}}var a=this.getCalendarPanel(g);var e=this.items.first();if(a.rendered){e.layout.setActiveItem(a.id)}else{e.add(a);e.layout.setActiveItem(a.id);e.doLayout()}this.activeView=g;var h=Ext.get(Ext.DomQuery.selectNode("tr[class=x-toolbar-right-row]",a.tbar.dom));for(var c=this.changeViewActions.length-1;c>=0;c--){h.insertFirst(this.changeViewActions[c].getEl().parent().dom)}this["show"+Ext.util.Format.capitalize(f.period)+"View"].toggle(true);this["show"+Ext.util.Format.capitalize(f.presentation)+"View"].toggle(true);this.updateEventActions();a.getView().updatePeriod({from:this.startDate});a.getStore().load({});this.fireEvent("changeview",this,g)},getAllFilterData:function(){var a=this.getCalendarPanel(this.activeView).getStore();var b={refresh:true,noPeriodFilter:true};this.onStoreBeforeload(a,b);return b.params.filter},getCustomfieldFilters:Tine.widgets.grid.GridPanel.prototype.getCustomfieldFilters,getFilterToolbar:Tine.widgets.grid.GridPanel.prototype.getFilterToolbar,getStore:function(){return this.getCalendarPanel(this.activeView).getStore()},onContextMenu:function(d){d.stopEvent();var j=this.getCalendarPanel(this.activeView).getView();var a=j.getTargetEvent(d);var f=j.getTargetDateTime(d);var h,b,i;if(f||a){var g=f||a.get("dtstart").clone();if(g.format("H:i")==="00:00"){g=g.add(Date.HOUR,9)}h={text:this.i18nAddActionText?this.app.i18n._hidden(this.i18nAddActionText):String.format(Tine.Tinebase.translation._hidden("Add {0}"),this.i18nRecordName),handler:this.onEditInNewWindow.createDelegate(this,["add",null,null,{dtStart:g,is_all_day_event:f&&f.is_all_day_event}]),iconCls:"action_add"};if(a){b=this.getResponseAction(a);i=this.getCopyAction(a)}}else{h=this.action_addInNewWindow}if(a){j.getSelectionModel().select(a,d,d.ctrlKey)}else{j.getSelectionModel().clearSelections()}var c=new Ext.menu.Menu({items:this.recordActions.concat(h,b||[],i||[])});c.showAt(d.getXY())},getResponseAction:function(b){var f=Tine.Tinebase.widgets.keyfield.StoreMgr.get("Calendar","attendeeStatus"),e=b.getMyAttenderRecord(),d=e?e.get("status"):null,a=f.getById(d),c=null;if(e){c={text:this.app.i18n._("Set my response"),icon:a?a.get("icon"):false,menu:[]};f.each(function(g){c.menu.push({text:g.get("i18nValue"),handler:this.setResponseStatus.createDelegate(this,[b,g.id]),icon:g.get("icon"),disabled:e.get("status")===g.id})},this)}return c},getCopyAction:function(b){var a={text:String.format(_("Copy {0}"),this.i18nRecordName),handler:this.onEditInNewWindow.createDelegate(this,["copy",b]),iconCls:"action_editcopy"};return a},checkPastEvent:function(c,f,a){var h=c.get("dtstart").getTime();var e=new Date().clearTime().getTime();switch(a){case"update":var g=this.app.i18n._("Updating event in the past"),d=this.app.i18n._("Update this event"),b=this.app.i18n._("Do not update this event");break;case"add":default:var g=this.app.i18n._("Creating event in the past"),d=this.app.i18n._("Create this event"),b=this.app.i18n._("Do not create this event")}if(h<e){Tine.widgets.dialog.MultiOptionsDialog.openWindow({title:g,height:170,scope:this,options:[{text:d,name:"yes"},{text:b,name:"no"}],handler:function(l){try{switch(l){case"yes":if(a=="update"){this.onUpdateEvent(c,true,a)}else{this.onAddEvent(c,f,true)}break;case"no":default:try{var j=this.getCalendarPanel(this.activeView);if(j){var k=j.getStore(),i=j.getView()}}catch(m){var j=null,k=null,i=null}if(a=="add"){if(k){k.remove(c)}}else{if(i&&i.calPanel&&i.rendered){this.loadMask.show();k.reload()}this.setLoading(false)}}}catch(m){Tine.log.error("Tine.Calendar.MainScreenCenterPanel::checkPastEvent::handler");Tine.log.error(m)}}})}else{if(a=="update"){this.onUpdateEvent(c,true,a)}else{this.onAddEvent(c,f,true)}}},onAddEvent:function(e,f,d){if(!d){this.checkPastEvent(e,f,"add");return}this.setLoading(true);if(e.get("id").match(/new/)){e.set("id","")}if(e.isRecurBase()){this.loadMask.show()}var b=this.getCalendarPanel(this.activeView),c=b.getStore(),a=b.getView();Tine.Calendar.backend.saveRecord(e,{scope:this,success:function(g){if(g.isRecurBase()){c.load({refresh:true})}else{c.replaceRecord(e,g);this.setLoading(false);if(a&&a.calPanel&&a.rendered){a.getSelectionModel().select(g)}}},failure:this.onProxyFail.createDelegate(this,[e],true)},{checkBusyConflicts:f===false?0:1})},onUpdateEvent:function(c,a,b){if(!b||b=="edit"){b="update"}this.setLoading(true);if(!a){this.checkPastEvent(c,null,b);return}if(c.isRecurBase()){if(this.loadMask){this.loadMask.show()}}if(c.isRecurInstance()||(c.isRecurBase()&&!c.get("rrule").newrule)){Tine.widgets.dialog.MultiOptionsDialog.openWindow({title:this.app.i18n._("Update Event"),height:170,scope:this,options:[{text:this.app.i18n._("Update this event only"),name:"this"},{text:this.app.i18n._("Update this and all future events"),name:(c.isRecurBase()&&!c.get("rrule").newrule)?"series":"future"},{text:this.app.i18n._("Update whole series"),name:"series"},{text:this.app.i18n._("Update nothing"),name:"cancel"}],handler:function(h){var e=this.getCalendarPanel(this.activeView),f=e.getStore(),d=e.getView();switch(h){case"series":if(this.loadMask){this.loadMask.show()}var g={scope:this,success:function(){f.load({refresh:true})},failure:this.onProxyFail.createDelegate(this,[c],true)};Tine.Calendar.backend.updateRecurSeries(c,g);break;case"this":case"future":var g={scope:this,success:function(i){if(h==="this"){c=f.indexOf(c)!=-1?c:f.getById(c.id);this.congruenceFilterCheck(c,i)}else{f.load({refresh:true})}},failure:this.onProxyFail.createDelegate(this,[c],true)};Tine.Calendar.backend.createRecurException(c,false,h=="future",g);break;default:if(this.loadMask){this.loadMask.show();f.load({refresh:true})}break}}})}else{this.onUpdateEventAction(c)}},onUpdateEventAction:function(d){var b=this.getCalendarPanel(this.activeView),c=b.getStore(),a=b.getView();Tine.Calendar.backend.saveRecord(d,{scope:this,success:function(e){if(e.isRecurBase()){c.load({refresh:true})}else{if(a&&a.calPanel&&a.rendered){this.congruenceFilterCheck(d,e)}else{if(d){c.replaceRecord(d,e)}else{c.add(e)}this.setLoading(false)}}},failure:this.onProxyFail.createDelegate(this,[d],true)},{checkBusyConflicts:1})},congruenceFilterCheck:function(e,d){var f=this.getAllFilterData(),b=this.getCalendarPanel(this.activeView),c=b.getStore(),a=b.getView();if(!a.rendered){return}f[0].filters[0].filters.push({field:"id",operator:"in",value:[d.get("id")]});Tine.Calendar.searchEvents(f,{},function(h){if(e){c.replaceRecord(e,d)}else{c.add(d)}a.getSelectionModel().select(d);var g=a.getSelectionModel().getSelected();if(h.totalcount==0){g.ui.markOutOfFilter()}this.setLoading(false)},this)},onDeleteRecords:function(){var a=this.getCalendarPanel(this.activeView);var c=a.getSelectionModel().getSelectedEvents();var e=false;var b=false;Ext.each(c,function(f){if(f.ui){f.ui.markDirty()}if(f.isRecurInstance()){b=true}if(f.isRecurBase()){e=true}});if(c.length>1&&(e||b)){Ext.Msg.show({title:this.app.i18n._("Please Change Selection"),msg:this.app.i18n._("Your selection contains recurring events. Recuring events must be deleted seperatly!"),icon:Ext.MessageBox.INFO,buttons:Ext.Msg.OK,scope:this,fn:function(){this.onDeleteRecordsConfirmFail(a,c)}});return}if(c.length===1&&(e||b)){this.deleteMethodWin=Tine.widgets.dialog.MultiOptionsDialog.openWindow({title:this.app.i18n._("Delete Event"),scope:this,height:170,options:[{text:this.app.i18n._("Delete this event only"),name:"this"},{text:this.app.i18n._("Delete this and all future events"),name:e?"all":"future"},{text:this.app.i18n._("Delete whole series"),name:"all"},{text:this.app.i18n._("Delete nothing"),name:"nothing"}],handler:function(g){try{switch(g){case"all":case"this":case"future":a.getTopToolbar().beforeLoad();if(g!=="this"){this.loadMask.show()}var f={scope:this,success:function(){if(g==="this"){Ext.each(c,function(i){a.getStore().remove(i)})}this.refresh(true)}};if(g==="all"){Tine.Calendar.backend.deleteRecurSeries(c[0],f)}else{Tine.Calendar.backend.createRecurException(c[0],true,g==="future",f)}break;default:this.onDeleteRecordsConfirmFail(a,c);break}}catch(h){Tine.log.error("Tine.Calendar.MainScreenCenterPanel::onDeleteRecords::handle");Tine.log.error(h)}}});return}var d=String.format(this.app.i18n.ngettext("Do you really want to delete this event?","Do you really want to delete the {0} selected events?",c.length),c.length);Ext.MessageBox.confirm(Tine.Tinebase.translation._hidden("Confirm"),d,function(f){if(f==="yes"){this.onDeleteRecordsConfirmNonRecur(a,c)}else{this.onDeleteRecordsConfirmFail(a,c)}},this)},onDeleteRecordsConfirmNonRecur:function(a,c){a.getTopToolbar().beforeLoad();var d=Ext.unique(c);var b={scope:this,success:function(){a.getTopToolbar().onLoad();Ext.each(d,function(e){a.getStore().remove(e)})},failure:function(){a.getTopToolbar().onLoad();Ext.MessageBox.alert(Tine.Tinebase.translation._hidden("Failed"),String.format(this.app.i18n.n_("Failed to delete event","Failed to delete the {0} events",c.length),c.length))}};Tine.Calendar.backend.deleteRecords(c,b)},onDeleteRecordsConfirmFail:function(a,b){Ext.each(b,function(c){c.ui.clearDirty()})},onEditInNewWindow:function(e,d,b,f){if(!d){d=null}if(Ext.isObject(e)){e=e.actionType}if(e==="edit"&&!d){var a=this.getCalendarPanel(this.activeView);var c=a.getSelectionModel().getSelectedEvents();if(Ext.isArray(c)&&c.length===1){d=c[0]}}if(e==="edit"&&(!d||d.dirty)){return}if(!d){d=new Tine.Calendar.Model.Event(Ext.apply(Tine.Calendar.Model.Event.getDefaultData(),f),0);if(f&&Ext.isDate(f.dtStart)){d.set("dtstart",f.dtStart);d.set("dtend",f.dtStart.add(Date.HOUR,1))}}Tine.log.debug("Tine.Calendar.MainScreenCenterPanel::onEditInNewWindow() - Opening event edit dialog with action: "+e);Tine.Calendar.EventEditDialog.openWindow({plugins:b?Ext.encode(b):null,record:Ext.encode(d.data),recordId:d.data.id,copyRecord:(e=="copy"),listeners:{scope:this,update:function(j){var i=Tine.Calendar.backend.recordReader({responseText:j});i.dirty=true;i.modified={};d.phantom=(e==="edit");var g=this.getCalendarPanel(this.activeView);var h=g.getStore();d=h.getById(d.id);if(d&&e!=="copy"){h.replaceRecord(d,i)}else{h.add(i)}this.onUpdateEvent(i,false,e)}}})},onKeyDown:function(a){if(a.ctrlKey){switch(a.getKey()){case a.A:a.preventDefault();break;case a.E:if(!this.action_editInNewWindow.isDisabled()){this.onEditInNewWindow("edit")}a.preventDefault();break;case a.N:if(!this.action_addInNewWindow.isDisabled()){this.onEditInNewWindow("add")}a.preventDefault();break}}else{if(a.getKey()===a.DELETE){if(!this.action_deleteRecord.isDisabled()){this.onDeleteRecords.call(this)}}}},onPrint:function(){var b=this.getCalendarPanel(this.activeView),a=b?b.getView():null;if(a&&Ext.isFunction(a.print)){a.print()}else{Ext.Msg.alert(this.app.i18n._("Could not Print"),this.app.i18n._("Sorry, your current view does not support printing."))}},onStoreBeforeload:function(a,b){b.params=b.params||{};this.lastStoreTransactionId=b.transactionId=Ext.id();b.params.filter=[];if(!b.refresh&&this.rendered){this.loadMask.show.defer(50,this.loadMask)}this.filterToolbar.onBeforeLoad.call(this.filterToolbar,a,b);if(!b.noPeriodFilter){b.params.filter.push({field:"period",operator:"within",value:this.getCalendarPanel(this.activeView).getView().getPeriod()})}},onStoreBeforeLoadRecords:function(c,a,b){return this.lastStoreTransactionId===a.transactionId},onStoreLoad:function(a,b){if(this.rendered){this.loadMask.hide()}if(window.isMainWindow&&this.autoRefreshInterval){this.autoRefreshTask.delay(this.autoRefreshInterval*1000)}if(a!==this.getCalendarPanel(this.activeView).getStore()){Tine.log.debug("Tine.Calendar.MainScreenCenterPanel::onStoreLoad view is not active anymore");return}if(this.rendered){if(this.filterToolbar){this.filterToolbar.setValue(a.proxy.jsonReader.jsonData.filter)}Tine.Tinebase.appMgr.get("Calendar").getMainScreen().getWestPanel().getContainerTreePanel().getFilterPlugin().setValue(a.proxy.jsonReader.jsonData.filter)}},onStoreLoadException:function(c,d,b,a){if(window.isMainWindow&&this.autoRefreshInterval){this.autoRefreshTask.delay(this.autoRefreshInterval*5000)}this.setLoading(false);this.loadMask.hide();if(!a.autoRefresh){this.onProxyFail(b)}},onProxyFail:function(c,d){this.setLoading(false);if(this.loadMask){this.loadMask.hide()}if(c.code==901){var a=[];var e={};var f=Tine.Calendar.Model.Attender.getAttendeeStore(c.event.attendee);Ext.each(c.freebusyinfo,function(g){f.each(function(h){var i=h.get("user_type");i=i=="groupmember"?"user":i;if(i==g.user_type&&h.getUserId()==g.user_id){if(a.indexOf(h)<0){a.push(h);e[h.id]=[]}e[h.id].push(g)}})},this);var b="";Ext.each(a,function(i){var h=Tine.Calendar.AttendeeGridPanel.prototype.renderAttenderName.call(Tine.Calendar.AttendeeGridPanel.prototype,i.get("user_id"),false,i);b+='<div class="cal-conflict-attendername">'+h+"</div>";var g=[];Ext.each(e[i.id],function(m){var l="H:i";var j=Ext.form.DateField.prototype.format;if(d.get("dtstart").format(j)!=d.get("dtend").format(j)||Date.parseDate(m.dtstart,Date.patterns.ISO8601Long).format(j)!=Date.parseDate(m.dtend,Date.patterns.ISO8601Long).format(j)){l=j+" "+l}var k=Date.parseDate(m.dtstart,Date.patterns.ISO8601Long).format(l)+" - "+Date.parseDate(m.dtend,Date.patterns.ISO8601Long).format(l);if(m.event&&m.event.summary){k+=" : "+m.event.summary}g.push(k)},this);b+='<div class="cal-conflict-eventinfos">'+g.join(", <br />")+"</div>"});this.conflictConfirmWin=Tine.widgets.dialog.MultiOptionsDialog.openWindow({modal:true,allowCancel:false,height:180+15*c.freebusyinfo.length,title:this.app.i18n._("Scheduling Conflict"),questionText:'<div class = "cal-conflict-heading">'+this.app.i18n._("The following attendee are busy at the requested time:")+"</div>"+b,options:[{text:this.app.i18n._("Ignore Conflict"),name:"ignore"},{text:this.app.i18n._("Edit Event"),name:"edit",checked:true},{text:this.app.i18n._("Cancel this action"),name:"cancel"}],scope:this,handler:function(l){var i=this.getCalendarPanel(this.activeView),j=i.getStore();switch(l){case"ignore":this.onAddEvent(d,false,true);this.conflictConfirmWin.close();break;case"edit":var h=this.activeView.match(this.presentationRe),k=Ext.isArray(h)?h[0]:null;if(k!="Grid"){var g=i.getView();g.getSelectionModel().select(d);d.dirty=false;g.fireEvent("dblclick",g,d)}else{this.onEditInNewWindow(null,d)}this.conflictConfirmWin.close();break;case"cancel":default:this.conflictConfirmWin.close();this.loadMask.show();j.load({refresh:true});break}}})}else{Tine.Tinebase.ExceptionHandler.handleRequestException(c)}},refresh:function(b){b=Ext.isObject(b)?b:{refresh:!!b};Tine.log.debug("Tine.Calendar.MainScreenCenterPanel::refresh("+b.refresh+")");var a=this.getCalendarPanel(this.activeView);a.getStore().load(b);Tine.Tinebase.appMgr.get("Calendar").getMainScreen().getWestPanel().getFavoritesPanel().getSelectionModel().clearSelections()},setLoading:function(b){var a=this.getCalendarPanel(this.activeView),c=a.getTopToolbar();if(c&&c.loading){c.loading[b?"disable":"enable"]()}},setResponseStatus:function(d,b){var e=d.getMyAttenderRecord();if(e){e.set("status",b);d.dirty=true;d.modified={};var a=this.getCalendarPanel(this.activeView);var c=a.getStore();c.replaceRecord(d,d);this.onUpdateEvent(d)}},updateEventActions:function(){var a=this.getCalendarPanel(this.activeView);var b=a.getSelectionModel().getSelectedEvents();this.actionUpdater.updateActions(b);if(this.detailsPanel){this.detailsPanel.onDetailsUpdate(a.getSelectionModel())}},updateView:function(c){Tine.log.debug("Tine.Calendar.MainScreenCenterPanel::updateView("+c+")");var a=this.getCalendarPanel(c);var b=a.getTopToolbar().getPeriod();a.getView().updatePeriod(b);a.getStore().load({})},getCalendarPanel:function(d){var c=this.getViewParts(d);d=c.toString();if(!this.calendarPanels[d]){Tine.log.debug("Tine.Calendar.MainScreenCenterPanel::getCalendarPanel creating new calender panel for view "+d);var b=new Ext.data.JsonStore({id:"id",fields:Tine.Calendar.Model.Event,proxy:Tine.Calendar.backend,reader:new Ext.data.JsonReader({}),listeners:{scope:this,beforeload:this.onStoreBeforeload,beforeloadrecords:this.onStoreBeforeLoadRecords,load:this.onStoreLoad,loadexception:this.onStoreLoadException},replaceRecord:function(g,h){var f=this.indexOf(g);this.remove(g);this.insert(f,h)}});var e=new Tine.Calendar.PagingToolbar({view:c.period,store:b,dtStart:this.startDate,listeners:{scope:this,render:function(g){for(var f=0;f<this.changeViewActions.length;f+=1){if(!this.changeViewActions[f].rendered){g.addButton(this.changeViewActions[f])}}}}});e.on("change",this.updateView.createDelegate(this,[d]),this,{buffer:200});e.on("refresh",this.refresh.createDelegate(this,[true]),this,{buffer:200});if(c.presentation.match(/sheet/i)){var a;switch(d){case"daySheet":a=new Tine.Calendar.DaysView({startDate:e.getPeriod().from,numOfDays:1});break;case"monthSheet":a=new Tine.Calendar.MonthView({period:e.getPeriod()});break;default:case"weekSheet":a=new Tine.Calendar.DaysView({startDate:e.getPeriod().from,numOfDays:7});break}a.on("changeView",this.changeView,this);a.on("changePeriod",function(f){this.startDate=f.from;this.startDates[d]=this.startDate.clone();this.updateMiniCal()},this);a.on("addEvent",this.onAddEvent,this);a.on("updateEvent",this.onUpdateEvent,this);this.calendarPanels[d]=new Tine.Calendar.CalendarPanel({tbar:e,store:b,view:a})}else{if(c.presentation.match(/grid/i)){this.calendarPanels[d]=new Tine.Calendar.GridView({tbar:e,store:b})}}this.calendarPanels[d].on("dblclick",this.onEditInNewWindow.createDelegate(this,["edit"]));this.calendarPanels[d].on("contextmenu",this.onContextMenu,this);this.calendarPanels[d].getSelectionModel().on("selectionchange",this.updateEventActions,this);this.calendarPanels[d].on("keydown",this.onKeyDown,this);this.calendarPanels[d].on("render",function(){var g=Tine.widgets.persistentfilter.model.PersistentFilter.getDefaultFavorite(this.app.appName);var f=this.app.getMainScreen().getWestPanel().getFavoritesPanel();f.selectFilter(g)},this);this.calendarPanels[d].relayEvents(this,["show","beforehide"])}return this.calendarPanels[d]},updateMiniCal:function(){var d=Ext.getCmp("cal-mainscreen-minical");var b=null;var f=this.getCalendarPanel(this.activeView).getView().getPeriod();switch(this.activeView){case"week":b=[f.from.add(Date.DAY,1).getWeekOfYear()];break;case"month":b=[];var a=f.from.add(Date.DAY,1).getWeekOfYear();var e=Math.round((f.until.getTime()-f.from.getTime())/Date.msWEEK);for(var c=0;c<e;c+=1){b.push(a+c)}break}d.update(this.startDate,true,b)}});Ext.ns("Tine.Calendar");Tine.Calendar.WestPanel=Ext.extend(Tine.widgets.mainscreen.WestPanel,{cls:"cal-tree",getAdditionalItems:function(){return[Ext.apply({title:this.app.i18n._("Mini Calendar"),forceLayout:true,border:false,layout:"hbox",layoutConfig:{align:"middle"},defaults:{border:false},items:[{flex:1},this.getDatePicker(),{flex:1}]},this.defaults)]},getDatePicker:function(){if(!this.datePicker){this.datePicker=new Ext.DatePicker({width:200,id:"cal-mainscreen-minical",plugins:[new Ext.ux.DatePickerWeekPlugin({weekHeaderString:Tine.Tinebase.appMgr.get("Calendar").i18n._("WK"),inspectMonthPickerClick:function(a,c){if(c.getTarget("button")){var b=Tine.Tinebase.appMgr.get("Calendar").getMainScreen().getCenterPanel();b.changeView("month",this.activeDate);return false}}})],listeners:{scope:this,select:function(b,c,a){var d=Tine.Tinebase.appMgr.get("Calendar").getMainScreen().getCenterPanel();d.changeView(a?"week":"day",c)}}})}return this.datePicker}});Ext.namespace("Tine.Calendar");Ext.onReady(function(){Ext.util.CSS.updateRule(".CalendarIconCls","background-image","url(../../images/view-calendar-day-"+new Date().getDate()+".png)")});Tine.Calendar.Application=Ext.extend(Tine.Tinebase.Application,{addButtonText:"New Event",getTitle:function(){return this.i18n.ngettext("Calendar","Calendars",1)},getIconCls:function(a){switch(a){case"PreferencesTreePanel":return"PreferencesTreePanel-CalendarIconCls";break;default:return"CalendarIconCls";break}},init:function(){Tine.Calendar.Application.superclass.init.apply(this.arguments);new Tine.Calendar.AddressbookGridPanelHook({app:this});if(Tine.Felamimail){Tine.Felamimail.MimeDisplayManager.register("text/calendar",Tine.Calendar.iMIPDetailsPanel)}}});Tine.Calendar.MainScreen=function(a){Ext.apply(this,a);Tine.Calendar.colorMgr=new Tine.Calendar.ColorManager({});Tine.Calendar.MainScreen.superclass.constructor.apply(this,arguments)};Ext.extend(Tine.Calendar.MainScreen,Tine.widgets.MainScreen,{getCenterPanel:function(){if(!this.contentPanel){this.contentPanel=new Tine.Calendar.MainScreenCenterPanel({detailsPanel:new Tine.Calendar.EventDetailsPanel()})}return this.contentPanel},showNorthPanel:function(){if(!this.actionToolbar){this.actionToolbar=this.contentPanel.getActionToolbar()}Tine.Tinebase.MainScreen.setActiveToolbar(this.actionToolbar,true)}});Tine.Calendar.handleRequestException=Tine.Tinebase.ExceptionHandler.handleRequestException;Ext.ns("Tine.Calendar");Tine.Calendar.EventEditDialog=Ext.extend(Tine.widgets.dialog.EditDialog,{containerId:-1,labelAlign:"side",windowNamePrefix:"EventEditWindow_",appName:"Calendar",recordClass:Tine.Calendar.Model.Event,recordProxy:Tine.Calendar.backend,showContainerSelector:false,tbarItems:[{xtype:"widget-activitiesaddbutton"}],mode:"local",evalGrants:false,onResize:function(){Tine.Calendar.EventEditDialog.superclass.onResize.apply(this,arguments);this.setTabHeight.defer(100,this)},getFormItems:function(){return{xtype:"tabpanel",border:false,plugins:[{ptype:"ux.tabpanelkeyplugin"}],plain:true,activeTab:0,border:false,items:[{title:this.app.i18n.n_("Event","Events",1),border:false,frame:true,layout:"border",items:[{region:"center",layout:"hfit",border:false,items:[{layout:"hbox",items:[{margins:"5",width:100,xtype:"label",text:this.app.i18n._("Summary")},{flex:1,xtype:"textfield",name:"summary",listeners:{render:function(a){a.focus(false,250)}},allowBlank:false,requiredGrant:"editGrant",maxLength:255}]},{layout:"hbox",items:[{margins:"5",width:100,xtype:"label",text:this.app.i18n._("View")},Ext.apply(this.perspectiveCombo,{flex:1})]},{layout:"hbox",height:115,layoutConfig:{align:"stretch",pack:"start"},items:[{flex:1,xtype:"fieldset",layout:"hfit",margins:"0 5 0 0",title:this.app.i18n._("Details"),items:[{xtype:"columnform",labelAlign:"side",labelWidth:100,formDefaults:{xtype:"textfield",anchor:"100%",labelSeparator:"",columnWidth:0.7},items:[[{columnWidth:1,fieldLabel:this.app.i18n._("Location"),name:"location",requiredGrant:"editGrant",maxLength:255}],[{xtype:"datetimefield",fieldLabel:this.app.i18n._("Start Time"),listeners:{scope:this,change:this.onDtStartChange},name:"dtstart",requiredGrant:"editGrant"},{columnWidth:0.19,xtype:"checkbox",hideLabel:true,boxLabel:this.app.i18n._("whole day"),listeners:{scope:this,check:this.onAllDayChange},name:"is_all_day_event",requiredGrant:"editGrant"}],[{xtype:"datetimefield",fieldLabel:this.app.i18n._("End Time"),listeners:{scope:this,change:this.onDtEndChange},name:"dtend",requiredGrant:"editGrant"},{columnWidth:0.3,xtype:"combo",hideLabel:true,readOnly:true,hideTrigger:true,disabled:true,name:"originator_tz",requiredGrant:"editGrant"}],[this.containerSelectCombo=new Tine.widgets.container.selectionComboBox({columnWidth:1,id:this.app.appName+"EditDialogContainerSelector"+Ext.id(),fieldLabel:_("Saved in"),ref:"../../../../../../../../containerSelect",name:this.recordClass.getMeta("containerProperty"),recordClass:this.recordClass,containerName:this.app.i18n.n_hidden(this.recordClass.getMeta("containerName"),this.recordClass.getMeta("containersName"),1),containersName:this.app.i18n._hidden(this.recordClass.getMeta("containersName")),appName:this.app.appName,requiredGrants:this.record.data.id?["editGrant"]:["addGrant"],disabled:true})]]}]},{width:130,xtype:"fieldset",title:this.app.i18n._("Status"),items:[{xtype:"checkbox",hideLabel:true,boxLabel:this.app.i18n._("non-blocking"),name:"transp",requiredGrant:"editGrant",getValue:function(){var a=Ext.form.Checkbox.prototype.getValue.call(this);return a?"TRANSPARENT":"OPAQUE"},setValue:function(b){var a=(b=="TRANSPARENT"||b===true);return Ext.form.Checkbox.prototype.setValue.call(this,a)}},Ext.apply(this.perspectiveCombo.getAttendeeTranspField(),{hideLabel:true}),{xtype:"checkbox",hideLabel:true,boxLabel:this.app.i18n._("Tentative"),name:"status",requiredGrant:"editGrant",getValue:function(){var a=Ext.form.Checkbox.prototype.getValue.call(this);return a?"TENTATIVE":"CONFIRMED"},setValue:function(b){var a=(b=="TENTATIVE"||b===true);return Ext.form.Checkbox.prototype.setValue.call(this,a)}},{xtype:"checkbox",hideLabel:true,boxLabel:this.app.i18n._("Private"),name:"class",requiredGrant:"editGrant",getValue:function(){var a=Ext.form.Checkbox.prototype.getValue.call(this);return a?"PRIVATE":"PUBLIC"},setValue:function(b){var a=(b=="PRIVATE"||b===true);return Ext.form.Checkbox.prototype.setValue.call(this,a)}},Ext.apply(this.perspectiveCombo.getAttendeeStatusField(),{width:115,hideLabel:true})]}]},{xtype:"tabpanel",deferredRender:false,activeTab:0,border:false,height:235,form:true,items:[this.attendeeGridPanel,this.rrulePanel,this.alarmPanel]}]},{region:"east",layout:"accordion",animate:true,width:200,split:true,collapsible:true,collapseMode:"mini",header:false,margins:"0 5 0 5",border:true,items:[new Ext.Panel({title:this.app.i18n._("Description"),iconCls:"descriptionIcon",layout:"form",labelAlign:"top",border:false,items:[{style:"margin-top: -4px; border 0px;",labelSeparator:"",xtype:"textarea",name:"description",hideLabel:true,grow:false,preventScrollbars:false,anchor:"100% 100%",emptyText:this.app.i18n._("Enter description"),requiredGrant:"editGrant"}]}),new Tine.widgets.activities.ActivitiesPanel({app:"Calendar",showAddNoteForm:false,border:false,bodyStyle:"border:1px solid #B5B8C8;"}),new Tine.widgets.tags.TagPanel({app:"Calendar",border:false,bodyStyle:"border:1px solid #B5B8C8;"})]}]},new Tine.widgets.activities.ActivitiesTabPanel({app:this.appName,record_id:(this.record)?this.record.id:"",record_model:this.appName+"_Model_"+this.recordClass.getMeta("modelName")})]}},initComponent:function(){var a;this.attendeeGridPanel=new Tine.Calendar.AttendeeGridPanel({bbar:[{xtype:"label",html:Tine.Tinebase.appMgr.get("Calendar").i18n._("Organizer")+"&nbsp;"},a=Tine.widgets.form.RecordPickerManager.get("Addressbook","Contact",{width:300,name:"organizer",userOnly:true,getValue:function(){var c=Tine.Addressbook.SearchCombo.prototype.getValue.apply(this,arguments),b=this.store.getById(c);return b?b.data:c}})]});this.attendeeGridPanel.on("afteredit",function(b){if(b.field=="user_id"&&b.record.get("user_type")=="resource"&&b.record.get("user_id").is_location){this.getForm().findField("location").setValue(this.attendeeGridPanel.renderAttenderResourceName(b.record.get("user_id")))}},this);this.on("render",function(){this.getForm().add(a)},this);this.rrulePanel=new Tine.Calendar.RrulePanel({});this.alarmPanel=new Tine.widgets.dialog.AlarmPanel({});this.attendeeStore=this.attendeeGridPanel.getStore();this.perspectiveCombo=new Tine.Calendar.PerspectiveCombo({editDialog:this});Tine.Calendar.EventEditDialog.superclass.initComponent.call(this)},isValid:function(){var a=this.validateDtStart()&&this.validateDtEnd();if(!this.rrulePanel.isValid()){a=false;this.rrulePanel.ownerCt.setActiveTab(this.rrulePanel)}return a&&Tine.Calendar.EventEditDialog.superclass.isValid.apply(this,arguments)},onAllDayChange:function(d,e){var b=this.getForm().findField("dtstart");var c=this.getForm().findField("dtend");b.setDisabled(e,"time");c.setDisabled(e,"time");if(e){b.clearTime();var a=c.getValue();if(Ext.isDate(a)&&a.format("H:i:s")!="23:59:59"){c.setValue(a.clearTime(true).add(Date.HOUR,24).add(Date.SECOND,-1))}}else{b.undo();c.undo()}},onDtEndChange:function(b,c,a){this.validateDtEnd()},onDtStartChange:function(b,f,a){if(Ext.isDate(f)&&Ext.isDate(a)){var e=f.getTime()-a.getTime();var c=this.getForm().findField("dtend");var d=c.getValue();if(Ext.isDate(d)){c.setValue(d.add(Date.MILLI,e))}}},doCopyRecord:function(){Tine.Calendar.EventEditDialog.superclass.doCopyRecord.call(this);Ext.each(this.record.data.attendee,function(a){delete a.id},this);this.record.set("editGrant",true);Tine.log.debug("Tine.Calendar.EventEditDialog::doCopyRecord() -> record:");Tine.log.debug(this.record)},handleRelations:function(){if(this.record.data.hasOwnProperty("relations")){var c=[],b={};Ext.each(this.plugins,function(d){if(d.ptype=="addrelations_edit_dialog"){b=d.relationConfig}},this);Ext.each(this.record.data.relations,function(f){var g=true;Ext.each(this.record.data.attendee,function(h){if(h.user_id.id==f.related_record.id){g=false;return false}},this);if(g){var e=new Tine.Calendar.Model.Attender(Ext.apply(Tine.Calendar.Model.Attender.getDefaultData(),b),"new-"+Ext.id());e.set("user_id",f.related_record);var d=(f.related_record.account_id==Tine.Tinebase.registry.get("currentAccount").accountId);if(!f.related_record.account_id||d){e.set("status_authkey",1);if(d){e.set("status","ACCEPTED")}}c.push(e.data)}},this);var a=this.record.get("id")?this.record.data.attendee.concat(c):c;this.record.set("attendee",a);delete this.record.data.relations}},onAfterRecordLoad:function(){this.handleRelations();Tine.Calendar.EventEditDialog.superclass.onAfterRecordLoad.call(this);this.attendeeGridPanel.onRecordLoad(this.record);this.rrulePanel.onRecordLoad(this.record);this.alarmPanel.onRecordLoad(this.record);if(!this.record.get("editGrant")){this.getForm().items.each(function(a){if(a.isFormField&&a.requiredGrant!==undefined){a.setDisabled(!this.record.get(a.requiredGrant))}},this)}this.perspectiveCombo.loadPerspective();this.containerSelect.setDisabled.defer(20,this.containerSelect,[(!this.record.get("editGrant"))])},onRecordUpdate:function(){Tine.Calendar.EventEditDialog.superclass.onRecordUpdate.apply(this,arguments);this.attendeeGridPanel.onRecordUpdate(this.record);this.rrulePanel.onRecordUpdate(this.record);this.alarmPanel.onRecordUpdate(this.record);this.perspectiveCombo.updatePerspective()},setTabHeight:function(){var b=this.items.first().items.first();var a=b.items.first();var c=a.items.last();c.setHeight(a.getEl().getBottom()-c.getEl().getTop())},validateDtEnd:function(){var c=this.getForm().findField("dtstart").getValue();var a=this.getForm().findField("dtend");var b=a.getValue();if(!Ext.isDate(b)){a.markInvalid(this.app.i18n._("End date is not valid"));return false}else{if(Ext.isDate(c)&&b.getTime()-c.getTime()<=0){a.markInvalid(this.app.i18n._("End date must be after start date"));return false}else{a.clearInvalid();return true}}},validateDtStart:function(){var a=this.getForm().findField("dtstart");var b=a.getValue();if(!Ext.isDate(b)){a.markInvalid(this.app.i18n._("Start date is not valid"));return false}else{a.clearInvalid();return true}},doApplyChanges:function(a){this.onRecordUpdate();if(this.isValid()){this.fireEvent("update",Ext.util.JSON.encode(this.record.data));this.onAfterApplyChanges(a)}else{this.loadMask.hide();Ext.MessageBox.alert(_("Errors"),this.getValidationErrorMessage())}}});Tine.Calendar.EventEditDialog.openWindow=function(a){var c=a.recordId?a.recordId:0;var b=Tine.WindowFactory.getWindow({width:800,height:505,name:Tine.Calendar.EventEditDialog.prototype.windowNamePrefix+c,contentPanelConstructor:"Tine.Calendar.EventEditDialog",contentPanelConstructorConfig:a});return b};Ext.ns("Tine.Calendar");Tine.Calendar.AttendeeGridPanel=Ext.extend(Ext.grid.EditorGridPanel,{autoExpandColumn:"user_id",clicksToEdit:1,enableHdMenu:false,showMemberOfType:false,showNamesOnly:false,record:null,currentAccountId:null,ctxMenu:null,attendeeStore:null,stateful:true,stateId:"cal-attendeegridpanel",initComponent:function(){this.app=this.app?this.app:Tine.Tinebase.appMgr.get("Calendar");this.currentAccountId=Tine.Tinebase.registry.get("currentAccount").accountId;this.title=this.hasOwnProperty("title")?this.title:this.app.i18n._("Attendee");this.plugins=this.plugins||[];if(!this.showNamesOnly){this.plugins.push(new Ext.ux.grid.GridViewMenuPlugin({}))}this.store=new Ext.data.SimpleStore({fields:Tine.Calendar.Model.Attender.getFieldDefinitions(),sortInfo:{field:"user_id",direction:"ASC"}});this.on("beforeedit",this.onBeforeAttenderEdit,this);this.on("afteredit",this.onAfterAttenderEdit,this);this.initColumns();Tine.Calendar.AttendeeGridPanel.superclass.initComponent.call(this)},initColumns:function(){this.columns=[{id:"role",dataIndex:"role",width:70,sortable:true,hidden:this.showNamesOnly||true,header:this.app.i18n._("Role"),renderer:this.renderAttenderRole.createDelegate(this),editor:{xtype:"widget-keyfieldcombo",app:"Calendar",keyFieldName:"attendeeRoles"}},{id:"displaycontainer_id",dataIndex:"displaycontainer_id",width:200,sortable:false,hidden:this.showNamesOnly||true,header:Tine.Tinebase.translation._hidden("Saved in"),tooltip:this.app.i18n._("This is the calendar where the attender has saved this event in"),renderer:this.renderAttenderDispContainer.createDelegate(this),editor2:new Tine.widgets.container.selectionComboBox({blurOnSelect:true,selectOnFocus:true,appName:"Calendar",getValue:function(){if(this.selectedContainer){var a=this.selectedContainer.id;this.selectedContainer.toString=function(){return a}}return this.selectedContainer},listeners:{scope:this,select:function(c,b){var a=this.getSelectionModel().getSelectedCell();if(a){var d=a[0];this.store.getAt(d).set("displaycontainer_id",b)}}}})},{id:"user_type",dataIndex:"user_type",width:40,sortable:true,resizable:false,header:"&#160;",tooltip:this.app.i18n._("Type"),renderer:this.renderAttenderType.createDelegate(this),editor:new Ext.form.ComboBox({blurOnSelect:true,expandOnFocus:true,mode:"local",store:[["user",this.app.i18n._("User")],["group",this.app.i18n._("Group")],["resource",this.app.i18n._("Resource")]].concat(this.showMemberOfType?[["memberOf",this.app.i18n._("Member of group")]]:[])})},{id:"user_id",dataIndex:"user_id",width:300,sortable:true,header:this.app.i18n._("Name"),renderer:this.renderAttenderName.createDelegate(this),editor:true},{id:"status",dataIndex:"status",width:100,sortable:true,header:this.app.i18n._("Status"),hidden:this.showNamesOnly,renderer:this.renderAttenderStatus.createDelegate(this),editor:{xtype:"widget-keyfieldcombo",app:"Calendar",keyFieldName:"attendeeStatus"}}]},onAfterAttenderEdit:function(c){switch(c.field){case"user_id":var a=false;this.store.each(function(e){if(c.record.getUserId()==e.getUserId()&&c.record.get("user_type")==e.get("user_type")&&c.record!=e){var d=this.getView().getRow(this.store.indexOf(e));Ext.fly(d).highlight();a=true;return false}},this);if(a){c.record.reject();this.startEditing(c.row,c.column)}else{if(c.value){if(!c.value.account_id){c.record.set("status_authkey",1)}var b=new Tine.Calendar.Model.Attender(Tine.Calendar.Model.Attender.getDefaultData(),"new-"+Ext.id());this.store.add([b]);this.startEditing(c.row+1,c.column)}}break;case"user_type":this.startEditing(c.row,c.column+1);break;case"container_id":if(c.record==this.eventOriginator){this.record.set("container_id","");this.record.set("container_id",c.record.get("displaycontainer_id"))}break}},onBeforeAttenderEdit:function(b){if(b.field=="status"){b.cancel=!b.record.get("status_authkey");return}if(b.field=="displaycontainer_id"){if(!b.value||!b.value.account_grants||!b.value.account_grants.deleteGrant){b.cancel=true}return}if(!this.record.get("editGrant")){b.cancel=true;return}if(b.record.get("user_id")){b.cancel=true;if(b.field=="quantity"&&b.record.get("user_type")=="resource"){b.cancel=false}if(b.field=="role"){b.cancel=false}return}if(b.field=="user_id"){var a=b.grid.getColumnModel();switch(b.record.get("user_type")){case"user":a.config[b.column].setEditor(new Tine.Addressbook.SearchCombo({blurOnSelect:true,selectOnFocus:true,forceSelection:false,renderAttenderName:this.renderAttenderName,getValue:function(){var c=this.selectedRecord?this.selectedRecord.data:((this.getRawValue()&&Ext.form.VTypes.email(this.getRawValue()))?this.getRawValue():null);return c}}));break;case"group":case"memberOf":a.config[b.column].setEditor(new Tine.Tinebase.widgets.form.RecordPickerComboBox({blurOnSelect:true,recordClass:Tine.Addressbook.Model.List,getValue:function(){return this.selectedRecord?this.selectedRecord.data:null}}));break;case"resource":a.config[b.column].setEditor(new Tine.Tinebase.widgets.form.RecordPickerComboBox({blurOnSelect:true,recordClass:Tine.Calendar.Model.Resource,getValue:function(){return this.selectedRecord?this.selectedRecord.data:null}}));break}a.config[b.column].editor.selectedRecord=null}},onContextMenu:function(b,a){b.preventDefault();var d=this.getView().findRowIndex(a);var c=this.store.getAt(d);if(c&&!this.disabled){var c=this.store.getAt(d);if(!c.get("user_id")){return}this.ctxMenu=new Ext.menu.Menu({items:[{text:this.app.i18n._("Remove Attender"),iconCls:"action_delete",scope:this,disabled:!this.record.get("editGrant"),handler:function(){this.store.removeAt(d)}}]});this.ctxMenu.showAt(b.getXY())}},onRecordLoad:function(b){this.record=b;this.store.removeAll();var a=b.get("attendee");Ext.each(a,function(d){var c=new Tine.Calendar.Model.Attender(d,d.id);this.store.addSorted(c);if(d.displaycontainer_id&&this.record.get("container_id")&&d.displaycontainer_id.id==this.record.get("container_id").id){this.eventOriginator=c}},this);if(b.get("editGrant")){this.store.add([new Tine.Calendar.Model.Attender(Tine.Calendar.Model.Attender.getDefaultData(),"new-"+Ext.id())])}},onRecordUpdate:function(b){this.stopEditing(false);var a=[];this.store.each(function(d){var c=d.get("user_id");if(c){if(typeof c.get=="function"){d.data.user_id=c.data}a.push(d.data)}},this);b.set("attendee",a)},onKeyDown:function(b){switch(b.getKey()){case b.DELETE:if(this.record.get("editGrant")){var a=this.getSelectionModel().getSelectedCell();if(a){var d=a[0];var c=this.store.getAt(d);if(!c.get("user_id")){return}this.store.removeAt(d)}}break}},renderAttenderName:function(c,b,a){if(c){var d=a?a.get("user_type"):"user";return this["renderAttender"+Ext.util.Format.capitalize(d)+"Name"].apply(this,arguments)}if(arguments[1]){arguments[1].css="x-form-empty-field";return this.app.i18n._("Click here to invite another attender...")}},renderAttenderUserName:function(a){a=a||"";if(typeof a.get=="function"&&a.get("n_fileas")){return Ext.util.Format.htmlEncode(a.get("n_fileas"))}if(a.n_fileas){return Ext.util.Format.htmlEncode(a.n_fileas)}if(a.accountDisplayName){return Ext.util.Format.htmlEncode(a.accountDisplayName)}if(Ext.isString(a)&&!a.match("^[0-9a-f-]{40,}$")&&!parseInt(a,10)){return Ext.util.Format.htmlEncode(a)}return Tine.Tinebase.appMgr.get("Calendar").i18n._("No Information")},renderAttenderGroupmemberName:function(a){var a=Tine.Calendar.AttendeeGridPanel.prototype.renderAttenderUserName.apply(this,arguments);return a+" "+Tine.Tinebase.appMgr.get("Calendar").i18n._("(as a group member)")},renderAttenderGroupName:function(a){if(typeof a.getTitle=="function"){return Ext.util.Format.htmlEncode(a.getTitle())}if(a.name){return Ext.util.Format.htmlEncode(a.name)}if(Ext.isString(a)){return Ext.util.Format.htmlEncode(a)}return Tine.Tinebase.appMgr.get("Calendar").i18n._("No Information")},renderAttenderMemberofName:function(a){return Tine.Calendar.AttendeeGridPanel.prototype.renderAttenderGroupName.apply(this,arguments)},renderAttenderResourceName:function(a){if(typeof a.getTitle=="function"){return Ext.util.Format.htmlEncode(a.getTitle())}if(a.name){return Ext.util.Format.htmlEncode(a.name)}if(Ext.isString(a)){return Ext.util.Format.htmlEncode(a)}return Tine.Tinebase.appMgr.get("Calendar").i18n._("No Information")},renderAttenderDispContainer:function(b,a,c){a.attr='style = "overflow: none;"';if(b){if(b.name){return Ext.util.Format.htmlEncode(b.name).replace(/ /g,"&nbsp;")}else{a.css="x-form-empty-field";return this.app.i18n._("No Information")}}},renderAttenderQuantity:function(b,a,c){return b>1?b:""},renderAttenderRole:function(e,a,d){var c=Tine.Tinebase.appMgr.get("Calendar").i18n,b=Tine.widgets.grid.RendererManager.get("Calendar","Attender","role",Tine.widgets.grid.RendererManager.CATEGORY_GRIDPANEL);if(this.record&&this.record.get("editGrant")){a.attr='style = "cursor:pointer;"'}else{a.css="x-form-empty-field"}return b(e)},renderAttenderStatus:function(a,b,e){var d=Tine.Tinebase.appMgr.get("Calendar").i18n,c=Tine.widgets.grid.RendererManager.get("Calendar","Attender","status",Tine.widgets.grid.RendererManager.CATEGORY_GRIDPANEL);if(!e.get("user_id")){return""}if(e.get("status_authkey")){b.attr='style = "cursor:pointer;"'}else{b.css="x-form-empty-field"}return c(a)},renderAttenderType:function(d,c,e){c.css="tine-grid-cell-no-dirty";var b="";switch(d){case"user":b="renderer_accountUserIcon";break;case"group":b="renderer_accountGroupIcon";break;default:b="cal-attendee-type-"+d;break}var a='<div style="background-position:0px;" class="'+b+'">&#160</div>';if(!e.get("user_id")){a=Tine.Tinebase.common.cellEditorHintRenderer(a)}return a},setDisabled:function(a){this.disabled=a;if(a){this.store.filterBy(function(b){return !(b.id&&b.id.match(/^new-/))})}else{this.store.clearFilter()}}});Ext.ns("Tine.Calendar");Tine.Calendar.AttendeeFilterModel=Ext.extend(Tine.widgets.grid.FilterModel,{app:null,field:"attender",defaultOperator:"in",initComponent:function(){Tine.Calendar.AttendeeFilterModel.superclass.initComponent.call(this);this.app=Tine.Tinebase.appMgr.get("Calendar");this.operators=["in"];this.label=this.app.i18n._("Attendee");this.defaultValue=Ext.apply(Tine.Calendar.Model.Attender.getDefaultData(),{user_id:Tine.Tinebase.registry.get("currentAccount")})},valueRenderer:function(b,a){var c=new Tine.Calendar.AttendeeFilterModelValueField({app:this.app,filter:b,width:200,id:"tw-ftb-frow-valuefield-"+b.id,value:b.data.value?b.data.value:this.defaultValue,renderTo:a});c.on("select",this.onFiltertrigger,this);return c}});Tine.widgets.grid.FilterToolbar.FILTERS["calendar.attendee"]=Tine.Calendar.AttendeeFilterModel;Tine.Calendar.AttendeeFilterModelValueField=Ext.extend(Ext.ux.form.LayerCombo,{hideButtons:false,layerAlign:"tr-br?",minLayerWidth:400,layerHeight:300,lazyInit:true,formConfig:{labelAlign:"left",labelWidth:30},initComponent:function(){this.fakeRecord=new Tine.Calendar.Model.Event(Tine.Calendar.Model.Event.getDefaultData());this.on("beforecollapse",this.onBeforeCollapse,this);this.supr().initComponent.call(this)},getFormValue:function(){this.attendeeGridPanel.onRecordUpdate(this.fakeRecord);return this.fakeRecord.get("attendee")},getItems:function(){this.attendeeGridPanel=new Tine.Calendar.AttendeeGridPanel({title:this.app.i18n._("Select Attendee"),height:this.layerHeight||"auto",showNamesOnly:true,showMemberOfType:true});this.attendeeGridPanel.store.on({add:function(b){this.action_ok.setDisabled(this.attendeeGridPanel.store.getCount()===1)},remove:function(b){this.action_ok.setDisabled(this.attendeeGridPanel.store.getCount()===1)},scope:this});var a=[this.attendeeGridPanel];return a},onBeforeCollapse:function(){return(!this.attendeeGridPanel.ctxMenu||this.attendeeGridPanel.ctxMenu.hidden)&&!this.attendeeGridPanel.editing},setValue:function(c){c=Ext.isArray(c)?c:[c];this.fakeRecord.set("attendee","");this.fakeRecord.set("attendee",c);this.currentValue=[];var d=Tine.Calendar.Model.Attender.getAttendeeStore(c);var b=[];d.each(function(e){this.currentValue.push(e.data);var a=Tine.Calendar.AttendeeGridPanel.prototype.renderAttenderName.call(Tine.Calendar.AttendeeGridPanel.prototype,e.get("user_id"),false,e);b.push(a)},this);this.setRawValue(b.join(", "));return this},setFormValue:function(a){this.attendeeGridPanel.onRecordLoad(this.fakeRecord)}});Ext.ns("Tine.Calendar");Tine.Calendar.FilterPanel=Ext.extend(Tine.widgets.persistentfilter.PickerPanel,{filter:[{field:"model",operator:"equals",value:"Calendar_Model_EventFilter"}],getFilterToolbar:function(){return this.app.getMainScreen().getCenterPanel().filterToolbar},storeOnBeforeload:function(a,b){b.params.filter=this.store.getById(this.getSelectionModel().getSelectedNode().id).get("filters");b.params.filter=Ext.decode(Ext.encode(b.params.filter));var c=Tine.Tinebase.appMgr.get("Calendar").getMainScreen().getCenterPanel();var d=c.getCalendarPanel(c.activeView).getView().getPeriod();Ext.each(b.params.filter,function(e){if(e.field==="period"){b.params.filter.remove(e);return false}},this);b.params.filter.push({field:"period",operator:"within",value:d});a.un("beforeload",this.storeOnBeforeload,this)}});Tine.Calendar.TreePanel=Ext.extend(Tine.widgets.container.TreePanel,{recordClass:Tine.Calendar.Model.Event,ddGroup:"cal-event",filterMode:"filterToolbar",useContainerColor:true,useProperties:true,initComponent:function(){this.filterPlugin=new Tine.widgets.tree.FilterPlugin({treePanel:this,getGridPanel:function(){return Tine.Tinebase.appMgr.get("Calendar").getMainScreen().getCenterPanel()}});this.on("beforeclick",this.onBeforeClick,this);this.on("containercolorset",function(){Tine.Tinebase.appMgr.get("Calendar").getMainScreen().getCenterPanel().refresh(true)});this.supr().initComponent.call(this)},onBeforeClick:function(a,b){if(a.attributes.path.match(/^\/$|^\/personal$/)){this.onClick(a,b);return false}},onBeforeCreateNode:function(a){this.supr().onBeforeCreateNode.apply(this,arguments);if(a.container){a.container.capabilites_private=true}},onBeforeNodeDrop:function(d){var a=d.target.attributes,c=d.data.selections,b=Tine.Tinebase.appMgr.get("Calendar").getMainScreen().getCenterPanel(),e=false;if(!a.account_grants.addGrant){e=true}Ext.each(c,function(f){if(Tine.Tinebase.container.pathIsMyPersonalContainer(f.get("container_id").path)){f.set("container_id",a.id);b.onUpdateEvent(f);d.cancel=false;d.dropStatus=true}else{e=true}},this);if(e){return false}}});Ext.ns("Tine.Calendar");Tine.Calendar.PerspectiveCombo=Ext.extend(Ext.form.ComboBox,{editDialog:null,defaultValue:"origin",typeAhead:true,triggerAction:"all",lazyRender:true,mode:"local",valueField:"id",displayField:"displayText",initComponent:function(){this.app=Tine.Tinebase.appMgr.get("Calendar");this.initStore();this.on("beforeselect",function(e,a,c){var b=this.getValue(),d=this.store.getAt(c).id;this.onPerspectiveChange.defer(50,this,[e,d,b])},this);this.editDialog.alarmPanel.alarmGrid.deleteAction.setHandler(this.onAlarmDelete,this);this.editDialog.alarmPanel.onRecordUpdate=this.onAlarmRecordUpdate.createDelegate(this);this.editDialog.alarmPanel.alarmGrid.store.on("add",this.onAlarmAdd,this);Tine.Calendar.PerspectiveCombo.superclass.initComponent.call(this)},getAttendeeStatusField:function(){if(!this.attendeeStatusField){this.attendeeStatusField=Ext.ComponentMgr.create({xtype:"widget-keyfieldcombo",width:115,hideLabel:true,app:"Calendar",name:"attendeeStatus",keyFieldName:"attendeeStatus"});this.attendeeStatusField.on("change",function(c){var b=this.getValue(),a=this.editDialog.attendeeStore.getById(b);a.set("status",c.getValue())},this)}return this.attendeeStatusField},getAttendeeTranspField:function(){if(!this.attendeeTranspField){this.attendeeTranspField=Ext.ComponentMgr.create({xtype:"checkbox",boxLabel:this.app.i18n._("non-blocking"),name:"attendeeTransp",getValue:function(){var a=Ext.form.Checkbox.prototype.getValue.call(this);return a?"TRANSPARENT":"OPAQUE"},setValue:function(b){var a=(b=="TRANSPARENT"||b===true);return Ext.form.Checkbox.prototype.setValue.call(this,a)}});this.attendeeTranspField.on("change",function(c){var b=this.getValue(),a=this.editDialog.attendeeStore.getById(b);a.set("transp",c.getValue())},this)}return this.attendeeTranspField},initStore:function(){this.store=new Ext.data.Store({fields:Tine.Calendar.Model.Attender.getFieldDefinitions().concat([{name:"displayText"}])});this.originRecord=new Tine.Calendar.Model.Attender({id:"origin",displayText:this.app.i18n._("Organizer")},"origin");this.editDialog.attendeeStore.on("add",this.syncStores,this);this.editDialog.attendeeStore.on("update",this.syncStores,this);this.editDialog.attendeeStore.on("remove",this.syncStores,this)},syncStores:function(){this.store.removeAll();this.store.add(this.originRecord);this.editDialog.attendeeStore.each(function(c){if(c.get("user_id")){var c=c.copy(),d=Tine.Calendar.AttendeeGridPanel.prototype.renderAttenderName.call(Tine.Calendar.AttendeeGridPanel.prototype,c.get("user_id"),false,c);c.set("displayText",d+" ("+Tine.Calendar.Model.Attender.getRecordName()+")");c.set("id",c.id);this.store.add(c)}},this);if(!this.store.getById(this.getValue())){this.setValue(this.originRecord.id)}if(this.getValue()!="origin"){var b=this.editDialog.getForm().findField("attendeeStatus"),a=this.editDialog.attendeeStore.getById(this.getValue()).get("status");b.setValue(a)}},applyAlarmFilter:function(){var b=this.editDialog.alarmPanel.alarmGrid,a=this.getValue(),c=this.store.getById(a),d=a=="origin";if(d){b.store.filterBy(function(e){return !e.getOption("attendee")},this)}else{b.store.filterBy(function(i){var g=i.getOption("skip")||[],f=Tine.Calendar.Model.Attender.getAttendeeStore.getAttenderRecord(Tine.Calendar.Model.Attender.getAttendeeStore(g),c),e=i.getOption("attendee"),h=Tine.Calendar.Model.Attender.getAttendeeStore.getAttenderRecord(Tine.Calendar.Model.Attender.getAttendeeStore([e]),c);return !(f||(e&&!h))},this)}},onAlarmAdd:function(b,a,c){var g=a[0],d=this.getValue(),e=this.store.getById(d),f=d=="origin";if(!g.get("id")&&!f){b.suspendEvents();g.setOption("attendee",{user_type:e.get("user_type"),user_id:e.getUserId()});b.resumeEvents()}},onAlarmDelete:function(){var b=this.editDialog.alarmPanel.alarmGrid,a=this.getValue(),c=this.store.getById(a),d=a=="origin";Ext.each(b.getSelectionModel().getSelections(),function(f){if(!d&&!f.getOption("user_id")){var e=f.getOption("skip")||[];e.push({user_type:c.get("user_type"),user_id:c.getUserId()});f.setOption("skip",e);this.applyAlarmFilter()}else{b.store.remove(f)}},this)},onAlarmRecordUpdate:function(a){var c=this.editDialog.alarmPanel.alarmGrid,b=c.store;b.suspendEvents();b.clearFilter();Tine.widgets.dialog.AlarmPanel.prototype.onRecordUpdate.call(this.editDialog.alarmPanel,a);this.applyAlarmFilter();b.suspendEvents()},onPerspectiveChange:function(c,b,a){if(b!=a){this.updatePerspective(a);this.loadPerspective(b)}},loadPerspective:function(d){if(!this.perspectiveIsInitialized){this.syncStores();var j=Tine.Calendar.Model.Attender.getAttendeeStore.getMyAttenderRecord(this.store),c=this.editDialog.record.get("organizer").id==Tine.Tinebase.registry.get("currentAccount").contact_id;d=c||!j?"origin":j.id;this.perspectiveIsInitialized=true;this.setValue(d)}var d=d||this.getValue(),h=this.store.getById(d),i=d=="origin",e=this.getAttendeeStatusField(),b=this.getAttendeeTranspField(),a=this.editDialog.getForm().findField("transp"),f=this.editDialog.getForm().findField("container_id");b.setValue(i?"":h.get("transp"));e.setValue(i?"":h.get("status"));e.setVisible(!i);b.setVisible(!i);a.setVisible(i);var g=this.editDialog.record.fields;g.each(function(k){var l=this.editDialog.getForm().findField(k.name);if(l){l.setDisabled(!i||(l.requiredGrant&&!this.editDialog.record.get(l.requiredGrant)))}},this);e.setDisabled(i||!h.get("status_authkey"));b.setDisabled(i||!h.get("status_authkey"));this.editDialog.alarmPanel.setDisabled((!i||!this.editDialog.record.get("editGrant"))&&!h.get("status_authkey"));this.editDialog.attendeeGridPanel.setDisabled(!i||!this.editDialog.record.get("editGrant"));this.editDialog.rrulePanel.setDisabled(!i||!this.editDialog.record.get("editGrant"));this.applyAlarmFilter()},updatePerspective:function(c){var c=c||this.getValue(),d=this.editDialog.attendeeStore.getById(c),f=c=="origin",b=this.getAttendeeStatusField(),a=this.getAttendeeTranspField(),e=this.editDialog.getForm().findField("container_id");if(!f){d.set("transp",a.getValue());d.set("status",b.getValue())}}});Ext.ns("Tine.Calendar");Tine.Calendar.ColorManager=function(a){Ext.apply(this,a);this.colorMap={};this.id=this.stateId;Ext.ComponentMgr.register(this);this.addEvents("beforestaterestore","staterestore","beforestatesave","statesave");if(this.stateful){this.initState()}};Ext.extend(Tine.Calendar.ColorManager,Ext.util.Observable,{schemaName:"standard",stateId:"cal-color-mgr-containers",stateful:false,colorMap:null,colorSchemataPointer:0,gray:{color:"#808080",light:"#EDEDED",text:"#FFFFFF",lightText:"#FFFFFF"},colorPalette:Ext.ColorPalette.prototype.colors,colorSchemata:{"000000":{color:"#000000",light:"#8F8F8F",text:"#FFFFFF",lightText:"#FFFFFF"},"993300":{color:"#993300",light:"#CEA590",text:"#FFFFFF",lightText:"#FFFFFF"},"333300":{color:"#333300",light:"#A6A691",text:"#FFFFFF",lightText:"#FFFFFF"},"003300":{color:"#003300",light:"#8FA48F",text:"#FFFFFF",lightText:"#FFFFFF"},"003366":{color:"#003366",light:"#90A5B9",text:"#FFFFFF",lightText:"#FFFFFF"},"000080":{color:"#000080",light:"#9090C4",text:"#FFFFFF",lightText:"#FFFFFF"},"333399":{color:"#333399",light:"#A5A5CE",text:"#FFFFFF",lightText:"#FFFFFF"},"333333":{color:"#333333",light:"#A6A6A6",text:"#FFFFFF",lightText:"#FFFFFF"},"800000":{color:"#800000",light:"#C79393",text:"#FFFFFF",lightText:"#FFFFFF"},FF6600:{color:"#FF6600",light:"#F8BB92",text:"#FFFFFF",lightText:"#FFFFFF"},"808000":{color:"#808000",light:"#C6C692",text:"#FFFFFF",lightText:"#FFFFFF"},"008000":{color:"#008000",light:"#92C692",text:"#FFFFFF",lightText:"#FFFFFF"},"008080":{color:"#008080",light:"#91C5C5",text:"#FFFFFF",lightText:"#FFFFFF"},"0000FF":{color:"#0000FF",light:"#9292F8",text:"#FFFFFF",lightText:"#FFFFFF"},"666699":{color:"#666699",light:"#BBBBD0",text:"#FFFFFF",lightText:"#FFFFFF"},"808080":{color:"#808080",light:"#C6C6C6",text:"#FFFFFF",lightText:"#FFFFFF"},FF0000:{color:"#FF0000",light:"#F89292",text:"#FFFFFF",lightText:"#FFFFFF"},FF9900:{color:"#FF9900",light:"#F8D092",text:"#FFFFFF",lightText:"#FFFFFF"},"99CC00":{color:"#99CC00",light:"#D0E492",text:"#FFFFFF",lightText:"#FFFFFF"},"339966":{color:"#339966",light:"#A7D0BB",text:"#FFFFFF",lightText:"#FFFFFF"},"33CCCC":{color:"#33CCCC",light:"#A8E5E5",text:"#FFFFFF",lightText:"#FFFFFF"},"3366FF":{color:"#3366FF",light:"#A7BBF8",text:"#FFFFFF",lightText:"#FFFFFF"},"800080":{color:"#800080",light:"#C692C6",text:"#FFFFFF",lightText:"#FFFFFF"},"969696":{color:"#969696",light:"#CECECE",text:"#FFFFFF",lightText:"#FFFFFF"},FF00FF:{color:"#FF00FF",light:"#F690F6",text:"#FFFFFF",lightText:"#FFFFFF"},FFCC00:{color:"#FFCC00",light:"#F7E391",text:"#FFFFFF",lightText:"#FFFFFF"},FFFF00:{color:"#FFFF00",light:"#F7F791",text:"#000000",lightText:"#000000"},"00FF00":{color:"#00FF00",light:"#93F993",text:"#000000",lightText:"#000000"},"00FFFF":{color:"#00FFFF",light:"#93F9F9",text:"#000000",lightText:"#000000"},"00CCFF":{color:"#00CCFF",light:"#93E5F9",text:"#FFFFFF",lightText:"#FFFFFF"},"993366":{color:"#993366",light:"#D1A8BC",text:"#FFFFFF",lightText:"#FFFFFF"},C0C0C0:{color:"#C0C0C0",light:"#DFDFDF",text:"#FFFFFF",lightText:"#FFFFFF"},FF99CC:{color:"#FF99CC",light:"#F8F0E4",text:"#FFFFFF",lightText:"#FFFFFF"},FFCC99:{color:"#FFCC99",light:"#F8E4D0",text:"#000000",lightText:"#000000"},FFFF99:{color:"#FFFF99",light:"#F9F9D1",text:"#000000",lightText:"#000000"},CCFFCC:{color:"#CCFFCC",light:"#E5F9E5",text:"#000000",lightText:"#000000"},CCFFFF:{color:"#CCFFFF",light:"#E5F9F9",text:"#000000",lightText:"#000000"},"99CCFF":{color:"#99CCFF",light:"#D0E4F8",text:"#000000",lightText:"#000000"},CC99FF:{color:"#CC99FF",light:"#E5D1F9",text:"#000000",lightText:"#000000"},FFFFFF:{color:"#DFDFDF",light:"#F8F8F8",text:"#000000",lightText:"#000000"}},getColor:function(d){var a=null,b=null,c=null;if(!Ext.isFunction(d.get)){a=d}else{a=d.get("container_id");if(Ext.isPrimitive(a)){a=d.getDisplayContainer()}}b=String(a.color).replace("#","");if(!b.match(/[0-9a-fA-F]{6}/)){return this.gray}c=this.colorSchemata[a.color.replace("#","")];return c?c:this.getCustomSchema(b)},getCustomSchema:function(a){var c=new Ext.util.MixedCollection();for(var b in this.colorSchemata){if(this.colorSchemata.hasOwnProperty(b)){c.add(Tine.Calendar.ColorManager.compare(a,b,true),this.colorSchemata[b])}}c.keySort("ASC",function(e,d){return e>d?1:(e<d?-1:0)});this.colorSchemata[a]=c.first();return this.colorSchemata[a]}});Tine.Calendar.ColorManager.str2dec=function(a){var b=String(a).replace("#",""),c=b.match(/([0-9a-fA-F]{2})([0-9a-fA-F]{2})([0-9a-fA-F]{2})/);if(!c||c.length!=4){return}return[parseInt("0x"+c[1]),parseInt("0x"+c[2]),parseInt("0x"+c[3])]};Tine.Calendar.ColorManager.compare=function(c,b,a){var e=Ext.isArray(c)?c:Tine.Calendar.ColorManager.str2dec(c),d=Ext.isArray(b)?b:Tine.Calendar.ColorManager.str2dec(b);if(!e||!d){return}var f=[e[0]-d[0],e[1]-d[1],e[2]-d[2]];return a?(Math.abs(f[0])+Math.abs(f[1])+Math.abs(f[2])):f};Ext.ns("Tine.Calendar");Tine.Calendar.RrulePanel=Ext.extend(Ext.Panel,{wkdays:["SU","MO","TU","WE","TH","FR","SA"],activeRuleCard:null,layout:"form",frame:true,initComponent:function(){this.app=Tine.Tinebase.appMgr.get("Calendar");this.title=this.app.i18n._("Recurrances");this.defaults={border:false};this.NONEcard=new Ext.Panel({freq:"NONE",html:this.app.i18n._("No recurring rule defined")});this.NONEcard.setRule=Ext.emptyFn;this.NONEcard.fillDefaults=Ext.emptyFn;this.NONEcard.getRule=function(){return null};this.NONEcard.isValid=function(){return true};this.DAILYcard=new Tine.Calendar.RrulePanel.DAILYcard({rrulePanel:this});this.WEEKLYcard=new Tine.Calendar.RrulePanel.WEEKLYcard({rrulePanel:this});this.MONTHLYcard=new Tine.Calendar.RrulePanel.MONTHLYcard({rrulePanel:this});this.YEARLYcard=new Tine.Calendar.RrulePanel.YEARLYcard({rrulePanel:this});this.ruleCards=new Ext.Panel({layout:"card",activeItem:0,style:"padding: 10px 0 0 10px;",items:[this.NONEcard,this.DAILYcard,this.WEEKLYcard,this.MONTHLYcard,this.YEARLYcard]});this.idPrefix=Ext.id();this.tbar=[{id:this.idPrefix+"tglbtnNONE",xtype:"tbbtnlockedtoggle",enableToggle:true,text:this.app.i18n._("None"),handler:this.onFreqChange.createDelegate(this,["NONE"]),toggleGroup:this.idPrefix+"freqtglgroup"},{id:this.idPrefix+"tglbtnDAILY",xtype:"tbbtnlockedtoggle",enableToggle:true,text:this.app.i18n._("Daily"),handler:this.onFreqChange.createDelegate(this,["DAILY"]),toggleGroup:this.idPrefix+"freqtglgroup"},{id:this.idPrefix+"tglbtnWEEKLY",xtype:"tbbtnlockedtoggle",enableToggle:true,text:this.app.i18n._("Weekly"),handler:this.onFreqChange.createDelegate(this,["WEEKLY"]),toggleGroup:this.idPrefix+"freqtglgroup"},{id:this.idPrefix+"tglbtnMONTHLY",xtype:"tbbtnlockedtoggle",enableToggle:true,text:this.app.i18n._("Monthly"),handler:this.onFreqChange.createDelegate(this,["MONTHLY"]),toggleGroup:this.idPrefix+"freqtglgroup"},{id:this.idPrefix+"tglbtnYEARLY",xtype:"tbbtnlockedtoggle",enableToggle:true,text:this.app.i18n._("Yearly"),handler:this.onFreqChange.createDelegate(this,["YEARLY"]),toggleGroup:this.idPrefix+"freqtglgroup"}];this.items=[this.ruleCards];Tine.Calendar.RrulePanel.superclass.initComponent.call(this)},isValid:function(){return this.activeRuleCard.isValid(this.record)},onFreqChange:function(a){this.ruleCards.layout.setActiveItem(this[a+"card"]);this.ruleCards.layout.layout();this.activeRuleCard=this[a+"card"]},setDisabled:function(a){this.items.each(function(b){b.setDisabled(a)},this)},onRecordLoad:function(a){this.record=a;if(!this.record.get("editGrant")||this.record.isRecurException()){this.setDisabled(true)}this.rrule=this.record.get("rrule");var c=this.record.get("dtstart");if(Ext.isDate(c)){var e=Tine.Calendar.RrulePanel.prototype.wkdays[c.format("w")];var g=c.format("j");var b=c.format("n");this.WEEKLYcard.setRule({interval:1,byday:e});this.MONTHLYcard.setRule({interval:1,byday:"1"+e,bymonthday:g});this.YEARLYcard.setRule({byday:"1"+e,bymonthday:g,bymonth:b})}var f=this.rrule&&this.rrule.freq?this.rrule.freq:"NONE";var d=Ext.getCmp(this.idPrefix+"tglbtn"+f);d.toggle(true);this.activeRuleCard=this[f+"card"];this.ruleCards.activeItem=this.activeRuleCard;this.activeRuleCard.setRule(this.rrule);if(this.record.isRecurException()){this.activeRuleCard=this.NONEcard;this.items.each(function(h){h.setDisabled(true)},this);this.NONEcard.html=this.app.i18n._("Exceptions of reccuring events can't have recurrences themselves.")}},onRecordUpdate:function(a){var b=this.activeRuleCard.rendered?this.activeRuleCard.getRule():this.rrule;if(!this.rrule&&b){b.newrule=true}a.set("rrule","");a.set("rrule",b)}});Tine.Calendar.RrulePanel.AbstractCard=Ext.extend(Ext.Panel,{border:false,layout:"form",labelAlign:"side",autoHeight:true,getRule:function(){var a={freq:this.freq,interval:this.interval.getValue()};if(this.untilRadio.checked){a.until=this.until.getRawValue();a.until=a.until?Date.parseDate(a.until,this.until.format):null;if(Ext.isDate(a.until)){a.until=a.until.clearTime(true).add(Date.HOUR,24).add(Date.SECOND,-1).format(Date.patterns.ISO8601Long)}}else{a.count=this.count.getValue()||1}return a},onAfterUnitTriggerClick:function(){if(!this.until.getValue()){var a=this.rrulePanel.record.get("dtstart");this.until.menu.picker.setValue(a)}},initComponent:function(){this.app=Tine.Tinebase.appMgr.get("Calendar");this.limitId=Ext.id();this.untilRadio=new Ext.form.Radio({requiredGrant:"editGrant",hideLabel:true,boxLabel:this.app.i18n._("at"),name:this.limitId+"LimitRadioGroup",inputValue:"UNTIL",checked:true,listeners:{check:this.onLimitRadioCheck.createDelegate(this)}});this.until=new Ext.form.DateField({requiredGrant:"editGrant",width:100,emptyText:this.app.i18n._("never"),onTriggerClick:Ext.form.DateField.prototype.onTriggerClick.createSequence(this.onAfterUnitTriggerClick,this),listeners:{scope:this,render:function(g){g.wrap.setWidth.defer(100,g.wrap,[g.initialConfig.width])}}});var c=this.app.i18n._("after {0} occurrences").split("{0}"),d=c[0],a=c[1];this.countRadio=new Ext.form.Radio({requiredGrant:"editGrant",hideLabel:true,boxLabel:d,name:this.limitId+"LimitRadioGroup",inputValue:"COUNT",listeners:{check:this.onLimitRadioCheck.createDelegate(this)}});this.count=new Ext.form.NumberField({requiredGrant:"editGrant",style:"text-align:right;",width:40,minValue:1,disabled:true,allowBlank:false});var f=this.intervalString.split("{0}");var e=f[0];var b=f[1];this.interval=new Ext.form.NumberField({requiredGrant:"editGrant",style:"text-align:right;",minValue:1,allowBlank:false,value:1,width:40});if(!this.items){this.items=[]}if(this.freq!="YEARLY"){this.items=[{layout:"column",items:[{width:70,html:e},this.interval,{style:"padding-top: 2px;",html:b}]}].concat(this.items)}this.items=this.items.concat({layout:"form",html:'<div style="padding-top: 5px;">'+this.app.i18n._("End")+'</div><div style="position: relative;"><div style="position: relative;"><table><tr><td width="65" id="'+this.limitId+'untilRadio"></td><td width="100" id="'+this.limitId+'until"></td></tr></table></div><div style="position: relative;"><table><tr><td width="65" id="'+this.limitId+'countRadio"></td><td width="40" id="'+this.limitId+'count"></td><td width="40" style="padding-left: 5px" >'+a+"</td></tr></table></div></div>",listeners:{scope:this,render:this.onLimitRender}});Tine.Calendar.RrulePanel.AbstractCard.superclass.initComponent.call(this)},onLimitRender:function(){var c=Ext.get(this.limitId+"untilRadio");var a=Ext.get(this.limitId+"until");var b=Ext.get(this.limitId+"countRadio");var d=Ext.get(this.limitId+"count");if(!(c&&b)){return this.onLimitRender.defer(100,this,arguments)}this.untilRadio.render(c);this.until.render(a);this.until.wrap.setWidth(80);this.countRadio.render(b);this.count.render(d)},onLimitRadioCheck:function(a,b){switch(a.inputValue){case"UNTIL":this.count.setDisabled(b);break;case"COUNT":this.until.setDisabled(b);break}},isValid:function(a){var b=this.until.getValue();if(Ext.isDate(b)&&Ext.isDate(a.get("dtstart"))){if(b.getTime()<a.get("dtstart").getTime()){this.until.markInvalid(this.app.i18n._("Until has to be after event start"));return false}}return true},setRule:function(b){this.interval.setValue(b.interval||1);var a=Date.parseDate(b.until,Date.patterns.ISO8601Long);this.until.value=a;if(b.count){this.count.value=b.count;this.untilRadio.setValue(false);this.countRadio.setValue(true);this.onLimitRadioCheck(this.untilRadio,false);this.onLimitRadioCheck(this.countRadio,true)}}});Tine.Calendar.RrulePanel.DAILYcard=Ext.extend(Tine.Calendar.RrulePanel.AbstractCard,{freq:"DAILY",initComponent:function(){this.app=Tine.Tinebase.appMgr.get("Calendar");this.intervalString=this.app.i18n._("Every {0}. Day");Tine.Calendar.RrulePanel.DAILYcard.superclass.initComponent.call(this)}});Tine.Calendar.RrulePanel.WEEKLYcard=Ext.extend(Tine.Calendar.RrulePanel.AbstractCard,{freq:"WEEKLY",getRule:function(){var b=Tine.Calendar.RrulePanel.WEEKLYcard.superclass.getRule.call(this);var a=[];this.byday.items.each(function(c){if(c.checked){a.push(c.name)}},this);b.byday=a.join();if(!b.byday){b.byday=this.byDayValue}b.wkst=this.wkst||Tine.Calendar.RrulePanel.prototype.wkdays[Ext.DatePicker.prototype.startDay];return b},initComponent:function(){this.app=Tine.Tinebase.appMgr.get("Calendar");this.intervalString=this.app.i18n._("Every {0}. Week at");var a=[];for(var b=0,c;b<7;b++){c=(b+Ext.DatePicker.prototype.startDay)%7;a.push({boxLabel:Date.dayNames[c],name:Tine.Calendar.RrulePanel.prototype.wkdays[c]})}this.byday=new Ext.form.CheckboxGroup({requiredGrant:"editGrant",style:"padding-top: 5px;",hideLabel:true,items:a});this.items=[this.byday];Tine.Calendar.RrulePanel.WEEKLYcard.superclass.initComponent.call(this)},setRule:function(b){Tine.Calendar.RrulePanel.WEEKLYcard.superclass.setRule.call(this,b);this.wkst=b.wkst;if(b.byday){this.byDayValue=b.byday;var a=b.byday.split(",");if(Ext.isArray(this.byday.items)){Ext.each(this.byday.items,function(c){if(a.indexOf(c.name)!=-1){c.checked=true}},this)}else{this.byday.items.each(function(c){if(a.indexOf(c.name)!=-1){c.setValue(true)}},this)}}}});Tine.Calendar.RrulePanel.MONTHLYcard=Ext.extend(Tine.Calendar.RrulePanel.AbstractCard,{freq:"MONTHLY",getRule:function(){var a=Tine.Calendar.RrulePanel.MONTHLYcard.superclass.getRule.call(this);if(this.bydayRadio.checked){a.byday=this.wkNumber.getValue()+this.wkDay.getValue()}else{a.bymonthday=this.bymonthdayday.getValue()}return a},initComponent:function(){this.app=Tine.Tinebase.appMgr.get("Calendar");this.intervalString=this.app.i18n._("Every {0}. Month");this.idPrefix=Ext.id();this.bydayRadio=new Ext.form.Radio({hideLabel:true,boxLabel:this.app.i18n._("at the"),name:this.idPrefix+"byRadioGroup",inputValue:"BYDAY",checked:true,listeners:{check:this.onByRadioCheck.createDelegate(this)}});this.wkNumber=new Ext.form.ComboBox({requiredGrant:"editGrant",width:80,listWidth:80,triggerAction:"all",hideLabel:true,value:1,editable:false,mode:"local",store:[[1,this.app.i18n._("first")],[2,this.app.i18n._("second")],[3,this.app.i18n._("third")],[4,this.app.i18n._("fourth")],[-1,this.app.i18n._("last")]]});var b=[];for(var a=0,c;a<7;a++){c=(a+Ext.DatePicker.prototype.startDay)%7;Tine.Calendar.RrulePanel.prototype.wkdays[c];b.push([Tine.Calendar.RrulePanel.prototype.wkdays[c],Date.dayNames[c]])}this.wkDay=new Ext.form.ComboBox({requiredGrant:"editGrant",width:100,listWidth:100,triggerAction:"all",hideLabel:true,value:Tine.Calendar.RrulePanel.prototype.wkdays[Ext.DatePicker.prototype.startDay],editable:false,mode:"local",store:b});this.bymonthdayRadio=new Ext.form.Radio({requiredGrant:"editGrant",hideLabel:true,boxLabel:this.app.i18n._("at the"),name:this.idPrefix+"byRadioGroup",inputValue:"BYMONTHDAY",listeners:{check:this.onByRadioCheck.createDelegate(this)}});this.bymonthdayday=new Ext.form.NumberField({requiredGrant:"editGrant",style:"text-align:right;",hideLabel:true,width:40,value:1,disabled:true});this.items=[{html:'<div style="padding-top: 5px;"><div style="position: relative;"><table><tr><td style="position: relative;" width="65" id="'+this.idPrefix+'bydayradio"></td><td width="100" id="'+this.idPrefix+'bydaywknumber"></td><td width="110" id="'+this.idPrefix+'bydaywkday"></td></tr></table></div><div style="position: relative;"><table><tr><td width="65" id="'+this.idPrefix+'bymonthdayradio"></td><td width="40" id="'+this.idPrefix+'bymonthdayday"></td><td>.</td></tr></table></div></div>',listeners:{scope:this,render:this.onByRender}}];Tine.Calendar.RrulePanel.MONTHLYcard.superclass.initComponent.call(this)},onByRadioCheck:function(a,b){switch(a.inputValue){case"BYDAY":this.bymonthdayday.setDisabled(b);break;case"BYMONTHDAY":this.wkNumber.setDisabled(b);this.wkDay.setDisabled(b);break}},onByRender:function(){var b=Ext.get(this.idPrefix+"bydayradio");var c=Ext.get(this.idPrefix+"bydaywknumber");var e=Ext.get(this.idPrefix+"bydaywkday");var a=Ext.get(this.idPrefix+"bymonthdayradio");var d=Ext.get(this.idPrefix+"bymonthdayday");if(!(b&&a)){return this.onByRender.defer(100,this,arguments)}this.bydayRadio.render(b);this.wkNumber.render(c);this.wkNumber.wrap.setWidth(80);this.wkDay.render(e);this.wkDay.wrap.setWidth(100);this.bymonthdayRadio.render(a);this.bymonthdayday.render(d)},setRule:function(b){Tine.Calendar.RrulePanel.MONTHLYcard.superclass.setRule.call(this,b);if(b.byday){this.bydayRadio.setValue(true);this.bymonthdayRadio.setValue(false);this.onByRadioCheck(this.bydayRadio,true);this.onByRadioCheck(this.bymonthdayRadio,false);var a=b.byday.match(/([\-\d]{1,2})([A-Z]{2})/);this.wkNumber.setValue(a[1]);this.wkDay.setValue(a[2])}if(b.bymonthday){this.bydayRadio.setValue(false);this.bymonthdayRadio.setValue(true);this.onByRadioCheck(this.bydayRadio,false);this.onByRadioCheck(this.bymonthdayRadio,true);this.bymonthdayday.setValue(b.bymonthday)}}});Tine.Calendar.RrulePanel.YEARLYcard=Ext.extend(Tine.Calendar.RrulePanel.AbstractCard,{freq:"YEARLY",getRule:function(){var a=Tine.Calendar.RrulePanel.MONTHLYcard.superclass.getRule.call(this);if(this.bydayRadio.checked){a.byday=this.wkNumber.getValue()+this.wkDay.getValue()}else{a.bymonthday=this.bymonthdayday.getValue()}a.bymonth=this.bymonth.getValue();return a},initComponent:function(){this.app=Tine.Tinebase.appMgr.get("Calendar");this.intervalString=this.app.i18n._("Every {0}. Year");this.idPrefix=Ext.id();this.bydayRadio=new Ext.form.Radio({requiredGrant:"editGrant",hideLabel:true,boxLabel:this.app.i18n._("at the"),name:this.idPrefix+"byRadioGroup",inputValue:"BYDAY",listeners:{check:this.onByRadioCheck.createDelegate(this)}});this.wkNumber=new Ext.form.ComboBox({requiredGrant:"editGrant",width:80,listWidth:80,triggerAction:"all",hideLabel:true,value:1,editable:false,mode:"local",disabled:true,store:[[1,this.app.i18n._("first")],[2,this.app.i18n._("second")],[3,this.app.i18n._("third")],[4,this.app.i18n._("fourth")],[-1,this.app.i18n._("last")]]});var b=[];for(var a=0,e;a<7;a++){e=(a+Ext.DatePicker.prototype.startDay)%7;Tine.Calendar.RrulePanel.prototype.wkdays[e];b.push([Tine.Calendar.RrulePanel.prototype.wkdays[e],Date.dayNames[e]])}this.wkDay=new Ext.form.ComboBox({requiredGrant:"editGrant",width:100,listWidth:100,triggerAction:"all",hideLabel:true,value:Tine.Calendar.RrulePanel.prototype.wkdays[Ext.DatePicker.prototype.startDay],editable:false,mode:"local",store:b,disabled:true});this.bymonthdayRadio=new Ext.form.Radio({requiredGrant:"editGrant",hideLabel:true,boxLabel:this.app.i18n._("at the"),name:this.idPrefix+"byRadioGroup",inputValue:"BYMONTHDAY",checked:true,listeners:{check:this.onByRadioCheck.createDelegate(this)}});this.bymonthdayday=new Ext.form.NumberField({requiredGrant:"editGrant",style:"text-align:right;",hideLabel:true,width:40,value:1});var c=[];for(var a=0;a<Date.monthNames.length;a++){c.push([a+1,Date.monthNames[a]])}this.bymonth=new Ext.form.ComboBox({requiredGrant:"editGrant",width:100,listWidth:100,triggerAction:"all",hideLabel:true,value:1,editable:false,mode:"local",store:c});this.items=[{html:'<div style="padding-top: 5px;"><div style="position: relative;"><table><tr><td style="position: relative;" width="65" id="'+this.idPrefix+'bydayradio"></td><td width="100" id="'+this.idPrefix+'bydaywknumber"></td><td width="110" id="'+this.idPrefix+'bydaywkday"></td></tr></table></div><div style="position: relative;"><table><tr><td width="65" id="'+this.idPrefix+'bymonthdayradio"></td><td width="40" id="'+this.idPrefix+'bymonthdayday"></td><td>.</td><td width="15" style="padding-left: 37px">'+this.app.i18n._("of")+'</td><td width="100" id="'+this.idPrefix+'bymonth"></td></tr></table></div></div>',listeners:{scope:this,render:this.onByRender}}];Tine.Calendar.RrulePanel.YEARLYcard.superclass.initComponent.call(this)},onByRadioCheck:function(a,b){switch(a.inputValue){case"BYDAY":this.bymonthdayday.setDisabled(b);break;case"BYMONTHDAY":this.wkNumber.setDisabled(b);this.wkDay.setDisabled(b);break}},onByRender:function(){var b=Ext.get(this.idPrefix+"bydayradio");var c=Ext.get(this.idPrefix+"bydaywknumber");var f=Ext.get(this.idPrefix+"bydaywkday");var a=Ext.get(this.idPrefix+"bymonthdayradio");var d=Ext.get(this.idPrefix+"bymonthdayday");var e=Ext.get(this.idPrefix+"bymonth");if(!(b&&a)){return this.onByRender.defer(100,this,arguments)}this.bydayRadio.render(b);this.wkNumber.render(c);this.wkNumber.wrap.setWidth(80);this.wkDay.render(f);this.wkDay.wrap.setWidth(100);this.bymonthdayRadio.render(a);this.bymonthdayday.render(d);this.bymonth.render(e);this.bymonth.wrap.setWidth(100)},setRule:function(b){Tine.Calendar.RrulePanel.MONTHLYcard.superclass.setRule.call(this,b);if(b.byday){this.bydayRadio.setValue(true);this.bymonthdayRadio.setValue(false);this.onByRadioCheck(this.bydayRadio,true);this.onByRadioCheck(this.bymonthdayRadio,false);var a=b.byday.match(/([\-\d]{1,2})([A-Z]{2})/);this.wkNumber.setValue(a[1]);this.wkDay.setValue(a[2])}if(b.bymonthday){this.bydayRadio.setValue(false);this.bymonthdayRadio.setValue(true);this.onByRadioCheck(this.bydayRadio,false);this.onByRadioCheck(this.bymonthdayRadio,true);this.bymonthdayday.setValue(b.bymonthday)}this.bymonth.setValue(b.bymonth)}});Ext.ns("Tine.Calendar");Tine.Calendar.ResourcesGridPanel=Ext.extend(Tine.widgets.grid.GridPanel,{recordClass:Tine.Calendar.Model.Resource,defaultSortInfo:{field:"name",dir:"ASC"},evalGrants:false,newRecordIcon:"cal-resource",initComponent:function(){this.app=Tine.Tinebase.appMgr.get("Calendar");this.gridConfig={};this.gridConfig.columns=[{id:"name",header:this.app.i18n._("Name"),width:150,sortable:true,dataIndex:"name"},{id:"email",header:this.app.i18n._("Email"),width:150,sortable:true,dataIndex:"email"},new Ext.ux.grid.CheckColumn({header:_("Location"),dataIndex:"is_location",width:55})];this.supr().initComponent.call(this)},initLayout:function(){this.supr().initLayout.call(this);this.items.push({region:"north",height:55,border:false,items:this.actionToolbar})},initialLoad:function(){this.store.load.defer(10,this.store,[typeof this.autoLoad=="object"?this.autoLoad:undefined])}});Ext.ns("Tine.Calendar");Tine.Calendar.ResourceEditDialog=Ext.extend(Tine.widgets.dialog.EditDialog,{recordClass:Tine.Calendar.Model.Resource,windowNamePrefix:"ResourceEditWindow_",evalGrants:false,showContainerSelector:false,tbarItems:[{xtype:"widget-activitiesaddbutton"}],getFormItems:function(){return{xtype:"tabpanel",border:false,plain:true,activeTab:0,border:false,items:[{title:this.app.i18n.n_("Resource","Resources",1),autoScroll:true,border:false,frame:true,layout:"border",items:[{region:"center",xtype:"columnform",labelAlign:"top",formDefaults:{xtype:"textfield",anchor:"100%",labelSeparator:"",columnWidth:0.333},items:[[{xtype:"textfield",fieldLabel:this.app.i18n._("Name"),allowBlank:false,name:"name"},{xtype:"textfield",fieldLabel:this.app.i18n._("Email"),allowBlank:false,name:"email",vtype:"email"},{xtype:"checkbox",fieldLabel:this.app.i18n._("Is a location"),name:"is_location"}],[{columnWidth:1,fieldLabel:this.app.i18n._("Description"),emptyText:this.app.i18n._("Enter description..."),name:"description",xtype:"textarea",height:200}]]},{layout:"accordion",animate:true,region:"east",width:210,split:true,collapsible:true,collapseMode:"mini",header:false,margins:"0 5 0 5",border:true,items:[new Tine.widgets.activities.ActivitiesPanel({app:"Calendar",showAddNoteForm:false,border:false,bodyStyle:"border:1px solid #B5B8C8;"}),new Tine.widgets.tags.TagPanel({app:"Calendar",border:false,bodyStyle:"border:1px solid #B5B8C8;"})]}]},new Tine.widgets.activities.ActivitiesTabPanel({app:this.appName,record_id:this.record.id,record_model:this.appName+"_Model_"+this.recordClass.getMeta("modelName")})]}}});Tine.Calendar.ResourceEditDialog.openWindow=function(a){var c=(a.record&&a.record.id)?a.record.id:0;var b=Tine.WindowFactory.getWindow({width:800,height:400,name:Tine.Calendar.ResourceEditDialog.prototype.windowNamePrefix+c,contentPanelConstructor:"Tine.Calendar.ResourceEditDialog",contentPanelConstructorConfig:a});return b};Ext.ns("Tine.Calendar.Printer");Tine.Calendar.Printer.BaseRenderer=Ext.extend(Ext.ux.Printer.BaseRenderer,{stylesheetPath:"Calendar/css/print.css",generateCalRows:function(h,d,e){var i,c,a,g,f=Math.ceil(h.length/d),b="";for(i=0;i<f;i++){a="";for(c=0;c<d;c++){g=e?i*d+c:c*f+i;a+=String.format('<td class="cal-print-daycell" style="vertical-align: top;">{0}</td>',h[g]||"")}b+=String.format('<tr class="cal-print-dayrow" style="height: {1}mm">{0}</tr>',a,this.paperHeight/f)}return b},generateDay:function(a,e,d){var c="";d.each(function(g){var h=g.data.dtstart.getTime()<=a.getTime()?a:g.data.dtstart,f=g.data.dtend.getTime()>e.getTime()?e:g.data.dtend;c+=this.eventTpl.apply({color:g.colorSet.color,startTime:g.data.is_all_day_event?"":h.format("H:i"),untilseperator:g.data.is_all_day_event?"":"-",endTime:g.data.is_all_day_event?"":f.format("H:i"),summary:Ext.util.Format.htmlEncode(g.data.summary),duration:g.data.is_all_day_event?Tine.Tinebase.appMgr.get("Calendar").i18n._("whole day"):Tine.Tinebase.common.minutesRenderer(Math.round((f.getTime()-h.getTime())/(1000*60)),"{0}:{1}","i")})},this);var b=this.dayTpl.apply({dayOfMonth:a.format("j"),weekDay:a.format("l")});return String.format('<table class="cal-print-daysview-day"><tr>{0}</tr>{1}</table>',b,c)},splitDays:function(c,b,d,e){var j=[];for(var h,a,g,f=0;f<d;f++){h=b.add(Date.DAY,f);a=h.add(Date.DAY,1).add(Date.SECOND,-1);g=c.queryBy(function(i){return i.data.dtstart.getTime()<a.getTime()&&i.data.dtend.getTime()>h.getTime()});j.push(e?{dayStart:h,dayEnd:a,dayEvents:g}:this.generateDay(h,a,g))}return j},dayTpl:new Ext.XTemplate("<tr>",'<th  colspan="5">','<span class="cal-print-daysview-day-dayOfMonth">{dayOfMonth}</span>','<span class="cal-print-daysview-day-weekDay">{weekDay}</span>',"</th>","</tr>"),eventTpl:new Ext.XTemplate("<tr>",'<td class="cal-print-daysview-day-color"><span style="color: {color};">&#9673;</span></td>','<td class="cal-print-daysview-day-starttime">{startTime}</td>','<td class="cal-print-daysview-day-untilseperator">{untilseperator}</td>','<td class="cal-print-daysview-day-endtime">{endTime}</td>','<td class="cal-print-daysview-day-summary">{summary} (<span class="cal-print-daysview-day-duration">{duration}</span>)</td>',"</tr>")});Tine.Calendar.Printer.DaysViewRenderer=Ext.extend(Tine.Calendar.Printer.BaseRenderer,{paperHeight:200,generateBody:function(b){var c=this.splitDays(b.ds,b.startDate,b.numOfDays),a=[];a.push('<table><tr><th class="cal-print-title">',this.getTitle(b),"</th></tr></table>");if(b.numOfDays===1){a.push(String.format('<div class="cal-print-day-singleday">{0}</div>',c[0]))}else{if(b.numOfDays<9){if(b.numOfDays==7&&b.startDate.format("w")==1){a.push(this.generateIsoWeek(c))}else{a.push(String.format("<table>{0}</table>",this.generateCalRows(c,2)))}}else{a.push(String.format("<table>{0}</table>",this.generateCalRows(c,2,true)))}}return a.join("\n")},getTitle:function(f){if(f.numOfDays==1){return String.format(f.dayFormatString+" {3}",f.startDate.format("l"),f.startDate.format("j"),f.startDate.format("F"),f.startDate.format("Y"))}else{var b=f.startDate.add(Date.DAY,f.numOfDays-1),h=f.startDate.format("j. "),g=f.startDate.format("F "),e=f.startDate.format("Y "),d=b.format("j. "),c=b.format("F "),i=b.format("Y "),a=f.numOfDays==7?String.format(f.app.i18n._("Week {0} :"),f.startDate.add(Date.DAY,1).getWeekOfYear())+" ":"";if(e===i){e=""}if(g===c){g=""}return a+h+g+e+" - "+d+c+i}},generateIsoWeek:function(b){var a=this.paperHeight/4;return["<table>",'<tr style="height: '+a+'mm;">','<td class="cal-print-daycell" width="50%">',b[0],"</td>",'<td class="cal-print-daycell" width="50%">',b[3],"</td>","</tr>",'<tr style="height: '+a+'mm;">','<td class="cal-print-daycell" width="50%">',b[1],"</td>",'<td class="cal-print-daycell" width="50%">',b[4],"</td>","</tr>",'<tr style="height: '+a+'mm;">','<td class="cal-print-daycell" width="50%">',b[2],"</td>",'<td class="cal-print-daycell" width="50%">','<table style="padding: 0;">','<tr style="height: '+a/2+'mm;">','<td class="cal-print-daycell" width="100%" style="padding: 0;">',b[5],"</td>","</tr>",'<tr style="height: '+a/2+'mm;">','<td class="cal-print-daycell" width="100%" style="padding: 0;">',b[6],"</td>","</tr>","</table>","</tr>","</table>"].join("\n")}});Tine.Calendar.Printer.MonthViewRenderer=Ext.extend(Tine.Calendar.Printer.BaseRenderer,{paperHeight:155,generateBody:function(b){var e=this.splitDays(b.ds,b.dateMesh[0],b.dateMesh.length),a=[];a.push('<style type="text/css">',"@page {","size:landscape","}","</style>");a.push('<table><tr><th class="cal-print-title">',this.getTitle(b),"</th></tr></table>");var g=[];for(var c=0;c<7;c++){var f=b.startDay+c;if(f>6){f=f-7}g.push("<td class='cal-print-monthview-daycell'><span>",b.dayNames[f],"</span></td>")}a.push(String.format('<br/><table class="cal-print-monthview"><tr>{0}</thead>{1}</tr>',g.join("\n"),this.generateCalRows(e,7,true)));return a.join("\n")},getTitle:function(a){return a.dateMesh[10].format("F Y")},dayHeadersTpl:new Ext.XTemplate("<tr>",'<tpl for=".">',"<th>{{dataIndex}}</th>","</tpl>","</tr>")});Ext.ns("Tine.Calendar");Tine.Calendar.ContactEventsGridPanel=Ext.extend(Tine.widgets.grid.GridPanel,{recordClass:Tine.Calendar.Model.Event,recordProxy:Tine.Calendar.backend,stateful:false,defaultSortInfo:{field:"dtstart",direction:"ASC"},gridConfig:{autoExpandColumn:"summary"},hasDetailsPanel:true,initComponent:function(){this.app=Tine.Tinebase.appMgr.get("Calendar");this.title=this.app.i18n._("Events");this.record=this.editDialog.record;this.gridConfig.cm=this.getColumnModel();this.initFilterToolbar();this.plugins=this.plugins||[];this.plugins.push(this.filterToolbar);Tine.Calendar.ContactEventsGridPanel.superclass.initComponent.call(this)},initialLoad:function(){this.store.load.defer(10,this.store,[typeof this.autoLoad=="object"?this.autoLoad:undefined])},initFilterToolbar:function(){this.filterToolbar=new Tine.widgets.grid.FilterToolbar({recordClass:this.recordClass,neverAllowSaving:true,filterModels:Tine.Calendar.Model.Event.getFilterModel(),defaultFilter:"query",filters:[{field:"query",operator:"contains",value:""},{field:"attender",operator:"in",value:[{user_type:"user",user_id:this.record.id?this.record.data:""}]}]})},getColumnModel:function(){return new Ext.grid.ColumnModel({defaults:{sortable:true,resizable:true},columns:[{id:"summary",header:this.app.i18n._("Summary"),width:350,sortable:true,dataIndex:"summary"},{id:"dtstart",header:this.app.i18n._("Start Time"),width:150,sortable:true,dataIndex:"dtstart",renderer:Tine.Tinebase.common.dateTimeRenderer},{id:"attendee_status",header:this.app.i18n._("Status"),width:100,sortable:true,dataIndex:"attendee",renderer:this.attendeeStatusRenderer.createDelegate(this)}]})},attendeeStatusRenderer:function(a){var b=new Tine.Calendar.Model.Attender.getAttendeeStore(a),c=null;b.each(function(d){if(d.getUserId()==this.record.id&&d.get("user_type")=="user"){c=d;return false}},this);if(c){return Tine.Tinebase.widgets.keyfield.Renderer.render("Calendar","attendeeStatus",c.get("status"))}}});Ext.ns("Tine.Calendar");Tine.Calendar.iMIPDetailsPanel=Ext.extend(Tine.Calendar.EventDetailsPanel,{preparedPart:null,actionToolbar:null,iMIPrecord:null,statusActions:[],initComponent:function(){this.app=Tine.Tinebase.appMgr.get("Calendar");this.iMIPrecord=new Tine.Calendar.Model.iMIP(this.preparedPart.preparedData);if(!Ext.isFunction(this.iMIPrecord.get("event").beginEdit)){this.iMIPrecord.set("event",Tine.Calendar.backend.recordReader({responseText:Ext.util.JSON.encode(this.preparedPart.preparedData.event)}))}this.initIMIPToolbar();this.on("afterrender",this.showIMIP,this);Tine.Calendar.iMIPDetailsPanel.superclass.initComponent.call(this)},prepareIMIP:function(){this.iMIPclause.setText(this.app.i18n._("Checking Calendar Data..."));Tine.Calendar.iMIPPrepare(this.iMIPrecord.data,function(a,b){this.preparedPart.preparedData=a;if(b.error){this.iMIPrecord.set("preconditions",{GENERIC:"generic problem"})}else{this.iMIPrecord=new Tine.Calendar.Model.iMIP(a);this.iMIPrecord.set("event",Tine.Calendar.backend.recordReader({responseText:Ext.util.JSON.encode(a.event)}))}this.showIMIP()},this)},processIMIP:function(a,b){if(this.iMIPrecord.get("event").isRecurBase()&&a!="ACCEPTED"&&!b){Tine.widgets.dialog.MultiOptionsDialog.openWindow({title:this.app.i18n._("Reply to Recurring Event"),questionText:this.app.i18n._("You are responding to an recurring event. What would you like to do?"),height:170,scope:this,options:[{text:this.app.i18n._("Respond to whole series"),name:"series"},{text:this.app.i18n._("Do not respond"),name:"cancel"}],handler:function(c){if(c!="cancel"){this.processIMIP(a,c)}}});return}Tine.log.debug("Tine.Calendar.iMIPDetailsPanel::processIMIP status: "+a);this.getLoadMask().show();Tine.Calendar.iMIPProcess(this.iMIPrecord.data,a,function(c,d){this.preparedPart.preparedData=c;if(d.error){return this.prepareIMIP()}this.iMIPrecord=new Tine.Calendar.Model.iMIP(c);this.iMIPrecord.set("event",Tine.Calendar.backend.recordReader({responseText:Ext.util.JSON.encode(c.event)}));this.showIMIP()},this)},initIMIPToolbar:function(){var a=this.getSingleRecordPanel();this.actions=[];this.statusActions=[];Tine.Tinebase.widgets.keyfield.StoreMgr.get("Calendar","attendeeStatus").each(function(b){if(b.id=="NEEDS-ACTION"){return}this.statusActions.push(new Ext.Action({text:b.get("i18nValue"),handler:this.processIMIP.createDelegate(this,[b.id]),icon:b.get("icon")}))},this);this.actions=this.actions.concat(this.statusActions);this.iMIPclause=new Ext.Toolbar.TextItem({text:""});this.tbar=this.actionToolbar=new Ext.Toolbar({items:[{xtype:"tbitem",cls:"CalendarIconCls",width:16,height:16,style:"margin: 3px 5px 2px 5px;"},this.iMIPclause,"->"].concat(this.actions)})},showIMIP:function(){var d=this.getSingleRecordPanel(),b=this.iMIPrecord.get("preconditions"),g=this.iMIPrecord.get("method"),c=this.iMIPrecord.get("event"),a=this.iMIPrecord.get("existing_event"),e=c.getMyAttenderRecord(),f=e?e.get("status"):null;if(a&&a.container_id){c.set("container_id",a.container_id)}Ext.each(this.actions,function(h){h.setHidden(true)});if(b){if(b.hasOwnProperty("EVENTEXISTS")){this.iMIPclause.setText(this.app.i18n._("The event of this message does not exist"))}else{if(b.hasOwnProperty("ORIGINATOR")){this.iMIPclause.setText(this.app.i18n._("The sender is not authorised to update the event"))}else{if(b.hasOwnProperty("RECENT")){this.iMIPclause.setText(this.app.i18n._("This message is already processed"))}else{if(b.hasOwnProperty("ATTENDEE")){this.iMIPclause.setText(this.app.i18n._("You are not an attendee of this event"))}else{this.iMIPclause.setText(this.app.i18n._("Unsupported message"))}}}}}else{switch(g){case"REQUEST":if(!e){this.iMIPclause.setText(this.app.i18n._("This is an event invitation for someone else."))}else{if(f!=="NEEDS-ACTION"){this.iMIPclause.setText(this.app.i18n._("You have already replied to this event invitation."))}else{this.iMIPclause.setText(this.app.i18n._("You received an event invitation. Set your response to:"));Ext.each(this.statusActions,function(h){h.setHidden(false)})}}break;case"REPLY":this.iMIPclause.setText(this.app.i18n._("An invited attendee responded to the invitation."));break;default:this.iMIPclause.setText(this.app.i18n._("Unsupported method"));break}}this.getLoadMask().hide();d.setVisible(true);d.setHeight(150);this.record=c;d.loadRecord(c)}});Ext.ns("Tine.Calendar");Tine.Calendar.CalDAVContainerPropertiesHookField=Ext.extend(Ext.form.TextField,{anchor:"100%",readOnly:true,initComponent:function(){this.on("added",this.onContainerAdded,this);Tine.Calendar.CalDAVContainerPropertiesHookField.superclass.initComponent.call(this)},onContainerAdded:function(){this.app=Tine.Tinebase.appMgr.get("Calendar");this.fieldLabel=this.app.i18n._("CalDAV URL");this.propertiesDialog=this.findParentBy(function(a){return !!a.grantContainer});this.grantContainer=this.propertiesDialog.grantContainer;if(this.grantContainer.application_id&&this.grantContainer.application_id.name){this.isCalendar=(this.grantContainer.application_id.name=="Calendar")}else{this.isCalendar=this.grantContainer.application_id===this.app.id}this.hidden=!this.isCalendar;this.value=[window.location.href.replace(/\/?(index\.php.*)?$/,""),"/calendars/",Tine.Tinebase.registry.get("currentAccount").contact_id,"/",this.grantContainer.id].join("")}});Ext.ux.ItemRegistry.registerItem("Tine.widgets.container.PropertiesDialog.FormItems.Properties",Tine.Calendar.CalDAVContainerPropertiesHookField,100);Ext.ns("Tine.Calendar");Tine.Calendar.AddToEventPanel=Ext.extend(Tine.widgets.dialog.AddToRecordPanel,{appName:"Calendar",recordClass:Tine.Calendar.Model.Event,callingApp:"Addressbook",callingModel:"Contact",isValid:function(){var a=true;if(this.searchBox.getValue()==""){this.searchBox.markInvalid(this.app.i18n._("Please choose the Event to add the contacts to"));a=false}return a},getRelationConfig:function(){var a={role:this.chooseRoleBox.getValue(),status:this.chooseStatusBox.getValue()};return a},getFormItems:function(){return{border:false,frame:false,layout:"border",items:[{region:"center",border:false,frame:false,layout:{align:"stretch",type:"vbox"},items:[{layout:"form",margins:"10px 10px",border:false,frame:false,items:[Tine.widgets.form.RecordPickerManager.get("Calendar","Event",{ref:"../../../searchBox"}),{fieldLabel:this.app.i18n._("Role"),emptyText:this.app.i18n._("Select Role"),xtype:"widget-keyfieldcombo",app:"Calendar",value:"REQ",anchor:"100% 100%",margins:"10px 10px",keyFieldName:"attendeeRoles",ref:"../../../chooseRoleBox"},{fieldLabel:this.app.i18n._("Status"),emptyText:this.app.i18n._("Select Status"),xtype:"widget-keyfieldcombo",app:"Calendar",value:"NEEDS-ACTION",anchor:"100% 100%",margins:"10px 10px",keyFieldName:"attendeeStatus",ref:"../../../chooseStatusBox"}]}]}]}}});Tine.Calendar.AddToEventPanel.openWindow=function(a){var b=Tine.WindowFactory.getWindow({modal:true,title:String.format(Tine.Tinebase.appMgr.get("Calendar").i18n._("Adding {0} Attendee to event"),a.count),width:240,height:250,contentPanelConstructor:"Tine.Calendar.AddToEventPanel",contentPanelConstructorConfig:a});return b};Ext.ns("Tine.Calendar");Tine.Calendar.calendarRenderer=function(i,b,e,g,k,j){var c=Tine.Tinebase.appMgr.get("Calendar");if(e){var d=e.get("container_id"),a=e.getDisplayContainer(),f="",h="";if(!Ext.isPrimitive(d)){f=Tine.Tinebase.common.containerRenderer(d)}else{f=Tine.Tinebase.common.containerRenderer(a)}h+=Ext.isPrimitive(d)?Ext.util.Format.htmlEncode(c.i18n._("This event is originally stored in a calendar you don't have access to.")):String.format(Ext.util.Format.htmlEncode(c.i18n._("This event is originally stored in {0}")),Ext.util.Format.htmlEncode(Tine.Tinebase.common.containerRenderer(d)));h+=a&&!Tine.Tinebase.container.pathIsMyPersonalContainer(d.path)?String.format(Ext.util.Format.htmlEncode(c.i18n._("This event is additionally displayed in your personal calendar {0}")),Ext.util.Format.htmlEncode(Tine.Tinebase.common.containerRenderer(a))):"";return f.replace("<div ",'<div ext:qtip="'+h+'" ')}else{return Tine.Tinebase.common.containerRenderer(i)}};Tine.widgets.grid.RendererManager.register("Calendar","Event","container_id",Tine.Calendar.calendarRenderer);