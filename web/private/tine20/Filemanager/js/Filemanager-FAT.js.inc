/*
 * Tine 2.0 - Filemanager 
 * Copyright (c) 2007-2011 Metaways Infosystems GmbH (http://www.metaways.de)
 * http://www.gnu.org/licenses/agpl.html AGPL Version 3
 */
Ext.ns("Tine.Filemanager");Tine.Filemanager.GridContextMenu={addNode:function(){Tine.log.debug("grid add")},renameNode:function(){if(this.scope.ctxNode){var b=this.scope.ctxNode[0];var a=b.data.name;if(typeof a=="object"){a=a.name}Ext.MessageBox.show({title:"Rename "+this.nodeName,msg:String.format(_("Please enter the new name of the {0}:"),this.nodeName),buttons:Ext.MessageBox.OKCANCEL,value:a,fn:function(f,g){if(f=="ok"){if(!g){Ext.Msg.alert(String.format(_("Not renamed {0}"),this.nodeName),String.format(_("You have to supply a {0} name!"),this.nodeName));return}var j={method:this.backend+".rename"+this.backendModel,newName:g};if(this.backendModel=="Node"){j.application=this.scope.app.appName||this.scope.appName;var d=b.data.path;j.sourceFilenames=[d];var h="/";var c=d.split("/");for(var e=1;e<c.length-1;e++){h+=c[e]+"/"}j.destinationFilenames=[h+g];j.method=this.backend+".moveNodes"}Ext.Ajax.request({params:j,scope:this,success:function(n,l){var k=Ext.util.JSON.decode(n.responseText)[0];this.scope.fireEvent("containerrename",k);if(this.backendModel=="Node"){var m=this.scope.app.getMainScreen().getCenterPanel();m.getStore().reload();var p=k.name;if(typeof p=="object"){p=p.name}var o=this.scope.app.getMainScreen().getWestPanel().getContainerTreePanel().getNodeById(k.id);if(o){o.setText(p);o.attributes.nodeRecord.beginEdit();o.attributes.nodeRecord.set("name",p);o.attributes.nodeRecord.set("path",k.path);o.attributes.path=k.path;o.attributes.nodeRecord.commit(false);if(typeof o.attributes.name=="object"){o.attributes.name.name=p}else{o.attributes.name=p}}}},failure:function(k,n){var l=Ext.util.JSON.decode(k.responseText);var m=Tine[this.scope.app.appName];if(m&&m.handleRequestException){m.handleRequestException(l.data)}}})}},scope:this,prompt:true,icon:Ext.MessageBox.QUESTION})}},deleteNode:function(){if(this.scope.ctxNode){var a=this.scope.ctxNode;var d="";if(a&&a.length){for(var c=0;c<a.length;c++){var b=a[c].data;if(typeof b.name=="object"){d+=b.name.name+"<br />"}else{d+=b.name+"<br />"}}}this.conflictConfirmWin=Tine.widgets.dialog.FileListDialog.openWindow({modal:true,allowCancel:false,height:180,width:300,title:this.scope.app.i18n._("Do you really want to delete the following files?"),text:d,scope:this,handler:function(f){if(f=="yes"){var h={method:this.backend+".delete"+this.backendModel};if(this.backendModel=="Node"){var g=new Array();if(a){for(var e=0;e<a.length;e++){g.push(a[e].data.path)}}h.application=this.scope.app.appName||this.scope.appName;h.filenames=g;h.method=this.backend+".deleteNodes"}Ext.Ajax.request({params:h,scope:this,success:function(m,k){if(a&&this.backendModel=="Node"){var o=this.scope.app.getMainScreen().getWestPanel().getContainerTreePanel();for(var l=0;l<a.length;l++){o.fireEvent("containerdelete",a[l].data.container_id);var p=o.getNodeById(a[l].id);if(p){p.parentNode.removeChild(p)}}for(var l=0;l<a.length;l++){var n=a[l];if(n.fileRecord){var j=Tine.Tinebase.uploadManager.getUpload(n.fileRecord.get("uploadKey"));j.setPaused(true);Tine.Tinebase.uploadManager.unregisterUpload(j.id)}}this.scope.app.getMainScreen().getCenterPanel().getStore().remove(a)}},failure:function(j,m){var k=Ext.util.JSON.decode(j.responseText);var l=Tine[this.scope.app.appName];if(l&&l.handleRequestException){l.handleRequestException(k.data)}}})}}})}},changeNodeColor:function(b,a){Tine.log.debug("grid change color")},managePermissions:function(){Tine.log.debug("grid manage permissions")},reloadNode:function(){Tine.log.debug("grid reload node")},onEditFile:function(b,c){var d=Tine.Tinebase.appMgr.get("Filemanager");var a=d.getMainScreen().getCenterPanel();a.onEditFile.call(a)},downloadFile:function(c,d){var b=this.scope.app.getMainScreen().getCenterPanel();var g=b.selectionModel.getSelections();var f=g[0];var a=f.data.path;var e=new Ext.ux.file.Download({params:{method:"Filemanager.downloadFile",requestType:"HTTP",id:"",path:a}}).start()},isDownloadEnabled:function(e,a,b){for(var d=0;d<b.length;d++){if(b[d].data.type==="folder"){e.hide();return}}e.show();var c=this.scope.app.getMainScreen().getCenterPanel();var f=c.selectionModel.getSelections();if(f.length>1){e.setDisabled(true)}else{e.setDisabled(false)}},onPause:function(e,g){var d=this.scope;var f=d.store;f.suspendEvents();var h=d.selectionModel.getSelections();for(var c=0;c<h.length;c++){var a=h[c];if(a.fileRecord){a=a.fileRecord}var b=Tine.Tinebase.uploadManager.getUpload(a.get("uploadKey"));b.setPaused(true)}f.resumeEvents();d.actionUpdater.updateActions(f);this.scope.selectionModel.deselectRange(0,this.scope.selectionModel.getCount())},onResume:function(e,g){var d=this.scope;var f=d.store;f.suspendEvents();var h=d.selectionModel.getSelections();for(var c=0;c<h.length;c++){var a=h[c];if(a.fileRecord){a=a.fileRecord}var b=Tine.Tinebase.uploadManager.getUpload(a.get("uploadKey"));b.resumeUpload()}f.resumeEvents();d.actionUpdater.updateActions(f);this.scope.selectionModel.deselectRange(0,this.scope.selectionModel.getCount())},isResumeEnabled:function(e,b,c){for(var d=0;d<c.length;d++){var a=c[d];if(a.fileRecord){a=a.fileRecord}if(a.get("type")=="folder"){e.hide();return}}for(var d=0;d<c.length;d++){var a=c[d];if(a.fileRecord){a=a.fileRecord}if(!a.get("status")||(a.get("type")!="folder"&&a.get("status")!="uploading"&&a.get("status")!="paused"&&a.get("status")!="pending")){e.hide();return}}e.show();for(var d=0;d<c.length;d++){var a=c[d];if(a.fileRecord){a=a.fileRecord}if(a.get("status")){e.setDisabled(false)}else{e.setDisabled(true)}if(a.get("status")&&a.get("status")!="paused"){e.setDisabled(true)}}},isPauseEnabled:function(e,b,c){for(var d=0;d<c.length;d++){var a=c[d];if(a.fileRecord){a=a.fileRecord}if(a.get("type")==="folder"){e.hide();return}}for(var d=0;d<c.length;d++){var a=c[d];if(a.fileRecord){a=a.fileRecord}if(!a.get("status")||(a.get("type ")!="folder"&&a.get("status")!="paused"&&a.get("status")!="uploading"&&a.get("status")!="pending")){e.hide();return}}e.show();for(var d=0;d<c.length;d++){var a=c[d];if(a.fileRecord){a=a.fileRecord}if(a.get("status")){e.setDisabled(false)}else{e.setDisabled(true)}if(a.get("status")&&a.get("status")!=="uploading"){e.setDisabled(true)}}}};Ext.applyIf(Tine.Filemanager.GridContextMenu,Tine.widgets.tree.ContextMenu);Ext.ns("Tine.Filemanager.Model");Tine.Filemanager.Model.Node=Tine.Tinebase.data.Record.create(Tine.Tinebase.Model.genericFields.concat([{name:"id"},{name:"name"},{name:"path"},{name:"size"},{name:"revision"},{name:"type"},{name:"contenttype"},{name:"description"},{name:"account_grants"},{name:"description"},{name:"object_id"},{name:"relations"},{name:"customfields"},{name:"notes"},{name:"tags"}]),{appName:"Filemanager",modelName:"Node",idProperty:"id",titleProperty:"name",recordName:"File",recordsName:"Files",containerProperty:null,containerName:"Folder",containersName:"Folders",isCreateFolderAllowed:function(){var a=this.get("account_grants");if(!a&&this.data.id!=="personal"&&this.data.id!=="shared"){return false}else{if(!a&&(this.data.id==="personal"||(this.data.id==="shared"&&(Tine.Tinebase.common.hasRight("admin",this.appName)||Tine.Tinebase.common.hasRight("manage_shared_folders",this.appName))))){return true}else{if(!a){return false}}}return this.get("type")=="file"?a.editGrant:a.addGrant},isDropFilesAllowed:function(){var a=this.get("account_grants");if(!a){return false}else{if(!a.addGrant){return false}}return true},isDragable:function(){var a=this.get("account_grants");if(!a){return false}if(this.get("id")==="personal"||this.get("id")==="shared"||this.get("id")==="otherUsers"){return false}return true}});Tine.Filemanager.Model.Node.createFromFile=function(a){return new Tine.Filemanager.Model.Node({name:a.name?a.name:a.fileName,size:a.size||0,type:"file",contenttype:a.type?a.type:a.fileType,revision:0})};Tine.Filemanager.fileRecordBackend=new Tine.Tinebase.data.RecordProxy({appName:"Filemanager",modelName:"Node",recordClass:Tine.Filemanager.Model.Node,createFolder:function(b,a){a=a||{};var c={application:this.appName,filename:b,type:"folder",method:this.appName+".createNode"};a.params=c;a.beforeSuccess=function(d){var e=this.recordReader(d);e.set("client_access_time",new Date());return[e]};a.success=function(e){var j=Tine.Tinebase.appMgr.get(Tine.Filemanager.fileRecordBackend.appName);var h=j.getMainScreen().getCenterPanel();var f=Ext.util.JSON.decode(e);var g=j.getMainScreen().getWestPanel().getContainerTreePanel().createTreeNode(f,d);var d=h.currentFolderNode;if(d){d.appendChild(g)}h.getStore().reload()};return this.doXHTTPRequest(a)},saveRecord:function(a,b){if(a.hasOwnProperty("fileRecord")){return}else{Tine.Tinebase.data.RecordProxy.prototype.saveRecord.call(this,a,b)}},deleteItems:function(b,c){c=c||{};var e=new Array();var a=b.length;for(var d=0;d<a;d++){e.push(b[d].data.path)}var f={application:this.appName,filenames:e,method:this.appName+".deleteNodes",timeout:300000};c.params=f;c.beforeSuccess=function(g){var h=this.recordReader(g);h.set("client_access_time",new Date());return[h]};c.success=(function(g){var n=Tine.Tinebase.appMgr.get(Tine.Filemanager.fileRecordBackend.appName),k=n.getMainScreen().getCenterPanel(),l=n.getMainScreen().getWestPanel().getContainerTreePanel(),h=this.items;for(var j=0;j<h.length;j++){var m=l.getNodeById(h[j].id);if(m){m.parentNode.removeChild(m)}}k.getStore().remove(h);k.selectionModel.deselectRange(0,k.getStore().getCount());k.pagingToolbar.refresh.enable()}).createDelegate({items:b});return this.doXHTTPRequest(c)},copyNodes:function(k,s,l,r){var h=false,j="",g=Tine.Tinebase.appMgr.get(Tine.Filemanager.fileRecordBackend.appName);if(!r){if(!s||!k||k.length<1){return false}var f=new Array(),e=new Array(),b=false,a=false,m=false,d;if(s.data){d=s.data.path}else{d=s.attributes.path;a=true}for(var n=0;n<k.length;n++){var q=k[n];var o=q.data;if(!o){o=q.attributes;m=true}f.push(o.path);var p=o.name;if(typeof p=="object"){p=p.name}e.push(d+"/"+p);if(o.type=="folder"){h=true}}var c="Filemanager.copyNodes",j=g.i18n._("Copying data .. {0}");if(l){c="Filemanager.moveNodes";j=g.i18n._("Moving data .. {0}")}r={application:this.appName,sourceFilenames:f,destinationFilenames:e,forceOverwrite:b,method:c}}else{j=g.i18n._("Copying data .. {0}");if(r.method=="Filemanager.moveNodes"){j=g.i18n._("Moving data .. {0}")}}this.loadMask=new Ext.LoadMask(g.getMainScreen().getCenterPanel().getEl(),{msg:String.format(_("Please wait"))+". "+String.format(j,"")});g.getMainScreen().getWestPanel().setDisabled(true);g.getMainScreen().getNorthPanel().setDisabled(true);this.loadMask.show();Ext.Ajax.request({params:r,timeout:300000,scope:this,success:function(C,w){this.loadMask.hide();g.getMainScreen().getWestPanel().setDisabled(false);g.getMainScreen().getNorthPanel().setDisabled(false);var u=Ext.util.JSON.decode(C.responseText),y=g.getMainScreen().getWestPanel().getContainerTreePanel(),t=g.getMainScreen().getCenterPanel();if(a){for(var z=0;z<k.length;z++){var B=k[z];if(B.data&&B.data.type!=="folder"){continue}if(l){var A=y.cloneTreeNode(B,s),x=B.id,v=y.getNodeById(x);if(v&&v.parentNode){v.parentNode.removeChild(v)}s.appendChild(A);A.setId(u[z].id)}else{var A=y.cloneTreeNode(B,s);s.appendChild(A);A.setId(u[z].id)}}}t.getStore().reload()},failure:function(t,v){var u=Ext.util.JSON.decode(t.responseText),v=Ext.util.JSON.decode(v.jsonData);this.loadMask.hide();g.getMainScreen().getWestPanel().setDisabled(false);g.getMainScreen().getNorthPanel().setDisabled(false);Tine.Filemanager.fileRecordBackend.handleRequestException(u.data,v)}})},createNode:function(h,b,e){var g=Tine.Tinebase.appMgr.get("Filemanager"),a=g.getMainScreen().getCenterPanel(),d=a.getStore();h.application="Filemanager";h.method="Filemanager.createNode";h.uploadKey=b;h.addToGridStore=e;var f=(function(j,n){var l=Ext.util.JSON.decode(response.responseText),k=Tine.Tinebase.uploadManager.upload(this.uploadKey);if(e){var m=d.query("name",k.get("name"));if(m.items[0]){d.remove(m.items[0])}k=Tine.Filemanager.fileRecordBackend.updateNodeRecord(l[i],k);var o=new Tine.Filemanager.Model.Node(l[i]);o.fileRecord=k;d.add(o)}}).createDelegate({uploadKey:b,addToGridStore:e});var c=(function(j,l){var k=Ext.util.JSON.decode(j.responseText),l=Ext.util.JSON.decode(l.jsonData);k.data.uploadKey=this.uploadKey;k.data.addToGridStore=this.addToGridStore;Tine.Filemanager.fileRecordBackend.handleRequestException(k.data,l)}).createDelegate({uploadKey:b,addToGridStore:e});Ext.Ajax.request({params:h,timeout:300000,scope:this,success:f||Ext.emptyFn,failure:c||Ext.emptyFn})},createNodes:function(h,d,e){var g=Tine.Tinebase.appMgr.get("Filemanager"),a=g.getMainScreen().getCenterPanel(),c=a.store;h.application="Filemanager";h.method="Filemanager.createNodes";h.uploadKeyArray=d;h.addToGridStore=e;var f=(function(k,o){var l=Ext.util.JSON.decode(k.responseText);for(var m=0;m<this.uploadKeyArray.length;m++){var j=Tine.Tinebase.uploadManager.upload(this.uploadKeyArray[m]);if(e){j=Tine.Filemanager.fileRecordBackend.updateNodeRecord(l[m],j);var p=new Tine.Filemanager.Model.Node(l[m]);p.fileRecord=j;var n=c.find("name",j.get("name"));if(n>-1){c.removeAt(n);c.insert(n,p)}else{c.add(p)}}}}).createDelegate({uploadKeyArray:d,addToGridStore:e});var b=(function(j,l){var k=Ext.util.JSON.decode(j.responseText),l=Ext.util.JSON.decode(l.jsonData);k.data.uploadKeyArray=this.uploadKeyArray;k.data.addToGridStore=this.addToGridStore;Tine.Filemanager.fileRecordBackend.handleRequestException(k.data,l)}).createDelegate({uploadKeyArray:d,addToGridStore:e});Ext.Ajax.request({params:h,timeout:300000,scope:this,success:f||Ext.emptyFn,failure:b||Ext.emptyFn})},handleRequestException:function(a,b){Tine.Filemanager.handleRequestException(a,b)},updateNodeRecord:function(a,c){for(var b in a){c.set(b,a[b])}return c}});Tine.Filemanager.Model.Node.getFilterModel=function(){var a=Tine.Tinebase.appMgr.get("Filemanager");return[{label:_("Quick search"),field:"query",operators:["contains"]},{label:a.i18n._("Contenttype"),field:"contenttype"},{label:a.i18n._("Creation Time"),field:"creation_time",valueType:"date"},{filtertype:"tine.filemanager.pathfiltermodel",app:a},{filtertype:"tinebase.tag",app:a}]};Ext.ns("Tine.Filemanager");Tine.Filemanager.PathFilterModel=Ext.extend(Tine.widgets.grid.FilterModel,{app:null,operators:["equals"],field:"path",defaultOperator:"equals",defaultValue:"/",initComponent:function(){this.label=this.app.i18n._("path");Tine.Filemanager.PathFilterModel.superclass.initComponent.call(this)},valueRenderer:function(b,a){var c=new Ext.ux.form.ClearableTextField({filter:b,width:this.filterValueWidth,id:"tw-ftb-frow-valuefield-"+b.id,renderTo:a,value:b.data.value?b.data.value:this.defaultValue,emptyText:this.emptyText,value:b.data.value});c.on("specialkey",function(f,d){if(d.getKey()==d.ENTER){this.onFiltertrigger()}},this);c.origSetValue=c.setValue.createDelegate(c);c.setValue=function(d){if(d&&d.path){d=d.path}else{if(Ext.isString(d)&&(!d.charAt(0)||d.charAt(0)!="/")){d="/"+d}}return this.origSetValue(d)};return c}});Tine.widgets.grid.FilterToolbar.FILTERS["tine.filemanager.pathfiltermodel"]=Tine.Filemanager.PathFilterModel;Ext.ns("Tine.Filemanager");Tine.Filemanager.SearchCombo=Ext.extend(Tine.Tinebase.widgets.form.RecordPickerComboBox,{allowBlank:false,itemSelector:"div.search-item",minListWidth:200,initComponent:function(){this.recordClass=Tine.Filemanager.Model.Node;this.recordProxy=Tine.Filemanager.recordBackend;this.initTemplate();Tine.Filemanager.SearchCombo.superclass.initComponent.call(this)},onBeforeQuery:function(a){Tine.Filemanager.SearchCombo.superclass.onBeforeQuery.apply(this,arguments);this.store.baseParams.filter.push({field:"recursive",operator:"equals",value:true});this.store.baseParams.filter.push({field:"path",operator:"equals",value:"/"})},initTemplate:function(){if(!this.tpl){this.tpl=new Ext.XTemplate('<tpl for="."><div class="search-item">','<table cellspacing="0" cellpadding="2" border="0" style="font-size: 11px;" width="100%">',"<tr>",'<td ext:qtip="{[this.renderPathName(values)]}" style="height:16px">{[this.renderFileName(values)]}</td>',"</tr>","</table>","</div></tpl>",{renderFileName:function(a){return Ext.util.Format.htmlEncode(a.name)},renderPathName:function(a){return Ext.util.Format.htmlEncode(a.path.replace(a.name,""))}})}},getValue:function(){return Tine.Filemanager.SearchCombo.superclass.getValue.call(this)},setValue:function(a){return Tine.Filemanager.SearchCombo.superclass.setValue.call(this,a)}});Tine.widgets.form.RecordPickerManager.register("Filemanager","Node",Tine.Filemanager.SearchCombo);Ext.ns("Tine.Filemanager");Tine.Filemanager.PathFilterPlugin=Ext.extend(Tine.widgets.tree.FilterPlugin,{selectValue:function(b){var a=Ext.isArray(b)?b:[b];Ext.each(a,function(c){var d=Ext.isString(c)?c:(c?c.path:"")||"/",e=this.treePanel.getTreePath(d);this.selectPath.call(this.treePanel,e,null,function(){c.isExpanded=true;var f=true;Ext.each(a,function(g){f&=g.isExpanded},this);if(f){this.treePanel.getSelectionModel().resumeEvents();this.treePanel.updateActions(this.treePanel.getSelectionModel(),this.treePanel.getSelectionModel().getSelectedNode());Tine.Tinebase.appMgr.get("Filemanager").getMainScreen().getCenterPanel().currentFolderNode=this.treePanel.getSelectionModel().getSelectedNode()}}.createDelegate(this),true)},this)}});Ext.ns("Tine.Filemanager");Tine.Filemanager.NodeEditDialog=Ext.extend(Tine.widgets.dialog.EditDialog,{windowNamePrefix:"NodeEditWindow_",appName:"Filemanager",recordClass:Tine.Filemanager.Model.Node,recordProxy:Tine.Filemanager.fileRecordBackend,tbarItems:[{xtype:"widget-activitiesaddbutton"}],evalGrants:true,showContainerSelector:false,initComponent:function(){this.app=Tine.Tinebase.appMgr.get("Filemanager");this.downloadAction=new Ext.Action({requiredGrant:"readGrant",allowMultiple:false,actionType:"download",text:this.app.i18n._("Save locally"),handler:this.onDownload,iconCls:"action_filemanager_save_all",disabled:false,scope:this});this.tbarItems.push(this.downloadAction);Tine.Filemanager.NodeEditDialog.superclass.initComponent.call(this)},onDownload:function(){var a=new Ext.ux.file.Download({params:{method:"Filemanager.downloadFile",requestType:"HTTP",path:"",id:this.record.get("id")}}).start()},getFormItems:function(){var a={xtype:"textfield",anchor:"100%",labelSeparator:"",columnWidth:0.5,readOnly:true,disabled:true};return{xtype:"tabpanel",border:false,plain:true,plugins:[{ptype:"ux.tabpanelkeyplugin"}],activeTab:0,border:false,items:[{title:this.app.i18n._("Node"),autoScroll:true,border:false,frame:true,layout:"border",items:[{region:"center",layout:"hfit",border:false,items:[{xtype:"fieldset",layout:"hfit",autoHeight:true,title:this.app.i18n._("Node"),items:[{xtype:"columnform",labelAlign:"top",formDefaults:a,items:[[{fieldLabel:this.app.i18n._("Name"),name:"name",allowBlank:false,readOnly:false,columnWidth:0.75,disabled:false},{fieldLabel:this.app.i18n._("Type"),name:"contenttype",columnWidth:0.25}],[Tine.widgets.form.RecordPickerManager.get("Addressbook","Contact",{userOnly:true,useAccountRecord:true,blurOnSelect:true,fieldLabel:this.app.i18n._("Created By"),name:"created_by"}),{fieldLabel:this.app.i18n._("Creation Time"),name:"creation_time",xtype:"datefield"}],[Tine.widgets.form.RecordPickerManager.get("Addressbook","Contact",{userOnly:true,useAccountRecord:true,blurOnSelect:true,fieldLabel:this.app.i18n._("Modified By"),name:"last_modified_by"}),{fieldLabel:this.app.i18n._("Last Modified"),name:"last_modified_time",xtype:"datefield"}]]}]}]},{layout:"accordion",animate:true,region:"east",width:210,split:true,collapsible:true,collapseMode:"mini",header:false,margins:"0 5 0 5",border:true,items:[new Ext.Panel({title:this.app.i18n._("Description"),iconCls:"descriptionIcon",layout:"form",labelAlign:"top",border:false,items:[{style:"margin-top: -4px; border 0px;",labelSeparator:"",xtype:"textarea",name:"description",hideLabel:true,grow:false,preventScrollbars:false,anchor:"100% 100%",emptyText:this.app.i18n._("Enter description"),requiredGrant:"editGrant"}]}),new Tine.widgets.activities.ActivitiesPanel({app:"Filemanager",showAddNoteForm:false,border:false,bodyStyle:"border:1px solid #B5B8C8;"}),new Tine.widgets.tags.TagPanel({app:"Filemanager",border:false,bodyStyle:"border:1px solid #B5B8C8;"})]}]},new Tine.widgets.activities.ActivitiesTabPanel({app:this.appName,record_id:this.record.id,record_model:this.appName+"_Model_"+this.recordClass.getMeta("modelName")})]}}});Tine.Filemanager.NodeEditDialog.openWindow=function(a){var c=(a.record&&a.record.id)?a.record.id:0;var b=Tine.WindowFactory.getWindow({width:800,height:570,name:Tine.Filemanager.NodeEditDialog.prototype.windowNamePrefix+c,contentPanelConstructor:"Tine.Filemanager.NodeEditDialog",contentPanelConstructorConfig:a});return b};Ext.ns("Tine.Filemanager");Tine.Filemanager.NodeTreePanel=function(a){Ext.apply(this,a);this.addEvents("containeradd","containerdelete","containerrename");Tine.Filemanager.NodeTreePanel.superclass.constructor.call(this)};Ext.extend(Tine.Filemanager.NodeTreePanel,Tine.widgets.container.TreePanel,{filterMode:"filterToolbar",recordClass:Tine.Filemanager.Model.Node,allowMultiSelection:false,defaultContainerPath:"/personal",ddGroup:"fileDDGroup",enableDD:true,initComponent:function(){this.on("containeradd",this.onFolderAdd,this);this.on("containerrename",this.onFolderRename,this);this.on("containerdelete",this.onFolderDelete,this);this.on("nodedragover",this.onNodeDragOver,this);Tine.Tinebase.uploadManager.on("update",this.onUpdate);Tine.Filemanager.NodeTreePanel.superclass.initComponent.call(this);this.dropConfig={ddGroup:this.ddGroup||"fileDDGroup",appendOnly:this.ddAppendOnly===true,onNodeOver:function(h,a,g,f){var b=false,d=false;if(a.dragData.selections){for(var c=0;c<a.dragData.selections.length;c++){if(h.node.id==a.dragData.selections[c].id){b=true}if(a.dragData.selections[c].data.type=="file"){d=true}}}else{if(a.dragData.node&&a.dragData.node.id==h.node.id){b=true}}if(d&&!h.node.attributes.account_grants){b=true}if(h.node.isAncestor(a.dragData.node)){b=true}return h.node.attributes.nodeRecord.isCreateFolderAllowed()&&(!a.dragData.node||a.dragData.node.attributes.nodeRecord.isDragable())&&!b?"x-dd-drop-ok":false},isValidDropPoint:function(h,g,a,f){var b=false,d=false;if(a.dragData.selections){for(var c=0;c<a.dragData.selections.length;c++){if(h.node.id==a.dragData.selections[c].id){b=true}if(a.dragData.selections[c].data.type=="file"){d=true}}}else{if(a.dragData.node&&a.dragData.node.id==h.node.id){b=true}}if(d&&!h.node.attributes.account_grants){b=true}if(h.node.isAncestor(a.dragData.node)){b=true}return h.node.attributes.nodeRecord.isCreateFolderAllowed()&&(!a.dragData.node||a.dragData.node.attributes.nodeRecord.isDragable())&&!b},completeDrop:function(d){var b=d.dropNode,c=d.point,a=d.target;a.ui.endDrop();this.tree.fireEvent("nodedrop",d)}};this.dragConfig={ddGroup:this.ddGroup||"fileDDGroup",scroll:this.ddScroll,onInitDrag:function(b){var a=this.dragData;this.tree.eventModel.disable();this.proxy.update("");a.node.ui.appendDDGhost(this.proxy.ghost.dom);this.tree.fireEvent("startdrag",this.tree,a.node,b)}};this.plugins=this.plugins||[];this.plugins.push({ptype:"ux.browseplugin",enableFileDialog:false,multiple:true,handler:this.dropIntoTree})},getFilterPlugin:function(){if(!this.filterPlugin){this.filterPlugin=new Tine.Filemanager.PathFilterPlugin({treePanel:this,field:"path",nodeAttributeField:"path"})}return this.filterPlugin},getRootPath:function(){return Tine.Tinebase.container.getMyFileNodePath()},onBeforeLoad:function(e){var g=e.attributes.path;var c=Tine.Tinebase.container.path2type(g);var a=Tine.Tinebase.container.pathIsPersonalNode(g);var f=Tine.Tinebase.registry.get("currentAccount").accountLoginName;if(c==="personal"&&a!=f){c="otherUsers"}var d=g;if(c==="personal"&&a){var b=g.toString().split("/");d="/"+b[1]+"/"+f;if(b[3]){d+="/"+b[3]}}var h={method:"Filemanager.searchNodes",application:this.app.appName,owner:a,filter:[{field:"path",operator:"equals",value:d},{field:"type",operator:"equals",value:"folder"}],paging:{dir:"ASC",limit:50,sort:"name",start:0}};return h},onBeforeCreateNode:function(a){Tine.Filemanager.NodeTreePanel.superclass.onBeforeCreateNode.apply(this,arguments);a.leaf=false;if(a.path&&a.created_by){var c=a.path.split("/");a.id=c.pop()}if(a.name&&typeof a.name=="object"){Ext.apply(a,{text:Ext.util.Format.htmlEncode(a.name.name),qtip:Tine.Tinebase.common.doubleEncode(a.name.name)})}var b=Ext.copyTo({},a,Tine.Filemanager.Model.Node.getFieldNames());a.nodeRecord=new Tine.Filemanager.Model.Node(b)},initContextMenu:function(){this.contextMenuUserFolder=Tine.widgets.tree.ContextMenu.getMenu({nodeName:this.app.i18n._(this.containerName),actions:["add","reload","delete","rename","properties"],scope:this,backend:"Filemanager",backendModel:"Node"});this.contextMenuRootFolder=Tine.widgets.tree.ContextMenu.getMenu({nodeName:this.app.i18n._(this.containerName),actions:["add","reload"],scope:this,backend:"Filemanager",backendModel:"Node"});this.contextMenuOtherUserFolder=Tine.widgets.tree.ContextMenu.getMenu({nodeName:this.app.i18n._(this.containerName),actions:["reload"],scope:this,backend:"Filemanager",backendModel:"Node"});this.contextMenuContainerFolder=Tine.widgets.tree.ContextMenu.getMenu({nodeName:this.app.i18n._(this.containerName),actions:["add","reload","delete","rename","grants","properties"],scope:this,backend:"Filemanager",backendModel:"Node"});this.contextMenuReloadFolder=Tine.widgets.tree.ContextMenu.getMenu({nodeName:this.app.i18n._(this.containerName),actions:["reload","properties"],scope:this,backend:"Filemanager",backendModel:"Node"})},afterRender:function(){Tine.Filemanager.NodeTreePanel.superclass.afterRender.call(this)},onContextMenu:function(d,c){var b=Tine.Tinebase.registry.get("currentAccount");this.ctxNode=d;var a=d.attributes.nodeRecord.data,e=a.path;if(!Ext.isString(e)||d.isRoot){return}Tine.log.debug("Tine.Filemanager.NodeTreePanel::onContextMenu - context node:");Tine.log.debug(d);if(d.id=="otherUsers"||(d.parentNode&&d.parentNode.id=="otherUsers")){this.contextMenuOtherUserFolder.showAt(c.getXY())}else{if(d.id=="personal"||d.id=="shared"){this.contextMenuRootFolder.showAt(c.getXY())}else{if(e.match(/^\/shared/)&&(Tine.Tinebase.common.hasRight("admin",this.app.appName)||Tine.Tinebase.common.hasRight("manage_shared_folders",this.app.appName))){if(typeof a.name=="object"){this.contextMenuContainerFolder.showAt(c.getXY())}else{this.contextMenuUserFolder.showAt(c.getXY())}}else{if(e.match(/^\/shared/)){this.contextMenuReloadFolder.showAt(c.getXY())}else{if(e.match(/^\/personal/)&&e.match("/personal/"+b.accountLoginName)){if(typeof a.name=="object"){this.contextMenuContainerFolder.showAt(c.getXY())}else{this.contextMenuUserFolder.showAt(c.getXY())}}else{if(e.match(/^\/personal/)&&a.account_grants){this.contextMenuUserFolder.showAt(c.getXY())}}}}}}},updateActions:function(c,b){var a=this.app.getMainScreen().getCenterPanel();a.action_deleteRecord.disable();a.action_upload.disable();if(!!b&&!!b.isRoot){a.action_goUpFolder.disable()}else{a.action_goUpFolder.enable()}if(b&&b.attributes&&b.attributes.nodeRecord.isCreateFolderAllowed()){a.action_createFolder.enable()}else{a.action_createFolder.disable()}if(b&&b.attributes&&b.attributes.nodeRecord.isDropFilesAllowed()){a.action_upload.enable()}else{a.action_upload.disable()}},onSelectionChange:function(c,b){this.updateActions(c,b);var a=this.app.getMainScreen().getCenterPanel();a.currentFolderNode=b;Tine.Filemanager.NodeTreePanel.superclass.onSelectionChange.call(this,c,b)},getTreePath:function(a){var b="/"+this.getRootNode().id;if(a&&a!="/"){if(a=="/personal"){b+="/otherUsers"}b+=String(a).replace("personal/"+Tine.Tinebase.registry.get("currentAccount").accountLoginName,"personal")}return b},expandPath:function(h,a,j){var d=h.split(this.pathSeparator);var c=this.root;var g=c.attributes.path;var b=1;var e=function(){if(++b==d.length){if(j){j(true,c)}return}if(b>2){var f=c.findChild("path",g+"/"+d[b])}else{var f=c.findChild("id",d[b])}if(!f){if(j){j(false,c)}return}c=f;g=f.attributes.path;f.expand(false,false,e)};c.expand(false,false,e)},onBeforeNodeDrop:function(b){var a,c=b.target;if(b.data.selections){a=b.data.grid.selModel.selections.items}if(!a&&b.data.node){a=[b.data.node]}Tine.Filemanager.fileRecordBackend.copyNodes(a,c,!b.rawEvent.ctrlKey);b.dropStatus=true;return true},onFolderDelete:function(b){var a=this.app.getMainScreen().getCenterPanel();if(a.currentFolderNode.isAncestor&&typeof a.currentFolderNode.isAncestor=="function"&&a.currentFolderNode.isAncestor(b)){b.parentNode.select()}a.getStore().reload()},cloneTreeNode:function(d,e){var h=e.attributes.path,c="",g;if(d.attributes){var f=d.attributes.name;if(typeof f=="object"){f=f.name}c=h+"/"+f;g=new Ext.tree.AsyncTreeNode({text:d.text,path:c,name:d.attributes.name,nodeRecord:d.attributes.nodeRecord,account_grants:d.attributes.account_grants})}else{var f=d.data.name;if(typeof f=="object"){f=f.name}var a=Ext.copyTo({},d.data,Tine.Filemanager.Model.Node.getFieldNames());var b=new Tine.Filemanager.Model.Node(a);c=h+"/"+f;g=new Ext.tree.AsyncTreeNode({text:f,path:c,name:d.data.name,nodeRecord:b,account_grants:d.data.account_grants})}g.attributes.nodeRecord.beginEdit();g.attributes.nodeRecord.set("path",c);g.attributes.nodeRecord.endEdit();g.parentNode=e;return g},createTreeNode:function(a,d){var e=a.name;if(typeof e=="object"){e=e.name}var c=new Tine.Filemanager.Model.Node(a);var b=new Ext.tree.AsyncTreeNode({text:e,path:a.path,name:a.name,nodeRecord:c,account_grants:a.account_grants,id:a.id});b.attributes.nodeRecord.beginEdit();b.attributes.nodeRecord.set("path",a.path);b.attributes.nodeRecord.endEdit();b.parentNode=d;return b},onNodeCreated:function(c,f,d){var g=Tine.Tinebase.appMgr.get("Filemanager"),e=g.getMainScreen().getCenterPanel();var a=Ext.util.JSON.decode(c.responseText);var b=d.fileRecord;b.beginEdit();b.set("contenttype",a.contenttype);b.set("created_by",Tine.Tinebase.registry.get("currentAccount"));b.set("creation_time",a.creation_time);b.set("revision",a.revision);b.set("last_modified_by",a.last_modified_by);b.set("last_modified_time",a.last_modified_time);b.set("status","complete");b.set("progress",100);b.set("name",a.name);b.set("path",a.path);b.commit(false);d.fireEvent("update","uploadfinished",d,b);e.pagingToolbar.refresh.enable()},onUploadComplete:function(a,b){var d=Tine.Tinebase.appMgr.get("Filemanager"),c=d.getMainScreen().getWestPanel().getContainerTreePanel();if(a.fmDirector!=c){return}Ext.Ajax.request({timeout:10*60*1000,params:{method:"Filemanager.createNode",filename:a.id,type:"file",tempFileId:b.get("id"),forceOverwrite:true},success:c.onNodeCreated.createDelegate(this,[a],true),failure:c.onNodeCreated.createDelegate(this,[a],true)})},onUploadFail:function(){Ext.MessageBox.alert(_("Upload Failed"),_("Could not upload file. Filesize could be too big. Please notify your Administrator. Max upload size: ")+Tine.Tinebase.registry.get("maxFileUploadSize")).setIcon(Ext.MessageBox.ERROR)},onFolderAdd:function(a){var c=Tine.Tinebase.appMgr.get("Filemanager"),b=c.getMainScreen().getCenterPanel();b.getStore().reload();if(a.error){Tine.log.debug(a)}},onFolderRename:function(b,d,a){var e=Tine.Tinebase.appMgr.get("Filemanager"),c=e.getMainScreen().getCenterPanel();if(b[0]){b=b[0]}d.attributes.nodeRecord.beginEdit();d.attributes.nodeRecord.set("name",a);d.attributes.nodeRecord.set("path",b.path);d.attributes.path=b.path;d.attributes.nodeRecord.commit(false);if(typeof d.attributes.name=="object"){d.attributes.name.name=a}else{d.attributes.name=a}c.currenFolderNode=d;Tine.Filemanager.NodeTreePanel.superclass.onSelectionChange.call(this,this.getSelectionModel(),d)},onUpdate:function(g,b,a){var f=Tine.Tinebase.appMgr.get("Filemanager"),d=f.getMainScreen().getCenterPanel(),e=f.getMainScreen().getWestPanel().getContainerTreePanel(),c=d.getStore().query("name",a.get("name"));if(g=="uploadstart"){Tine.Tinebase.uploadManager.onUploadStart()}else{if(g=="uploadfailure"){e.onUploadFail()}}if(c.get(0)){if(g=="uploadcomplete"){e.onUploadComplete(b,a)}else{if(g=="uploadfinished"){c.get(0).set("size",b.fileSize);c.get(0).set("contenttype",a.get("contenttype"))}}c.get(0).afterEdit();c.get(0).commit(false)}},dropIntoTree:function(o,c){var j=o.component,e=j.app,a=e.getMainScreen().getCenterPanel(),l,k;var n;var d=c.getTarget("div").attributes["ext:tree-node-id"];if(d){n=d.nodeValue;l=j.getNodeById(n);k=l.attributes.path}if(!l.attributes.nodeRecord.isDropFilesAllowed()){Ext.MessageBox.alert(_("Upload Failed"),e.i18n._("Putting files in this folder is not allowed!")).setIcon(Ext.MessageBox.ERROR);return}var b=o.getFileList(),h=[],g=[],m=false;Ext.each(b,function(s){var t=s.name||s.fileName,r=k+"/"+t;var p=new Ext.ux.file.Upload({fmDirector:j,file:s,fileSelector:o,id:r});var q=Tine.Tinebase.uploadManager.queueUpload(p);h.push(r);g.push(q);m=a.currentFolderNode.id===n},this);var f={filenames:h,type:"file",tempFileIds:[],forceOverwrite:false};Tine.Filemanager.fileRecordBackend.createNodes(f,g,m)}});Ext.ns("Tine.Filemanager");Tine.Filemanager.NodeGridPanel=Ext.extend(Tine.widgets.grid.GridPanel,{filesProperty:"files",header:false,border:false,deferredRender:false,autoExpandColumn:"name",showProgress:true,recordClass:Tine.Filemanager.Model.Node,hasDetailsPanel:false,evalGrants:true,defaultSortInfo:{field:"name",direction:"DESC"},gridConfig:{autoExpandColumn:"name",enableFileDialog:false,enableDragDrop:true,ddGroup:"fileDDGroup"},ddGroup:"fileDDGroup",currentFolderNode:"/",initComponent:function(){this.recordProxy=Tine.Filemanager.fileRecordBackend;this.gridConfig.cm=this.getColumnModel();this.defaultFilters=[{field:"query",operator:"contains",value:""},{field:"path",operator:"equals",value:"/"}];this.filterToolbar=this.filterToolbar||this.getFilterToolbar();this.filterToolbar.getQuickFilterPlugin().criteriaIgnores.push({field:"path"});this.plugins=this.plugins||[];this.plugins.push(this.filterToolbar);this.plugins.push({ptype:"ux.browseplugin",multiple:true,scope:this,enableFileDialog:false,handler:this.onFilesSelect});Tine.Filemanager.NodeGridPanel.superclass.initComponent.call(this);this.getStore().on("load",this.onLoad);Tine.Tinebase.uploadManager.on("update",this.onUpdate)},afterRender:function(){Tine.Filemanager.NodeGridPanel.superclass.afterRender.call(this);this.action_upload.setDisabled(true);this.initDropTarget();this.currentFolderNode=this.app.getMainScreen().getWestPanel().getContainerTreePanel().getRootNode()},getColumnModel:function(){var a=[{id:"tags",header:this.app.i18n._("Tags"),dataIndex:"tags",width:50,renderer:Tine.Tinebase.common.tagsRenderer,sortable:false,hidden:false},{id:"name",header:this.app.i18n._("Name"),width:70,sortable:true,dataIndex:"name",renderer:Ext.ux.PercentRendererWithName},{id:"size",header:this.app.i18n._("Size"),width:40,sortable:true,dataIndex:"size",renderer:Tine.Tinebase.common.byteRenderer},{id:"contenttype",header:this.app.i18n._("Contenttype"),width:50,sortable:true,dataIndex:"contenttype",renderer:function(d,c,b){var e=Tine.Tinebase.appMgr.get("Filemanager");if(b.data.type=="folder"){return e.i18n._("Folder")}else{return d}}},{id:"creation_time",header:this.app.i18n._("Creation Time"),width:50,sortable:true,dataIndex:"creation_time",renderer:Tine.Tinebase.common.dateTimeRenderer},{id:"created_by",header:this.app.i18n._("Created By"),width:50,sortable:true,dataIndex:"created_by",renderer:Tine.Tinebase.common.usernameRenderer},{id:"last_modified_time",header:this.app.i18n._("Last Modified Time"),width:80,sortable:true,dataIndex:"last_modified_time",renderer:Tine.Tinebase.common.dateTimeRenderer},{id:"last_modified_by",header:this.app.i18n._("Last Modified By"),width:50,sortable:true,dataIndex:"last_modified_by",renderer:Tine.Tinebase.common.usernameRenderer}];return new Ext.grid.ColumnModel({defaults:{sortable:true,resizable:true},columns:a})},statusRenderer:function(a){return this.app.i18n._hidden(a)},initGrid:function(){Tine.Filemanager.NodeGridPanel.superclass.initGrid.call(this);if(this.usePagingToolbar){this.initPagingToolbar()}},initPagingToolbar:function(){if(!this.pagingToolbar||!this.pagingToolbar.rendered){this.initPagingToolbar.defer(50,this);return}if(!((!Ext.isGecko&&window.XMLHttpRequest&&window.File&&window.FileList)||(Ext.isGecko&&window.FileReader))){var a=new Ext.Panel({padding:2,html:String.format(this.app.i18n._("The max. Upload Filesize is {0} MB"),Tine.Tinebase.registry.get("maxFileUploadSize")/1048576)});this.pagingToolbar.insert(12,new Ext.Toolbar.Separator());this.pagingToolbar.insert(12,a);this.pagingToolbar.doLayout()}},getFilterToolbar:function(b){b=b||{};var a=[];if(!Ext.isDefined(this.hasQuickSearchFilterToolbarPlugin)||this.hasQuickSearchFilterToolbarPlugin){this.quickSearchFilterToolbarPlugin=new Tine.widgets.grid.FilterToolbarQuickFilterPlugin();a.push(this.quickSearchFilterToolbarPlugin)}return new Tine.widgets.grid.FilterToolbar(Ext.apply(b,{app:this.app,recordClass:this.recordClass,filterModels:this.recordClass.getFilterModel().concat(this.getCustomfieldFilters()),defaultFilter:"query",filters:this.defaultFilters||[],plugins:a}))},getAddAction:function(){return{requiredGrant:"addGrant",actionType:"add",text:this.app.i18n._("Upload"),handler:this.onFilesSelect,disabled:true,scope:this,plugins:[{ptype:"ux.browseplugin",multiple:true,enableFileDrop:false,disable:true}],iconCls:this.app.appName+"IconCls"}},initActions:function(){this.action_upload=new Ext.Action(this.getAddAction());this.action_editFile=new Ext.Action({requiredGrant:"editGrant",allowMultiple:false,text:this.app.i18n._("Edit Properties"),handler:this.onEditFile,iconCls:"action_edit_file",disabled:false,actionType:"edit",scope:this});this.action_createFolder=new Ext.Action({requiredGrant:"addGrant",actionType:"reply",allowMultiple:true,text:this.app.i18n._("Create Folder"),handler:this.onCreateFolder,iconCls:"action_create_folder",disabled:true,scope:this});this.action_goUpFolder=new Ext.Action({allowMultiple:true,actionType:"goUpFolder",text:this.app.i18n._("Folder Up"),handler:this.onLoadParentFolder,iconCls:"action_filemanager_folder_up",disabled:true,scope:this});this.action_download=new Ext.Action({requiredGrant:"readGrant",allowMultiple:false,actionType:"download",text:this.app.i18n._("Save locally"),handler:this.onDownload,iconCls:"action_filemanager_save_all",disabled:true,scope:this});this.action_deleteRecord=new Ext.Action({requiredGrant:"deleteGrant",allowMultiple:true,singularText:this.app.i18n._("Delete"),pluralText:this.app.i18n._("Delete"),translationObject:this.i18nDeleteActionText?this.app.i18n:Tine.Tinebase.translation,text:this.app.i18n._("Delete"),handler:this.onDeleteRecords,disabled:true,iconCls:"action_delete",scope:this});this.contextMenu=Tine.Filemanager.GridContextMenu.getMenu({nodeName:Tine.Filemanager.Model.Node.getRecordName(),actions:["delete","rename","download","resume","pause","edit"],scope:this,backend:"Filemanager",backendModel:"Node"});this.folderContextMenu=Tine.Filemanager.GridContextMenu.getMenu({nodeName:this.app.i18n._(this.app.getMainScreen().getWestPanel().getContainerTreePanel().containerName),actions:["delete","rename"],scope:this,backend:"Filemanager",backendModel:"Node"});this.actionUpdater.addActions(this.contextMenu.items);this.actionUpdater.addActions(this.folderContextMenu.items);this.actionUpdater.addActions([this.action_createFolder,this.action_goUpFolder,this.action_download,this.action_deleteRecord,this.action_editFile])},getContextMenu:function(a,f,d){var c=this.store.getAt(f),b=c?c.get("type"):null;return b==="folder"?this.folderContextMenu:this.contextMenu},getActionToolbar:function(){if(!this.actionToolbar){this.actionToolbar=new Ext.Toolbar({defaults:{height:55},items:[{xtype:"buttongroup",columns:8,defaults:{minWidth:60},items:[this.splitAddButton?Ext.apply(new Ext.SplitButton(this.action_upload),{scale:"medium",rowspan:2,iconAlign:"top",arrowAlign:"right",menu:new Ext.menu.Menu({items:[],plugins:[{ptype:"ux.itemregistry",key:"Tine.widgets.grid.GridPanel.addButton"}]})}):Ext.apply(new Ext.Button(this.action_upload),{scale:"medium",rowspan:2,iconAlign:"top"}),Ext.apply(new Ext.Button(this.action_editFile),{scale:"medium",rowspan:2,iconAlign:"top"}),Ext.apply(new Ext.Button(this.action_deleteRecord),{scale:"medium",rowspan:2,iconAlign:"top"}),Ext.apply(new Ext.Button(this.action_createFolder),{scale:"medium",rowspan:2,iconAlign:"top"}),Ext.apply(new Ext.Button(this.action_goUpFolder),{scale:"medium",rowspan:2,iconAlign:"top"}),Ext.apply(new Ext.Button(this.action_download),{scale:"medium",rowspan:2,iconAlign:"top"})]},this.getActionToolbarItems()]});if(this.filterToolbar&&typeof this.filterToolbar.getQuickFilterField=="function"){this.actionToolbar.add("->",this.filterToolbar.getQuickFilterField())}}return this.actionToolbar},onEditFile:function(){var c=this.getGrid().getSelectionModel().getSelections();if(c.length==1){var a=new Tine.Filemanager.Model.Node(c[0].data);var b=Tine.Filemanager.NodeEditDialog.openWindow({record:a})}b.on("saveAndClose",function(){this.getGrid().store.reload()},this)},onCreateFolder:function(a,b){var c=this.app,d=Tine.Filemanager.Model.Node.getContainerName();Ext.MessageBox.prompt(_("New Folder"),_("Please enter the name of the new folder:"),function(g,h){var f=c.getMainScreen().getCenterPanel().currentFolderNode;if(f&&g=="ok"){if(!h){Ext.Msg.alert(String.format(_("No {0} added"),d),String.format(_("You have to supply a {0} name!"),d));return}var e=f.attributes.path+"/"+h;Tine.Filemanager.fileRecordBackend.createFolder(e)}},this)},onDeleteRecords:function(d,e){var f=this.app,h="",g=f.getMainScreen().getCenterPanel().selectionModel,a=g.getSelections();if(a&&a.length){for(var c=0;c<a.length;c++){var b=a[c].data;if(typeof b.name=="object"){h+=b.name.name+"<br />"}else{h+=b.name+"<br />"}}}this.conflictConfirmWin=Tine.widgets.dialog.FileListDialog.openWindow({modal:true,allowCancel:false,height:180,width:300,title:f.i18n._("Do you really want to delete the following files?"),text:h,scope:this,handler:function(l){if(a&&l=="yes"){this.store.remove(a);this.pagingToolbar.refresh.disable();Tine.Filemanager.fileRecordBackend.deleteItems(a)}for(var k=0;k<a.length;k++){var m=a[k];if(m.fileRecord){var j=Tine.Tinebase.uploadManager.getUpload(m.fileRecord.get("uploadKey"));j.setPaused(true);Tine.Tinebase.uploadManager.unregisterUpload(j.id)}}}},this)},onLoadParentFolder:function(b,c){var d=this.app,a=d.getMainScreen().getCenterPanel().currentFolderNode;if(a&&a.parentNode){d.getMainScreen().getCenterPanel().currentFolderNode=a.parentNode;a.parentNode.select()}},onRowDblClick:function(b,k,h){var f=this.app;var j=b.getStore().getAt(k);if(j.data.type=="file"){var d=j.data.path;var c=new Ext.ux.file.Download({params:{method:"Filemanager.downloadFile",requestType:"HTTP",id:"",path:d}}).start()}else{if(j.data.type=="folder"){var g=f.getMainScreen().getWestPanel().getContainerTreePanel();var a;if(j.data.path=="/personal/system"){a=g.getNodeById("personal")}else{if(j.data.path=="/shared"){a=g.getNodeById("shared")}else{if(j.data.path=="/personal"){a=g.getNodeById("otherUsers")}else{a=g.getNodeById(j.id)}}}if(a){a.select();a.expand();f.getMainScreen().getCenterPanel().currentFolderNode=a}else{this.filterToolbar.filterStore.each(function(e){var l=e.get("field");if(l==="path"){e.set("value","");e.set("value",j.data);e.formFields.value.setValue(j.get("path"));this.filterToolbar.onFiltertrigger();return false}},this)}}}},onUploadFail:function(){Ext.MessageBox.alert(_("Upload Failed"),_("Could not upload file. Filesize could be too big. Please notify your Administrator. Max upload size: ")+Tine.Tinebase.common.byteRenderer(Tine.Tinebase.registry.get("maxFileUploadSize"))).setIcon(Ext.MessageBox.ERROR);var b=Tine.Tinebase.appMgr.get("Filemanager"),a=b.getMainScreen().getCenterPanel();a.pagingToolbar.refresh.enable()},onRemove:function(c,d){var e=this.selectionModel.getSelections();for(var b=0;b<e.length;b+=1){this.store.remove(e[b]);var a=Tine.Tinebase.uploadManager.getUpload(e[b].get("uploadKey"));a.setPaused(true)}},loadRecord:function(a){if(a&&a.get(this.filesProperty)){var d=a.get(this.filesProperty);for(var c=0;c<d.length;c+=1){var b=new Ext.ux.file.Upload.file(d[c]);b.set("status","complete");b.set("nodeRecord",new Tine.Filemanager.Model.Node(b.data));this.store.add(b)}}},onUploadComplete:function(a,c){var d=Tine.Tinebase.appMgr.get("Filemanager"),b=d.getMainScreen().getCenterPanel();if(a.fmDirector!=b){return}Ext.Ajax.request({timeout:10*60*1000,params:{method:"Filemanager.createNode",filename:a.id,type:"file",tempFileId:c.get("id"),forceOverwrite:true},success:b.onNodeCreated.createDelegate(this,[a],true),failure:b.onNodeCreated.createDelegate(this,[a],true)})},onNodeCreated:function(e,f,k){var h=Ext.util.JSON.decode(e.responseText);var d=k.fileRecord;d.beginEdit();d.set("contenttype",h.contenttype);d.set("created_by",Tine.Tinebase.registry.get("currentAccount"));d.set("creation_time",h.creation_time);d.set("revision",h.revision);d.set("last_modified_by",h.last_modified_by);d.set("last_modified_time",h.last_modified_time);d.set("name",h.name);d.set("path",h.path);d.set("status","complete");d.set("progress",100);d.commit(false);k.fireEvent("update","uploadfinished",k,d);var c=Tine.Tinebase.appMgr.get("Filemanager"),a=c.getMainScreen().getCenterPanel();var b=true;var j=a.getStore().getRange();for(var g=0;g<j.length;g++){if(j[g].get("status")&&j[g].get("status")!=="complete"){b=false;break}}if(b){a.pagingToolbar.refresh.enable()}},onFilesSelect:function(o,c){var d=Tine.Tinebase.appMgr.get("Filemanager"),a=d.getMainScreen().getCenterPanel(),l=a.currentFolderNode,f=a.store,n=false,k=a.currentFolderNode.attributes.path,p=true,q=false,m=null;if(c&&c.getTarget()){n=a.getView().findRowIndex(c.getTarget())}if(l.attributes){m=l.attributes.nodeRecord}if(n!==false&&n>-1){var e=f.getAt(n);if(e&&e.data.type=="folder"){k=e.data.path;p=false;m=new Tine.Filemanager.Model.Node(e.data)}}if(!m.isDropFilesAllowed()){Ext.MessageBox.alert(_("Upload Failed"),d.i18n._("Putting files in this folder is not allowed!")).setIcon(Ext.MessageBox.ERROR);return}var b=o.getFileList();if(b.length>0){a.pagingToolbar.refresh.disable()}var j=[],h=[];Ext.each(b,function(v){var r=Tine.Filemanager.Model.Node.createFromFile(v),u=k+"/"+r.get("name");r.set("path",u);var w=f.find("name",r.get("name"));if(w<0){f.add(r)}var s=new Ext.ux.file.Upload({fmDirector:a,file:v,fileSelector:o,id:u});var t=Tine.Tinebase.uploadManager.queueUpload(s);j.push(u);h.push(t)},this);var g={filenames:j,type:"file",tempFileIds:[],forceOverwrite:false};Tine.Filemanager.fileRecordBackend.createNodes(g,h,true)},onDownload:function(c,d){var h=Tine.Tinebase.appMgr.get("Filemanager"),b=h.getMainScreen().getCenterPanel(),g=b.selectionModel.getSelections();var f=g[0];var a=f.data.path;var e=new Ext.ux.file.Download({params:{method:"Filemanager.downloadFile",requestType:"HTTP",id:"",path:a}}).start()},onLoad:function(c,b,e){var h=Tine.Tinebase.appMgr.get("Filemanager"),g=h.getMainScreen().getCenterPanel();for(var f=b.length-1;f>=0;f--){var a=b[f];if(a.get("type")=="file"&&(!a.get("size")||a.get("size")==0)){var d=Tine.Tinebase.uploadManager.getUpload(a.get("path"));if(d){if(d.fileRecord&&a.get("name")==d.fileRecord.get("name")){g.updateNodeRecord(a,d.fileRecord);a.afterEdit()}}}}},updateNodeRecord:function(c,a){for(var b in a.fields){c.set(b,a.get(b))}c.fileRecord=a},onUpdate:function(f,b,a){var e=Tine.Tinebase.appMgr.get("Filemanager"),d=e.getMainScreen().getCenterPanel(),c=d.getStore().query("name",a.get("name"));if(f=="uploadstart"){Tine.Tinebase.uploadManager.onUploadStart()}else{if(f=="uploadfailure"){d.onUploadFail()}}if(c.get(0)){if(f=="uploadcomplete"){d.onUploadComplete(b,a)}else{if(f=="uploadfinished"){c.get(0).set("size",a.get("size"));c.get(0).set("contenttype",a.get("contenttype"))}}c.get(0).afterEdit();c.get(0).commit(false)}},initDropTarget:function(){var a=new Ext.dd.DropTarget(this.getEl(),{ddGroup:"fileDDGroup",notifyDrop:function(d,l,h){if(h.node&&h.node.attributes&&!h.node.attributes.nodeRecord.isDragable()){return false}var f=Tine.Tinebase.appMgr.get(Tine.Filemanager.fileRecordBackend.appName),b=f.getMainScreen().getCenterPanel(),j=f.getMainScreen().getWestPanel().getContainerTreePanel(),n=b.getView().findRowIndex(l.target),m=b.getStore().getAt(n),c=h.selections?h.selections:[h.node];if((!m||m.data.type==="file")&&b.currentFolderNode){m=b.currentFolderNode}if(!m){return false}for(var g=0;g<c.length;g++){if(c[g].id==m.id){return false}}var k=j.getNodeById(m.id);if(k&&k.isAncestor(c[0])){return false}Tine.Filemanager.fileRecordBackend.copyNodes(c,m,!l.ctrlKey);return true},notifyOver:function(d,l,h){if(h.node&&h.node.attributes&&!h.node.attributes.nodeRecord.isDragable()){return false}var f=Tine.Tinebase.appMgr.get(Tine.Filemanager.fileRecordBackend.appName),b=f.getMainScreen().getCenterPanel(),n=b.getView().findRowIndex(l.target),j=f.getMainScreen().getWestPanel().getContainerTreePanel(),m=b.getStore().getAt(n),c=h.selections?h.selections:[h.node];if((!m||(m.data&&m.data.type==="file"))&&b.currentFolderNode){m=b.currentFolderNode}if(!m){return false}for(var g=0;g<c.length;g++){if(c[g].id==m.id){return false}}var k=j.getNodeById(m.id);if(k&&k.isAncestor(c[0])){return false}return this.dropAllowed}})}});Ext.ns("Tine.Filemanager");Tine.Filemanager.Application=Ext.extend(Tine.Tinebase.Application,{hasMainScreen:true,getTitle:function(){return this.i18n.gettext("Filemanager")}});Tine.widgets.relation.MenuItemManager.register("Filemanager","Node",{text:"Save locally",iconCls:"action_filemanager_save_all",requiredGrant:"readGrant",actionType:"download",allowMultiple:false,handler:function(d){var b=d.grid.store.getAt(d.gridIndex).get("related_record");var a=b.path;var c=new Ext.ux.file.Download({params:{method:"Filemanager.downloadFile",requestType:"HTTP",id:"",path:a}}).start()}});Tine.Filemanager.MainScreen=Ext.extend(Tine.widgets.MainScreen,{activeContentType:"Node"});Tine.Filemanager.handleRequestException=function(c,f){var g=Tine.Tinebase.appMgr.get("Filemanager"),e=[],d=[],b,a=null;switch(c.code){case 503:Ext.MessageBox.show({buttons:Ext.Msg.OK,icon:Ext.MessageBox.WARNING,title:_("Service Unavailable"),msg:String.format(g.i18n._("The Filemanager is not configured correctly. Please refer to the {0}Tine 2.0 Admin FAQ{1} for configuration advice or contact your administrator."),'<a href="http://www.tine20.org/wiki/index.php/Admin_FAQ#The_message_.22filesdir_config_value_not_set.22_appears_in_the_logfile_and_I_can.27t_open_the_Filemanager" target="_blank">',"</a>")});break;case 901:if(f){Tine.log.debug("Tine.Filemanager.handleRequestException - request exception:");Tine.log.debug(c);if(c.existingnodesinfo){for(b=0;b<c.existingnodesinfo.length;b++){e.push(c.existingnodesinfo[b].name)}}this.conflictConfirmWin=Tine.widgets.dialog.FileListDialog.openWindow({modal:true,allowCancel:false,height:180,width:300,title:g.i18n._("Files already exists")+". "+g.i18n._("Do you want to replace the following file(s)?"),text:e.join("<br />"),scope:this,handler:function(j){var k=f.params,h=c.uploadKeyArray;k.method=f.method;k.forceOverwrite=true;if(j=="no"){Tine.log.debug("Tine.Filemanager.handleRequestException::"+k.method+" -> only non-existant nodes.");Ext.each(k.filenames,function(l){a=l.match(/[^\/]*$/);if(a&&e.indexOf(a[0])===-1){d.push(l)}});k.filenames=d;h=d}else{Tine.log.debug("Tine.Filemanager.handleRequestException::"+k.method+" -> replace all existing nodes.")}if(k.method=="Filemanager.copyNodes"||k.method=="Filemanager.moveNodes"){Tine.Filemanager.fileRecordBackend.copyNodes(null,null,null,k)}else{if(k.method=="Filemanager.createNodes"){Tine.Filemanager.fileRecordBackend.createNodes(k,h,c.addToGridStore)}}}})}else{Ext.Msg.show({title:g.i18n._("Failure on create folder"),msg:g.i18n._("Item with this name already exists!"),icon:Ext.MessageBox.ERROR,buttons:Ext.Msg.OK})}break;default:Tine.Tinebase.ExceptionHandler.handleRequestException(c);break}};