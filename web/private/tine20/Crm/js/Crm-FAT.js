/*
 * Tine 2.0 - Crm 
 * Copyright (c) 2007-2011 Metaways Infosystems GmbH (http://www.metaways.de)
 * http://www.gnu.org/licenses/agpl.html AGPL Version 3
 */
Ext.ns("Tine.Crm");Tine.Crm.AddressbookGridPanelHook=function(a){Tine.log.info("initialising crm addressbook hooks");Ext.apply(this,a);var b=this.app.i18n.n_hidden(Tine.Crm.Model.Lead.prototype.recordName,Tine.Crm.Model.Lead.prototype.recordsName,1);this.addLeadAction=new Ext.Action({actionType:"new",requiredGrant:"readGrant",allowMultiple:true,text:b,iconCls:this.app.getIconCls(),scope:this,handler:this.onAddLead,listeners:{scope:this,render:this.onRender}});this.updateLeadAction=new Ext.Action({actionType:"add",requiredGrant:"readGrant",allowMultiple:true,text:b,iconCls:this.app.getIconCls(),scope:this,handler:this.onUpdateLead,listeners:{scope:this,render:this.onRender}});Ext.ux.ItemRegistry.registerItem("Addressbook-GridPanel-ContextMenu-New",this.addLeadAction,80);Ext.ux.ItemRegistry.registerItem("Addressbook-GridPanel-ContextMenu-Add",this.updateLeadAction,80)};Ext.apply(Tine.Crm.AddressbookGridPanelHook.prototype,{app:null,addLeadAction:null,updateLeadAction:null,ContactGridPanel:null,getContactGridPanel:function(){if(!this.ContactGridPanel){this.ContactGridPanel=Tine.Tinebase.appMgr.get("Addressbook").getMainScreen().getCenterPanel()}return this.ContactGridPanel},getFilter:function(a){var c=this.getContactGridPanel().selectionModel,b=null;if(c.isFilterSelect){var b=c.getSelectionFilter()}return b},onAddLead:function(c){var b=this.app.getMainScreen(),e=b.getCenterPanel(),d=this.getFilter(b),f=this.getContactGridPanel().selectionModel;if(!d){var a=this.getSelectionsAsArray()}else{var a=true}e.onEditInNewWindow.call(e,"add",null,[{ptype:"addrelations_edit_dialog",selectionFilter:d,addRelations:a,callingApp:"Addressbook",callingModel:"Contact"}])},onUpdateLead:function(c){var b=this.app.getMainScreen(),f=b.getCenterPanel(),d=this.getFilter(b),g=this.getContactGridPanel().selectionModel;if(!d){var a=this.getSelectionsAsArray(),e=this.getSelectionsAsArray().length}else{var a=true,e=g.store.totalLength}Tine.Crm.AddToLeadPanel.openWindow({count:e,selectionFilter:d,addRelations:a,callingApp:"Addressbook",callingModel:"Contact"})},getSelectionsAsArray:function(){var b=this.getContactGridPanel().grid.getSelectionModel().getSelections(),a=[];Ext.each(b,function(c){if(c.data){a.push(c.data)}});return a},onRender:function(){var b=this.getContactGridPanel().actionUpdater,a=b.actions;if(a.indexOf(this.updateLeadAction)<0){b.addActions([this.updateLeadAction])}if(a.indexOf(this.addLeadAction)<0){b.addActions([this.addLeadAction])}}});Ext.ns("Tine.Crm");Tine.Crm.SearchCombo=Ext.extend(Tine.Tinebase.widgets.form.RecordPickerComboBox,{allowBlank:false,itemSelector:"div.search-item",minListWidth:200,initComponent:function(){this.recordClass=Tine.Crm.Model.Lead;this.recordProxy=Tine.Crm.recordBackend;this.initTemplate();Tine.Crm.SearchCombo.superclass.initComponent.call(this);this.displayField="lead_name"},onBeforeQuery:function(b){Tine.Crm.SearchCombo.superclass.onBeforeQuery.apply(this,arguments);var a=this.store.baseParams.filter},initTemplate:function(){if(!this.tpl){this.tpl=new Ext.XTemplate('<tpl for="."><div class="search-item">',"{[this.encode(values)]}","</div></tpl>",{encode:function(a){return Ext.util.Format.htmlEncode(a.lead_name)}})}},getValue:function(){return Tine.Crm.SearchCombo.superclass.getValue.call(this)},setValue:function(a){return Tine.Crm.SearchCombo.superclass.setValue.call(this,a)}});Ext.reg("crmleadpickercombobox",Tine.Crm.SearchCombo);Tine.widgets.form.RecordPickerManager.register("Crm","Lead","crmleadpickercombobox");Ext.namespace("Tine.Crm","Tine.Crm.Model");Tine.Crm.Model.Lead=Tine.Tinebase.data.Record.create(Tine.Tinebase.Model.genericFields.concat([{name:"id",type:"string"},{name:"lead_name",type:"string"},{name:"leadstate_id",type:"int"},{name:"leadtype_id",type:"int"},{name:"leadsource_id",type:"int"},{name:"start",type:"date",dateFormat:Date.patterns.ISO8601Long},{name:"description",type:"string"},{name:"end",type:"date",dateFormat:Date.patterns.ISO8601Long},{name:"turnover",type:"int"},{name:"probability",type:"int"},{name:"probableTurnover",type:"int"},{name:"end_scheduled",type:"date",dateFormat:Date.patterns.ISO8601Long},{name:"lastread"},{name:"lastreader"},{name:"responsible"},{name:"customer"},{name:"partner"},{name:"tasks"},{name:"relations"},{name:"products"},{name:"tags"},{name:"notes"},{name:"customfields",isMetaField:true}]),{appName:"Crm",modelName:"Lead",idProperty:"id",titleProperty:"lead_name",recordName:"Lead",recordsName:"Leads",containerProperty:"container_id",containerName:"lead list",containersName:"lead lists",getTitle:function(){return this.get("lead_name")?this.get("lead_name"):false}});Tine.Crm.Model.Lead.getDefaultData=function(){var b=Tine.Crm.registry.get("defaults");var c=Tine.Tinebase.appMgr.get("Crm");var a={start:new Date().clearTime(),leadstate_id:b.leadstate_id,leadtype_id:b.leadtype_id,leadsource_id:b.leadsource_id,container_id:c.getMainScreen().getWestPanel().getContainerTreePanel().getSelectedContainer("addGrant",b.container_id),probability:0,turnover:0,relations:[{type:"responsible",related_record:Tine.Tinebase.registry.get("userContact")}]};return a};Tine.Crm.Model.Lead.getFilterModel=function(){var b=Tine.Tinebase.appMgr.get("Crm"),a=[{label:_("Quick search"),field:"query",operators:["contains"]},{filtertype:"tine.widget.container.filtermodel",app:b,recordClass:Tine.Crm.Model.Lead},{label:b.i18n._("Lead name"),field:"lead_name"},{filtertype:"crm.leadstate",app:b},{label:b.i18n._("Probability"),field:"probability",valueType:"percentage"},{label:b.i18n._("Turnover"),field:"turnover",valueType:"number",defaultOperator:"greater"},{filtertype:"tinebase.tag",app:b},{label:_("Last Modified Time"),field:"last_modified_time",valueType:"date"},{label:_("Last Modified By"),field:"last_modified_by",valueType:"user"},{label:_("Creation Time"),field:"creation_time",valueType:"date"},{label:_("Created By"),field:"created_by",valueType:"user"},{filtertype:"crm.contact"},{filtertype:"foreignrecord",app:b,foreignRecordClass:Tine.Tasks.Model.Task,ownField:"task"}];if(Tine.Sales&&Tine.Tinebase.common.hasRight("run","Sales")){a.push({filtertype:"foreignrecord",app:b,foreignRecordClass:Tine.Sales.Model.Product,ownField:"product"})}return a};Tine.Crm.Model.Settings=Tine.Tinebase.data.Record.create([{name:"id"},{name:"defaults"},{name:"leadstates"},{name:"leadtypes"},{name:"leadsources"},{name:"default_leadstate_id",type:"int"},{name:"default_leadtype_id",type:"int"},{name:"default_leadsource_id",type:"int"}],{appName:"Crm",modelName:"Settings",idProperty:"id",titleProperty:"title",recordName:"Settings",recordsName:"Settingss",containerProperty:"container_id",containerName:"Settings",containersName:"Settings",getTitle:function(){return this.recordName}});Tine.Crm.Model.getRandomUnusedId=function(b){var a;do{a=Tine.Tinebase.common.getRandomNumber(0,21474836)}while(b.getById(a)!=undefined);return a};Ext.ns("Tine.Crm");Tine.Crm.Application=Ext.extend(Tine.Tinebase.Application,{addButtonText:"New Lead",init:function(){Tine.Crm.Application.superclass.init.apply(this,arguments);new Tine.Crm.AddressbookGridPanelHook({app:this})}});Tine.Crm.MainScreen=Ext.extend(Tine.widgets.MainScreen,{activeContentType:"Lead",contentTypes:[{model:"Lead",requiredRight:null,singularContainerMode:false}]});Tine.Crm.LeadTreePanel=function(a){Ext.apply(this,a);this.id="CrmLeadTreePanel";this.filterMode="filterToolbar";this.recordClass=Tine.Crm.Model.Lead;Tine.Crm.LeadTreePanel.superclass.constructor.call(this)};Ext.extend(Tine.Crm.LeadTreePanel,Tine.widgets.container.TreePanel);Tine.Crm.LeadFilterPanel=function(a){Ext.apply(this,a);Tine.Crm.LeadFilterPanel.superclass.constructor.call(this)};Ext.extend(Tine.Crm.LeadFilterPanel,Tine.widgets.persistentfilter.PickerPanel,{filter:[{field:"model",operator:"equals",value:"Crm_Model_LeadFilter"}]});Tine.Crm.leadBackend=new Tine.Tinebase.data.RecordProxy({appName:"Crm",modelName:"Lead",recordClass:Tine.Crm.Model.Lead});Tine.Crm.settingsBackend=new Tine.Tinebase.data.RecordProxy({appName:"Crm",modelName:"Settings",recordClass:Tine.Crm.Model.Settings});Ext.ns("Tine.Crm.LinkGridPanel");Tine.Crm.LinkGridPanel.initActions=function(){var c=Tine.Tinebase.appMgr.get(this.recordClass.getMeta("appName"));if(!c){return}if(c.i18n){var b=c.i18n.n_(this.recordClass.getMeta("recordName"),this.recordClass.getMeta("recordsName"),1)}else{var b=this.recordClass.getMeta("recordName")}var a=c.addButtonText&&c.i18n?c.i18n._hidden(c.addButtonText):String.format(this.app.i18n._("Add new {0}"),b);this.actionAdd=new Ext.Action({requiredGrant:"editGrant",text:a,tooltip:a,iconCls:"action_add",disabled:!(this.record&&this.record.get("container_id")&&this.record.get("container_id").account_grants&&this.record.get("container_id").account_grants.editGrant),scope:this,handler:function(e,d){var f=this.recordEditDialogOpener({listeners:{scope:this,update:this.onUpdate}})}});this.actionUnlink=new Ext.Action({requiredGrant:"editGrant",text:String.format(this.app.i18n._("Unlink {0}"),b),tooltip:String.format(this.app.i18n._("Unlink selected {0}"),b),disabled:true,iconCls:"action_remove",onlySingle:true,scope:this,handler:function(g,d){var f=this.getSelectionModel().getSelections();for(var e=0;e<f.length;++e){this.store.remove(f[e])}}});this.actionEdit=new Ext.Action({requiredGrant:"editGrant",text:String.format(this.app.i18n._("Edit {0}"),b),tooltip:String.format(this.app.i18n._("Edit selected {0}"),b),disabled:true,iconCls:"actionEdit",onlySingle:true,scope:this,handler:function(g,e){var f=this.getSelectionModel().getSelections();var d=f[0];if(d.phantom){d.id=0}var h=this.recordEditDialogOpener({record:d,listeners:{scope:this,update:this.onUpdate}})}});this.bbar=[this.actionAdd,this.actionUnlink];this.actions=[this.actionEdit,this.actionUnlink];if(this.otherActions){this.actions=this.actions.concat(this.otherActions)}this.contextMenu=new Ext.menu.Menu({items:this.actions.concat(["-",this.actionAdd])});this.actions.push(this.actionAdd)};Tine.Crm.LinkGridPanel.initStore=function(){this.store=new Ext.data.JsonStore({fields:(this.storeFields)?this.storeFields:this.recordClass});this.store.on("add",function(b,a,c){(function(){if(this.rendered){this.getView().focusRow(c);this.getSelectionModel().selectRow(c)}}).defer(300,this)},this)};Tine.Crm.LinkGridPanel.initGrid=function(){this.cm=this.getColumnModel();this.selModel=new Ext.grid.RowSelectionModel({multiSelect:true});this.enableHdMenu=false;this.plugins=this.plugins||[];this.plugins.push(new Ext.ux.grid.GridViewMenuPlugin({}));this.selModel.on("selectionchange",function(e){var b=e.getCount();var d=this.getSelectionModel().getSelections();if(d.length>0){var a=d[0]}if(this.record&&(this.record.get("container_id")&&this.record.get("container_id").account_grants)){for(var c=0;c<this.actions.length;c++){this.actions[c].setDisabled(!this.record.get("container_id").account_grants.editGrant||(this.actions[c].initialConfig.onlySingle&&b!=1)||(this.actions[c]==this.actionEdit&&a&&a.phantom==true))}}},this);this.on("rowcontextmenu",function(b,d,c){c.stopEvent();var a=b.getSelectionModel();if(!a.isSelected(d)){a.selectRow(d)}this.contextMenu.showAt(c.getXY())},this);this.on("rowdblclick",function(a,f,c){var b=a.getSelectionModel().getSelections();record=b[0];if(!record.phantom&&this.recordEditDialogOpener!=Ext.emptyFn){var d=this.recordEditDialogOpener({record:record,listeners:{scope:this,update:this.onUpdate}})}},this)};Ext.namespace("Tine.Crm");Tine.Crm.LeadGridContactFilter=Ext.extend(Tine.widgets.grid.ForeignRecordFilter,{foreignRecordClass:Tine.Addressbook.Model.Contact,ownField:"contact",initComponent:function(){this.app=Tine.Tinebase.appMgr.get("Crm");this.label=this.app.i18n._("Contact");Tine.Crm.LeadGridContactFilter.superclass.initComponent.call(this)},getSubFilters:function(){var a=new Tine.widgets.grid.FilterModel({label:this.app.i18n._("CRM Role"),field:"relation_type",operators:["equals"],valueRenderer:function(c,b){var d=new Tine.Crm.Contact.TypeComboBox({filter:c,blurOnSelect:true,width:200,listAlign:"tr-br",id:"tw-ftb-frow-valuefield-"+c.id,value:c.data.value?c.data.value:this.defaultValue,renderTo:b});d.on("specialkey",function(g,f){if(f.getKey()==f.ENTER){this.onFiltertrigger()}},this);return d}});return[a]}});Tine.widgets.grid.FilterToolbar.FILTERS["crm.contact"]=Tine.Crm.LeadGridContactFilter;Ext.namespace("Tine.Crm");Tine.Crm.LeadGridPanel=Ext.extend(Tine.widgets.grid.GridPanel,{recordClass:Tine.Crm.Model.Lead,evalGrants:true,defaultSortInfo:{field:"lead_name",direction:"DESC"},gridConfig:{autoExpandColumn:"title",enableDragDrop:true,ddGroup:"containerDDGroup"},initComponent:function(){this.recordProxy=Tine.Crm.leadBackend;this.gridConfig.cm=this.getColumnModel();this.defaultFilters=[{field:"leadstate_id",operator:"notin",value:Tine.Crm.LeadState.getClosedStatus()}];this.filterToolbar=this.getFilterToolbar();this.plugins=this.plugins||[];this.plugins.push(this.filterToolbar);this.detailsPanel=new Tine.Crm.LeadGridDetailsPanel({grid:this});Tine.Crm.LeadGridPanel.superclass.initComponent.call(this)},getActionToolbarItems:function(){return[Ext.apply(new Ext.SplitButton(this.actions_exportLead),{scale:"medium",rowspan:2,iconAlign:"top",arrowAlign:"right"})]},getContextMenuItems:function(){var a=["-",this.actions_exportLead];return a},getColumnModel:function(){return new Ext.grid.ColumnModel({defaults:{sortable:true},columns:[{header:this.app.i18n._("Lead id"),id:"id",dataIndex:"id",width:20,hidden:true},{header:this.app.i18n._("Tags"),id:"tags",dataIndex:"tags",width:50,renderer:Tine.Tinebase.common.tagsRenderer,sortable:false},{header:this.app.i18n._("Lead name"),id:"lead_name",dataIndex:"lead_name",width:200},{header:this.app.i18n._("Responsible"),id:"lead_responsible",dataIndex:"relations",width:175,sortable:false,hidden:true,renderer:this.responsibleRenderer},{header:this.app.i18n._("Partner"),id:"lead_partner",dataIndex:"relations",width:175,sortable:false,renderer:this.partnerRenderer},{header:this.app.i18n._("Customer"),id:"lead_customer",dataIndex:"relations",width:175,sortable:false,renderer:this.customerRenderer},{header:this.app.i18n._("Leadstate"),id:"leadstate_id",dataIndex:"leadstate_id",sortable:false,width:100,renderer:Tine.Crm.LeadState.Renderer},{header:this.app.i18n._("Probability"),id:"probability",dataIndex:"probability",width:50,renderer:Ext.util.Format.percentage},{header:this.app.i18n._("Turnover"),id:"turnover",dataIndex:"turnover",width:100,renderer:Ext.util.Format.euMoney},{header:this.app.i18n._("Probable Turnover"),id:"probableTurnover",dataIndex:"probableTurnover",width:100,renderer:Ext.util.Format.euMoney,sortable:false}].concat(this.getModlogColumns().concat(this.getCustomfieldColumns()))})},responsibleRenderer:function(a){return Tine.Crm.LeadGridPanel.shortContactRenderer(a,"RESPONSIBLE")},partnerRenderer:function(a){return Tine.Crm.LeadGridPanel.shortContactRenderer(a,"PARTNER")},customerRenderer:function(a){return Tine.Crm.LeadGridPanel.shortContactRenderer(a,"CUSTOMER")},initActions:function(){this.actions_exportLead=new Ext.Action({text:this.app.i18n._("Export Lead"),iconCls:"action_export",scope:this,requiredGrant:"readGrant",disabled:true,allowMultiple:true,menu:{items:[new Tine.widgets.grid.ExportButton({text:this.app.i18n._("Export as PDF"),iconCls:"action_exportAsPdf",format:"pdf",exportFunction:"Crm.exportLead",gridPanel:this}),new Tine.widgets.grid.ExportButton({text:this.app.i18n._("Export as CSV"),iconCls:"tinebase-action-export-csv",format:"csv",exportFunction:"Crm.exportLead",gridPanel:this}),new Tine.widgets.grid.ExportButton({text:this.app.i18n._("Export as ODS"),iconCls:"tinebase-action-export-ods",format:"ods",exportFunction:"Crm.exportLead",gridPanel:this}),new Tine.widgets.grid.ExportButton({text:this.app.i18n._("Export as XLS"),iconCls:"tinebase-action-export-xls",format:"xls",exportFunction:"Crm.exportLead",gridPanel:this})]}});this.actionUpdater.addActions([this.actions_exportLead]);this.supr().initActions.call(this)}});Tine.Crm.LeadGridPanel.shortContactRenderer=function(c,b){if(Ext.isArray(c)&&c.length>0){var a=0;while(a<c.length&&c[a].type!=b){a++}if(c[a]){var d=(c[a].related_record.org_name!==null)?c[a].related_record.org_name:"";return"<b>"+Ext.util.Format.htmlEncode(d)+"</b><br />"+Ext.util.Format.htmlEncode(c[a].related_record.n_fileas)}}};Ext.namespace("Tine.Crm");Tine.Crm.LeadGridDetailsPanel=Ext.extend(Tine.widgets.grid.DetailsPanel,{border:false,contactRenderer:function(h){var e=this.record.get("relations");var d=[];var c=[{label:(h=="CUSTOMER")?this.app.i18n._("Customer"):this.app.i18n._("Partner"),dataField:"n_fileas"},{label:this.app.i18n._("Phone"),dataField:"tel_work"},{label:this.app.i18n._("Mobile"),dataField:"tel_cell"},{label:this.app.i18n._("Fax"),dataField:"tel_fax"},{label:this.app.i18n._("E-Mail"),dataField:"email"},{label:this.app.i18n._("Web"),dataField:"url"}];var b='<label class="x-form-item x-form-item-label">';if(Ext.isArray(e)&&e.length>0){for(var g=0;g<e.length;g++){if(e[g].type==h){var k=e[g].related_record;for(var f=0;f<c.length;f++){if(k[c[f].dataField]){if(c[f].dataField=="url"){d.push(b+c[f].label+':</label> <a href="'+Ext.util.Format.htmlEncode(k[c[f].dataField])+'" target="_blank">'+Ext.util.Format.htmlEncode(k[c[f].dataField])+"</a>")}else{d.push(b+c[f].label+":</label> "+Ext.util.Format.htmlEncode(k[c[f].dataField]))}}}d.push("")}}}return d.join("\n")},sourceTypeRenderer:function(c,a,b){record=a.getById(c);if(record){return record.data[b]}else{return"undefined"}},initComponent:function(){this.app=Tine.Tinebase.appMgr.get("Crm");this.leadstatePiechartStore=new Ext.data.JsonStore({fields:["id","label","total"],id:"id"});this.leadsourcePiechartStore=new Ext.data.JsonStore({fields:["id","label","total"],id:"id"});this.leadtypePiechartStore=new Ext.data.JsonStore({fields:["id","label","total"],id:"id"});this.supr().initComponent.call(this)},getDefaultInfosPanel:function(){if(!this.defaultInfosPanel){this.defaultInfosPanel=new Ext.ux.display.DisplayPanel({layout:"fit",border:false,items:[{layout:"hbox",border:false,defaults:{margins:"0 5 0 0",padding:2,style:{cursor:"crosshair"},flex:1,layout:"ux.display",border:false},layoutConfig:{padding:"5",align:"stretch"},items:[{layoutConfig:{background:"border",declaration:this.app.i18n._("Leadstates")},items:[{store:this.leadstatePiechartStore,xtype:"piechart",dataField:"total",categoryField:"label"}]},{layoutConfig:{background:"border",declaration:this.app.i18n._("Leadsources")},items:[{store:this.leadsourcePiechartStore,xtype:"piechart",dataField:"total",categoryField:"label"}]},{layoutConfig:{background:"border",declaration:this.app.i18n._("Leadtypes")},items:[{store:this.leadtypePiechartStore,xtype:"piechart",dataField:"total",categoryField:"label"}]}]}]})}return this.defaultInfosPanel},setPiechartStores:function(a){if(!this.getDefaultInfosPanel().isVisible()){return}if(a===false){var d=this.getCountFromSelection()}else{var d={leadstate:this.grid.store.proxy.jsonReader.jsonData.totalleadstates,leadsource:this.grid.store.proxy.jsonReader.jsonData.totalleadsources,leadtype:this.grid.store.proxy.jsonReader.jsonData.totalleadtypes}}var c=[{store:this.leadstatePiechartStore,data:d.leadstate,definitionsStore:Tine.Crm.LeadState.getStore(),definitionsLabel:"leadstate"},{store:this.leadsourcePiechartStore,data:d.leadsource,definitionsStore:Tine.Crm.LeadSource.getStore(),definitionsLabel:"leadsource"},{store:this.leadtypePiechartStore,data:d.leadtype,definitionsStore:Tine.Crm.LeadType.getStore(),definitionsLabel:"leadtype"}];for(var b=0;b<c.length;b++){this.loadPiechartStore(c[b])}},getCountFromSelection:function(){var a={leadstate:{},leadsource:{},leadtype:{}};var c=this.grid.getSelectionModel().getSelections();for(var b=0;b<c.length;++b){if(!a.leadstate[c[b].get("leadstate_id")]){a.leadstate[c[b].get("leadstate_id")]=1}else{a.leadstate[c[b].get("leadstate_id")]++}if(!a.leadsource[c[b].get("leadsource_id")]){a.leadsource[c[b].get("leadsource_id")]=1}else{a.leadsource[c[b].get("leadsource_id")]++}if(!a.leadtype[c[b].get("leadtype_id")]){a.leadtype[c[b].get("leadtype_id")]=1}else{a.leadtype[c[b].get("leadtype_id")]++}}return a},loadPiechartStore:function(b){try{if(b.store.getCount()>0){b.store.removeAll()}var a=[];if(b.data){b.definitionsStore.each(function(d){if(b.data[d.id]){a.push(new b.store.recordType({id:d.id,label:d.get(b.definitionsLabel),total:b.data[d.id]},d.id))}},this)}if(a.length>0){b.store.add(a)}}catch(c){this.loadPiechartStore.defer(500,this,[b])}},getMultiRecordsPanel:function(){return this.getDefaultInfosPanel()},getSingleRecordPanel:function(){if(!this.singleRecordPanel){this.singleRecordPanel=new Ext.ux.display.DisplayPanel({layout:"fit",border:false,items:[{layout:"vbox",border:false,layoutConfig:{align:"stretch"},items:[{layout:"hbox",flex:0,height:16,border:false,style:"padding-left: 5px; padding-right: 5px",layoutConfig:{align:"stretch"},items:[{flex:1,xtype:"ux.displayfield",cls:"x-ux-display-header",name:"lead_name"},{flex:1,xtype:"ux.displayfield",style:"text-align: right;",name:"container_id",cls:"x-ux-display-header",htmlEncode:false,renderer:Tine.Tinebase.common.containerRenderer}]},{layout:"hbox",flex:1,border:false,layoutConfig:{padding:"5",align:"stretch"},defaults:{margins:"0 5 0 0"},items:[{flex:1,layout:"ux.display",labelWidth:90,layoutConfig:{background:"solid",declaration:this.app.i18n._("Status")},items:[{xtype:"ux.displayfield",name:"start",fieldLabel:this.app.i18n._("Start"),renderer:Tine.Tinebase.common.dateRenderer},{xtype:"ux.displayfield",name:"end_scheduled",fieldLabel:this.app.i18n._("Estimated end"),renderer:Tine.Tinebase.common.dateRenderer},{xtype:"ux.displayfield",name:"leadtype_id",fieldLabel:this.app.i18n._("Leadtype"),renderer:this.sourceTypeRenderer.createDelegate(this,[Tine.Crm.LeadType.getStore(),"leadtype"],true)},{xtype:"ux.displayfield",name:"leadsource_id",fieldLabel:this.app.i18n._("Leadsource"),renderer:this.sourceTypeRenderer.createDelegate(this,[Tine.Crm.LeadSource.getStore(),"leadsource"],true)}]},{flex:1,layout:"ux.display",labelAlign:"top",autoScroll:true,layoutConfig:{background:"solid"},items:[{xtype:"ux.displayfield",name:"partner",nl2br:true,htmlEncode:false,renderer:this.contactRenderer.createDelegate(this,["PARTNER"])}]},{flex:1,layout:"ux.display",labelAlign:"top",autoScroll:true,layoutConfig:{background:"solid"},items:[{xtype:"ux.displayfield",name:"customer",nl2br:true,htmlEncode:false,renderer:this.contactRenderer.createDelegate(this,["CUSTOMER"])}]},{flex:1,layout:"fit",border:false,items:[{cls:"x-ux-display-background-border",xtype:"ux.displaytextarea",name:"description"}]}]}]}]})}return this.singleRecordPanel},updateDetails:function(b,a){this.getSingleRecordPanel().loadRecord.defer(100,this.getSingleRecordPanel(),[b])},showDefault:function(a){this.setPiechartStores.defer(500,this,[true])},showMulti:function(b,a){this.setPiechartStores.defer(1000,this,[false])}});Ext.namespace("Tine.Crm");Tine.Crm.LeadEditDialog=Ext.extend(Tine.widgets.dialog.EditDialog,{contactGrid:null,tasksGrid:null,windowNamePrefix:"LeadEditWindow_",appName:"Crm",recordClass:Tine.Crm.Model.Lead,recordProxy:Tine.Crm.leadBackend,tbarItems:[{xtype:"widget-activitiesaddbutton"}],showContainerSelector:true,ignoreRelatedModels:["Sales_Model_Product","Addressbook_Model_Contact","Tasks_Model_Task"],onAfterRecordLoad:function(){Tine.Crm.LeadEditDialog.superclass.onAfterRecordLoad.call(this);if(this.contactGrid&&this.tasksGrid&&this.productsGrid&&this.contactGrid.store.getCount()==0&&(!this.tasksGrid.store||this.tasksGrid.store.getCount()==0)&&(!this.productsGrid.store||this.productsGrid.store.getCount()==0)){var a=this.splitRelations();this.contactGrid.store.loadData(a.contacts,true);if(this.tasksGrid.store){this.tasksGrid.store.loadData(a.tasks,true)}if(this.productsGrid.store){this.productsGrid.store.loadData(a.products,true)}}},doApplyChanges:function(b){this.getAdditionalData();var a=[].concat(this.record.get("relations"));this.record.data.relations=a;Tine.Crm.LeadEditDialog.superclass.doApplyChanges.call(this,b)},getRelationData:function(a){var b=null;if(a.data.relation){b=a.data.relation}else{b={}}if(!b.type){b.type=a.data.relation_type.toUpperCase()}delete a.data.relation;b.related_record=a.data;b.remark={};if(a.data.remark_price){b.remark.price=a.data.remark_price}if(a.data.remark_description){b.remark.description=a.data.remark_description}if(a.data.remark_quantity){b.remark.quantity=a.data.remark_quantity}Tine.log.debug("Tine.Crm.LeadEditDialog::getRelationData() -> relation:");Tine.log.debug(b);return b},getAdditionalData:function(){var a=this.record.get("relations"),b=[this.contactGrid,this.tasksGrid,this.productsGrid];Ext.each(b,function(c){if(c.store){c.store.each(function(d){a.push(this.getRelationData(d.copy()))},this)}},this);this.record.data.relations=a},splitRelations:function(){var d=[],f=[],e=[];var b=this.record.get("relations");for(var c=0;c<b.length;c++){var a=b[c]["related_record"];delete b[c]["related_record"]["relation"];a.relation=b[c];a.relation_type=b[c]["type"].toLowerCase();if((a.relation_type==="responsible"||a.relation_type==="customer"||a.relation_type==="partner")){d.push(a)}else{if(a.relation_type==="task"){f.push(a)}else{if(a.relation_type==="product"){a.remark_description=b[c].remark.description;a.remark_price=b[c].remark.price;a.remark_quantity=b[c].remark.quantity;e.push(a)}}}}return{contacts:d,tasks:f,products:e}},getFormItems:function(){this.combo_probability=new Ext.ux.PercentCombo({fieldLabel:this.app.i18n._("Probability"),id:"combo_probability",anchor:"95%",name:"probability"});this.date_end=new Ext.ux.form.ClearableDateField({fieldLabel:this.app.i18n._("End"),id:"end",anchor:"95%"});this.contactGrid=new Tine.Crm.Contact.GridPanel({record:this.record,anchor:"100% 98%"});if(Tine.Tasks&&Tine.Tinebase.common.hasRight("run","Tasks")){this.tasksGrid=new Tine.Crm.Task.GridPanel({record:this.record})}else{this.tasksGrid=new Ext.Panel({title:this.app.i18n._("Tasks"),html:this.app.i18n._("You do not have the run right for the Tasks application or it is not activated.")})}if(Tine.Sales&&Tine.Tinebase.common.hasRight("run","Sales")){this.productsGrid=new Tine.Crm.Product.GridPanel({record:this.record})}else{this.productsGrid=new Ext.Panel({title:this.app.i18n._("Products"),html:this.app.i18n._("You do not have the run right for the Sales application or it is not activated.")})}return{xtype:"tabpanel",border:false,plain:true,plugins:[{ptype:"ux.tabpanelkeyplugin"}],activeTab:0,border:false,items:[{title:this.app.i18n._("Lead"),autoScroll:true,border:true,frame:true,layout:"border",id:"editCenterPanel",defaults:{border:true,frame:true},items:[{region:"center",layout:"border",items:[{region:"north",height:40,layout:"form",labelAlign:"top",defaults:{anchor:"100%",labelSeparator:"",columnWidth:1},items:[{xtype:"textfield",hideLabel:true,id:"lead_name",emptyText:this.app.i18n._("Enter short name"),name:"lead_name",allowBlank:false,selectOnFocus:true,maxLength:255,listeners:{render:function(a){a.focus(false,2000)}}}]},{region:"center",layout:"form",items:[this.contactGrid]},{region:"south",height:390,split:true,collapseMode:"mini",header:false,collapsible:true,items:[{xtype:"panel",layout:"column",height:140,id:"lead_combos",anchor:"100%",labelAlign:"top",items:[{columnWidth:0.33,items:[{layout:"form",defaults:{valueField:"id",typeAhead:true,mode:"local",triggerAction:"all",editable:false,allowBlank:false,forceSelection:true,anchor:"95%",xtype:"combo"},items:[{fieldLabel:this.app.i18n._("Leadstate"),id:"leadstatus",name:"leadstate_id",store:Tine.Crm.LeadState.getStore(),displayField:"leadstate",lazyInit:false,value:(Tine.Crm.LeadState.getStore().getCount()>0)?Tine.Crm.LeadState.getStore().getAt(0).id:null,listeners:{select:function(c,a,b){if(this.record.data.probability!==null){this.combo_probability.setValue(a.data.probability)}if(a.data.endslead=="1"){this.date_end.setValue(new Date())}},scope:this}},{fieldLabel:this.app.i18n._("Leadtype"),id:"leadtype",name:"leadtype_id",store:Tine.Crm.LeadType.getStore(),value:(Tine.Crm.LeadType.getStore().getCount()>0)?Tine.Crm.LeadType.getStore().getAt(0).id:null,displayField:"leadtype"},{fieldLabel:this.app.i18n._("Leadsource"),id:"leadsource",name:"leadsource_id",store:Tine.Crm.LeadSource.getStore(),value:(Tine.Crm.LeadSource.getStore().getCount()>0)?Tine.Crm.LeadSource.getStore().getAt(0).id:null,displayField:"leadsource"}]}]},{columnWidth:0.33,items:[{layout:"form",border:false,items:[{xtype:"numberfield",fieldLabel:this.app.i18n._("Expected turnover"),name:"turnover",selectOnFocus:true,anchor:"95%",minValue:0},this.combo_probability]}]},{columnWidth:0.33,items:[{layout:"form",border:false,items:[new Ext.form.DateField({fieldLabel:this.app.i18n._("Start"),allowBlank:false,id:"start",anchor:"95%"}),new Ext.ux.form.ClearableDateField({fieldLabel:this.app.i18n._("Estimated end"),id:"end_scheduled",anchor:"95%"}),this.date_end]}]}]},{xtype:"tabpanel",id:"linkPanelBottom",activeTab:0,height:250,items:[this.tasksGrid,this.productsGrid]}]}]},{layout:"accordion",animate:true,region:"east",width:210,split:true,collapsible:true,collapseMode:"mini",header:false,margins:"0 5 0 5",border:true,items:[new Ext.Panel({title:this.app.i18n._("Description"),iconCls:"descriptionIcon",layout:"form",labelAlign:"top",border:false,items:[{style:"margin-top: -4px; border 0px;",labelSeparator:"",xtype:"textarea",name:"description",hideLabel:true,grow:false,preventScrollbars:false,anchor:"100% 100%",emptyText:this.app.i18n._("Enter description")}]}),new Tine.widgets.activities.ActivitiesPanel({app:"Crm",showAddNoteForm:false,border:false,bodyStyle:"border:1px solid #B5B8C8;"}),new Tine.widgets.tags.TagPanel({app:"Crm",border:false,bodyStyle:"border:1px solid #B5B8C8;"})]}]},new Tine.widgets.activities.ActivitiesTabPanel({app:this.appName,record_id:this.record.id,record_model:this.appName+"_Model_"+this.recordClass.getMeta("modelName")})]}}});Tine.Crm.LeadEditDialog.openWindow=function(a){var c=(a.record&&a.record.id)?a.record.id:0;var b=Tine.WindowFactory.getWindow({width:800,height:750,name:Tine.Crm.LeadEditDialog.prototype.windowNamePrefix+c,contentPanelConstructor:"Tine.Crm.LeadEditDialog",contentPanelConstructorConfig:a});return b};Ext.ns("Tine.Crm");Tine.Crm.AddToLeadPanel=Ext.extend(Tine.widgets.dialog.AddToRecordPanel,{appName:"Crm",recordClass:Tine.Crm.Model.Lead,callingApp:"Addressbook",callingModel:"Contact",isValid:function(){var a=true;if(this.searchBox.getValue()==""){this.searchBox.markInvalid(this.app.i18n._("Please choose the Lead to add the contacts to"));a=false}if(this.chooseRoleBox.getValue()==""){this.chooseRoleBox.markInvalid(this.app.i18n._("Please select the attenders' role"));a=false}return a},getRelationConfig:function(){return{type:this.chooseRoleBox.getValue()}},getFormItems:function(){return{border:false,frame:false,layout:"border",items:[{region:"center",border:false,frame:false,layout:{align:"stretch",type:"vbox"},items:[{layout:"form",margins:"10px 10px",border:false,frame:false,items:[{xtype:"crmleadpickercombobox",fieldLabel:this.app.i18n._("Lead"),emptyText:this.app.i18n._("Select Lead"),anchor:"100% 100%",ref:"../../../searchBox"},{fieldLabel:this.app.i18n._("Role"),amptyText:this.app.i18n._("Select Role"),xtype:"leadcontacttypecombo",ref:"../../../chooseRoleBox",anchor:"100% 100%"}]}]}]}}});Tine.Crm.AddToLeadPanel.openWindow=function(a){var b=Tine.WindowFactory.getWindow({modal:true,title:String.format(Tine.Tinebase.appMgr.get("Crm").i18n._("Adding {0} contacts to lead"),a.count),width:250,height:150,contentPanelConstructor:"Tine.Crm.AddToLeadPanel",contentPanelConstructorConfig:a});return b};Ext.namespace("Tine.Crm");Tine.Crm.AdminPanel=Ext.extend(Tine.widgets.dialog.EditDialog,{appName:"Crm",recordClass:Tine.Crm.Model.Settings,recordProxy:Tine.Crm.settingsBackend,evalGrants:false,updateToolbars:function(){},onRecordLoad:function(){if(!this.record.get("default_leadstate_id")){this.record.set("default_leadstate_id",this.record.data.defaults.leadstate_id);this.record.set("default_leadsource_id",this.record.data.defaults.leadsource_id);this.record.set("default_leadtype_id",this.record.data.defaults.leadtype_id)}if(this.fireEvent("load",this)!==false){this.getForm().loadRecord(this.record);this.updateToolbars(this.record,this.recordClass.getMeta("containerProperty"));this.loadMask.hide()}},onRecordUpdate:function(){Tine.Crm.AdminPanel.superclass.onRecordUpdate.call(this);var a={leadstate_id:this.record.get("default_leadstate_id"),leadsource_id:this.record.get("default_leadsource_id"),leadtype_id:this.record.get("default_leadtype_id")};this.record.set("defaults",a);this.record.set("leadstates",this.getFromStore(this.leadstatePanel.store));this.record.set("leadtypes",this.getFromStore(this.leadtypePanel.store));this.record.set("leadsources",this.getFromStore(this.leadsourcePanel.store))},getFromStore:function(b){var a=[];b.each(function(c){a.push(c.data)},this);b.commitChanges();return a},getFormItems:function(){this.leadstatePanel=new Tine.Crm.LeadState.GridPanel({title:this.app.i18n._("Leadstates")});this.leadtypePanel=new Tine.Crm.LeadType.GridPanel({title:this.app.i18n._("Leadtypes")});this.leadsourcePanel=new Tine.Crm.LeadSource.GridPanel({title:this.app.i18n._("Leadsources")});return{xtype:"tabpanel",activeTab:0,border:true,items:[{title:this.app.i18n._("Defaults"),autoScroll:true,border:false,frame:true,xtype:"columnform",formDefaults:{xtype:"combo",anchor:"90%",labelSeparator:"",columnWidth:1,valueField:"id",typeAhead:true,mode:"local",triggerAction:"all",editable:false,allowBlank:false,forceSelection:true},items:[[{fieldLabel:this.app.i18n._("Leadstate"),name:"default_leadstate_id",store:Tine.Crm.LeadState.getStore(),displayField:"leadstate",lazyInit:false,value:(Tine.Crm.LeadState.getStore().getCount()>0)?Tine.Crm.LeadState.getStore().getAt(0).id:null},{fieldLabel:this.app.i18n._("Leadsource"),name:"default_leadsource_id",store:Tine.Crm.LeadSource.getStore(),displayField:"leadsource",lazyInit:false,value:(Tine.Crm.LeadSource.getStore().getCount()>0)?Tine.Crm.LeadSource.getStore().getAt(0).id:null},{fieldLabel:this.app.i18n._("Leadtype"),name:"default_leadtype_id",store:Tine.Crm.LeadType.getStore(),displayField:"leadtype",lazyInit:false,value:(Tine.Crm.LeadType.getStore().getCount()>0)?Tine.Crm.LeadType.getStore().getAt(0).id:null}]]},this.leadstatePanel,this.leadtypePanel,this.leadsourcePanel]}}});Tine.Crm.AdminPanel.onUpdate=function(){window.location=window.location.href.replace(/#+.*/,"")};Tine.Crm.AdminPanel.openWindow=function(a){var c=(a.record&&a.record.id)?a.record.id:0;var b=Tine.WindowFactory.getWindow({width:600,height:400,name:Tine.Crm.AdminPanel.prototype.windowNamePrefix+c,contentPanelConstructor:"Tine.Crm.AdminPanel",contentPanelConstructorConfig:a});return b};Ext.namespace("Tine.Crm.Admin");Tine.Crm.Admin.QuickaddGridPanel=Ext.extend(Tine.widgets.grid.QuickaddGridPanel,{initComponent:function(){this.app=this.app?this.app:Tine.Tinebase.appMgr.get("Crm");Tine.Crm.Admin.QuickaddGridPanel.superclass.initComponent.call(this)}});Ext.namespace("Tine.Crm","Tine.Crm.LeadState");Tine.Crm.LeadState.Model=Tine.Tinebase.data.Record.create([{name:"id",type:"int"},{name:"leadstate"},{name:"probability",type:"int"},{name:"endslead",type:"boolean"}],{appName:"Crm",modelName:"LeadState",idProperty:"id",titleProperty:"leadstate",recordName:"Lead State",recordsName:"Lead States"});Tine.Crm.LeadState.Model.getDefaultData=function(){var a={id:Tine.Crm.Model.getRandomUnusedId(Ext.StoreMgr.get("CrmLeadstateStore"))};return a};Tine.Crm.LeadState.getStore=function(){var a=Ext.StoreMgr.get("CrmLeadstateStore");if(!a){a=new Ext.data.JsonStore({fields:Tine.Crm.LeadState.Model,baseParams:{method:"Crm.getLeadstates",sort:"leadstate",dir:"ASC"},root:"results",totalProperty:"totalcount",id:"id",remoteSort:false});if(Tine.Crm.registry.get("leadstates")){a.loadData(Tine.Crm.registry.get("leadstates"))}Ext.StoreMgr.add("CrmLeadstateStore",a)}return a};Tine.Crm.LeadState.getClosedStatus=function(){var a=[];Tine.Crm.LeadState.getStore().each(function(b){if(b.get("endslead")){a.push(b.get("id"))}},this);return a};Tine.Crm.LeadState.Renderer=function(a){leadstateStore=Tine.Crm.LeadState.getStore();record=leadstateStore.getById(a);if(record){return record.data.leadstate}else{return"undefined"}};Tine.Crm.LeadState.GridPanel=Ext.extend(Tine.Crm.Admin.QuickaddGridPanel,{autoExpandColumn:"leadstate",quickaddMandatory:"leadstate",initComponent:function(){this.app=this.app?this.app:Tine.Tinebase.appMgr.get("Crm");this.store=Tine.Crm.LeadState.getStore();this.recordClass=Tine.Crm.LeadState.Model;this.cm=this.getColumnModel();Tine.Crm.LeadState.GridPanel.superclass.initComponent.call(this)},getColumnModel:function(){return new Ext.grid.ColumnModel([{id:"leadstate_id",header:"id",dataIndex:"id",width:25,hidden:true},{id:"leadstate",header:"entries",dataIndex:"leadstate",width:170,hideable:false,sortable:false,quickaddField:new Ext.form.TextField({emptyText:this.app.i18n._("Add a Leadstate...")}),editor:new Ext.form.TextField({allowBlank:false})},{id:"probability",header:"probability",dataIndex:"probability",width:100,hideable:false,sortable:false,renderer:Ext.util.Format.percentage,editor:new Ext.ux.PercentCombo({name:"probability",id:"probability"}),quickaddField:new Ext.ux.PercentCombo({autoExpand:true})},{header:"X Lead?",id:"endslead",dataIndex:"endslead",width:50,editor:new Ext.form.Checkbox({}),quickaddField:new Ext.form.Checkbox({name:"endslead"}),renderer:Tine.Tinebase.common.booleanRenderer}])}});Ext.ns("Tine.Crm");Tine.Crm.LeadStateFilterModel=Ext.extend(Tine.widgets.grid.FilterModel,{app:null,field:"leadstate_id",defaultOperator:"notin",initComponent:function(){this.label=this.app.i18n._("Leadstate");this.operators=["in","notin"];this.defaultValue=Tine.Crm.LeadState.getClosedStatus();this.supr().initComponent.call(this)},valueRenderer:function(b,a){var c=new Tine.Crm.LeadStateFilterModelValueField({app:this.app,filter:b,width:200,id:"tw-ftb-frow-valuefield-"+b.id,value:b.data.value?b.data.value:this.defaultValue,renderTo:a});c.on("specialkey",function(f,d){if(d.getKey()==d.ENTER){this.onFiltertrigger()}},this);c.on("select",this.onFiltertrigger,this);return c}});Tine.widgets.grid.FilterToolbar.FILTERS["crm.leadstate"]=Tine.Crm.LeadStateFilterModel;Tine.Crm.LeadStateFilterModelValueField=Ext.extend(Ext.ux.form.LayerCombo,{hideButtons:false,formConfig:{labelAlign:"left",labelWidth:30},getFormValue:function(){var a=[];var d=Tine.Crm.LeadState.getStore();var b=this.getInnerForm().getForm().getValues();for(var c in b){if(b[c]==="on"&&d.getById(c)){a.push(c)}}return a},getItems:function(){var a=[];Tine.Crm.LeadState.getStore().each(function(b){a.push({xtype:"checkbox",boxLabel:b.get("leadstate"),icon:b.get("status_icon"),name:b.get("id")})},this);return a},setValue:function(a){a=Ext.isArray(a)?a:[a];var c=Tine.Crm.LeadState.getStore();var b=[];this.currentValue=[];Tine.Crm.LeadState.getStore().each(function(d){var f=d.get("id");var e=d.get("leadstate");Ext.each(a,function(g){if(g==f){b.push(e);this.currentValue.push(f)}},this)},this);this.setRawValue(b.join(", "));return this},setFormValue:function(a){this.getInnerForm().getForm().items.each(function(b){b.setValue(a.indexOf(b.name)>=0?"on":"off")},this)}});Ext.namespace("Tine.Crm","Tine.Crm.LeadSource");Tine.Crm.LeadSource.Model=Tine.Tinebase.data.Record.create([{name:"id",type:"int"},{name:"leadsource"}],{appName:"Crm",modelName:"LeadState",idProperty:"id",titleProperty:"leadsource",recordName:"Lead Source",recordsName:"Lead Sources"});Tine.Crm.LeadSource.Model.getDefaultData=function(){var a={id:Tine.Crm.Model.getRandomUnusedId(Ext.StoreMgr.get("CrmLeadSourceStore"))};return a};Tine.Crm.LeadSource.getStore=function(){var a=Ext.StoreMgr.get("CrmLeadSourceStore");if(!a){a=new Ext.data.JsonStore({fields:Tine.Crm.LeadSource.Model,baseParams:{method:"Crm.getLeadsources",sort:"LeadSource",dir:"ASC"},root:"results",totalProperty:"totalcount",id:"id",remoteSort:false});if(Tine.Crm.registry.get("leadsources")){a.loadData(Tine.Crm.registry.get("leadsources"))}Ext.StoreMgr.add("CrmLeadSourceStore",a)}return a};Tine.Crm.LeadSource.GridPanel=Ext.extend(Tine.Crm.Admin.QuickaddGridPanel,{autoExpandColumn:"leadsource",quickaddMandatory:"leadsource",initComponent:function(){this.app=this.app?this.app:Tine.Tinebase.appMgr.get("Crm");this.store=Tine.Crm.LeadSource.getStore();this.recordClass=Tine.Crm.LeadSource.Model;Tine.Crm.LeadSource.GridPanel.superclass.initComponent.call(this)},getColumnModel:function(){return new Ext.grid.ColumnModel([{id:"leadsource_id",header:"id",dataIndex:"id",width:25,hidden:true},{id:"leadsource",header:"entries",dataIndex:"leadsource",width:170,hideable:false,sortable:false,editor:new Ext.form.TextField({allowBlank:false}),quickaddField:new Ext.form.TextField({emptyText:this.app.i18n._("Add a Leadsource...")})}])}});Ext.namespace("Tine.Crm","Tine.Crm.LeadType");Tine.Crm.LeadType.Model=Tine.Tinebase.data.Record.create([{name:"id",type:"int"},{name:"leadtype"}],{appName:"Crm",modelName:"LeadType",idProperty:"id",titleProperty:"leadtype",recordName:"Lead Type",recordsName:"Lead Types"});Tine.Crm.LeadType.Model.getDefaultData=function(){var a={id:Tine.Crm.Model.getRandomUnusedId(Ext.StoreMgr.get("CrmLeadTypeStore"))};return a};Tine.Crm.LeadType.getStore=function(){var a=Ext.StoreMgr.get("CrmLeadTypeStore");if(!a){a=new Ext.data.JsonStore({fields:Tine.Crm.LeadType.Model,baseParams:{method:"Crm.getLeadtypes",sort:"LeadType",dir:"ASC"},root:"results",totalProperty:"totalcount",id:"id",remoteSort:false});if(Tine.Crm.registry.get("leadtypes")){a.loadData(Tine.Crm.registry.get("leadtypes"))}Ext.StoreMgr.add("CrmLeadTypeStore",a)}return a};Tine.Crm.LeadType.GridPanel=Ext.extend(Tine.Crm.Admin.QuickaddGridPanel,{autoExpandColumn:"leadtype",quickaddMandatory:"leadtype",initComponent:function(){this.app=this.app?this.app:Tine.Tinebase.appMgr.get("Crm");this.store=Tine.Crm.LeadType.getStore();this.recordClass=Tine.Crm.LeadType.Model;Tine.Crm.LeadType.GridPanel.superclass.initComponent.call(this)},getColumnModel:function(){return new Ext.grid.ColumnModel([{id:"leadtype_id",header:"id",dataIndex:"id",width:25,hidden:true},{id:"leadtype",header:"entries",dataIndex:"leadtype",width:170,hideable:false,sortable:false,editor:new Ext.form.TextField({allowBlank:false}),quickaddField:new Ext.form.TextField({emptyText:this.app.i18n._("Add a Leadtype...")})}])}});Ext.ns("Tine.Crm.Contact");Tine.Crm.Contact.Combo=Ext.extend(Tine.Addressbook.SearchCombo,{valueField:"id",contactsStore:null,onSelect:function(a){var c={relation_type:(a.get("type")=="user")?"responsible":"customer"};if(!this.contactsStore.getById(a.id)){var b=new this.contactsStore.recordType(Ext.apply(c,a.data),a.id);this.contactsStore.add([b])}this.collapse();this.clearValue()}});Tine.Crm.Contact.GridPanel=Ext.extend(Ext.grid.EditorGridPanel,{autoExpandColumn:"n_fileas",clicksToEdit:1,baseCls:"contact-grid",record:null,store:null,contextMenu:null,otherActions:null,recordEditDialogOpener:null,recordClass:null,initComponent:function(){this.app=this.app?this.app:Tine.Tinebase.appMgr.get("Crm");this.recordEditDialogOpener=Tine.Addressbook.ContactEditDialog.openWindow;this.recordClass=Tine.Addressbook.Model.Contact;this.storeFields=Tine.Addressbook.Model.ContactArray;this.storeFields.push({name:"relation"});this.storeFields.push({name:"relation_type"});this.initStore=Tine.Crm.LinkGridPanel.initStore.createDelegate(this);this.initActions=Tine.Crm.LinkGridPanel.initActions.createDelegate(this);this.initGrid=Tine.Crm.LinkGridPanel.initGrid.createDelegate(this);this.initStore();this.initOtherActions();this.initActions();this.initGrid();this.actionAdd.contactType="customer";this.store.setDefaultSort("type","asc");Tine.Crm.Contact.GridPanel.superclass.initComponent.call(this)},initOtherActions:function(){this.actionChangeContactTypeCustomer=new Ext.Action({requiredGrant:"editGrant",contactType:"customer",text:this.app.i18n._("Customer"),tooltip:this.app.i18n._("Change type to Customer"),iconCls:"contactIconCustomer",scope:this,handler:this.onChangeContactType});this.actionChangeContactTypeResponsible=new Ext.Action({requiredGrant:"editGrant",contactType:"responsible",text:this.app.i18n._("Responsible"),tooltip:this.app.i18n._("Change type to Responsible"),iconCls:"contactIconResponsible",scope:this,handler:this.onChangeContactType});this.actionChangeContactTypePartner=new Ext.Action({requiredGrant:"editGrant",contactType:"partner",text:this.app.i18n._("Partner"),tooltip:this.app.i18n._("Change type to Partner"),iconCls:"contactIconPartner",scope:this,handler:this.onChangeContactType});var a=[this.actionChangeContactTypeCustomer,this.actionChangeContactTypeResponsible,this.actionChangeContactTypePartner];this.otherActions=[new Ext.Action({text:this.app.i18n._("Change contact type"),requiredGrant:"editGrant",disabled:true,menu:a})];this.tbar=new Ext.Panel({layout:"fit",items:[new Tine.Crm.Contact.Combo({contactsStore:this.store,emptyText:this.app.i18n._("Search for Contacts to add ...")})]})},getColumnModel:function(){return new Ext.grid.ColumnModel({defaults:{sortable:true},columns:[{id:"id",header:"id",dataIndex:"id",width:25,hidden:true},{id:"n_fileas",header:this.app.i18n._("Name"),dataIndex:"n_fileas",width:200,sortable:true,renderer:function(f,e,a){var b=Ext.isEmpty(a.data.org_name)===false?a.data.org_name:" ";var d=Ext.isEmpty(a.data.n_fileas)===false?a.data.n_fileas:" ";var c="<b>"+Ext.util.Format.htmlEncode(d)+"</b><br />"+Ext.util.Format.htmlEncode(b);return c}},{id:"contact_one",header:this.app.i18n._("Address"),dataIndex:"adr_one_locality",width:140,sortable:false,renderer:function(g,f,a){var e=Ext.isEmpty(a.data.adr_one_street)===false?a.data.adr_one_street:" ";var c=Ext.isEmpty(a.data.adr_one_postalcode)===false?a.data.adr_one_postalcode:" ";var b=Ext.isEmpty(a.data.adr_one_locality)===false?a.data.adr_one_locality:" ";var d=Ext.util.Format.htmlEncode(e)+"<br />"+Ext.util.Format.htmlEncode(c)+" "+Ext.util.Format.htmlEncode(b);return d}},{id:"tel_work",header:this.app.i18n._("Data"),dataIndex:"tel_work",width:140,sortable:false,renderer:function(f,e,a){var g=new Locale.Gettext();g.textdomain("Crm");var c=Ext.isEmpty(a.data.tel_work)===false?g._("Phone")+": "+a.data.tel_work:" ";var b=Ext.isEmpty(a.data.tel_cell)===false?g._("Cellphone")+": "+a.data.tel_cell:" ";var d=Ext.util.Format.htmlEncode(c)+"<br/>"+Ext.util.Format.htmlEncode(b)+"<br/>";return d}},{id:"relation_type",header:this.app.i18n._("Role"),dataIndex:"relation_type",width:60,sortable:true,renderer:Tine.Crm.Contact.typeRenderer,editor:new Tine.Crm.Contact.TypeComboBox({autoExpand:true,blurOnSelect:true,listClass:"x-combo-list-small"})}]})},onChangeContactType:function(d,a){var c=this.getSelectionModel().getSelections();for(var b=0;b<c.length;++b){c[b].data.relation_type=d.contactType}this.store.fireEvent("dataChanged",this.store)},onUpdate:function(a){var b={responseText:a};a=Tine.Addressbook.contactBackend.recordReader(b);Tine.log.debug("Tine.Crm.Contact.GridPanel::onUpdate - Contact has been updated:");Tine.log.debug(a);a.data.relations=null;var d=this.store.getById(a.id);if(d){d.beginEdit();for(var c in a.data){d.set(c,a.get(c))}d.endEdit()}else{a.data.relation_type="customer";this.store.add(a)}}});Tine.Crm.Contact.TypeComboBox=Ext.extend(Ext.form.ComboBox,{autoExpand:false,blurOnSelect:false,displayField:"label",valueField:"relation_type",mode:"local",triggerAction:"all",lazyInit:false,forceSelection:true,allowBlank:false,initComponent:function(){var a=new Locale.Gettext();a.textdomain("Crm");Tine.Crm.Contact.TypeComboBox.superclass.initComponent.call(this);if(!this.value){this.value="responsible"}this.store=new Ext.data.SimpleStore({fields:["label","relation_type"],data:[[a._("Responsible"),"responsible"],[a._("Customer"),"customer"],[a._("Partner"),"partner"]]});if(this.autoExpand){this.lazyInit=false;this.on("focus",function(){this.selectByValue(this.getValue());this.onTriggerClick()})}if(this.blurOnSelect){this.on("select",function(){this.fireEvent("blur",this)},this)}}});Ext.reg("leadcontacttypecombo",Tine.Crm.Contact.TypeComboBox);Tine.Crm.Contact.typeRenderer=function(d){var e=new Locale.Gettext();e.textdomain("Crm");switch(d){case"responsible":var a="contactIconResponsible";var c=e._("Responsible");break;case"customer":var a="contactIconCustomer";var c=e._("Customer");break;case"partner":var a="contactIconPartner";var c=e._("Partner");break}var b='<img class="x-menu-item-icon contactIcon '+a+'" src="library/ExtJS/resources/images/default/s.gif" ext:qtip="'+Ext.util.Format.htmlEncode(c)+'"/>';return b};Ext.ns("Tine.Crm.Product");Tine.Crm.Product.GridPanel=Ext.extend(Ext.grid.EditorGridPanel,{autoExpandColumn:"name",clicksToEdit:1,record:null,store:null,contextMenu:null,otherActions:null,recordEditDialogOpener:null,recordClass:null,initComponent:function(){this.app=this.app?this.app:Tine.Tinebase.appMgr.get("Crm");this.title=this.app.i18n._("Products");this.recordEditDialogOpener=Ext.emptyFn;this.recordClass=Tine.Sales.Model.Product;this.storeFields=Tine.Sales.Model.ProductArray;this.storeFields.push({name:"relation"});this.storeFields.push({name:"relation_type"});this.storeFields.push({name:"remark_price"});this.storeFields.push({name:"remark_description"});this.storeFields.push({name:"remark_quantity"});this.initStore=Tine.Crm.LinkGridPanel.initStore.createDelegate(this);this.initGrid=Tine.Crm.LinkGridPanel.initGrid.createDelegate(this);this.onUpdate=Ext.emptyFn;this.initStore();this.initActions();this.initGrid();this.store.setDefaultSort("name","asc");this.on("newentry",function(b){var a=[b];this.store.loadData(a,true);return true},this);Tine.Crm.Product.GridPanel.superclass.initComponent.call(this)},getColumnModel:function(){return new Ext.grid.ColumnModel({defaults:{sortable:true},columns:[{header:this.app.i18n._("Product"),id:"name",dataIndex:"name",width:150},{header:this.app.i18n._("Description"),id:"remark_description",dataIndex:"remark_description",width:150,editor:new Ext.form.TextField({})},{header:this.app.i18n._("Price"),id:"remark_price",dataIndex:"remark_price",width:150,editor:new Ext.form.NumberField({allowBlank:false,allowNegative:false,decimalSeparator:","}),renderer:Ext.util.Format.euMoney},{header:this.app.i18n._("Quantity"),id:"remark_quantity",dataIndex:"remark_quantity",width:50,editor:new Ext.form.NumberField({allowBlank:false,allowNegative:false})}]})},initActions:function(){var b=Tine.Tinebase.appMgr.get(this.recordClass.getMeta("appName"));if(!b){return}var a=b.i18n.n_(this.recordClass.getMeta("recordName"),this.recordClass.getMeta("recordsName"),1);this.actionUnlink=new Ext.Action({requiredGrant:"editGrant",text:String.format(this.app.i18n._("Unlink {0}"),a),tooltip:String.format(this.app.i18n._("Unlink selected {0}"),a),disabled:true,iconCls:"action_remove",onlySingle:true,scope:this,handler:function(f,c){var e=this.getSelectionModel().getSelections();for(var d=0;d<e.length;++d){this.store.remove(e[d])}}});this.bbar=[this.actionUnlink];this.actions=[this.actionUnlink];this.contextMenu=new Ext.menu.Menu({items:this.actions});this.tbar=new Ext.Panel({layout:"fit",items:[new Tine.Tinebase.widgets.form.RecordPickerComboBox({anchor:"90%",emptyText:this.app.i18n._("Search for Products to add ..."),productsStore:this.store,blurOnSelect:true,recordClass:Tine.Sales.Model.Product,getValue:function(){return this.selectedRecord?this.selectedRecord.data:null},onSelect:function(c){if(!this.productsStore.getById(c.id)){var d=new Ext.data.Record({price:c.data.price,remark_price:c.data.price,remark_quantity:1,name:c.data.name,relation_type:"product",related_id:c.id,id:c.id},c.id);this.productsStore.insert(0,d)}this.collapse();this.clearValue()}})]})}});Ext.ns("Tine.Crm.Task");Tine.Crm.Task.GridPanel=Ext.extend(Ext.ux.grid.QuickaddGridPanel,{autoExpandColumn:"summary",quickaddMandatory:"summary",clicksToEdit:1,enableColumnHide:false,enableColumnMove:false,record:null,store:null,contextMenu:null,otherActions:null,recordEditDialogOpener:null,recordClass:null,initComponent:function(){this.app=this.app?this.app:Tine.Tinebase.appMgr.get("Crm");this.title=this.app.i18n._("Tasks");this.recordEditDialogOpener=Tine.Tasks.TaskEditDialog.openWindow;this.recordClass=Tine.Tasks.Model.Task;this.storeFields=Tine.Tasks.Model.TaskArray;this.storeFields.push({name:"relation"});this.storeFields.push({name:"relation_type"});this.initStore=Tine.Crm.LinkGridPanel.initStore.createDelegate(this);this.initActions=Tine.Crm.LinkGridPanel.initActions.createDelegate(this);this.initGrid=Tine.Crm.LinkGridPanel.initGrid.createDelegate(this);this.initStore();this.initActions();this.initGrid();this.store.setDefaultSort("due","asc");this.view=new Ext.grid.GridView({autoFill:true,forceFit:true,ignoreAdd:true,emptyText:this.app.i18n._("No Tasks to display"),onLoad:Ext.emptyFn,listeners:{beforerefresh:function(a){a.scrollTop=a.scroller.dom.scrollTop},refresh:function(a){a.scroller.dom.scrollTop=a.scrollTop}}});this.on("newentry",function(c){var a=c;a.relation_type="task";var b=0;while(this.record.data.relations.length>b&&this.record.data.relations[b].type!="responsible"){b++}if(this.record.data.relations[b]&&this.record.data.relations[b].type=="responsible"&&this.record.data.relations[b].related_record.account_id!=""){a.organizer=this.record.data.relations[b].related_record.account_id}this.store.loadData([a],true);return true},this);this.on("rowclick",function(b,f,c){var a=Ext.get(b.getView().getCell(f,1));var d=a.child("div:last");while(a.first()){a=a.first();a.on("click",function(g){g.stopPropagation();b.fireEvent("celldblclick",b,f,1,g)})}},this);Tine.Crm.Task.GridPanel.superclass.initComponent.call(this)},getColumnModel:function(){return new Ext.grid.ColumnModel({defaults:{sortable:true},columns:[{id:"summary",header:this.app.i18n._("Summary"),width:100,dataIndex:"summary",quickaddField:new Ext.form.TextField({emptyText:this.app.i18n._("Add a task...")})},{id:"due",header:this.app.i18n._("Due Date"),width:55,dataIndex:"due",renderer:Tine.Tinebase.common.dateRenderer,editor:new Ext.ux.form.ClearableDateField({}),quickaddField:new Ext.ux.form.ClearableDateField({})},{id:"priority",header:this.app.i18n._("Priority"),width:45,dataIndex:"priority",renderer:Tine.Tinebase.widgets.keyfield.Renderer.get("Tasks","taskPriority"),editor:{xtype:"widget-keyfieldcombo",app:"Tasks",keyFieldName:"taskPriority"},quickaddField:new Tine.Tinebase.widgets.keyfield.ComboBox({app:"Tasks",keyFieldName:"taskPriority",value:"NORMAL"})},{id:"percent",header:this.app.i18n._("Percent"),width:50,dataIndex:"percent",renderer:Ext.ux.PercentRenderer,editor:new Ext.ux.PercentCombo({autoExpand:true,blurOnSelect:true}),quickaddField:new Ext.ux.PercentCombo({autoExpand:true})},{id:"status",header:this.app.i18n._("Status"),width:45,dataIndex:"status",renderer:Tine.Tinebase.widgets.keyfield.Renderer.get("Tasks","taskStatus"),editor:{xtype:"widget-keyfieldcombo",app:"Tasks",keyFieldName:"taskStatus"},quickaddField:new Tine.Tinebase.widgets.keyfield.ComboBox({app:"Tasks",keyFieldName:"taskStatus",value:"NEEDS-ACTION"})}]})},onUpdate:function(c){var b={responseText:c};c=Tine.Tasks.JsonBackend.recordReader(b);Tine.log.debug("Tine.Crm.Task.GridPanel::onUpdate - Task has been updated:");Tine.log.debug(c);c.data.relations=null;var a=this.store.getById(c.id);if(a){a.beginEdit();for(var d in c.data){a.set(d,c.get(d))}a.endEdit()}else{c.data.relation_type="task";this.store.add(c)}}});