/*
 * Tine 2.0 - Sales 
 * Copyright (c) 2007-2011 Metaways Infosystems GmbH (http://www.metaways.de)
 * http://www.gnu.org/licenses/agpl.html AGPL Version 3
 */
Ext.namespace("Tine.Sales","Tine.Sales.Model");Tine.Sales.Model.ProductArray=Tine.Tinebase.Model.genericFields.concat([{name:"id",type:"string"},{name:"name",type:"string"},{name:"description",type:"string"},{name:"price",type:"float"},{name:"manufacturer",type:"string"},{name:"category",type:"string"},{name:"tags"},{name:"notes"},{name:"relations"}]);Tine.Sales.Model.Product=Tine.Tinebase.data.Record.create(Tine.Sales.Model.ProductArray,{appName:"Sales",modelName:"Product",idProperty:"id",titleProperty:"name",recordName:"Product",recordsName:"Products",containerProperty:"container_id",containerName:"All Products",containersName:"Products",getTitle:function(){return this.get("name")?this.get("name"):false}});Tine.Sales.Model.Product.getDefaultData=function(){var a={};return a};Tine.Sales.Model.Product.getFilterModel=function(){var a=Tine.Tinebase.appMgr.get("Sales");return[{label:_("Quick search"),field:"query",operators:["contains"]},{label:a.i18n._("Product name"),field:"name"},{filtertype:"tinebase.tag",app:a},{label:a.i18n._("Creator"),field:"created_by",valueType:"user"}]};Tine.Sales.Model.ContractArray=Tine.Tinebase.Model.genericFields.concat([{name:"id"},{name:"number"},{name:"title"},{name:"description"},{name:"status"},{name:"cleared"},{name:"cleared_in"},{name:"notes"},{name:"relations"}]);Tine.Sales.Model.Contract=Tine.Tinebase.data.Record.create(Tine.Sales.Model.ContractArray,{appName:"Sales",modelName:"Contract",idProperty:"id",titleProperty:"title",recordName:"Contract",recordsName:"Contracts",containerProperty:"container_id",containerName:"All Contracts",containersName:"contracts lists",getTitle:function(){return this.get("number")+" - "+this.get("title")}});Tine.Sales.Model.Contract.getDefaultData=function(){return{container_id:Tine.Sales.registry.get("defaultContainer")}};Tine.Sales.Model.Contract.getFilterModel=function(){var a=Tine.Tinebase.appMgr.get("Sales");return[{label:_("Quick search"),field:"query",operators:["contains"]},{label:a.i18n._("Contract name"),field:"name"},{label:a.i18n._("Creator"),field:"created_by",valueType:"user"},{label:a.i18n._("Status"),field:"status",filtertype:"tine.widget.keyfield.filter",app:a,keyfieldName:"contractStatus"},{label:a.i18n._("Cleared"),field:"cleared",filtertype:"tine.widget.keyfield.filter",app:a,keyfieldName:"contractCleared"},{label:a.i18n._("Cleared in"),field:"cleared_in"},{filtertype:"tinebase.tag",app:a}]};Tine.Sales.Model.CostCenterArray=[{name:"id"},{name:"number"},{name:"remark"},{name:"relations"}];Tine.Sales.Model.CostCenter=Tine.Tinebase.data.Record.create(Tine.Sales.Model.CostCenterArray,{appName:"Sales",modelName:"CostCenter",idProperty:"id",titleProperty:"remark",recordName:"Cost Center",recordsName:"Cost Centers",containerName:"All CostCenters",containersName:"All CostCenters"});Tine.Sales.Model.CostCenter.getFilterModel=function(){var a=Tine.Tinebase.appMgr.get("Sales");return[{label:_("Quick search"),field:"query",operators:["contains"]},{label:a.i18n._("Number"),field:"number"},{label:a.i18n._("Remark"),field:"remark"}]};Tine.Sales.Model.DivisionArray=Tine.Tinebase.Model.genericFields.concat([{name:"id",type:"string"},{name:"title",type:"string"}]);Tine.Sales.Model.Division=Tine.Tinebase.data.Record.create(Tine.Sales.Model.DivisionArray,{appName:"Sales",modelName:"Division",idProperty:"id",titleProperty:"title",recordName:"Division",recordsName:"Divisions",containerName:"All Divisions",containersName:"Divisions"});Tine.Sales.Model.Division.getFilterModel=function(){var a=Tine.Tinebase.appMgr.get("Sales");return[{label:_("Quick search"),field:"query",operators:["contains"]},{label:a.i18n._("Title"),field:"title"}]};Ext.namespace("Tine.Sales");Tine.Sales.MainScreen=Ext.extend(Tine.widgets.MainScreen,{activeContentType:"Product",contentTypes:[{model:"Product",requiredRight:null,singularContainerMode:true},{model:"Contract",requiredRight:null,singularContainerMode:true,genericCtxActions:["grants"]}]});Tine.Sales.ProductFilterPanel=function(a){Ext.apply(this,a);Tine.Sales.ProductFilterPanel.superclass.constructor.call(this)};Ext.extend(Tine.Sales.ProductFilterPanel,Tine.widgets.persistentfilter.PickerPanel,{filter:[{field:"model",operator:"equals",value:"Sales_Model_ProductFilter"}]});Tine.Sales.ContractFilterPanel=function(a){Ext.apply(this,a);Tine.Sales.ContractFilterPanel.superclass.constructor.call(this)};Ext.extend(Tine.Sales.ContractFilterPanel,Tine.widgets.persistentfilter.PickerPanel,{filter:[{field:"model",operator:"equals",value:"Sales_Model_ContractFilter"}]});Tine.Sales.contractBackend=new Tine.Tinebase.data.RecordProxy({appName:"Sales",modelName:"Contract",recordClass:Tine.Sales.Model.Contract});Tine.Sales.productBackend=new Tine.Tinebase.data.RecordProxy({appName:"Sales",modelName:"Product",recordClass:Tine.Sales.Model.Product});Tine.Sales.costcenterBackend=new Tine.Tinebase.data.RecordProxy({appName:"Sales",modelName:"CostCenter",recordClass:Tine.Sales.Model.CostCenter});Tine.Sales.divisionBackend=new Tine.Tinebase.data.RecordProxy({appName:"Sales",modelName:"Division",recordClass:Tine.Sales.Model.Division});Ext.ns("Tine.Sales");Tine.Sales.AdminPanel=Ext.extend(Ext.FormPanel,{appName:"Sales",layout:"fit",border:false,cls:"tw-editdialog",labelAlign:"top",anchor:"100% 100%",deferredRender:false,buttonAlign:null,bufferResize:500,initComponent:function(){if(!this.app){this.app=Tine.Tinebase.appMgr.get(this.appName)}Tine.log.debug("initComponent: appName: ",this.appName);Tine.log.debug("initComponent: app: ",this.app);this.initActions();this.initButtons();this.items=this.getFormItems();Tine.Sales.AdminPanel.superclass.initComponent.call(this)},initActions:function(){this.action_cancel=new Ext.Action({text:this.app.i18n._("Cancel"),minWidth:70,scope:this,handler:this.onCancel,iconCls:"action_cancel"});this.action_update=new Ext.Action({text:this.app.i18n._("OK"),minWidth:70,scope:this,handler:this.onUpdate,iconCls:"action_saveAndClose"})},initButtons:function(){this.fbar=["->",this.action_cancel,this.action_update]},onRender:function(b,a){this.loadMask=new Ext.LoadMask(b,{msg:_("Loading...")});Tine.Sales.AdminPanel.superclass.onRender.call(this,b,a);var c=new Ext.KeyMap(this.el,[{key:[10,13],ctrl:true,fn:this.onUpdate,scope:this}])},onCancel:function(){this.fireEvent("cancel");this.purgeListeners();this.window.close()},onUpdate:function(){Ext.Ajax.request({url:"index.php",scope:this,params:{method:"Sales.setConfig",config:{contractNumberGeneration:this.getForm().findField("contractNumberGeneration").getValue(),contractNumberValidation:this.getForm().findField("contractNumberValidation").getValue()}},success:function(b,a){this.onCancel()}})},getFormItems:function(){var b=Tine.Sales.registry.get("config").contractNumberGeneration,a=Tine.Sales.registry.get("config").contractNumberValidation;return{border:false,frame:false,layout:"border",items:[{region:"center",border:false,frame:false,layout:{align:"stretch",type:"vbox"},items:[{layout:"form",margins:"10px 10px",border:false,frame:false,items:[{fieldLabel:this.app.i18n._(b.definition.label),name:"contractNumberGeneration",xtype:"combo",mode:"local",forceSelection:true,triggerAction:"all",value:b.value?b.value:b["default"],store:b.definition.options},{fieldLabel:this.app.i18n._(a.definition.label),name:"contractNumberValidation",xtype:"combo",mode:"local",value:a.value?a.value:a["default"],forceSelection:true,triggerAction:"all",store:a.definition.options}]}]}]}}});Tine.Sales.AdminPanel.openWindow=function(a){var b=Tine.WindowFactory.getWindow({modal:true,width:240,height:250,contentPanelConstructor:"Tine.Sales.AdminPanel",contentPanelConstructorConfig:a});return b};Ext.ns("Tine.Sales");Tine.Sales.ContractSearchCombo=Ext.extend(Tine.Tinebase.widgets.form.RecordPickerComboBox,{allowBlank:false,itemSelector:"div.search-item",minListWidth:200,initComponent:function(){this.recordClass=Tine.Sales.Model.Contract;this.recordProxy=Tine.Sales.contractBackend;this.initTemplate();Tine.Sales.ContractSearchCombo.superclass.initComponent.call(this)},initTemplate:function(){if(!this.tpl){this.tpl=new Ext.XTemplate('<tpl for="."><div class="search-item">','<table cellspacing="0" cellpadding="2" border="0" style="font-size: 11px;" width="100%">',"<tr>",'<td style="height:16px">{[this.encode(values)]}</td>',"</tr>","</table>","</div></tpl>",{encode:function(a){var b="";if(a.number){b+="<b>"+Ext.util.Format.htmlEncode(a.number)+"</b> - "}b+=Ext.util.Format.htmlEncode(a.title);return b}})}}});Tine.widgets.form.RecordPickerManager.register("Sales","Contract",Tine.Sales.ContractSearchCombo);Ext.ns("Tine.Sales");Tine.Sales.CostCenterSearchCombo=Ext.extend(Tine.Tinebase.widgets.form.RecordPickerComboBox,{allowBlank:false,itemSelector:"div.search-item",minListWidth:200,sortBy:"number",initComponent:function(){this.recordClass=Tine.Sales.Model.CostCenter;this.recordProxy=Tine.Sales.costcenterBackend;this.initTemplate();Tine.Sales.CostCenterSearchCombo.superclass.initComponent.call(this)},initTemplate:function(){if(!this.tpl){this.tpl=new Ext.XTemplate('<tpl for="."><div class="search-item">','<table cellspacing="0" cellpadding="2" border="0" style="font-size: 11px;" width="100%">',"<tr>",'<td style="height:16px">{[this.encode(values)]}</td>',"</tr>","</table>","</div></tpl>",{encode:function(a){var b="";if(a.number){b+="<b>"+Ext.util.Format.htmlEncode(a.number)+"</b> - "}b+=Ext.util.Format.htmlEncode(a.remark);return b}})}}});Tine.widgets.form.RecordPickerManager.register("Sales","CostCenter",Tine.Sales.CostCenterSearchCombo);Ext.namespace("Tine.Sales");Tine.Sales.ContractGridPanel=Ext.extend(Tine.widgets.grid.GridPanel,{recordClass:Tine.Sales.Model.Contract,defaultSortInfo:{field:"title",dir:"ASC"},gridConfig:{autoExpandColumn:"title"},multipleEdit:true,initComponent:function(){this.recordProxy=Tine.Sales.contractBackend;this.gridConfig.columns=this.getColumns();this.initFilterToolbar();this.plugins.push(this.filterToolbar);Tine.Sales.ContractGridPanel.superclass.initComponent.call(this);this.action_addInNewWindow.actionUpdater=function(){var a=this.app.getRegistry().get("defaultContainer");this.action_addInNewWindow.setDisabled(!a.account_grants[this.action_addInNewWindow.initialConfig.requiredGrant])}},initFilterToolbar:function(){this.filterToolbar=new Tine.widgets.grid.FilterToolbar({recordClass:this.recordClass,filterModels:Tine.Sales.Model.Contract.getFilterModel(),defaultFilter:"query",filters:[],plugins:[new Tine.widgets.grid.FilterToolbarQuickFilterPlugin()]})},getColumns:function(){return[{id:"number",header:this.app.i18n._("Contract number"),width:100,sortable:true,dataIndex:"number"},{id:"title",header:this.app.i18n._("Title"),width:200,sortable:true,dataIndex:"title"},{id:"status",header:this.app.i18n._("Status"),width:100,sortable:true,dataIndex:"status",renderer:Tine.Tinebase.widgets.keyfield.Renderer.get("Sales","contractStatus")},{id:"cleared",header:this.app.i18n._("Cleared"),width:15,sortable:true,dataIndex:"cleared",renderer:Tine.Tinebase.widgets.keyfield.Renderer.get("Sales","contractCleared")},{id:"cleared_in",header:this.app.i18n._("Cleared in"),width:100,sortable:true,dataIndex:"cleared_in"}]}});Ext.namespace("Tine.Sales");Tine.Sales.ContractEditDialog=Ext.extend(Tine.widgets.dialog.EditDialog,{labelAlign:"side",windowNamePrefix:"ContractEditWindow_",appName:"Sales",recordClass:Tine.Sales.Model.Contract,recordProxy:Tine.Sales.contractBackend,tbarItems:[{xtype:"widget-activitiesaddbutton"}],autoGenerateNumber:null,validateNumber:null,initComponent:function(){this.autoGenerateNumber=(Tine.Sales.registry.get("config").contractNumberGeneration.value=="auto")?true:false;this.validateNumber=Tine.Sales.registry.get("config").contractNumberValidation.value;Tine.Sales.ContractEditDialog.superclass.initComponent.call(this)},requestData:function(){this.loadRequest=Ext.Ajax.request({scope:this,success:function(a){this.record=this.recordProxy.recordReader(a);this.onRecordLoad()},params:{method:"Sales.getContract",id:this.record.id}})},isMultipleValid:function(){return true},isValid:function(){var a=Tine.Sales.ContractEditDialog.superclass.isValid.call(this);var b=this.autoGenerateNumber?true:(this.validateNumber=="integer")?Ext.isNumber(Ext.num(this.getForm().findField("number").getValue())):true;if(!b){this.getForm().findField("number").markInvalid(this.app.i18n._("Please use a decimal number here!"))}return b&&a},getFormItems:function(){return{xtype:"tabpanel",layoutOnTabChange:true,border:false,plain:true,activeTab:0,border:false,plugins:[{ptype:"ux.tabpanelkeyplugin"}],items:[{title:this.app.i18n.n_("Contract","Contract",1),autoScroll:true,border:false,frame:true,layout:"border",items:[{region:"center",xtype:"columnform",labelAlign:"top",formDefaults:{xtype:"textfield",anchor:"100%",labelSeparator:"",columnWidth:0.333},items:[[{columnWidth:0.25,fieldLabel:this.app.i18n._("Number"),name:"number",multiEditable:false,readOnly:this.autoGenerateNumber,allowBlank:this.autoGenerateNumber},{columnWidth:0.75,fieldLabel:this.app.i18n._("Title"),name:"title",allowBlank:false}],[{columnWidth:0.5,xtype:"tinerelationpickercombo",fieldLabel:this.app.i18n._("Contact Customer"),editDialog:this,allowBlank:true,app:"Addressbook",recordClass:Tine.Addressbook.Model.Contact,relationType:"CUSTOMER",relationDegree:"sibling",modelUnique:true},{columnWidth:0.5,editDialog:this,xtype:"tinerelationpickercombo",fieldLabel:this.app.i18n._("Contact Responsible"),allowBlank:true,app:"Addressbook",recordClass:Tine.Addressbook.Model.Contact,relationType:"RESPONSIBLE",relationDegree:"sibling",modelUnique:true}],[new Tine.Tinebase.widgets.keyfield.ComboBox({app:"Sales",keyFieldName:"contractStatus",fieldLabel:this.app.i18n._("Status"),name:"status"}),new Tine.Tinebase.widgets.keyfield.ComboBox({app:"Sales",keyFieldName:"contractCleared",fieldLabel:this.app.i18n._("Cleared"),name:"cleared"}),{fieldLabel:this.app.i18n._("Cleared in"),name:"cleared_in",xtype:"textfield"}],[{columnWidth:1,fieldLabel:this.app.i18n._("Description"),emptyText:this.app.i18n._("Enter description..."),name:"description",xtype:"textarea",height:200}]]},{layout:"accordion",animate:true,region:"east",width:210,split:true,collapsible:true,collapseMode:"mini",header:false,margins:"0 5 0 5",border:true,items:[new Tine.widgets.activities.ActivitiesPanel({app:"Sales",showAddNoteForm:false,border:false,bodyStyle:"border:1px solid #B5B8C8;"}),new Tine.widgets.tags.TagPanel({app:"Sales",border:false,bodyStyle:"border:1px solid #B5B8C8;"})]}]},new Tine.widgets.activities.ActivitiesTabPanel({app:this.appName,record_id:this.record.id,record_model:this.appName+"_Model_"+this.recordClass.getMeta("modelName")})]}}});Tine.Sales.ContractEditDialog.openWindow=function(a){var b=Tine.WindowFactory.getWindow({width:800,height:470,name:Tine.Sales.ContractEditDialog.prototype.windowNamePrefix+Ext.id(),contentPanelConstructor:"Tine.Sales.ContractEditDialog",contentPanelConstructorConfig:a});return b};Ext.namespace("Tine.Sales");Tine.Sales.ProductGridPanel=Ext.extend(Tine.widgets.grid.GridPanel,{recordClass:Tine.Sales.Model.Product,evalGrants:false,defaultSortInfo:{field:"name",direction:"DESC"},gridConfig:{autoExpandColumn:"name"},initComponent:function(){this.recordProxy=Tine.Sales.productBackend;this.actionToolbarItems=this.getToolbarItems();this.contextMenuItems=[];this.gridConfig.cm=this.getColumnModel();this.filterToolbar=this.getFilterToolbar();this.plugins=this.plugins||[];this.plugins.push(this.filterToolbar);Tine.Sales.ProductGridPanel.superclass.initComponent.call(this);this.selectionModel.on("selectionchange",function(b){var a=Tine.Tinebase.common.hasRight("manage","Sales","products");if(a){Tine.widgets.actionUpdater(b,this.actions,this.recordClass.getMeta("containerProperty"),!this.evalGrants);if(this.updateOnSelectionChange&&this.detailsPanel){this.detailsPanel.onDetailsUpdate(b)}}else{this.action_editInNewWindow.setDisabled(true);this.action_deleteRecord.setDisabled(true);this.action_tagsMassAttach.setDisabled(true)}},this);this.action_addInNewWindow.setDisabled(!Tine.Tinebase.common.hasRight("manage","Sales","products"))},getFilterToolbar:function(){return new Tine.widgets.grid.FilterToolbar({filterModels:Tine.Sales.Model.Product.getFilterModel(),defaultFilter:"query",recordClass:this.recordClass,filters:[],plugins:[new Tine.widgets.grid.FilterToolbarQuickFilterPlugin()]})},getColumnModel:function(){return new Ext.grid.ColumnModel({defaults:{sortable:true},columns:[{header:this.app.i18n._("Tags"),id:"tags",dataIndex:"tags",width:50,renderer:Tine.Tinebase.common.tagsRenderer,sortable:false},{header:this.app.i18n._("Name"),id:"name",dataIndex:"name",width:200},{header:this.app.i18n._("Manufacturer"),id:"manufacturer",dataIndex:"manufacturer",width:100},{header:this.app.i18n._("Category"),id:"category",dataIndex:"category",width:100},{header:this.app.i18n._("Description"),id:"description",dataIndex:"description",width:150,sortable:false,hidden:true},{header:this.app.i18n._("Price"),id:"price",dataIndex:"price",width:75,renderer:Ext.util.Format.euMoney}]})},getToolbarItems:function(){return[]}});Ext.namespace("Tine.Sales");Tine.Sales.ProductEditDialog=Ext.extend(Tine.widgets.dialog.EditDialog,{windowNamePrefix:"ProductEditWindow_",appName:"Sales",recordClass:Tine.Sales.Model.Product,recordProxy:Tine.Sales.productBackend,tbarItems:[{xtype:"widget-activitiesaddbutton"}],evalGrants:false,initComponent:function(){Tine.Sales.ProductEditDialog.superclass.initComponent.call(this)},onRecordLoad:function(){Tine.Sales.ProductEditDialog.superclass.onRecordLoad.call(this)},getFormItems:function(){return{xtype:"tabpanel",border:false,plain:true,activeTab:0,border:false,plugins:[{ptype:"ux.tabpanelkeyplugin"}],items:[{title:this.app.i18n.n_("Product","Product",1),autoScroll:true,border:false,frame:true,layout:"border",items:[{region:"center",xtype:"columnform",labelAlign:"top",formDefaults:{xtype:"textfield",anchor:"100%",labelSeparator:"",columnWidth:0.333},items:[[{columnWidth:1,fieldLabel:this.app.i18n._("Name"),name:"name",allowBlank:false}],[{columnWidth:1,xtype:"numberfield",fieldLabel:this.app.i18n._("Price"),name:"price",allowNegative:false,allowBlank:false}],[{columnWidth:1,fieldLabel:this.app.i18n._("Manufacturer"),name:"manufacturer"}],[{columnWidth:1,fieldLabel:this.app.i18n._("Category"),name:"category"}],[{columnWidth:1,fieldLabel:this.app.i18n._("Description"),emptyText:this.app.i18n._("Enter description..."),name:"description",xtype:"textarea",height:150}]]},{layout:"accordion",animate:true,region:"east",width:210,split:true,collapsible:true,collapseMode:"mini",header:false,margins:"0 5 0 5",border:true,items:[new Tine.widgets.activities.ActivitiesPanel({app:"Sales",showAddNoteForm:false,border:false,bodyStyle:"border:1px solid #B5B8C8;"}),new Tine.widgets.tags.TagPanel({app:"Sales",border:false,bodyStyle:"border:1px solid #B5B8C8;"})]}]},new Tine.widgets.activities.ActivitiesTabPanel({app:this.appName,record_id:this.record.id,record_model:this.appName+"_Model_"+this.recordClass.getMeta("modelName")})]}}});Tine.Sales.ProductEditDialog.openWindow=function(a){var c=(a.record&&a.record.id)?a.record.id:0;var b=Tine.WindowFactory.getWindow({width:600,height:500,name:Tine.Sales.ProductEditDialog.prototype.windowNamePrefix+c,contentPanelConstructor:"Tine.Sales.ProductEditDialog",contentPanelConstructorConfig:a});return b};