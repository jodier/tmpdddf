/*
 * Tine 2.0 - Addressbook 
 * Copyright (c) 2007-2011 Metaways Infosystems GmbH (http://www.metaways.de)
 * http://www.gnu.org/licenses/agpl.html AGPL Version 3
 */
Ext.ns("Tine.Addressbook");Tine.Addressbook.ListMemberFilterModel=Ext.extend(Tine.widgets.grid.FilterModel,{app:null,field:"list",defaultOperator:"equals",initComponent:function(){Tine.Addressbook.ListMemberFilterModel.superclass.initComponent.call(this);this.app=Tine.Tinebase.appMgr.get("Addressbook");this.operators=["equals"];this.label=this.app.i18n._("Member of List")},valueRenderer:function(b,a){var c=new Tine.Tinebase.widgets.form.RecordPickerComboBox({blurOnSelect:true,recordClass:Tine.Addressbook.Model.List,filter:b,width:200,id:"tw-ftb-frow-valuefield-"+b.id,value:b.data.value?b.data.value:this.defaultValue,renderTo:a});c.on("select",this.onFiltertrigger,this);return c}});Tine.widgets.grid.FilterToolbar.FILTERS["addressbook.listMember"]=Tine.Addressbook.ListMemberFilterModel;Ext.ns("Tine.Addressbook.Model");Tine.Addressbook.Model.ContactArray=Tine.Tinebase.Model.genericFields.concat([{name:"id",omitDuplicateResolving:true},{name:"tid",omitDuplicateResolving:true},{name:"private",omitDuplicateResolving:true},{name:"cat_id",omitDuplicateResolving:true},{name:"n_family",label:"Last Name",group:"Name"},{name:"n_given",label:"First Name",group:"Name"},{name:"n_middle",label:"Middle Name",group:"Name"},{name:"n_prefix",label:"Title",group:"Name"},{name:"n_suffix",label:"Suffix",group:"Name"},{name:"n_fn",label:"Display Name",group:"Name",omitDuplicateResolving:true},{name:"n_fileas",group:"Name",omitDuplicateResolving:true},{name:"bday",label:"Birthday",type:"date",dateFormat:Date.patterns.ISO8601Long},{name:"org_name",label:"Company",group:"Company"},{name:"org_unit",label:"Unit",group:"Company"},{name:"salutation",label:"Salutation",group:"Name"},{name:"title",label:"Job Title",group:"Company"},{name:"role",label:"Job Role",group:"Company"},{name:"assistent",group:"Company",omitDuplicateResolving:true},{name:"room",label:"Room",group:"Company"},{name:"adr_one_street",label:"Street (Company Address)",group:"Company Address"},{name:"adr_one_street2",label:"Street 2 (Company Address)",group:"Company Address"},{name:"adr_one_locality",label:"City (Company Address)",group:"Company Address"},{name:"adr_one_region",label:"Region (Company Address)",group:"Company Address"},{name:"adr_one_postalcode",label:"Postal Code (Company Address)",group:"Company Address"},{name:"adr_one_countryname",label:"Country (Company Address)",group:"Company Address"},{name:"adr_one_lon",group:"Company Address",omitDuplicateResolving:true},{name:"adr_one_lat",group:"Company Address",omitDuplicateResolving:true},{name:"label",omitDuplicateResolving:true},{name:"adr_two_street",label:"Street (Private Address)",group:"Private Address"},{name:"adr_two_street2",label:"Street 2 (Private Address)",group:"Private Address"},{name:"adr_two_locality",label:"City (Private Address)",group:"Private Address"},{name:"adr_two_region",label:"Region (Private Address)",group:"Private Address"},{name:"adr_two_postalcode",label:"Postal Code (Private Address)",group:"Private Address"},{name:"adr_two_countryname",label:"Country (Private Address)",group:"Private Address"},{name:"adr_two_lon",group:"Private Address",omitDuplicateResolving:true},{name:"adr_two_lat",group:"Private Address",omitDuplicateResolving:true},{name:"tel_work",label:"Phone",group:"Company Communication"},{name:"tel_cell",label:"Mobile",group:"Company Communication"},{name:"tel_fax",label:"Fax",group:"Company Communication"},{name:"tel_assistent",group:"contact_infos",omitDuplicateResolving:true},{name:"tel_car",group:"contact_infos",omitDuplicateResolving:true},{name:"tel_pager",group:"contact_infos",omitDuplicateResolving:true},{name:"tel_home",label:"Phone (private)",group:"Private Communication"},{name:"tel_fax_home",label:"Fax (private)",group:"Private Communication"},{name:"tel_cell_private",label:"Mobile (private)",group:"Private Communication"},{name:"tel_other",group:"contact_infos",omitDuplicateResolving:true},{name:"tel_prefer",group:"contact_infos",omitDuplicateResolving:true},{name:"email",label:"E-Mail",group:"Company Communication"},{name:"email_home",label:"E-Mail (private)",group:"Private Communication"},{name:"url",label:"Web",group:"Company Communication"},{name:"url_home",label:"Web (private)",group:"Private Communication"},{name:"freebusy_uri",omitDuplicateResolving:true},{name:"calendar_uri",omitDuplicateResolving:true},{name:"note",label:"Description"},{name:"tz",omitDuplicateResolving:true},{name:"pubkey",omitDuplicateResolving:true},{name:"jpegphoto",omitDuplicateResolving:true},{name:"account_id",isMetaField:true},{name:"tags"},{name:"notes",omitDuplicateResolving:true},{name:"relations",omitDuplicateResolving:true},{name:"customfields",isMetaField:true},{name:"type",omitDuplicateResolving:true}]);Tine.Addressbook.Model.Contact=Tine.Tinebase.data.Record.create(Tine.Addressbook.Model.ContactArray,{appName:"Addressbook",modelName:"Contact",idProperty:"id",titleProperty:"n_fn",recordName:"Contact",recordsName:"Contacts",containerProperty:"container_id",containerName:"Addressbook",containersName:"Addressbooks",copyOmitFields:["account_id","type"],hasEmail:function(){return this.get("email")||this.get("email_home")},getPreferedEmail:function(b){var b=b||"email",a=b=="email"?"email_home":"email";return(this.get(b)||this.get(a))}});Tine.Addressbook.Model.Contact.getFilterModel=function(){var b=Tine.Tinebase.appMgr.get("Addressbook");var a=[["contact",b.i18n._("Contact")],["user",b.i18n._("User Account")]];return[{label:_("Quick search"),field:"query",operators:["contains"]},{filtertype:"tine.widget.container.filtermodel",app:b,recordClass:Tine.Addressbook.Model.Contact},{filtertype:"addressbook.listMember",app:b},{label:b.i18n._("First Name"),field:"n_given"},{label:b.i18n._("Last Name"),field:"n_family"},{label:b.i18n._("Company"),field:"org_name"},{label:b.i18n._("Unit"),field:"org_unit"},{label:b.i18n._("Phone"),field:"telephone",operators:["contains"]},{label:b.i18n._("Job Title"),field:"title"},{label:b.i18n._("Job Role"),field:"role"},{label:b.i18n._("Description"),field:"note"},{label:b.i18n._("E-Mail"),field:"email_query",operators:["contains"]},{filtertype:"tinebase.tag",app:b},{label:b.i18n._("Street")+" ("+b.i18n._("Company Address")+")",field:"adr_one_street",defaultOperator:"equals"},{label:b.i18n._("Region")+" ("+b.i18n._("Company Address")+")",field:"adr_one_region",defaultOperator:"equals"},{label:b.i18n._("Postal Code")+" ("+b.i18n._("Company Address")+")",field:"adr_one_postalcode",defaultOperator:"equals"},{label:b.i18n._("City")+"  ("+b.i18n._("Company Address")+")",field:"adr_one_locality"},{label:b.i18n._("Country")+"  ("+b.i18n._("Company Address")+")",field:"adr_one_countryname",valueType:"country"},{label:b.i18n._("Street")+" ("+b.i18n._("Private Address")+")",field:"adr_two_street",defaultOperator:"equals"},{label:b.i18n._("Region")+" ("+b.i18n._("Private Address")+")",field:"adr_two_region",defaultOperator:"equals"},{label:b.i18n._("Postal Code")+" ("+b.i18n._("Private Address")+")",field:"adr_two_postalcode",defaultOperator:"equals"},{label:b.i18n._("City")+" ("+b.i18n._("Private Address")+")",field:"adr_two_locality"},{label:b.i18n._("Country")+"  ("+b.i18n._("Private Address")+")",field:"adr_two_countryname",valueType:"country"},{label:b.i18n._("Type"),defaultValue:"contact",valueType:"combo",field:"type",store:a},{label:_("Last Modified Time"),field:"last_modified_time",valueType:"date"},{label:_("Last Modified By"),field:"last_modified_by",valueType:"user"},{label:_("Creation Time"),field:"creation_time",valueType:"date"},{label:_("Created By"),field:"created_by",valueType:"user"}]};Tine.Addressbook.contactBackend=new Tine.Tinebase.data.RecordProxy({appName:"Addressbook",modelName:"Contact",recordClass:Tine.Addressbook.Model.Contact});Tine.Addressbook.Model.List=Tine.Tinebase.data.Record.create([{name:"id"},{name:"container_id"},{name:"created_by"},{name:"creation_time"},{name:"last_modified_by"},{name:"last_modified_time"},{name:"is_deleted"},{name:"deleted_time"},{name:"deleted_by"},{name:"name"},{name:"description"},{name:"members"},{name:"email"},{name:"type"},{name:"group_id"}],{appName:"Addressbook",modelName:"List",idProperty:"id",titleProperty:"name",recordName:"List",recordsName:"Lists",containerProperty:"container_id",containerName:"Addressbook",containersName:"Addressbooks",copyOmitFields:["group_id"]});Ext.ns("Tine.Addressbook");Tine.Addressbook.Application=Ext.extend(Tine.Tinebase.Application,{addButtonText:"New Contact",getTitle:function(){return this.i18n.ngettext("Addressbook","Addressbooks",1)}});Tine.Addressbook.MainScreen=Ext.extend(Tine.widgets.MainScreen,{activeContentType:"Contact"});Tine.Addressbook.ContactTreePanel=function(a){Ext.apply(this,a);this.id="Addressbook_Tree";this.filterMode="filterToolbar";this.recordClass=Tine.Addressbook.Model.Contact;Tine.Addressbook.ContactTreePanel.superclass.constructor.call(this)};Ext.extend(Tine.Addressbook.ContactTreePanel,Tine.widgets.container.TreePanel);Tine.Addressbook.handleRequestException=Tine.Tinebase.ExceptionHandler.handleRequestException;Tine.Addressbook.ContactFilterPanel=function(a){Ext.apply(this,a);Tine.Addressbook.ContactFilterPanel.superclass.constructor.call(this)};Ext.extend(Tine.Addressbook.ContactFilterPanel,Tine.widgets.persistentfilter.PickerPanel,{filter:[{field:"model",operator:"equals",value:"Addressbook_Model_ContactFilter"}]});Ext.ns("Tine.Addressbook");Tine.Addressbook.ContactGridDetailsPanel=Ext.extend(Tine.widgets.grid.DetailsPanel,{il8n:null,felamimail:false,initComponent:function(){this.initTemplate();this.initDefaultTemplate();Tine.Addressbook.ContactGridDetailsPanel.superclass.initComponent.call(this)},afterRender:function(){Tine.Addressbook.ContactGridDetailsPanel.superclass.afterRender.apply(this,arguments);if(this.felamimail===true){this.body.on("click",this.onClick,this)}},initDefaultTemplate:function(){this.defaultTpl=new Ext.XTemplate('<div class="preview-panel-timesheet-nobreak">',"<!-- Preview contacts -->",'<div class="preview-panel preview-panel-timesheet-left">','<div class="bordercorner_1"></div>','<div class="bordercorner_2"></div>','<div class="bordercorner_3"></div>','<div class="bordercorner_4"></div>','<div class="preview-panel-declaration">'+this.il8n._("Contacts")+"</div>",'<div class="preview-panel-timesheet-leftside preview-panel-left">','<span class="preview-panel-bold">',this.il8n._("Select contact")+"<br/>","<br/>","<br/>","<br/>","</span>","</div>",'<div class="preview-panel-timesheet-rightside preview-panel-left">','<span class="preview-panel-nonbold">',"<br/>","<br/>","<br/>","<br/>","</span>","</div>","</div>","<!-- Preview xxx -->",'<div class="preview-panel-timesheet-right">','<div class="bordercorner_gray_1"></div>','<div class="bordercorner_gray_2"></div>','<div class="bordercorner_gray_3"></div>','<div class="bordercorner_gray_4"></div>','<div class="preview-panel-declaration"></div>','<div class="preview-panel-timesheet-leftside preview-panel-left">','<span class="preview-panel-bold">',"<br/>","<br/>","<br/>","<br/>","</span>","</div>",'<div class="preview-panel-timesheet-rightside preview-panel-left">','<span class="preview-panel-nonbold">',"<br/>","<br/>","<br/>","<br/>","</span>","</div>","</div>","</div>")},initTemplate:function(){this.tpl=new Ext.XTemplate('<tpl for=".">','<div class="preview-panel-adressbook-nobreak">','<div class="preview-panel-left">',"<!-- Preview image -->",'<div class="preview-panel preview-panel-left preview-panel-image">','<div class="bordercorner_1"></div>','<div class="bordercorner_2"></div>','<div class="bordercorner_3"></div>','<div class="bordercorner_4"></div>','<img src="{[this.getImageUrl(values.jpegphoto, 90, 113, values)]}"/>',"</div>","<!-- Preview office -->",'<div class="preview-panel preview-panel-office preview-panel-left">','<div class="bordercorner_1"></div>','<div class="bordercorner_2"></div>','<div class="bordercorner_3"></div>','<div class="bordercorner_4"></div>','<div class="preview-panel-declaration">'+this.il8n._("Company")+"</div>",'<div class="preview-panel-address preview-panel-left">','<span class="preview-panel-bold">{[this.encode(values.org_name, "mediumtext")]}{[this.encode(values.org_unit, "prefix", " / ")]}</span><br/>',"{[this.encode(values.adr_one_street)]}<br/>",'{[this.encode(values.adr_one_postalcode, " ")]}{[this.encode(values.adr_one_locality)]}<br/>','{[this.encode(values.adr_one_region, " / ")]}{[this.encode(values.adr_one_countryname, "country")]}<br/>',"</div>",'<div class="preview-panel-contact preview-panel-right">','<span class="preview-panel-symbolcompare">'+this.il8n._("Phone")+"</span>{[this.encode(values.tel_work)]}<br/>",'<span class="preview-panel-symbolcompare">'+this.il8n._("Mobile")+"</span>{[this.encode(values.tel_cell)]}<br/>",'<span class="preview-panel-symbolcompare">'+this.il8n._("Fax")+"</span>{[this.encode(values.tel_fax)]}<br/>",'<span class="preview-panel-symbolcompare">'+this.il8n._("E-Mail")+"</span>{[this.getMailLink(values.email, "+this.felamimail+")]}<br/>",'<span class="preview-panel-symbolcompare">'+this.il8n._("Web")+'</span><a href="{[this.encode(values.url, "href")]}" target="_blank">{[this.encode(values.url, "shorttext")]}</a><br/>',"</div>","</div>","</div>","<!-- Preview privat -->",'<div class="preview-panel preview-panel-privat preview-panel-left">','<div class="bordercorner_1"></div>','<div class="bordercorner_2"></div>','<div class="bordercorner_3"></div>','<div class="bordercorner_4"></div>','<div class="preview-panel-declaration">'+this.il8n._("Private")+"</div>",'<div class="preview-panel-address preview-panel-left">','<span class="preview-panel-bold">{[this.encode(values.n_fn)]}</span><br/>',"{[this.encode(values.adr_two_street)]}<br/>",'{[this.encode(values.adr_two_postalcode, " ")]}{[this.encode(values.adr_two_locality)]}<br/>','{[this.encode(values.adr_two_region, " / ")]}{[this.encode(values.adr_two_countryname, "country")]}<br/>',"</div>",'<div class="preview-panel-contact preview-panel-right">','<span class="preview-panel-symbolcompare">'+this.il8n._("Phone")+"</span>{[this.encode(values.tel_home)]}<br/>",'<span class="preview-panel-symbolcompare">'+this.il8n._("Mobile")+"</span>{[this.encode(values.tel_cell_private)]}<br/>",'<span class="preview-panel-symbolcompare">'+this.il8n._("Fax")+"</span>{[this.encode(values.tel_fax_home)]}<br/>",'<span class="preview-panel-symbolcompare">'+this.il8n._("E-Mail")+"</span>{[this.getMailLink(values.email_home, "+this.felamimail+")]}<br/>",'<span class="preview-panel-symbolcompare">'+this.il8n._("Web")+'</span><a href="{[this.encode(values.url, "href")]}" target="_blank">{[this.encode(values.url_home, "shorttext")]}</a><br/>',"</div>","</div>","<!-- Preview info -->",'<div class="preview-panel-description preview-panel-left" ext:qtip="{[this.encode(values.note)]}">','<div class="bordercorner_gray_1"></div>','<div class="bordercorner_gray_2"></div>','<div class="bordercorner_gray_3"></div>','<div class="bordercorner_gray_4"></div>','<div class="preview-panel-declaration">'+this.il8n._("Info")+"</div>",'{[this.encode(values.note, "longtext")]}',"</div>","</div>","</tpl>",{encode:function(c,a,b){if(c){if(a){switch(a){case"country":c=Locale.getTranslationData("CountryList",c);break;case"longtext":c=Ext.util.Format.ellipsis(c,135);break;case"mediumtext":c=Ext.util.Format.ellipsis(c,30);break;case"shorttext":c=Ext.util.Format.ellipsis(c,18);break;case"prefix":if(b){c=b+c}break;case"href":if(!String(c).match(/^(https?|ftps?)/)){var d=Tine.Tinebase.appMgr.get("Addressbook");return"javascript:Ext.Msg.alert('"+d.i18n._("Insecure link")+"', '"+d.i18n._("Please review this link in edit dialog.")+"');"}break;default:c+=a}}c=Ext.util.Format.htmlEncode(c);return Ext.util.Format.nl2br(c)}else{return""}},getTags:function(c){var a="";for(var b=0;b<c.length;b++){a+=c[b].name+" "}return a},getImageUrl:function(d,e,b,a){var c=a.last_modified_time||a.creation_time;if(d.match(/&/)){d=Ext.ux.util.ImageURL.prototype.parseURL(d);d.width=e;d.height=b;d.ratiomode=0;d.mtime=Ext.isDate(c)?c.getTime():new Date().getTime()}return d},getMailLink:function(b,a){if(!b){return""}b=this.encode(b);var c=(a===true)?"#":"mailto:"+b;var d=Ext.id()+":"+b;return'<a href="'+c+'" class="tinebase-email-link" id="'+d+'">'+Ext.util.Format.ellipsis(b,18)+"</a>"}})},onClick:function(g){var f=g.getTarget("a[class=tinebase-email-link]");if(f){var b=f.id.split(":")[1];var d=Tine.Felamimail.Model.Message.getDefaultData();d.to=[b];d.body=Tine.Felamimail.getSignature();var a=new Tine.Felamimail.Model.Message(d,0);var c=Tine.Felamimail.MessageEditDialog.openWindow({record:a})}}});Ext.ns("Tine.Addressbook");Tine.Addressbook.ContactGridPanel=Ext.extend(Tine.widgets.grid.GridPanel,{recordClass:Tine.Addressbook.Model.Contact,defaultSortInfo:{field:"n_fileas",direction:"ASC"},gridConfig:{autoExpandColumn:"n_fileas",enableDragDrop:true,ddGroup:"containerDDGroup"},copyEditAction:true,felamimail:false,multipleEdit:true,duplicateResolvable:true,hasDetailsPanel:true,initComponent:function(){this.recordProxy=Tine.Addressbook.contactBackend;if(Tine.Felamimail&&Tine.Tinebase.common.hasRight("run","Felamimail")&&Tine.Felamimail.registry.get("preferences").get("useInAdb")){this.felamimail=(Tine.Felamimail.registry.get("preferences").get("useInAdb")==1)}this.gridConfig.cm=this.getColumnModel();this.filterToolbar=this.filterToolbar||this.getFilterToolbar();if(this.hasDetailsPanel){this.detailsPanel=this.getDetailsPanel()}this.plugins=this.plugins||[];this.plugins.push(this.filterToolbar);Tine.Addressbook.ContactGridPanel.superclass.initComponent.call(this)},getColumnModel:function(){return new Ext.grid.ColumnModel({defaults:{sortable:true,hidden:true,resizable:true},columns:this.getColumns()})},getColumns:function(){return[{id:"tid",header:this.app.i18n._("Type"),dataIndex:"tid",width:30,renderer:this.contactTidRenderer.createDelegate(this),hidden:false},{id:"tags",header:this.app.i18n._("Tags"),dataIndex:"tags",width:50,renderer:Tine.Tinebase.common.tagsRenderer,sortable:false,hidden:false},{id:"salutation",header:this.app.i18n._("Salutation"),dataIndex:"salutation",renderer:Tine.Tinebase.widgets.keyfield.Renderer.get("Addressbook","contactSalutation")},{id:"n_family",header:this.app.i18n._("Last Name"),dataIndex:"n_family"},{id:"n_given",header:this.app.i18n._("First Name"),dataIndex:"n_given",width:80},{id:"n_fn",header:this.app.i18n._("Full Name"),dataIndex:"n_fn"},{id:"n_fileas",header:this.app.i18n._("Display Name"),dataIndex:"n_fileas",hidden:false},{id:"org_name",header:this.app.i18n._("Company"),dataIndex:"org_name",width:120,hidden:false},{id:"org_unit",header:this.app.i18n._("Unit"),dataIndex:"org_unit"},{id:"title",header:this.app.i18n._("Job Title"),dataIndex:"title"},{id:"role",header:this.app.i18n._("Job Role"),dataIndex:"role"},{id:"room",header:this.app.i18n._("Room"),dataIndex:"room"},{id:"adr_one_street",header:this.app.i18n._("Street"),dataIndex:"adr_one_street"},{id:"adr_one_locality",header:this.app.i18n._("City"),dataIndex:"adr_one_locality",width:150,hidden:false},{id:"adr_one_region",header:this.app.i18n._("Region"),dataIndex:"adr_one_region"},{id:"adr_one_postalcode",header:this.app.i18n._("Postalcode"),dataIndex:"adr_one_postalcode"},{id:"adr_one_countryname",header:this.app.i18n._("Country"),dataIndex:"adr_one_countryname"},{id:"adr_two_street",header:this.app.i18n._("Street (private)"),dataIndex:"adr_two_street"},{id:"adr_two_locality",header:this.app.i18n._("City (private)"),dataIndex:"adr_two_locality"},{id:"adr_two_region",header:this.app.i18n._("Region (private)"),dataIndex:"adr_two_region"},{id:"adr_two_postalcode",header:this.app.i18n._("Postalcode (private)"),dataIndex:"adr_two_postalcode"},{id:"adr_two_countryname",header:this.app.i18n._("Country (private)"),dataIndex:"adr_two_countryname"},{id:"email",header:this.app.i18n._("Email"),dataIndex:"email",width:150,hidden:false},{id:"tel_work",header:this.app.i18n._("Phone"),dataIndex:"tel_work",hidden:false},{id:"tel_cell",header:this.app.i18n._("Mobile"),dataIndex:"tel_cell",hidden:false},{id:"tel_fax",header:this.app.i18n._("Fax"),dataIndex:"tel_fax"},{id:"tel_car",header:this.app.i18n._("Car phone"),dataIndex:"tel_car"},{id:"tel_pager",header:this.app.i18n._("Pager"),dataIndex:"tel_pager"},{id:"tel_home",header:this.app.i18n._("Phone (private)"),dataIndex:"tel_home"},{id:"tel_fax_home",header:this.app.i18n._("Fax (private)"),dataIndex:"tel_fax_home"},{id:"tel_cell_private",header:this.app.i18n._("Mobile (private)"),dataIndex:"tel_cell_private"},{id:"email_home",header:this.app.i18n._("Email (private)"),dataIndex:"email_home"},{id:"url",header:this.app.i18n._("Web"),dataIndex:"url"},{id:"url_home",header:this.app.i18n._("URL (private)"),dataIndex:"url_home"},{id:"note",header:this.app.i18n._("Note"),dataIndex:"note"},{id:"tz",header:this.app.i18n._("Timezone"),dataIndex:"tz"},{id:"geo",header:this.app.i18n._("Geo"),dataIndex:"geo"},{id:"bday",header:this.app.i18n._("Birthday"),dataIndex:"bday",renderer:Tine.Tinebase.common.dateRenderer}].concat(this.getModlogColumns().concat(this.getCustomfieldColumns()))},initActions:function(){this.actions_exportContact=new Ext.Action({requiredGrant:"exportGrant",text:String.format(this.app.i18n.ngettext("Export {0}","Export {0}",50),this.i18nRecordsName),singularText:String.format(this.app.i18n.ngettext("Export {0}","Export {0}",1),this.i18nRecordName),pluralText:String.format(this.app.i18n.ngettext("Export {0}","Export {0}",1),this.i18nRecordsName),translationObject:this.app.i18n,iconCls:"action_export",scope:this,disabled:true,allowMultiple:true,menu:{items:[new Tine.widgets.grid.ExportButton({text:this.app.i18n._("Export as PDF"),iconCls:"action_exportAsPdf",format:"pdf",exportFunction:"Addressbook.exportContacts",gridPanel:this}),new Tine.widgets.grid.ExportButton({text:this.app.i18n._("Export as CSV"),iconCls:"tinebase-action-export-csv",format:"csv",exportFunction:"Addressbook.exportContacts",gridPanel:this}),new Tine.widgets.grid.ExportButton({text:this.app.i18n._("Export as ODS"),format:"ods",iconCls:"tinebase-action-export-ods",exportFunction:"Addressbook.exportContacts",gridPanel:this}),new Tine.widgets.grid.ExportButton({text:this.app.i18n._("Export as XLS"),format:"xls",iconCls:"tinebase-action-export-xls",exportFunction:"Addressbook.exportContacts",gridPanel:this}),new Tine.widgets.grid.ExportButton({text:this.app.i18n._("Export as ..."),iconCls:"tinebase-action-export-xls",exportFunction:"Addressbook.exportContacts",showExportDialog:true,gridPanel:this})]}});this.actions_import=new Ext.Action({text:this.app.i18n._("Import contacts"),disabled:false,handler:this.onImport,iconCls:"action_import",scope:this,allowMultiple:true});this.actionUpdater.addActions([this.actions_exportContact,this.actions_import]);Tine.Addressbook.ContactGridPanel.superclass.initActions.call(this)},getActionToolbarItems:function(){return[{xtype:"buttongroup",columns:1,frame:false,items:[this.actions_exportContact,this.actions_import]}]},getContextMenuItems:function(){var a=["-",this.actions_exportContact,"-"];return a},onImport:function(b){var a=Tine.widgets.dialog.ImportDialog.openWindow({appName:"Addressbook",modelName:"Contact",defaultImportContainer:this.app.getMainScreen().getWestPanel().getContainerTreePanel().getDefaultContainer("defaultAddressbook"),listeners:{scope:this,finish:function(){this.loadGridData({preserveCursor:false,preserveSelection:false,preserveScroller:false,removeStrategy:"default"})}}})},contactTidRenderer:function(c,a,b){switch(b.get("type")){case"user":return'<img src="images/oxygen/16x16/actions/user-female.png" width="12" height="12" alt="contact" ext:qtip="'+Ext.util.Format.htmlEncode(this.app.i18n._("Internal Contact"))+'"/>';default:return"<img src='images/oxygen/16x16/actions/user.png' width='12' height='12' alt='contact'/>"}},getDetailsPanel:function(){return new Tine.Addressbook.ContactGridDetailsPanel({gridpanel:this,il8n:this.app.i18n,felamimail:this.felamimail})}});Ext.ns("Tine.Calendar");Tine.Addressbook.ContactFilterModel=Ext.extend(Tine.widgets.grid.FilterModel,{app:null,field:"contact_id",defaultOperator:"equals",initComponent:function(){Tine.Addressbook.ContactFilterModel.superclass.initComponent.call(this);this.app=Tine.Tinebase.appMgr.get("Addressbook");this.operators=["equals"];this.label=this.label||this.app.i18n._("Contact")},valueRenderer:function(b,a){var c=new Tine.Addressbook.SearchCombo({app:this.app,filter:b,width:200,listWidth:400,listAlign:"tr-br?",id:"tw-ftb-frow-valuefield-"+b.id,value:b.data.value?b.data.value:this.defaultValue,renderTo:a,getValue:function(){return this.selectedRecord.id},onSelect:function(d){this.setValue(d);this.collapse();this.fireEvent("select",this,d);if(this.blurOnSelect){this.fireEvent("blur",this)}},setValue:function(e){this.selectedRecord=e;var d=Tine.Calendar.AttendeeGridPanel.prototype.renderAttenderUserName.call(this,e);Tine.Addressbook.SearchCombo.superclass.setValue.call(this,d)}});c.on("select",this.onFiltertrigger,this);return c}});Tine.widgets.grid.FilterToolbar.FILTERS["addressbook.contact"]=Tine.Addressbook.ContactFilterModel;Ext.ns("Tine.Addressbook");Tine.Addressbook.ContactEditDialog=Ext.extend(Tine.widgets.dialog.EditDialog,{parseAddressButton:null,windowNamePrefix:"ContactEditWindow_",appName:"Addressbook",recordClass:Tine.Addressbook.Model.Contact,showContainerSelector:true,multipleEdit:true,getFormItems:function(){if(Tine.Tinebase.registry.get("mapPanel")&&Tine.widgets.MapPanel){this.mapPanel=new Tine.Addressbook.MapPanel({layout:"fit",title:this.app.i18n._("Map"),disabled:(Ext.isEmpty(this.record.get("adr_one_lon"))||Ext.isEmpty(this.record.get("adr_one_lat")))&&(Ext.isEmpty(this.record.get("adr_two_lon"))||Ext.isEmpty(this.record.get("adr_two_lat")))});Tine.widgets.dialog.MultipleEditDialogPlugin.prototype.registerSkipItem(this.mapPanel)}else{this.mapPanel=new Ext.Panel({layout:"fit",title:this.app.i18n._("Map"),disabled:true,html:""})}return{xtype:"tabpanel",border:false,plain:true,activeTab:0,plugins:[{ptype:"ux.tabpanelkeyplugin"}],items:[{title:this.app.i18n.n_("Contact","Contacts",1),border:false,frame:true,layout:"border",items:[{region:"center",layout:"border",items:[{xtype:"fieldset",region:"north",autoHeight:true,title:this.app.i18n._("Personal Information"),items:[{xtype:"panel",layout:"fit",width:90,height:120,style:{position:"absolute",right:"10px",top:Ext.isGecko?"7px":"19px","z-index":100},items:[new Ext.ux.form.ImageField({name:"jpegphoto",width:90,height:120})]},{xtype:"columnform",items:[[new Tine.Tinebase.widgets.keyfield.ComboBox({fieldLabel:this.app.i18n._("Salutation"),name:"salutation",app:"Addressbook",keyFieldName:"contactSalutation",value:"",columnWidth:0.35,listeners:{scope:this,select:function(d,a,b){var c=this.getForm().findField("jpegphoto");if(Ext.isEmpty(c.getValue())&&!Ext.isEmpty(a.json.image)){c.setDefaultImage(a.json.image)}}}}),{columnWidth:0.65,fieldLabel:this.app.i18n._("Title"),name:"n_prefix",maxLength:64},{width:100,hidden:true}],[{columnWidth:0.35,fieldLabel:this.app.i18n._("First Name"),name:"n_given",maxLength:64},{columnWidth:0.3,fieldLabel:this.app.i18n._("Middle Name"),name:"n_middle",maxLength:64},{columnWidth:0.35,fieldLabel:this.app.i18n._("Last Name"),name:"n_family",maxLength:255},{width:100,hidden:true}],[{columnWidth:0.65,xtype:"mirrortextfield",fieldLabel:this.app.i18n._("Company"),name:"org_name",maxLength:255},{columnWidth:0.35,fieldLabel:this.app.i18n._("Unit"),name:"org_unit",maxLength:64},{width:100,hidden:true}],[{columnWidth:0.65,xtype:"combo",fieldLabel:this.app.i18n._("Display Name"),name:"n_fn",disabled:true},{columnWidth:0.35,fieldLabel:this.app.i18n._("Job Title"),name:"title",maxLength:64},{width:100,xtype:"extuxclearabledatefield",fieldLabel:this.app.i18n._("Birthday"),name:"bday"}]]}]},{xtype:"fieldset",region:"center",title:this.app.i18n._("Contact Information"),autoScroll:true,items:[{xtype:"columnform",items:[[{fieldLabel:this.app.i18n._("Phone"),labelIcon:"images/oxygen/16x16/apps/kcall.png",name:"tel_work",maxLength:40},{fieldLabel:this.app.i18n._("Mobile"),labelIcon:"images/oxygen/16x16/devices/phone.png",name:"tel_cell",maxLength:40},{fieldLabel:this.app.i18n._("Fax"),labelIcon:"images/oxygen/16x16/devices/printer.png",name:"tel_fax",maxLength:40}],[{fieldLabel:this.app.i18n._("Phone (private)"),labelIcon:"images/oxygen/16x16/apps/kcall.png",name:"tel_home",maxLength:40},{fieldLabel:this.app.i18n._("Mobile (private)"),labelIcon:"images/oxygen/16x16/devices/phone.png",name:"tel_cell_private",maxLength:40},{fieldLabel:this.app.i18n._("Fax (private)"),labelIcon:"images/oxygen/16x16/devices/printer.png",name:"tel_fax_home",maxLength:40}],[{fieldLabel:this.app.i18n._("E-Mail"),labelIcon:"images/oxygen/16x16/actions/kontact-mail.png",name:"email",vtype:"email",maxLength:64},{fieldLabel:this.app.i18n._("E-Mail (private)"),labelIcon:"images/oxygen/16x16/actions/kontact-mail.png",name:"email_home",vtype:"email",maxLength:64},{xtype:"mirrortextfield",fieldLabel:this.app.i18n._("Web"),labelIcon:"images/oxygen/16x16/actions/network.png",name:"url",maxLength:128,listeners:{scope:this,focus:function(a){if(!a.getValue()){a.setValue("http://www.");a.selectText.defer(100,a,[7,11])}},blur:function(a){if(a.getValue()==="http://www."){a.setValue(null);a.validate()}}}}]]}]},{xtype:"tabpanel",region:"south",border:false,deferredRender:false,height:124,split:true,activeTab:0,defaults:{frame:true},items:[{title:this.app.i18n._("Company Address"),xtype:"columnform",items:[[{fieldLabel:this.app.i18n._("Street"),name:"adr_one_street",maxLength:64},{fieldLabel:this.app.i18n._("Street 2"),name:"adr_one_street2",maxLength:64},{fieldLabel:this.app.i18n._("Region"),name:"adr_one_region",maxLength:64}],[{fieldLabel:this.app.i18n._("Postal Code"),name:"adr_one_postalcode",maxLength:64},{fieldLabel:this.app.i18n._("City"),name:"adr_one_locality",maxLength:64},{xtype:"widget-countrycombo",fieldLabel:this.app.i18n._("Country"),name:"adr_one_countryname",maxLength:64}]]},{title:this.app.i18n._("Private Address"),xtype:"columnform",items:[[{fieldLabel:this.app.i18n._("Street"),name:"adr_two_street",maxLength:64},{fieldLabel:this.app.i18n._("Street 2"),name:"adr_two_street2",maxLength:64},{fieldLabel:this.app.i18n._("Region"),name:"adr_two_region",maxLength:64}],[{fieldLabel:this.app.i18n._("Postal Code"),name:"adr_two_postalcode",maxLength:64},{fieldLabel:this.app.i18n._("City"),name:"adr_two_locality",maxLength:64},{xtype:"widget-countrycombo",fieldLabel:this.app.i18n._("Country"),name:"adr_two_countryname",maxLength:64}]]}]}]},{region:"east",layout:"accordion",animate:true,width:210,split:true,collapsible:true,collapseMode:"mini",header:false,margins:"0 5 0 5",border:true,items:[new Ext.Panel({title:this.app.i18n._("Description"),iconCls:"descriptionIcon",layout:"form",labelAlign:"top",border:false,items:[{style:"margin-top: -4px; border 0px;",labelSeparator:"",xtype:"textarea",name:"note",hideLabel:true,grow:false,preventScrollbars:false,anchor:"100% 100%",emptyText:this.app.i18n._("Enter description"),requiredGrant:"editGrant"}]}),new Tine.widgets.activities.ActivitiesPanel({app:"Addressbook",showAddNoteForm:false,border:false,bodyStyle:"border:1px solid #B5B8C8;"}),new Tine.widgets.tags.TagPanel({app:"Addressbook",border:false,bodyStyle:"border:1px solid #B5B8C8;"})]}]},this.mapPanel,new Tine.widgets.activities.ActivitiesTabPanel({app:this.appName,record_id:(this.record&&!this.copyRecord)?this.record.id:"",record_model:this.appName+"_Model_"+this.recordClass.getMeta("modelName")})]}},initComponent:function(){var a={};this.initToolbar();this.supr().initComponent.apply(this,arguments)},initToolbar:function(){var b=new Ext.Action({id:"exportButton",text:Tine.Tinebase.appMgr.get("Addressbook").i18n._("Export as pdf"),handler:this.onExportContact,iconCls:"action_exportAsPdf",disabled:false,scope:this});var a=new Tine.widgets.activities.ActivitiesAddButton({});this.parseAddressButton=new Ext.Action({text:Tine.Tinebase.appMgr.get("Addressbook").i18n._("Parse address"),handler:this.onParseAddress,iconCls:"action_parseAddress",disabled:false,scope:this,enableToggle:true});this.tbarItems=[b,a,this.parseAddressButton]},isValid:function(){var a=this.getForm();var b=true;if(a.findField("n_family").getValue()===""&&a.findField("org_name").getValue()===""){var c=String.format(this.app.i18n._("Either {0} or {1} must be given"),this.app.i18n._("Last Name"),this.app.i18n._("Company"));a.findField("n_family").markInvalid(c);a.findField("org_name").markInvalid(c);b=false}return b&&Tine.Addressbook.ContactEditDialog.superclass.isValid.apply(this,arguments)},isMultipleValid:function(){var a=true;if(((this.getForm().findField("n_family").getValue()==="")&&(this.getForm().findField("n_family").edited))&&((this.getForm().findField("org_name").getValue()==="")&&(this.getForm().findField("org_name").edited))){var b=String.format(this.app.i18n._("Either {0} or {1} must be given"),this.app.i18n._("Last Name"),this.app.i18n._("Company"));this.getForm().findField("n_family").markInvalid(b);this.getForm().findField("org_name").markInvalid(b);a=false}return a},onExportContact:function(){var a=new Ext.ux.file.Download({params:{method:"Addressbook.exportContacts",filter:Ext.encode([{field:"id",operator:"in",value:this.record.id}]),options:Ext.util.JSON.encode({format:"pdf"})}});a.start()},onParseAddress:function(a){if(a.pressed){Ext.Msg.prompt(this.app.i18n._("Paste address"),this.app.i18n._("Please paste an address that should be parsed:"),function(b,c){if(b=="ok"){this.parseAddress(c)}else{if(b=="cancel"){a.toggle()}}},this,100)}else{a.setText(this.app.i18n._("Parse address"));this.tokenModePlugin.endTokenMode()}},parseAddress:function(a){Tine.log.debug("parsing address ... ");Tine.Addressbook.parseAddressData(a,function(b,c){Tine.log.debug("parsed address:");Tine.log.debug(b);Ext.iterate(b.contact,function(e,f){this.record.set(e,f)},this);var d=(this.record.get("note"))?this.record.get("note"):"";this.record.set("note",b.unrecognizedTokens.join(" ")+d);this.onRecordLoad();this.parseAddressButton.setText(this.app.i18n._("End token mode"));this.tokenModePlugin.startTokenMode()},this)},onRecordLoad:function(){if(this.rendered){var a=this.record.get("container_id");if(!this.record.id){if(this.forceContainer){a=this.forceContainer;this.forceContainer=null}else{if(!Ext.isObject(a)){a=Tine.Addressbook.registry.get("defaultAddressbook")}}this.record.set("container_id","");this.record.set("container_id",a)}if(this.mapPanel instanceof Tine.Addressbook.MapPanel){this.mapPanel.onRecordLoad(this.record)}}this.supr().onRecordLoad.apply(this,arguments)}});Tine.Addressbook.ContactEditDialog.openWindow=function(a){var c=Ext.getCmp("Addressbook_Tree")?Ext.getCmp("Addressbook_Tree").getSelectionModel().getSelectedNode():null;if(c&&c.attributes&&c.attributes.container.type){a.forceContainer=c.attributes.container}else{a.forceContainer=null}var d=(a.record&&a.record.id)?a.record.id:0;var b=Tine.WindowFactory.getWindow({width:800,height:610,name:Tine.Addressbook.ContactEditDialog.prototype.windowNamePrefix+d,contentPanelConstructor:"Tine.Addressbook.ContactEditDialog",contentPanelConstructorConfig:a});return b};Ext.ns("Tine.Addressbook");Tine.Addressbook.SearchCombo=Ext.extend(Tine.Tinebase.widgets.form.RecordPickerComboBox,{userOnly:false,additionalFilters:null,useAccountRecord:false,allowBlank:false,itemSelector:"div.search-item",minListWidth:350,initComponent:function(){this.recordClass=Tine.Addressbook.Model.Contact;this.recordProxy=Tine.Addressbook.contactBackend;this.initTemplate();Tine.Addressbook.SearchCombo.superclass.initComponent.call(this)},processValue:function(a){if(this.useAccountRecord){if(a==""){this.accountId=null;this.selectedRecord=null}}return Tine.Addressbook.SearchCombo.superclass.processValue.call(this,a)},onBeforeQuery:function(c){Tine.Addressbook.SearchCombo.superclass.onBeforeQuery.apply(this,arguments);var b=this.store.baseParams.filter;if(this.userOnly){b.push({field:"type",operator:"equals",value:"user"})}if(this.additionalFilters!==null&&this.additionalFilters.length>0){for(var a=0;a<this.additionalFilters.length;a++){b.push(this.additionalFilters[a])}}},initTemplate:function(){if(!this.tpl){this.tpl=new Ext.XTemplate('<tpl for="."><div class="search-item">','<table cellspacing="0" cellpadding="2" border="0" style="font-size: 11px;" width="100%">',"<tr>",'<td width="30%"><b>{[this.encode(values.n_fileas)]}</b><br/>{[this.encode(values.org_name)]}</td>','<td width="25%">{[this.encode(values.adr_one_street)]}<br/>',"{[this.encode(values.adr_one_postalcode)]} {[this.encode(values.adr_one_locality)]}</td>",'<td width="25%">{[this.encode(values.tel_work)]}<br/>{[this.encode(values.tel_cell)]}</td>','<td width="20%">','<img width="45px" height="39px" src="{jpegphoto}" />',"</td>","</tr>","</table>","</div></tpl>",{encode:function(a){if(a){return Ext.util.Format.htmlEncode(a)}else{return""}}})}},getValue:function(){if(this.useAccountRecord){if(this.selectedRecord){return this.selectedRecord.get("account_id")}else{return this.accountId}}else{return Tine.Addressbook.SearchCombo.superclass.getValue.call(this)}},setValue:function(a){if(this.useAccountRecord){if(a){if(a.accountId){this.accountId=a.accountId;a=a.accountDisplayName}else{if(typeof(a.get)=="function"){this.accountId=a.get("id");a=a.get("name")}}}else{this.accountId=null;this.selectedRecord=null}}return Tine.Addressbook.SearchCombo.superclass.setValue.call(this,a)}});Ext.reg("addressbookcontactpicker",Tine.Addressbook.SearchCombo);Tine.widgets.form.RecordPickerManager.register("Addressbook","Contact",Tine.Addressbook.SearchCombo);Ext.ns("Tine.Addressbook");Tine.Addressbook.MapPanel=Ext.extend(Ext.Panel,{activeMapCard:null,record:null,layout:"fit",frame:true,companyMap:null,privateMap:null,initComponent:function(){this.app=Tine.Tinebase.appMgr.get("Addressbook");this.title=this.app.i18n._("Map");this.defaults={border:false};this.mapCards=new Ext.Panel({layout:"card",activeItem:0,items:[]});this.idPrefix=Ext.id();this.tbar=[{id:this.idPrefix+"tglbtncompanyMap",enableToggle:true,allowDepress:false,text:this.app.i18n._("Company address"),handler:this.onMapChange.createDelegate(this,["companyMap"]),toggleGroup:this.idPrefix+"maptglgroup"}," ",{id:this.idPrefix+"tglbtnprivateMap",enableToggle:true,allowDepress:false,text:this.app.i18n._("Private address"),handler:this.onMapChange.createDelegate(this,["privateMap"]),toggleGroup:this.idPrefix+"maptglgroup"}];this.items=this.mapCards;Tine.Addressbook.MapPanel.superclass.initComponent.call(this)},onMapChange:function(a){this.mapCards.layout.setActiveItem(this[a]);this.mapCards.layout.layout();this.activeMapCard=this[a]},onRecordLoad:function(a){this.record=a;var e=!Ext.isEmpty(this.record.get("adr_one_lon"))&&!Ext.isEmpty(this.record.get("adr_one_lat")),d=!Ext.isEmpty(this.record.get("adr_two_lon"))&&!Ext.isEmpty(this.record.get("adr_two_lat")),c=Ext.getCmp(this.idPrefix+"tglbtncompanyMap"),b=Ext.getCmp(this.idPrefix+"tglbtnprivateMap");if(e&&!this.companyMap){Tine.log.debug("Add company address map");this.companyMap=new Tine.widgets.MapPanel({map:"companyMap",layout:"fit",zoom:15,listeners:{scope:this,activate:function(f){if(!f.center){Tine.log.debug("Loading company address map coordinates: "+this.record.get("adr_one_lon")+", "+this.record.get("adr_one_lat"));f.setCenter(this.record.get("adr_one_lon"),this.record.get("adr_one_lat"))}}}});this.mapCards.add(this.companyMap);this.mapCards.doLayout()}if(d&&!this.privateMap){Tine.log.debug("Add private address map");this.privateMap=new Tine.widgets.MapPanel({map:"privateMap",layout:"fit",zoom:15,listeners:{scope:this,activate:function(f){if(!f.center){Tine.log.debug("Loading private address map coordinates: "+this.record.get("adr_two_lon")+", "+this.record.get("adr_two_lat"));f.setCenter(this.record.get("adr_two_lon"),this.record.get("adr_two_lat"))}}}});this.mapCards.add(this.privateMap);this.mapCards.doLayout()}c.toggle(e);c.setDisabled(!e);b.toggle(!e&&d);b.setDisabled(!d)},onRecordUpdate:function(a){}});Ext.ns("Tine.Addressbook");Tine.Addressbook.CardDAVContainerPropertiesHookField=Ext.extend(Ext.form.TextField,{anchor:"100%",readOnly:true,initComponent:function(){this.on("added",this.onContainerAdded,this);Tine.Addressbook.CardDAVContainerPropertiesHookField.superclass.initComponent.call(this)},onContainerAdded:function(){this.app=Tine.Tinebase.appMgr.get("Addressbook");this.fieldLabel=this.app.i18n._("CardDAV URL");this.propertiesDialog=this.findParentBy(function(a){return !!a.grantContainer});this.grantContainer=this.propertiesDialog.grantContainer;if(this.grantContainer.application_id&&this.grantContainer.application_id.name){this.isAddressbook=(this.grantContainer.application_id.name=="Addressbook")}else{this.isAddressbook=this.grantContainer.application_id===this.app.id}this.hidden=!this.isAddressbook;this.value=[window.location.href.replace(/\/?(index\.php.*)?$/,""),"/addressbooks/",Tine.Tinebase.registry.get("currentAccount").contact_id,"/",this.grantContainer.id].join("")}});Ext.ux.ItemRegistry.registerItem("Tine.widgets.container.PropertiesDialog.FormItems.Properties",Tine.Addressbook.CardDAVContainerPropertiesHookField,100);